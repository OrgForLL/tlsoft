<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0,maximum-scale=1" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <title>发表评价</title>
    <style type="text/css">
    body {
        font-family: Helvetica, Arial, STHeiTi, "Hiragino Sans GB", "Microsoft Yahei", "微软雅黑", STHeiti, "华文细黑", sans-serif;
        font-size: 14px;
        color: #212121;
        -webkit-user-select: none;
        user-select: none;
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
        margin: 0;
        padding: 0;
        background-color: #f3f3f3;
    }
    
    p {
        margin: 0;
    }
    /*main_page style*/
    .page {
        position: absolute;
        top: 0;
        right: 0;
        left: 0;
        bottom: 65px;
        overflow-x: hidden;
        overflow-y: auto;
    }
        
    .top_con {
        width: 100%;
        height: 200px;
    }
    
    .top_con > textarea {
        border: 0;
        border-radius: 0;
        outline: 0;
        -webkit-appearance: none;
        width: 100%;
        height: 180px;
        color: #333;
        font-size: 14px;
        padding: 10px 15px;
    }
    
    .bot_con {
        background-color: #fff;
        margin-bottom: 12px;
        width: 100%;
    }
    
    .title {
        border-bottom: 1px solid #f3f3f3;
        padding: 5px 15px;
        font-size: 13px;
        display: -webkit-flex;
        display: flex;
        align-items: center;
        justify-content: flex-start;
    }
    
    .backimg {
        background-repeat: no-repeat;
        background-size: cover;
        background-image: url(../../res/img/vipweixin/icon_evaluation.png);
    }
    
    .icon-shop {
        width: 26px;
        height: 26px;
        background-position: -4px -4px;
    }
    
    .score_list {
        padding: 6px 0;
    }
    
    .score_item {
        padding: 5px 15px;
        color: #666;
        display: -webkit-flex;
        display: flex;
        align-items: center;
    }
    
    .icon_list {
        display: inline-block;
        margin-left: 15px;
    }
    
    .icon_list > .backimg {
        width: 30px;
        height: 30px;
        display: inline-block;
        vertical-align: middle;
    }
    
    .icon_list > .icon-smile {
        background-position: -4px -96px;
    }
    
    .icon_list > .icon-smile-selected {
        background-position: -4px -126px;
    }
    
    .icon_list > .icon-star {
        background-position: -4px -35px;
    }
    
    .icon_list > .icon-star-selected {
        background-position: -4px -64px;
    }
    
    .score_item > .rank {
        color: #aaa;
        font-size: 13px;
        margin-left: 10px;
    }
    
    .footer {
        background-color: #333;
        color: #fff;
        width: 90%;
        height: 45px;
        line-height: 40px;
        position: absolute;
        bottom: 10px;
        text-align: center;
        border-radius: 2px;
        left: 5%;
        font-size: 15px;
    }
    /*secceed_page style*/
    
    #succceed_page {
        bottom: 0;
        background-color: #fff;
        display: none;
    }
    .top_succeed{
    	position: absolute;
    	top: 0;
    	bottom: 65px;
    	left: 0;
    	right: 0;
    	display: -webkit-flex;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
    }
    
    .icon-susseed {
        height: 100px;
        width: 100px;
    }
    
    .succeed_txt {
        font-size: 20px;
        margin-top: 30px;
        letter-spacing: 2px;
    }
    
    .tip {
        color: #aaa;
        margin-top: 4px;
    }
    
    .btn_close {
        color: #fff;
        width: 90%;
        height: 45px;
        line-height: 40px;
        position: absolute;
        bottom: 10px;
        text-align: center;
        border-radius: 2px;
        left: 5%;
        font-size: 15px;
        background-color: #333;
    }
        
    #myLoading {
        display: none;
    }

    .load_toast_mask, .load_toast_container {
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        z-index: 9999;
    }

    .load_toast_mask {
        z-index: 9998;
        background-color: rgba(37,38,45,.4);
    }

    .load_toast_container {
        -webkit-transform: translate(100%,100%);
        transform: translate(100%,100%);
    }

    .lee_toast {
        position: absolute;
        top: -50%;
        left: -50%;
        width: auto;
        display: -webkit-box;
        display: flex;
        -webkit-box-align: center;
        align-items: center;
        padding: 13px 16px;
        color: #ccc;
        background-color: rgba(37,38,45,.9);
        border-radius: 4px;
        -webkit-transform: translate(-50%,-50%);
        transform: translate(-50%,-50%);
    }

    .load_img img {
        width: 24px;
        height: 24px;
        display: block;
        margin-right: 10px;
    }

    .load_text {
        max-width: 40vw;
        max-height: 200px;
        overflow: hidden;    
    }
    </style>
    <script>
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?79a5d8b81b16455bcbd5d3c9bb9ab55f";
          var s = document.getElementsByTagName("script")[0]; 
          s.parentNode.insertBefore(hm, s);
        })();
    </script>
</head>

<body>
    <!-- 评价页面 -->
    <div class="page" id="main_page">
        <div class="bot_con">
            <div class="title">
                <div class="icon-shop backimg"></div>
                <p>对<strong>店铺</strong>的评价</p>
            </div>
            <div class="score_list">
                <div class="score_item">
                    <span>总体</span>
                    <div class="icon_list">
                        <div class="icon-smile backimg"></div>
                        <div class="icon-smile backimg"></div>
                        <div class="icon-smile backimg"></div>
                        <div class="icon-smile backimg"></div>
                        <div class="icon-smile backimg"></div>
                    </div>
                    <span class="rank"></span>
                </div>
                <div class="score_item">
                    <span>服务</span>
                    <div class="icon_list">
                        <div class="icon-star backimg"></div>
                        <div class="icon-star backimg"></div>
                        <div class="icon-star backimg"></div>
                        <div class="icon-star backimg"></div>
                        <div class="icon-star backimg"></div>
                    </div>
                    <span class="rank"></span>
                </div>
                <div class="score_item">
                    <span>环境</span>
                    <div class="icon_list">
                        <div class="icon-star backimg"></div>
                        <div class="icon-star backimg"></div>
                        <div class="icon-star backimg"></div>
                        <div class="icon-star backimg"></div>
                        <div class="icon-star backimg"></div>
                    </div>
                    <span class="rank"></span>
                </div>
                <div class="score_item">
                    <span>产品</span>
                    <div class="icon_list">
                        <div class="icon-star backimg"></div>
                        <div class="icon-star backimg"></div>
                        <div class="icon-star backimg"></div>
                        <div class="icon-star backimg"></div>
                        <div class="icon-star backimg"></div>
                    </div>
                    <span class="rank"></span>
                </div>
            </div>
        </div>
        <div class="top_con">
            <textarea placeholder="您对本次消费还满意吗？说点什么吧..."></textarea>
        </div>
    </div>
    <div class="footer" id="btn_submit">提 交</div>
    <!-- 提交成功页面 -->
    <div class="page" id="succceed_page">
        <div class="top_succeed">
            <img class="icon-susseed" src="../../res/img/vipweixin/icon-succeed.png">
            <p class="succeed_txt">提交成功</p>
            <p class="tip">您的评价已经成功反馈，谢谢您的参与</p>
        </div>
        <div class="btn_close">完 成</div>
    </div>
    
    <!--加载提示-->
    <div class="load_toast" id="myLoading">
        <div class="load_toast_mask"></div>
        <div class="load_toast_container">
            <div class="lee_toast">
                <div class="load_img">
                    <img src="../../res/img/my_loading.gif" />
                </div>
                <div class="load_text">正在保存评价...</div>
            </div>
        </div>
    </div>
</body>
<script type="text/javascript" src="../../res/js/jquery.js"></script>
<script type="text/javascript" src="../../res/js/fastclick.min.js"></script>
<script type="text/javascript" src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<script type="text/javascript">
	$(function(){
        var point = {
            "AllPoint": 0,
            "ServicePoint": 0,
            "FacePoint": 0,
            "ProductPoint": 0,
            "Remark": "",
            "djid": "",
            "mdid": ""
        };
        var url = "http://tm.lilanz.com/project/vipweixin/StoreEvaluation.ashx";
        
        var init = function() {
            bindEvents();
            FastClick.attach(document.body);
            
            point.djid = GetQueryParams("djid") || "";
            point.mdid = GetQueryParams("mdid") || "";

            var params = {
                action: "evaluationInit",
                Parameter: [
                    point.mdid,
                    point.djid
                ]
            }

            evaluate(JSON.stringify(params)).then(function(data) {
                var detail = data.data;

                if(data.code == "200") {
                    $(".bot_con .title strong").text(detail.mdmc);
                    if(detail.evaluation.length != 0) {
                        $("#succceed_page").find(".succeed_txt").text("您已完成评价");
                        $("#succceed_page").show();
                    }
                }else {
                    onLoading(data.message);
                    setTimeout(function() {
                        $(".btn_close").click();
                    }, 2000);
                }
            });
            
            WXAPIConfig();
        };
        
        var bindEvents = function() {
            $(".score_item").on("click",".backimg",function() {
                var curr = $(this);
                var isStar, isSmile, isStarSelect, isSmileSelect;
                var index = curr.index() + 1;
                var pointIndex = curr.parent().parent().index();
                var rating = "";
                isStar = curr.hasClass("icon-star");
                isSmile = curr.hasClass("icon-smile");
                isStarSelect = curr.hasClass("icon-star-selected");
                isSmileSelect = curr.hasClass("icon-smile-selected");
                
                if(isStar) {
                    curr.removeClass("icon-star").addClass("icon-star-selected");
                    curr.prevAll().removeClass("icon-star").addClass("icon-star-selected");
                }
                
                if(isSmile) {
                    curr.removeClass("icon-smile").addClass("icon-smile-selected");
                    curr.prevAll().removeClass("icon-smile").addClass("icon-smile-selected");
                }
                
                if(isStarSelect) {
                    curr.nextAll().removeClass("icon-star-selected").addClass("icon-star");
                }
                
                if(isSmileSelect) {
                    curr.nextAll().removeClass("icon-smile-selected").addClass("icon-smile");
                }
                
                switch(index) {
                    case 1:
                        rating = "非常差";
                        break;
                    case 2:
                        rating = "差";
                        break;
                    case 3:
                        rating = "一般";
                        break;
                    case 4:
                        rating = "好";
                        break;
                    case 5:
                        rating = "非常好";
                        break;
                }
                
                switch(pointIndex) {
                    case 0:
                        point.AllPoint = index;
                        break;
                    case 1:
                        point.ServicePoint = index;
                        break;
                    case 2:
                        point.FacePoint = index;
                        break;
                    case 3:
                        point.ProductPoint = index;
                        break;
                }
                
                curr.parent().next().text(rating);
            });
            
            $("#btn_submit").click(function() {
                if(point.AllPoint == 0) {
                    $(".load_img").hide();
                    onLoading("请对本店总体进行评价");
                    setTimeout(function() {
                        $("#myLoading").hide();
                        $(".load_img").show();
                    }, 1000);
                    return;
                }else if(point.ServicePoint == 0) {
                    $(".load_img").hide();
                    onLoading("请对本店服务进行评价");
                    setTimeout(function() {
                        $("#myLoading").hide();
                        $(".load_img").show();
                    }, 1000);
                    return;
                }else if(point.FacePoint == 0) {
                    $(".load_img").hide();
                    onLoading("请对本店环境进行评价");
                    setTimeout(function() {
                        $("#myLoading").hide();
                        $(".load_img").show();
                    }, 1000);
                    return;
                }else if(point.ProductPoint == 0) {
                    $(".load_img").hide();
                    onLoading("请对本店产品进行评价");
                    setTimeout(function() {
                        $("#myLoading").hide();
                        $(".load_img").show();
                    }, 1000);
                    return;
                }
                
                
                point.Remark = getRemark();
                var params = {
                    action: "evaluationSubmit",
                    Parameter: [JSON.stringify(point)]
                }
                onLoading();
                evaluate(JSON.stringify(params)).then(function(data) {
                    if(data.code == "200") {
                        setTimeout(function() {
                            $("#myLoading").hide();
                            $("#succceed_page").show();
                        }, 50);
                    }else {
                        onLoading(data.message);
                        setTimeout(function() {
                            $("#myLoading").hide();
                        }, 2000);
                    }
                });
            });
            
            $(".btn_close").click(function() {
                WeixinJSBridge.call('closeWindow');
            });
        };
        
        var evaluate = function(params) {
            return new Promise(function(resolve, reject) {
                $.ajax({
                    url: url,
                    type: "POST",
                    data: params,
                    dataType: "json"
                }).then(function(data) {
                    resolve(data);
                }).fail(function(err) {
                    reject(err);
                });
            });
        };
        
        var WXAPIConfig = function() {
            var url = window.location.href;
            url = url.split("#")[0];
            var params = {
                action: "getApiConfigInfos",
                Parameter: ["5", url]
            };
            
            evaluate(JSON.stringify(params)).then(function(data) {
                var appId = data.data[0],
                    timestamp = data.data[1],
                    nonceStr = data.data[2],
                    signature = data.data[3];
                
                wx.config({
                    debug: false,
                    appId: appId,
                    timeStamp: timestamp,
                    nonceStr: nonceStr,
                    signature: signature,
                    jsApiList: ['hideOptionMenu']
                });
                
                wx.ready(function() {
                    wx.hideOptionMenu();
                });
            });
        }
        
        var getRemark = function() {
            var remark = $(".top_con").find("textarea").val();
            
            return remark;
        };
        
        /* 获取URL GET参数 */
        var GetQueryParams = function (name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
            var r = window.location.search.substr(1).match(reg);
            if (r != null)
                return unescape(r[2])
            else
                return "";
        }; 
        
        /* 显示加载状态 */
        function onLoading(msg){
            $(".load_text").text(msg || '正在保存评价...');
            $("#myLoading").show();
        }
        
        init();
	})
</script>
</html>
