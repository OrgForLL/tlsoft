<!DOCTYPE html>
<html>
	<head>
		<title>我的报销</title>
		<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=0,maximum-scale=1" />
        <link rel="stylesheet" type="text/css" href="../../res/css/font-awesome.min.css">
        <link rel="stylesheet" type="text/css" href="../../res/css/LeePageSlider.css" />
        <link rel="stylesheet" type="text/css" href="../../res/css/AppMyInfo/myreimbursement.css" />
	</head>
	<body>
        <div class="header"></div>
        <div class="wrap-page">
            <div class="page">
                <div class="options">
                    <ul>
                        <li class="onchoose">全部</li>
                        <li>已审核</li>
                        <li>审核中</li>
                        <li>未审核</li>
                    </ul>
                </div>
                <div class="reimbursement reim-total">
                    <ul>
                    </ul>
                </div>
                <div class="reimbursement noreim-info">
                    <ul>
                    </ul>
                </div>
                <div class="reimbursement reiming-info">
                    <ul>
                    </ul>
                </div>
                <div class="reimbursement reimed-info">
                    <ul>
                    </ul>
                </div>
            </div>
        </div>
        <div class="footer"></div>
        <!--加载提示-->
        <div class="load_toast" id="myLoading">
            <div class="load_toast_mask"></div>
            <div class="load_toast_container">
                <div class="lee_toast">
                    <div class="load_img">
                        <img src="../../res/img/my_loading.gif" />
                    </div>
                    <div class="load_text">加载中...</div>
                </div>
            </div>
        </div>
        
        <!--报销模板-->
        <script id="reim" type="text/html">
            <li>
                <div class="reim-info {{if shbs == 0}} audit {{else if shbs == 3}} auditing {{else if shbs == 1}} audited {{/if}}">
                    <div class="reim-icon">
                        {{if shbs == 0}}
                        <img src="../../res/img/AppMyInfo/icon_mark_wsh.png" />
                        {{else if shbs == 3}}
                        <img src="../../res/img/AppMyInfo/icon_mark_shz.png" />
                        {{else if shbs == 1}}
                        <img src="../../res/img/AppMyInfo/icon_mark_ysh.png" />
                        {{/if}}
                    </div>
                    <div class="reim-cost">
                        <p>{{formatMoney(je)}}</p>
                        <p>{{formatComma(kmmc)}}</p>
                        <p>经办人：{{jbrmc}}</p>
                    </div>
                </div>
                <div class="reim-detail">
                    <p><span>单据信息：</span><span>【{{djh}}】{{formatDate(zdrq)}}</span></p>
                    <p><span>报销内容：</span><span>{{formatComma(bxnr)}}</span></p>
                    <p><span>审核人：</span><span>{{shr}}</span></p>
                </div>
            </li>
        </script>
        
        <script type="text/javascript" src="../../res/js/jquery-3.2.1.min.js"></script>
        <script type="text/javascript" src="../../res/js/template.js"></script>
        <script type="text/javascript" src="../../res/js/fastclick.min.js"></script>
        <script type="text/javascript">
            (function( window,$ ){
                $(function(){
                    bindEven();
                    getInfo();
                    FastClick.attach(document.body);

                    /* 数值转化为货币格式 */
                    Number.prototype.formatMoney = function (places, symbol, thousand, decimal) {
                        places = !isNaN(places = Math.abs(places)) ? places : 2;
                        symbol = symbol !== undefined ? symbol : "¥";
                        thousand = thousand || ",";
                        decimal = decimal || ".";
                        var number = this,
                            negative = number < 0 ? "-" : "",
                            i = parseInt(number = Math.abs(+number || 0).toFixed(places), 10) + "",
                            j = (j = i.length) > 3 ? j % 3 : 0;
                        return symbol + negative + (j ? i.substr(0, j) + thousand : "") + i.substr(j).replace(/(\d{3})(?=\d)/g, "$1" + thousand) + (places ? decimal + Math.abs(number - i).toFixed(places).slice(2) : "");
                    };
                });

                function bindEven(){
                    $(".options li").click(function(){
                        $(this).addClass("onchoose").siblings().removeClass("onchoose");
                        var i = $(this).index();
                        $(".reimbursement").hide(1);
                        switch(i){
                            case 0:
                                $(".reim-total").show();
                                break;
                            case 1:
                                $(".reimed-info").show();
                                break;
                            case 2:
                                $(".reiming-info").show();
                                break;
                            case 3:
                                $(".noreim-info").show();
                                break;
                        }
                    });
                }

                /* 获取报销信息 */
                function getInfo(){
                    apptoken = GetQueryParams("apptoken");
                    if(apptoken == ''){
                        onLoading("请在利郎APP中打开！");
                    }else{
                        getReimbursement(apptoken);
                    } 
                }

                function getReimbursement(apptoken){
                    onLoading();
                    $.ajax({
                        url: '../../api/appmycore.ashx',
                        data: {
                            action: 'getReimbursement',
                            apptoken: apptoken
                        },
                        dataType: 'JSON',
                        success: function(data){
                            if (data.code == '200') {
                                if (data.info == "") {
                                    onLoading('没有报销记录！');
                                    var nonerecord = "<div class='none' >Sorry,没有报销记录</div>";
                                    $(".reim-total ul").append(nonerecord);
                                    $(".noreim-info ul").append(nonerecord);
                                    $(".reiming-info ul").append( nonerecord);
                                    $(".reimed-info ul").append(nonerecord);
                                    setTimeout(function(){
                                        $("#myLoading").hide();
                                    },1000);
                                } else {
                                    onLoading();
                                    template.helper('formatMoney',function(data){
                                        return parseFloat(data).formatMoney();
                                    });
                                    template.helper('formatDate',function(data){
                                        return data.split("T").join(" ").substr(0,16);
                                    });
                                    template.helper('formatComma',function(data){
                                        return data.substr(0,data.length - 1);
                                    });
                                    setReim(data.info);
                                    $(".reimbursement").hide(0);
                                    $(".reim-total").show();
                                    $("#myLoading").hide();
                                }
                            }else{
                                onLoading(data.msg);
                                setTimeout(function(){
                                    $("#myLoading").hide();
                                },1000);
                            }
                        }
                    });
                }
                
                /* 生成报销款项 */
                function setReim(info){
                    var totalHtml = "";  //全部
                    var reimHtml = "";   //未审核
                    var reimingHtml= ""; //审核中
                    var reimedHtml = ""; //已审核
                    var nonerecord = "<div class='none' >Sorry,没有报销记录</div>";
                    
                    for(var i = 0; i < info.length; i++){
                        totalHtml = totalHtml + template("reim",info[i]);
                        
                        switch (info[i].shbs){
                            case 0:
                                reimHtml = reimHtml + template("reim",info[i]);
                                break;
                            case 3:
                                reimingHtml = reimingHtml + template("reim",info[i]);
                                break;
                            case 1:
                                reimedHtml = reimedHtml + template("reim",info[i]);
                                break;
                        }
                    }
                    
                    $(".reim-total ul").append(totalHtml || nonerecord);
                    $(".noreim-info ul").append(reimHtml || nonerecord);
                    $(".reiming-info ul").append(reimingHtml || nonerecord);
                    $(".reimed-info ul").append(reimedHtml || nonerecord);
                }
                
                /* 获取URL GET参数 */
                var GetQueryParams = function (name) {
                    var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
                    var r = window.location.search.substr(1).match(reg);
                    if (r != null)
                        return unescape(r[2])
                    else
                        return "";
                };
                
                /* 显示加载状态 */
                function onLoading(msg){
                    $(".load_text").text(msg || '加载中...');
                    $("#myLoading").show();
                }
            })( window, jQuery )
        </script>
	</body>
</html>