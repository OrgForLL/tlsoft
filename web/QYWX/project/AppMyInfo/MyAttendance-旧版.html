<!DOCTYPE html>
<html>
	<head>
		<title>我的考勤</title>
		<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=0,maximum-scale=1" />
        <link rel="stylesheet" type="text/css" href="../../res/css/font-awesome.min.css">
        <link rel="stylesheet" type="text/css" href="../../res/css/LeePageSlider.css" />
        <link rel="stylesheet" type="text/css" href="../../res/css/AppMyInfo/myattendance.css" />
        <style type="text/css">
            a {
                -webkit-tap-highlight-color:rgba(0,0,0,0);
            }
        </style>
	</head>
	<body>
        <div class="wrap-page">
            <div class="page">
                <div class="attendance">
                    <div class="attendance-month">
                        <i id="lastmonth" class="fa fa-angle-left"></i>
                        <input id="month" type="month" value="" />
                        <i id="nextmonth" class="fa fa-angle-right"></i>
                    </div>
                    <div class="attendance-record">
                        <div class="attendance-day">
                            <div class="day-num">
                                <div class="circle c1">
                                    <div class="pic_left"><div class="left"></div></div>
                                    <div class="pic_right"><div class="right"></div></div>
                                </div>
                                <div class="day-time">
                                    <span id="zqcqts"></span>
                                </div>
                            </div>
                            <div class="day-title">
                                <span>周期出勤</span>
                            </div>
                        </div>
                        <div class="attendance-day">
                            <div class="day-num">
                                <div class="circle c2">
                                    <div class="pic_left"><div class="left"></div></div>
                                    <div class="pic_right"><div class="right"></div></div>
                                </div>
                                <div class="day-time">
                                    <span id="zccqts"></span>
                                </div>
                            </div>
                            <div class="day-title">
                                <span>正常上班</span>
                            </div>
                        </div>
                        <div class="attendance-day">
                            <div class="day-num">
                                <div class="circle c3">
                                    <div class="pic_left"><div class="left"></div></div>
                                    <div class="pic_right"><div class="right"></div></div>
                                </div>
                                <div class="day-time">
                                    <span id="jbcqts"></span>
                                </div>
                            </div>
                            <div class="day-title">
                                <span>固定加班</span>
                            </div>
                        </div>
                        <div class="attendance-day">
                            <div class="day-num">
                                <div class="circle c4">
                                    <div class="pic_left"><div class="left"></div></div>
                                    <div class="pic_right"><div class="right"></div></div>
                                </div>
                                <div class="day-time">
                                    <span id="kxqjts"></span>
                                </div>
                            </div>
                            <div class="day-title">
                                <span>扣薪请假</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="information">
                    <ul>
                        <li class="ontouch"><span>请假</span><i class="fa fa-angle-right"></i><span id="qjzts"></span></li>
                        <li class="ontouch"><span>迟到</span><i class="fa fa-angle-right"></i><span id="cdzcs"></span></li>
                        <li class="ontouch"><span>早退</span><i class="fa fa-angle-right"></i><span id="ztzcs"></span></li>
                        <li><span>上月婚假天数</span><span id="syhjts"></span></li>
                        <li><span>上月丧假天数</span><span id="sysjts"></span></li>
                        <li><span>无薪婚假天数</span><span id="wxhjts"></span></li>
                        <li><span>无薪丧假天数</span><span id="wxsjts"></span></li>
                        <li><span>无薪病假天数</span><span id="wxbjts"></span></li>
                    </ul>
                </div>
            </div>
        </div>
        <div id="qj" class="layer-page">
            <div class="detail">
                <div class="detail-title"><span>请假明细</span><i class="fa fa-times"></i></div>
                <div class="detail-leave">
                    <ul>
                    </ul>
                </div>
            </div>
        </div>
        <div id="late-detail" class="layer-page">
            <div class="detail">
                <div class="detail-title"><span>迟到明细</span><i class="fa fa-times"></i></div>
                <div class="detail-time"><span>累计迟到</span><span id="cd"></span><span>分钟</span></div>
                <div class="detail-info">
                    <ul>
                        <li><span><<10分钟</span><span id="cdmin"></span></li>
                        <li><span>>10分钟</span><span id="cdmax"></span></li>
                    </ul>
                </div>
            </div>
        </div>
        <div id="leavearely-detail" class="layer-page">
            <div class="detail">
                <div class="detail-title"><span>早退明细</span><i class="fa fa-times"></i></div>
                <div class="detail-time"><span>累计早退</span><span id="zt"></span><span>分钟</span></div>
                <div class="detail-info">
                    <ul>
                        <li><span><<10分钟</span><span id="ztmin"></span></li>
                        <li><span>>10分钟</span><span id="ztmax"></span></li>
                        <li><span>>旷工</span><span id="kg"></span></li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!--加载提示-->
        <div class="load_toast" id="myLoading">
            <div class="load_toast_mask"></div>
            <div class="load_toast_container">
                <div class="lee_toast">
                    <div class="load_img">
                        <img src="../../res/img/my_loading.gif" />
                    </div>
                    <div class="load_text">加载中...</div>
                </div>
            </div>
        </div>

        <!--请假明细模板-->
        <script id="leave" type="text/html">
            <li>
                <div class="leave-cause"><div class="cause"><span>{{qjlxmc}}</span></div></div>
                <div class="leave-day">
                    <span>{{qjts}}天</span><span>{{zdrq}}</span>
                    <p>{{qjyy}}</p>
                    <p>{{kssj}} 至 {{jssj}}</p>
                </div>
            </li>
        </script>
        
        <script type="text/javascript" src="../../res/js/jquery-3.2.1.min.js"></script>
        <script type="text/javascript" src="../../res/js/template.js"></script>
        <script type="text/javascript" src="../../res/js/fastclick.min.js"></script>
        <script type="text/javascript">
            var apptoken;
            var nowMonth = new Date().getMonth() + 1;
            var nowYear = new Date().getFullYear();
            
            $(function(){
                bindEven();
                getInfo();
                FastClick.attach(document.body);
            });
            
            /* 绑定事件组 */
            function bindEven(){
                $(".layer-page i").click(function(){
                    $(this).parent().parent().parent().hide();
                });
                
                $(".layer-page .detail").click(function(e){
                    e.stopPropagation();
                });
                
                $(".layer-page").click(function(){
                    $(this).hide();
                });

                $(".information li").eq(0).click(function(){
                    $("#qj").show();
                });
                
                $(".information li").eq(1).click(function(){
                    $("#late-detail").show();
                });
                
                $(".information li").eq(2).click(function(){
                    $("#leavearely-detail").show();
                });
                
                $("#lastmonth").click(function(){
                    var date = $("#month").val();
                    var year = parseInt(date.split('-')[0]);
                    var month = parseInt(date.split('-')[1]);
                    
                    if(month == 1){
                        month = 12;
                        year--;
                    }else{
                        month--;
                        if(month < 10){
                            month = '0' + month;
                        }
                    }
                    
                    var year_month = year + '-' + month;
                    $("#month").val(year_month);
                    getDataAttendance(apptoken,year_month);
                });
                
                $("#nextmonth").click(function(){
                    var date = $("#month").val();
                    var year = parseInt(date.split('-')[0]);
                    var month = parseInt(date.split('-')[1]);
                    
                    if(month == 12){
                        month = '01';
                        year++;
                    }else{
                        month++
                        
                        if(month < 10){
                            month = '0' + month;
                        }
                    }
                    var year_month = year + '-' + month;
                    $("#month").val(year_month);
                    getDataAttendance(apptoken,year_month);
                });
                
                $("#month").change(function(){
                    var date = $(this).val();
                    var year = parseInt(date.split('-')[0]);
                    var month = parseInt(date.split('-')[1]);
                    
                    if(year == nowYear && month > nowMonth){
                        onLoading("请在当前日期之前选择月份！");
                        setTimeout(function(){
                            $("#myLoading").hide();
                            $("#month").val(getDate());
                            $("#month").change();
                        },2000);
                    }else{
                        onLoading();
                        getDataAttendance(apptoken,date);
                    }
                });
            }
            
            /* 获取考勤数据 */
            function getInfo(){
                var date = getDate();
                apptoken = GetQueryParams("apptoken");
                if(apptoken == ''){
                    onLoading("请在利郎APP中打开！");
                }else{
                    getDataAttendance(apptoken,date);
                }
            }
            
            /* 根据日期获取考勤数据 */
            function getDataAttendance(apptoken,date){
                onLoading();
                setTimeout(function(){
                    $.ajax({
                        url: '../../api/appmycore.ashx',
                        data: {
                            action: 'MyAttendance',
                            apptoken: apptoken,
                            rq: date
                        },
                        dataType: 'JSON',
                        success: function(data){
                            var info;
                            if (data.code == '200') {
                                if (data.info == "") {
                                    onLoading('对不起，还未生成考勤数据！');
                                    setTimeout(function(){
                                        $("#myLoading").hide();
                                    },1000);
                                } else {
                                    onLoading();
                                    if (data.info.rylx == "zb") {
                                        setzbinfo(data);
                                    } else {
                                        setmyinfo(data);
                                    }
                                }
                            }else{
                                onLoading(data.msg);
                                setTimeout(function(){
                                    $("#myLoading").hide();
                                },1000);
                            }
                        }
                    });
                },100);
            }
            
            /* 获取当前日期 */
            function getDate(){
                var date = new Date();
                var year = date.getFullYear();
                var month = date.getMonth();
                if(month < 10){
                    month = '0' + month;
                }
                $("#month").val(year + '-' + month);
                return year + '-' + month;
            }
            
            /* 显示总部考勤数据 */
            function setzbinfo(data){
                var info = data.info;
                
                if(info.main != undefined && info.main != null && info.main.length > 0){
                    $("#zqcqts").text((info.main[0].zqcqts || '0') + '天');
                    $("#zccqts").text((info.main[0].zccqts || '0') + '天');
                    $("#jbcqts").text((info.main[0].jbcqts || '0') + '天');
                    $("#kxqjts").text((info.main[0].kxqjts || '0') + '天');
                    $("#qjzts").text((info.main[0].qjzts || '0') + '天');
                    $("#cdzcs").text((info.main[0].cdmin + info.main[0].cdmax || '0') + '次');
                    $("#cdmin").text((info.main[0].cdmin || '0') + '次');
                    $("#cdmax").text((info.main[0].cdmax || '0') + '次');
                    $("#cd").text((info.main[0].cd || '0'));
                    $("#ztzcs").text((info.main[0].ztmin + info.main[0].ztmax || '0') + '次');
                    $("#ztmin").text((info.main[0].ztmin || '0') + '次');
                    $("#ztmax").text((info.main[0].ztmax || '0') + '次');
                    $("#zt").text((info.main[0].zt || '0'));
                    $("#syhjts").text((info.main[0].syhjts || '0') + '天');
                    $("#sysjts").text((info.main[0].sysjts || '0') + '天');
                    $("#wxhjts").text((info.main[0].wxhjts || '0') + '天');
                    $("#wxsjts").text((info.main[0].wxsjts || '0') + '天');
                    $("#wxbjts").text((info.main[0].wxbjts || '0') + '天');
                    $("#kg").text((info.main[0].kg || '0') + '次');

                    var html = '';
                    var length = info.detail.length || 0;
                    for(var i = 0; i <length;i++){
                        if(info.detail[i].qjlxmc == "出差"){
                            info.detail[i].qjlxmc = info.detail[i].qjlxmc.split('')[1];
                        }else{
                            info.detail[i].qjlxmc = info.detail[i].qjlxmc.split('')[0];
                        }
                        html = html + template('leave',info.detail[i]);
                    }
                    var detail = $(".detail-leave ul");
                    detail.empty();
                    detail.append(html);

                    var circle = [
                        {
                            el: 'c1',
                            angle: info.main[0].zqcqts
                        },
                        {
                            el: 'c2',
                            angle: info.main[0].zccqts
                        },
                        {
                            el: 'c3',
                            angle: info.main[0].jbcqts
                        },
                        {
                            el: 'c4',
                            angle: info.main[0].kxqjts
                        }
                    ];

                    var month = getDays(parseInt(info.main[0].ny.substring(4)));
                    setAngle(circle,month);
                }
                $("#myLoading").hide();
            }
            
            /* 显示贸易考勤数据 */
            function setmyinfo(data){
                var info = data.info;
                
                if(info.main != undefined && info.main != null && info.main.length > 0){
                    $("#zqcqts").text((info.main[0].zqcqts || '0') + '天');
                    $("#zccqts").text((info.main[0].zccqts || '0') + '天');
                    $("#jbcqts").text((info.main[0].jbcqts || '0') + '天');
                    $("#kxqjts").text((info.main[0].kxqjts || '0') + '天');

                    var circle = [
                        {
                            el: 'c1',
                            angle: info.main[0].zqcqts
                        },
                        {
                            el: 'c2',
                            angle: info.main[0].zccqts
                        },
                        {
                            el: 'c3',
                            angle: info.main[0].jbcqts
                        },
                        {
                            el: 'c4',
                            angle: info.main[0].kxqjts
                        }
                    ];

                    var month = getDays(parseInt(info.main[0].ny.substring(4)));
                    setAngle(circle,month);

                    var html = '<div class="info-title">请假明细</div><div class="detail-leave"><ul>';
                    var length = info.detail.length || 0;
                    for(var i = 0; i < length;i++){
                        if(info.detail[i].qjlxmc == "出差"){
                            info.detail[i].qjlxmc = info.detail[i].qjlxmc.split('')[1];
                        }else{
                            info.detail[i].qjlxmc = info.detail[i].qjlxmc.split('')[0];
                        }
                        info.detail[i].qjyy = '请假原因：' + info.detail[i].qjyy;
                        html = html + template('leave',info.detail[i]);
                    }

                    html = html + '</ul></div>';
                    $(".information").empty();
                    $(".information").append(html);
                }
                
                $("#myLoading").hide();
            }
            
            /* 获取URL GET参数 */
            var GetQueryParams = function (name) {
                var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
                var r = window.location.search.substr(1).match(reg);
                if (r != null)
                    return unescape(r[2])
                else
                    return "";
            }; 
            
            /* 获取月份天数 */
            function getDays(month){
                var month_day = [31,28,31,30,31,30,31,31,30,31,30,31];
                return month_day[month - 1];
            }
            
            /* 设置圆传动角度 */
            function setAngle(c,month){
                for(var i = 0; i < 4 ;i++){
                    var angle = (1 - c[i].angle / month) * 100;
                    $("." + c[i].el).css("transform","rotate(0deg)");
                    if(angle <= 50 ){
                        if(angle > 0 && angle <= 5){
                            setAnim(c[i].el,5,true);
                        }else if(angle > 5 && angle <= 10 ){
                            setAnim(c[i].el,15,true);
                        }else if(angle > 10 && angle <= 15 ){
                            setAnim(c[i].el,25,true);
                        }else if(angle > 15 && angle <= 25 ){
                            $("." + c[i].el).css("transform","rotate(45deg)");
                            setAnim(c[i].el,50,true);
                        }else if(angle > 25 && angle <= 35 ){
                            setAnim(c[i].el,75,true);
                        }else if(angle > 35 && angle <= 40 ){
                            setAnim(c[i].el,85,true);
                        }else if(angle > 40 && angle <= 45 ){
                            setAnim(c[i].el,95,true);
                        }else if(angle > 45 && angle <= 50 ){
                            setAnim(c[i].el,100,true);
                        }
                    }else if(angle < 100){
                        if(angle > 50 && angle <= 55){
                            setAnim(c[i].el,5,false);
                        }else if(angle > 55 && angle <= 60 ){
                            setAnim(c[i].el,15,false);
                        }else if(angle > 60 && angle <= 65 ){
                            setAnim(c[i].el,25,false);
                        }else if(angle > 65 && angle <= 75 ){
                            setAnim(c[i].el,50,false);
                        }else if(angle > 75 && angle <= 85 ){
                            setAnim(c[i].el,75,false);
                        }else if(angle > 85 && angle <= 90 ){
                            setAnim(c[i].el,85,false);
                        }else if(angle > 90 && angle < 100 ){
                            setAnim(c[i].el,95,false);
                        }
                    }else{
                        setAnim(c[i].el,100,false);
                    }
                }
            }
            
            /* 设置圆转动动画 */
            function setAnim(el,angle,ishalf){
                $("." + el + " .left").removeAttr("style");
                $("." + el + " .right").removeAttr("style");
                
                if(ishalf){
                    setTimeout(function(){
                        $("." + el + " .right").css("animation","load" + angle + " 3s forwards");
                        document.querySelector("." + el).querySelector(".right").addEventListener("webkitAnimationEnd",function(){
                            $("." + el + " .left").css("animation","load0 2s forwards");
                        });
                    },10);
                }else{
                    setTimeout(function(){
                        $("." + el + " .right").css("animation","load100 1.5s forwards");
                    },10);
                    document.querySelector("." + el).querySelector(".right").addEventListener("webkitAnimationEnd",function(){
                        $("." + el + " .left").css("animation","load" + angle + " 2s forwards");
                    });
                }
            }

            /* 显示加载状态 */
            function onLoading(msg){
                $(".load_text").text(msg || '加载中...');
                $("#myLoading").show();
            }
        </script>
	</body>
</html>