<!DOCTYPE html>

<html>
	<head>
		<title>我的消费</title>
		<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=0,maximum-scale=1" />
        <link rel="stylesheet" type="text/css" href="../../res/css/font-awesome.min.css" />
        <link rel="stylesheet" type="text/css" href="../../res/css/LeePageSlider.css" />
        <link rel="stylesheet" type="text/css" href="../../res/css/AppMyInfo/myspending.css" />
        <style type="text/css">
            ul li.total {
                text-align:right;
                padding:10px 0;
                font-size:16px;
                font-weight:bold;
                justify-content:flex-end;
                padding-right:15px;
                /*color:rgb(255,146,98);*/
            }

            .total > span {
                font-size:18px !important;
            }
        </style>
	</head>
	<body>
        <div class="wrap-page">
            <div class="page">
                <div class="spending-info">
                    <div class="spending-month">
                        <i id="lastmonth" class="fa fa-angle-left"></i>
                        <input id="month" type="month" value="" />
                        <i id="nextmonth" class="fa fa-angle-right"></i>
                    </div>
                    <div class="spending-data">
                        <hr/>
                        <div class="spending-total">
                            <div class="icon">
                                <img src="../../res/img/AppMyInfo/icon_xf.png" />
                            </div>
                            <div class="cost">
                                <span>总消费</span>
                                <p id="totalSpending"></p>
                            </div>
                        </div>
                        <div class="spending-perc">
                            <canvas id="canvas" width="60" height="60"></canvas>
                            <div class="perc-info">
                                <span>食堂报餐</span><span>刷卡煮面</span>
                            </div>
                        </div>
                    </div>
                    <div class="spending-place">
                        <ul>
                            <li class="onchoose">食堂报餐</li>
                            <li>刷卡煮面</li>
                            <li>活动中心</li>
                        </ul>
                    </div>
                </div>
                <div class="spending-record hidden">
                    <ul></ul>
                </div>
                <div class="spending-noodle hidden">
                    <ul></ul>
                </div>
                <div class="spending-swim hidden">
                    <ul></ul>
                </div>
            </div>
        </div>
        
        <!--加载提示-->
        <div class="load_toast" id="myLoading">
            <div class="load_toast_mask"></div>
            <div class="load_toast_container">
                <div class="lee_toast">
                    <div class="load_img">
                        <img src="../../res/img/my_loading.gif" />
                    </div>
                    <div class="load_text">加载中...</div>
                </div>
            </div>
        </div>
        <!--报餐模板-->
        <script id="canteen" type="text/html">
            {{each canteen as value i}}
            <li>
                <div><span class="record-canteen">{{formatMoney(value.pay)}}</span></div>
                <div><p>{{value.classname}}</p><p>{{value.startdate}} 至 {{value.enddate}}</p></div>
            </li>
            {{/each}}
        </script>
        <!--煮面模板-->
        <script id="noodle" type="text/html">
            {{each noodle as value i}}
            <li>
                <div><span class="record-noodle">{{formatMoney(value.consumemoney)}}</span></div>
                <div><p>{{formatDate(value.consumetime)}}</p></div>
            </li>
            {{/each}}
        </script>
        <!--活动中心模板-->
        <script id="swim" type="text/html">
            {{each swim as value i}}
            <li>
                <div><p>窗口：{{value.winno}}</p><p>通道：{{value.classname}}</p></div>
                <div><span>{{formatDate(value.consumetime)}}</span></div>
            </li>
            {{/each}}
        </script>
        <script type="text/javascript" src="../../res/js/jquery-3.2.1.min.js"></script>
        <script type="text/javascript" src="../../res/js/Chart.min.js"></script>
        <script type="text/javascript" src="../../res/js/template.js"></script>
        <script type="text/javascript" src="../../res/js/fastclick.min.js"></script>
        <script type="text/javascript">
            var apptoken;
            var nowMonth = new Date().getMonth() + 1;
            var nowYear = new Date().getFullYear();
            
            $(function(){
                bindEven();
                getInfo();
                FastClick.attach(document.body);
                
                /* 数值转化为货币格式 */
                Number.prototype.formatMoney = function(places, symbol, thousand, decimal) {
                    places = !isNaN(places = Math.abs(places)) ? places : 2;
                    symbol = symbol !== undefined ? symbol : "¥ ";
                    thousand = thousand || ",";
                    decimal = decimal || ".";
                    var number = this,
                        negative = number < 0 ? "-" : "",
                        i = parseInt(number = Math.abs(+number || 0).toFixed(places), 10) + "",
                        j = (j = i.length) > 3 ? j % 3 : 0;
                    return symbol + negative + (j ? i.substr(0,j) + thousand : "") + i.substr(j).replace(/(\d{3})(?=\d)/g, "$1" + thousand) + (places ? decimal + Math.abs(number - i).toFixed(places).slice(2) : "");
                }
            });
            
            function bindEven(){
                $(".spending-place li").click(function(){
                    $(this).addClass("onchoose").siblings().removeClass("onchoose");
                    var i = $(this).index();
                    $(".hidden").hide(0);
                    if(i == 0){
                        $(".spending-record").show();
                    }else if(i == 1){
                        $(".spending-noodle").show();
                    }else if(i == 2){
                        $(".spending-swim").show();
                    }
                });
                
                $("#lastmonth").click(function(){
                    var date = $("#month").val();
                    var year = parseInt(date.split('-')[0]);
                    var month = parseInt(date.split('-')[1]);
                    
                    if(month == 1){
                        month = 12;
                        year--;
                    }else{
                        month--;
                        if(month < 10){
                            month = '0' + month;
                        }
                    }
                    
                    var year_month = year + '-' + month;
                    $("#month").val(year_month);
                    getDataSpending(apptoken,year_month);
                });
                
                $("#nextmonth").click(function(){
                    var date = $("#month").val();
                    var year = parseInt(date.split('-')[0]);
                    var month = parseInt(date.split('-')[1]);
                    
                    if(month == 12){
                        month = '01';
                        year++;
                    }else{
                        month++
                        
                        if(month < 10){
                            month = '0' + month;
                        }
                    }
                    var year_month = year + '-' + month;
                    $("#month").val(year_month);
                    getDataSpending(apptoken,year_month);
                });
                
                $("#month").change(function(){
                    var date = $(this).val();
                    var year = parseInt(date.split('-')[0]);
                    var month = parseInt(date.split('-')[1]);
                    
                    if(year == nowYear && month > nowMonth){
                        onLoading("请在当前日期之前选择月份！");
                        setTimeout(function(){
                            $("#myLoading").hide();
                            $("#month").val(getDate());
                            $("#month").change();
                        },2000);
                    }else{
                        onLoading();
                        getDataSpending(apptoken,date);
                    }
                });
            }
            
            function getDate(){
                var date = new Date();
                var year = date.getFullYear();
                var month = date.getMonth() + 1;
                if(month < 10){
                    month = '0' + month;
                }
                $("#month").val(year + '-' + month);
                return year + '-' + month;
            }
            
            /* 获取消费信息 */
            function getInfo(){
                var date = getDate();
                apptoken = GetQueryParams("apptoken");
                if(apptoken == ''){
                    onLoading("请在利郎APP中打开！");
                }else{
                    console.log(date);
                    getDataSpending(apptoken,date);
                } 
            }
            
            /* 根据日期获取消费数据 */
            function getDataSpending(apptoken,date){
                onLoading();
                setTimeout(function(){
                    $.ajax({
                        url: '../../api/appmycore.ashx',
                        data: {
                            action: 'getMyConsume',
                            apptoken: apptoken,
                            rq: date
                        },
                        dataType: 'JSON',
                        success: function(data){
                            if (data.code == '200') {
                                if (data.info == "") {
                                    onLoading('对不起，还未生成消费数据！');
                                    setSpending({"canteen":"","noodle":"","swim":""});
                                    setTimeout(function(){
                                        $("#myLoading").hide();
                                    },1000);
                                } else {
                                    onLoading();
                                    template.helper('formatMoney',function(data){
                                        return parseFloat(data).formatMoney();
                                    });
                                    template.helper('formatDate',function(data){
                                        return data.split("T").join(" ").substr(0,16);
                                    });
                                    setSpending(data.info);
                                    $("#myLoading").hide();
                                }
                            }else{
                                onLoading(data.msg);
                                $(".spending-record ul").empty();
                                $(".spending-noodle ul").empty();
                                $(".spending-swim ul").empty();
                                $("#totalSpending").text("--");
                                setTimeout(function(){
                                    $("#myLoading").hide();
                                },1000);
                            }
                        }
                    });
                },100);
            }
            
            /* 消费记录 */
            function setSpending(info){
                var canteen = "";
                var noodle = "";
                var swim = "";
                var total;
                var none = "<div class='none' style='font-size:14px;white-space: nowrap;'>Sorry,【" + $("#month").val() + "】没有消费记录</div>";

                canteen = template("canteen",info);
                noodle = template("noodle",info);
                swim = template("swim",info);
                $(".spending-record ul").empty();
                $(".spending-noodle ul").empty();
                $(".spending-swim ul").empty();

                if(canteen == ""){
                    $(".spending-record ul").append(none);
                }else{
                    $(".spending-record ul").append(canteen);
                    $(".spending-record ul").append("<li class='total' style='color:#08ea96;'>合计：<span>--</span></li>");
                }

                if(noodle == ""){
                    $(".spending-noodle ul").append(none);
                }else{
                    $(".spending-noodle ul").append(noodle);
                    $(".spending-noodle ul").append("<li class='total' style='color:#fea192;'>合计：<span>--</span></li>");
                }

                if(swim == ""){
                    $(".spending-swim ul").append(none);
                }else{
                    $(".spending-swim ul").append(swim);
                }
                
                var total = getRecord(info);
                $(".spending-record ul li.total>span").text(total.cRecord.formatMoney());
                $(".spending-noodle ul li.total>span").text(total.nRecord.formatMoney());

                $("#totalSpending").text(total.Total.formatMoney());
                setDoughnut(total);
            }
            
            function getRecord(info){
                var info = info;
                var canteen = 0;
                var noodle = 0;
                for (var i = 0; i < info.canteen.length ; i++) {
                    canteen = canteen + info.canteen[i].pay;
                }
                
                for (var j = 0; j < info.noodle.length; j++) {
                    noodle = noodle + info.noodle[j].consumemoney;
                }
                
                return { "cRecord": canteen, "nRecord": noodle, "Total": canteen + noodle };
            }
            
            /* 获取URL GET参数 */
            var GetQueryParams = function (name) {
                var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
                var r = window.location.search.substr(1).match(reg);
                if (r != null)
                    return unescape(r[2])
                else
                    return "";
            }; 
            
            function setDoughnut(record){
                var data = [
                    {
                        value: parseInt(record.cRecord / record.Total * 360),
                        color: "#08ea96"
                    },
                    {
                        value: parseInt(record.nRecord / record.Total * 360),
                        color: "#fea192"
                    }
                ];
                var canvas = $("#canvas");
                canvas.removeAttr("style");
                canvas.attr("width",60);
                canvas.attr("height",60);
                var myDoughnut = new Chart(canvas[0].getContext("2d")).Doughnut(data);
            }
            
            /* 显示加载状态 */
            function onLoading(msg){
                $(".load_text").text(msg || '加载中...');
                $("#myLoading").show();
            }
        </script>
	</body>
</html>