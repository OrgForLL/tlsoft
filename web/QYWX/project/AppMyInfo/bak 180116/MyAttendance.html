<!DOCTYPE html>
<html>
	<head>
		<title>我的考勤</title>
		<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=0,maximum-scale=1" />
        <link rel="stylesheet" type="text/css" href="../../res/css/font-awesome.min.css">
        <link rel="stylesheet" type="text/css" href="../../res/css/LeePageSlider.css" />
        <link rel="stylesheet" type="text/css" href="../../res/css/AppMyInfo/myattendance.css" />
        <style type="text/css">
            a {
                -webkit-tap-highlight-color:rgba(0,0,0,0);
            }
        </style>
	</head>
	<body>
        <div class="wrap-page">
            <div class="page">
                <div class="attendance">
                    <div class="attendance-month">
                        <i id="lastmonth" class="fa fa-angle-left"></i>
                        <input id="month" type="month" value="" />
                        <i id="nextmonth" class="fa fa-angle-right"></i>
                    </div>
                    <div class="attendance-record">
                        <div class="attendance-day">
                            <div class="day-num">
                                <div class="circle c1">
                                    <div class="pic_left"><div class="left"></div></div>
                                    <div class="pic_right"><div class="right"></div></div>
                                </div>
                                <div class="day-time">
                                    <span id="zqcqts"></span>
                                </div>
                            </div>
                            <div class="day-title">
                                <span>周期出勤</span>
                            </div>
                        </div>
                        <div class="attendance-day">
                            <div class="day-num">
                                <div class="circle c2">
                                    <div class="pic_left"><div class="left"></div></div>
                                    <div class="pic_right"><div class="right"></div></div>
                                </div>
                                <div class="day-time">
                                    <span id="zccqts"></span>
                                </div>
                            </div>
                            <div class="day-title">
                                <span>正常上班</span>
                            </div>
                        </div>
                        <div class="attendance-day">
                            <div class="day-num">
                                <div class="circle c3">
                                    <div class="pic_left"><div class="left"></div></div>
                                    <div class="pic_right"><div class="right"></div></div>
                                </div>
                                <div class="day-time">
                                    <span id="jbcqts"></span>
                                </div>
                            </div>
                            <div class="day-title">
                                <span>固定加班</span>
                            </div>
                        </div>
                        <div class="attendance-day">
                            <div class="day-num">
                                <div class="circle c4">
                                    <div class="pic_left"><div class="left"></div></div>
                                    <div class="pic_right"><div class="right"></div></div>
                                </div>
                                <div class="day-time">
                                    <span id="kxqjts"></span>
                                </div>
                            </div>
                            <div class="day-title">
                                <span>扣薪请假</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="sign">
                    <div class="calendar">
                        <div class="Day">
                            <table>
                                <thead>
                                    <tr>
                                        <th>日</th>
                                        <th>一</th>
                                        <th>二</th>
                                        <th>三</th>
                                        <th>四</th>
                                        <th>五</th>
                                        <th>六</th>
                                    </tr>
                                </thead>
                                <tbody>

                                </tbody>
                            </table>
                        </div>
                        <div class="sign-title"><p>打卡记录</p></div>
                    </div>
                    <div class="sign-detail">
                    </div>
                </div>
                <div class="sign-bd"><span>签卡补单</span><i class="iconfont icon-dianziqiandan"></i></div>
                <div class="information">
                    <ul>
                        <li class="ontouch"><span>请假</span><i class="fa fa-angle-right"></i><span id="qjzts"></span></li>
                        <li class="ontouch"><span>迟到</span><i class="fa fa-angle-right"></i><span id="cdzcs"></span></li>
                        <li class="ontouch"><span>早退</span><i class="fa fa-angle-right"></i><span id="ztzcs"></span></li>
                        <li><span>上月婚假天数</span><span id="syhjts"></span></li>
                        <li><span>上月丧假天数</span><span id="sysjts"></span></li>
                        <li><span>无薪婚假天数</span><span id="wxhjts"></span></li>
                        <li><span>无薪丧假天数</span><span id="wxsjts"></span></li>
                        <li><span>无薪病假天数</span><span id="wxbjts"></span></li>
                    </ul>
                </div>
            </div>
        </div>
        <div id="qj" class="layer-page">
            <div class="detail">
                <div class="detail-title"><span>请假明细</span><i class="fa fa-times"></i></div>
                <div class="detail-leave">
                    <ul>
                    </ul>
                </div>
            </div>
        </div>
        <div id="late-detail" class="layer-page">
            <div class="detail">
                <div class="detail-title"><span>迟到明细</span><i class="fa fa-times"></i></div>
                <div class="detail-time"><span>累计迟到</span><span id="cd"></span><span>分钟</span></div>
                <div class="detail-info">
                    <ul>
                        <li><span><<10分钟</span><span id="cdmin"></span></li>
                        <li><span>>10分钟</span><span id="cdmax"></span></li>
                    </ul>
                </div>
            </div>
        </div>
        <div id="leavearely-detail" class="layer-page">
            <div class="detail">
                <div class="detail-title"><span>早退明细</span><i class="fa fa-times"></i></div>
                <div class="detail-time"><span>累计早退</span><span id="zt"></span><span>分钟</span></div>
                <div class="detail-info">
                    <ul>
                        <li><span><<10分钟</span><span id="ztmin"></span></li>
                        <li><span>>10分钟</span><span id="ztmax"></span></li>
                        <li><span>>旷工</span><span id="kg"></span></li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!--加载提示-->
        <div class="load_toast" id="myLoading">
            <div class="load_toast_mask"></div>
            <div class="load_toast_container">
                <div class="lee_toast">
                    <div class="load_img">
                        <img src="../../res/img/my_loading.gif" />
                    </div>
                    <div class="load_text">加载中...</div>
                </div>
            </div>
        </div>
        
        <!--底部对话框-->
        <div class="layer">
            <ul>
                <li id="layer-qj">请假</li>
                <li id="layer-tx">调休</li>
                <li id="layer-bq">签卡</li>
                <li class="cancel">取消</li>
            </ul>
        </div>

        <!--请假明细模板-->
        <script id="leave" type="text/html">
            <li>
                <div class="leave-cause"><div class="cause"><span>{{qjlxmc}}</span></div></div>
                <div class="leave-day">
                    <span>{{qjts}}天</span><span>{{zdrq}}</span>
                    <p>{{qjyy}}</p>
                    <p>{{kssj}} 至 {{jssj}}</p>
                </div>
            </li>
        </script>
        <!--签到详情模板 正常签到-->
        <script id="sign-detail" type="text/html">
            {{each}}
                {{if $value == "缺"}}
                    <span class="Yc">{{$value}}</span>
                {{else}}
                    <span>{{$value}}</span>
                {{/if}}
            {{/each}}
        </script>
        <!--签到详情模板 特殊情况-->
        <script id="sign-error" type="text/html">
            <span>{{$value}}</span>
        </script>
        <script type="text/javascript" src="../../res/js/jquery-3.2.1.min.js"></script>
        <script type="text/javascript" src="../../res/js/template.js"></script>
        <script type="text/javascript" src="../../res/js/fastclick.min.js"></script>
        <script type="text/javascript" src="../../res/js/AppMyInfo/datepicker.js"></script>
        <script type="text/javascript">
            var apptoken;
            var nowMonth = new Date().getMonth() + 1;
            var nowYear = new Date().getFullYear();
            var signData = {};
            var isPop = false;
            
            $(function(){
                bindEven();
                getInfo();
                FastClick.attach(document.body);
            });
            
            /* 绑定事件组 */
            function bindEven(){
                $(".layer-page i").click(function(){
                    $(this).parent().parent().parent().hide();
                });
                
                $(".layer-page .detail").click(function(e){
                    e.stopPropagation();
                });
                
                $(".layer-page").click(function(){
                    $(this).hide();
                });

                $(".information li").eq(0).click(function(){
                    $("#qj").show();
                });
                
                $(".information li").eq(1).click(function(){
                    $("#late-detail").show();
                });
                
                $(".information li").eq(2).click(function(){
                    $("#leavearely-detail").show();
                });
                
                $("#lastmonth").click(function(){
                    var date = $("#month").val();
                    var year = parseInt(date.split('-')[0]);
                    var month = parseInt(date.split('-')[1]);
                    
                    if(month == 1){
                        month = 12;
                        year--;
                    }else{
                        month--;
                        if(month < 10){
                            month = '0' + month;
                        }
                    }
                    
                    var year_month = year + '-' + month;
                    getCanlender.setDay(year,month - 1);
                    $("#month").val(year_month);
                    getDataAttendance(apptoken,year_month);
                });
                
                $("#nextmonth").click(function(){
                    var date = $("#month").val();
                    var year = parseInt(date.split('-')[0]);
                    var month = parseInt(date.split('-')[1]);
                    
                    if(month == 12){
                        month = '01';
                        year++;
                    }else{
                        month++
                        
                        if(month < 10){
                            month = '0' + month;
                        }
                    }
                    var year_month = year + '-' + month;
                    getCanlender.setDay(year,month - 1);
                    $("#month").val(year_month);
                    getDataAttendance(apptoken,year_month);
                });
                
                $("#month").change(function(){
                    var date = $(this).val();
                    var year = parseInt(date.split('-')[0]);
                    var month = parseInt(date.split('-')[1]);
                    
                    if(year == nowYear && month > nowMonth){
                        onLoading("请在当前日期之前选择月份！");
                        setTimeout(function(){
                            $("#myLoading").hide();
                            $("#month").val(getDate());
                            $("#month").change();
                        },2000);
                    }else{
                        onLoading();
                        getDataAttendance(apptoken,date);
                    }
                });
                
                $(".calendar").on('click','.dataStyle',function(){
                    $(this).parent().parent().find(".dataStyle").removeClass("onchoose");
                    $(this).addClass("onchoose");
                    var month = getCanlender.getMonth() < 10 ? "0" + getCanlender.getMonth() : getCanlender.getMonth();
                    var year = getCanlender.getYear();
                    var sign = month + "-" + $(this).text();
                    var html = "";
                    
                    signDetail = signData[sign];
                    
                    if(signDetail.indexOf('<font class="Yc">') > -1 && signDetail.indexOf("缺") > -1) {
                        var reg = new RegExp('<font class="Yc">',"g");
                        signDetail = signDetail.replace(reg,"");
                        reg = new RegExp('</font>',"g");
                        signDetail = signDetail.replace(reg,"");
                        signDetail = signDetail.replace('</font><br>',"");
                        signDetail = signDetail.split('<br>');
                        signDetail.length = signDetail.length - 1;
                        signDetail = signDetail[0].split("-").concat(signDetail[1].split("-"));
                        html = template("sign-detail",signDetail);
                    }else if(signDetail.indexOf('<font class="Yc">') > -1) {
                        html = template("sign-error",signDetail);
                    }else {
                        if(signDetail) {
                            signDetail = signDetail.split('<br>');
                            signDetail.length = signDetail.length - 1;
                            if(signDetail.length >= 2) {
                                signDetail = signDetail[0].split("-").concat(signDetail[1].split("-"));
                            }else {
                                signDetail = signDetail[0].split("-");
                            }
                        }else {
                            signDetail = {};
                        }
                            
                        html = template("sign-detail",signDetail);
                    }
                    
                    $(".sign-detail").empty().append(html);
                    $(".sign-title p").text(year + "-" + sign);
                });
                
                $(".sign-bd").click(function() {
                    $(".layer ul").css("animation","fadeup 200ms");
                    $(".layer").show();
                    isPop = false;
                });
                
                $(".layer").click(function() {
                    isPop = true;
                    $(".layer ul").css("animation","fadedown 200ms");
                    document.querySelector(".layer ul").addEventListener("webkitAnimationEnd",function(){
                        if(isPop) {
                            $(".layer").hide();
                        }
                    });
                });
                
                $(".layer ul").click(function(e) {
                    e.stopPropagation();
                });
                
                $("#layer-qj").click(function() {
                    location.href = "http://tm.lilanz.com/oa/project/MobileApplyCheck/index.html?target=leavefor&apptoken=" + apptoken;
                });
                
                $("#layer-tx").click(function() {
                    location.href = "http://tm.lilanz.com/oa/project/MobileApplyCheck/index.html?target=takeoff&apptoken=" + apptoken;
                });
                
                $("#layer-bq").click(function() {
                    location.href = "http://tm.lilanz.com/oa/project/MobileApplyCheck/index.html?target=signcard&apptoken=" + apptoken;
                });
                
                $(".cancel").click(function() {
                    $(".layer").click();
                });
            }
            
            /* 获取考勤数据 */
            function getInfo(){
                var date = getDate();
                apptoken = GetQueryParams("apptoken");
                if(apptoken == ''){
                    onLoading("请在利郎APP中打开！");
                }else{
                    getDataAttendance(apptoken,date);
                }
            }
            
            /* 根据日期获取考勤数据 */
            function getDataAttendance(apptoken,date){
                onLoading();
                $(".sign").hide();
                $(".sign-bd").hide();
                setTimeout(function(){
                    $.ajax({
                        url: '../../api/appmycore.ashx',
                        data: {
                            action: 'MyAttendance',
                            apptoken: apptoken,
                            rq: date
                        },
                        dataType: 'JSON',
                        success: function(data){
                            var info;
                            if (data.code == '200') {
                                if (data.info == "") {
                                    onLoading('对不起，还未生成考勤数据！');
                                    setTimeout(function(){
                                        getCanlender.isSign();
                                        $(".information").hide();
                                    },1500);
                                } else {
                                    onLoading();
                                    $(".information").show();
                                    if (data.info.rylx == "zb") {
                                        setzbinfo(data);
                                    } else {
                                        setmyinfo(data);
                                    }
                                }
                            }else{
                                onLoading(data.msg);
                                setTimeout(function(){
                                    getCanlender.isSign();
                                    $(".information").hide();
                                },1000);
                            }
                        }
                    });
                },100);
            }
            
            /* 获取当前日期 */
            function getDate(){
                var date = new Date();
                var year = date.getFullYear();
                var month = date.getMonth() + 1;
                if(month < 10){
                    month = '0' + month;
                }
                $("#month").val(year + '-' + month);
                return year + '-' + month;
            }
            
            /* 显示总部考勤数据 */
            function setzbinfo(data){
                var info = data.info;
                
                if(info.main != undefined && info.main != null && info.main.length > 0){
                    $("#zqcqts").text((info.main[0].zqcqts || '0') + '天');
                    $("#zccqts").text((info.main[0].zccqts || '0') + '天');
                    $("#jbcqts").text((info.main[0].jbcqts || '0') + '天');
                    $("#kxqjts").text((info.main[0].kxqjts || '0') + '天');
                    $("#qjzts").text((info.main[0].qjzts || '0') + '天');
                    $("#cdzcs").text((info.main[0].cdmin + info.main[0].cdmax || '0') + '次');
                    $("#cdmin").text((info.main[0].cdmin || '0') + '次');
                    $("#cdmax").text((info.main[0].cdmax || '0') + '次');
                    $("#cd").text((info.main[0].cd || '0'));
                    $("#ztzcs").text((info.main[0].ztmin + info.main[0].ztmax || '0') + '次');
                    $("#ztmin").text((info.main[0].ztmin || '0') + '次');
                    $("#ztmax").text((info.main[0].ztmax || '0') + '次');
                    $("#zt").text((info.main[0].zt || '0'));
                    $("#syhjts").text((info.main[0].syhjts || '0') + '天');
                    $("#sysjts").text((info.main[0].sysjts || '0') + '天');
                    $("#wxhjts").text((info.main[0].wxhjts || '0') + '天');
                    $("#wxsjts").text((info.main[0].wxsjts || '0') + '天');
                    $("#wxbjts").text((info.main[0].wxbjts || '0') + '天');
                    $("#kg").text((info.main[0].kg || '0') + '次');

                    var html = '';
                    var length = info.detail.length || 0;
                    for(var i = 0; i <length;i++){
                        if(info.detail[i].qjlxmc == "出差"){
                            info.detail[i].qjlxmc = info.detail[i].qjlxmc.split('')[1];
                        }else{
                            info.detail[i].qjlxmc = info.detail[i].qjlxmc.split('')[0];
                        }
                        html = html + template('leave',info.detail[i]);
                    }
                    var detail = $(".detail-leave ul");
                    detail.empty();
                    detail.append(html);

                    var circle = [
                        {
                            el: 'c1',
                            angle: info.main[0].zqcqts
                        },
                        {
                            el: 'c2',
                            angle: info.main[0].zccqts
                        },
                        {
                            el: 'c3',
                            angle: info.main[0].jbcqts
                        },
                        {
                            el: 'c4',
                            angle: info.main[0].kxqjts
                        }
                    ];

                    var month = getDays(parseInt(info.main[0].ny.substring(4)));
                    setAngle(circle,month);
                }
                $("#myLoading").hide();
            }
            
            /* 显示贸易考勤数据 */
            function setmyinfo(data){
                var info = data.info;
                
                if(info.main != undefined && info.main != null && info.main.length > 0){
                    $("#zqcqts").text((info.main[0].zqcqts || '0') + '天');
                    $("#zccqts").text((info.main[0].zccqts || '0') + '天');
                    $("#jbcqts").text((info.main[0].jbcqts || '0') + '天');
                    $("#kxqjts").text((info.main[0].kxqjts || '0') + '天');

                    var circle = [
                        {
                            el: 'c1',
                            angle: info.main[0].zqcqts
                        },
                        {
                            el: 'c2',
                            angle: info.main[0].zccqts
                        },
                        {
                            el: 'c3',
                            angle: info.main[0].jbcqts
                        },
                        {
                            el: 'c4',
                            angle: info.main[0].kxqjts
                        }
                    ];

                    var month = getDays(parseInt(info.main[0].ny.substring(4)));
                    setAngle(circle,month);

                    var html = '<div class="info-title">请假明细</div><div class="detail-leave"><ul>';
                    var length = info.detail.length || 0;
                    for(var i = 0; i < length;i++){
                        if(info.detail[i].qjlxmc == "出差"){
                            info.detail[i].qjlxmc = info.detail[i].qjlxmc.split('')[1];
                        }else{
                            info.detail[i].qjlxmc = info.detail[i].qjlxmc.split('')[0];
                        }
                        info.detail[i].qjyy = '请假原因：' + info.detail[i].qjyy;
                        html = html + template('leave',info.detail[i]);
                    }

                    html = html + '</ul></div>';
                    $(".information").empty();
                    $(".information").append(html);
                }
                
                $("#myLoading").hide();
            }
            
            /* 获取URL GET参数 */
            var GetQueryParams = function (name) {
                var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
                var r = window.location.search.substr(1).match(reg);
                if (r != null)
                    return unescape(r[2])
                else
                    return "";
            }; 
            
            /* 获取月份天数 */
            function getDays(month){
                var month_day = [31,28,31,30,31,30,31,31,30,31,30,31];
                return month_day[month - 1];
            }
            
            /* 设置圆传动角度 */
            function setAngle(c,month){
                for(var i = 0; i < 4 ;i++){
                    var angle = (1 - c[i].angle / month) * 100;
                    $("." + c[i].el).css("transform","rotate(0deg)");
                    if(angle <= 50 ){
                        if(angle > 0 && angle <= 5){
                            setAnim(c[i].el,5,true);
                        }else if(angle > 5 && angle <= 10 ){
                            setAnim(c[i].el,15,true);
                        }else if(angle > 10 && angle <= 15 ){
                            setAnim(c[i].el,25,true);
                        }else if(angle > 15 && angle <= 25 ){
                            $("." + c[i].el).css("transform","rotate(45deg)");
                            setAnim(c[i].el,50,true);
                        }else if(angle > 25 && angle <= 35 ){
                            setAnim(c[i].el,75,true);
                        }else if(angle > 35 && angle <= 40 ){
                            setAnim(c[i].el,85,true);
                        }else if(angle > 40 && angle <= 45 ){
                            setAnim(c[i].el,95,true);
                        }else if(angle > 45 && angle <= 50 ){
                            setAnim(c[i].el,100,true);
                        }
                    }else if(angle < 100){
                        if(angle > 50 && angle <= 55){
                            setAnim(c[i].el,5,false);
                        }else if(angle > 55 && angle <= 60 ){
                            setAnim(c[i].el,15,false);
                        }else if(angle > 60 && angle <= 65 ){
                            setAnim(c[i].el,25,false);
                        }else if(angle > 65 && angle <= 75 ){
                            setAnim(c[i].el,50,false);
                        }else if(angle > 75 && angle <= 85 ){
                            setAnim(c[i].el,75,false);
                        }else if(angle > 85 && angle <= 90 ){
                            setAnim(c[i].el,85,false);
                        }else if(angle > 90 && angle < 100 ){
                            setAnim(c[i].el,95,false);
                        }
                    }else{
                        setAnim(c[i].el,100,false);
                    }
                }
            }
            
            /* 设置圆转动动画 */
            function setAnim(el,angle,ishalf){
                $("." + el + " .left").removeAttr("style");
                $("." + el + " .right").removeAttr("style");
                
                if(ishalf){
                    setTimeout(function(){
                        $("." + el + " .right").css("animation","load" + angle + " 3s forwards");
                        document.querySelector("." + el).querySelector(".right").addEventListener("webkitAnimationEnd",function(){
                            $("." + el + " .left").css("animation","load0 2s forwards");
                        });
                    },10);
                }else{
                    setTimeout(function(){
                        $("." + el + " .right").css("animation","load100 1.5s forwards");
                    },10);
                    document.querySelector("." + el).querySelector(".right").addEventListener("webkitAnimationEnd",function(){
                        $("." + el + " .left").css("animation","load" + angle + " 2s forwards");
                    });
                }
            }
            
            function getCanlendar(){
                var html = '';
                var day = 1;
                var firstDay = getCanlender.getfirstDay();
                var month = getCanlender.getMonth() < 10 ? "0" + getCanlender.getMonth(): getCanlender.getMonth();

                if(arguments.length == 2){
                    firstDay = getCanlender.getfirstDay(arguments[0],arguments[1]);
                }
                
                for(var i = 0; i < getCanlender.gettrLine();i++){
                    html = html + '<tr>';
                    
                    for(var j = 0; j < 7; j++){
                        if(i == 0 && j == 0){
                            j = firstDay;
                            html = html + new Array(firstDay + 1).join('<td></td>');
                        }
                        if(day <= getCanlender.getMonthDay()){
                            day = day < 10 ? "0" + day : day;
                            var sign = month + "-" + day;
                            
                            if(signData[sign] == "") {
                                if(getCanlender.isToday(day)){
                                    html = html + '<td class="dataStyle today onchoose">' + day + '</td>';
                                    day++;
                                    continue;
                                }
                                html = html + '<td class="dataStyle">' + day + '</td>' ;
                            }else if(signData[sign].lastIndexOf("缺") > 90 && signData[sign].indexOf('<font class="Yc">') > -1) {
                                html = html + '<td class="dataStyle">' + day + '</td>' ;
                            }else if(signData[sign].indexOf('<font class="Yc">') == -1) {
                                if(getCanlender.isToday(day)){
                                    html = html + '<td class="dataStyle sign-in onchoose">' + day + '</td>';
                                    day++;
                                    continue;
                                }
                                html = html + '<td class="dataStyle sign-in">' + day + '</td>' ;
                            }else {
                                if(getCanlender.isToday(day)){
                                    html = html + '<td class="dataStyle sign-error onchoose">' + day + '</td>';
                                    day++;
                                    continue;
                                }
                                html = html + '<td class="dataStyle sign-error">' + day + '</td>' ;
                            }
                            day++;
                        }
                    }
                    html = html + '</tr>';
                    html = html.replace("<tr></tr>","");
                }
                $(".Day").find("tbody").empty();
                $(".Day").find("tbody").append(html);
                $(".onchoose").click();
            }
            
            function setSignDate() {
                var day = $(".calendar table").find(".sign-in").length;
                $("#zqcqts").text("----");
                $("#zccqts").text(day + '天');
                $("#jbcqts").text("----");
                $("#kxqjts").text("----");
                setAnim("c1",0,true);
                setAnim("c2",0,true);
                setAnim("c3",0,true);
                setAnim("c4",0,true);
            }

            /* 显示加载状态 */
            function onLoading(msg){
                $(".load_text").text(msg || '加载中...');
                $("#myLoading").show();
            }
        </script>
	</body>
</html>