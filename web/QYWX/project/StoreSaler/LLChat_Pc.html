<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>利郎VIP综合维护系统 V1.1</title>
    <link rel="stylesheet" type="text/css" href="../../res/css/font-awesome.min.css" />
    <link rel="stylesheet" type="text/css" href="../../res/css/chat.css" />    
    <style type="text/css">
        .item img {
            max-height: 100px;
            max-width: 100px;
        }

        .tools {
            height: 30px;
            padding: 0 10px;
            line-height: 34px;
            font-size: 20px;
        }

            .tools > i {
                line-height: 30px;
                color: #999;
                cursor: pointer;
            }

        .chat-bot textarea {
            height: 65px;
            padding: 5px 8px;
        }
        /*loader css*/
        .mask, .review {
            color: #fff;
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            font-size: 1.1em;
            text-align: center;
            display: none;
            background-color: rgba(0,0,0,0.5);
        }

        .review {
            position:fixed;
            overflow-x:hidden;
            overflow-y:auto;
        }

        .loader {
            position: absolute;
            top: 50%;
            left: 50%;
            margin-top: -43px;
            margin-left: -61px;
            background-color: rgba(39, 43, 46, 0.9);
            padding: 15px 25px;
            border-radius: 5px;
        }

        #loadtext {
            margin-top: 5px;
            font-weight: bold;
        }

        a:link {
            text-decoration: none;
        }

        #userinfo{
            background-color: #333;
            padding:8px 14px;
            box-shadow: 0 0 2px #555;
            position: absolute;
            top:40px;
            left: 50%;
            transform:translate(-50%,0);
            border-radius:4px;
            z-index:100;

        }
        #userinfo p{
            color: #fff;
            line-height: 25px;
        }

        #userinfo:before {
            content: "";
            border-style: solid;
            border-width: 0 9px 9px 9px;
            border-color: transparent transparent #333 transparent;
            height: 0;
            position: absolute;
            left: 15px;
            top: -9px;
            width: 0;
            -webkit-transform: rotate(360deg);
        }

        .hide {
            display: none;
        }

        .show {
            display: block;
        }

        .review img {
            max-width: 600px;
            display: block;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%,-50%);
        }

        /*登陆界面样式*/
        .qrlogin {
            height: 100%;
            min-width: 860px;
            min-height: 700px;
            overflow: auto;
            position: relative;
        }

        .login-box {
            position: absolute;
            top: 50%;
            left: 50%;
            margin-left: -190px;
            margin-top: -270px;
            border-radius: 4px;
            -webkit-border-radius: 4px;
            background-color: #fff;
            width: 380px;
            height: 540px;
            box-shadow: #999 0 2px 10px;
            -webkit-box-shadow: #999 0 2px 10px;
        }
        .qrlogin .logo {
            position:absolute;
            top:40px;
            left:50px;
        }
        .qrlogin .logo img {
            width:34px;
            height:auto;
        }
        .qrlogin .copyright {
            position:absolute;            
            bottom:20px;
            right:40px;            
            color:#d3d3d3;
            font-size:12px;
            letter-spacing:1px;
        }
            .login-box .qrcode {
                text-align: center;
            }

                .login-box .qrcode .img {
                    display: block;
                    width: 276px;
                    height: 276px;
                    margin: 42px auto 5px;
                    padding: 15px;
                    border: 1px solid #ebebeb;
                }

                .login-box .qrcode .sub-title {
                    text-align: center;
                    font-size: 18px;
                    color: #353535;
                }

                .login-box .qrcode .extension {
                    margin-top: 40px;
                    padding-left:40px;
                }

                    .login-box .qrcode .extension .item {
                        margin-bottom: 30px;
                    }

                        .login-box .qrcode .extension .item .icon {
                            background-repeat: no-repeat;
                            background-position: 50% 50%;
                            background-size: cover;
                            width: 40px;
                            height: 40px;
                            float: left;
                            margin-right: 20px;
                        }

                    .login-box .qrcode .extension .content {
                        text-align:left;
                        float:left;
                    }
                        .login-box .qrcode .extension .item p {
                            line-height: 20px;
                            color: #353535;
                            font-size: 14px;
                            white-space: nowrap;
                        }

        .floatfix {
            content: '';
            display: table;
            clear: both;
        }

        .warning {
            background-color:#ccc !important;
            color:#fff !important;
            pointer-events:none;
        }

        .record-time {
            text-align: center;
            color: #bbb;
            border-radius: 2px;
            font-size: 13px;
            padding: 4px;
            max-width: 180px;
            margin: 0 auto;
            margin-bottom: -15px;
            margin-top: 10px;
            overflow: hidden;
        }

        .not-read {
            border-right:4px solid #d9534f;
        }
        /*新消息来时的闪烁动画*/
        @-webkit-keyframes twinkling { /*透明度由0到1*/
            0% {
                background-color: transparent;                
            }
                        
            100% {
                background-color: #f3b64b;
            }
        }

        .twinkle {
            -webkit-animation: twinkling 0.7s infinite;
        }
        .offline {
            position:absolute;
            top:50%;
            left:50%;            
            transform:translate(-50%,-50%);
            -webkit-transform:translate(-50%,-50%);
            z-index:2000;
            display:none;
        }
        .circle {
            width:120px;
            height:120px;
            background-color:#444;
            border-radius:50%;
            border:4px solid #eee;
            box-shadow:0 0 5px #fff;
            background-image:url(../../res/img/storesaler/officon.png);
            background-repeat:no-repeat;
            background-position:50% 50%;
            background-size:80px;
        }
        .off-txt {
            text-align: center;
            color: #fff;
            background: rgba(51,51,51,.9);
            padding: 5px 0;
            margin-top: 20px;
            border-radius: 5px;
            font-size: 14px;
            box-shadow: 0 0 2px #ccc;
            cursor: pointer;
            letter-spacing: 1px;
            border: 1px solid #ccc;
            line-height:20px;
        }
        .off-btn {
            position: absolute;
            right: 0;
            top: -26px;
            color: #fff;
            font-size: 14px;
            text-shadow: 1px 2px 1px #808080; 
            line-height:24px;   
            cursor:pointer;        
        }
        .glass {
            -webkit-filter: blur(4px);
            -moz-filter: blur(4px);
            -o-filter: blur(4px);            
            filter: blur(3px);
            transition:all 0.5s;
        }
        .chat-list li {
            cursor:pointer;
        }
        textarea {
            outline:none;
        }
    </style>
</head>
<body>
    <!--登陆界面-->
    <div class="qrlogin">
        <!--<div class="title">利郎VIP综合维护系统</div>
        <div class="login-tab">扫码登陆</div>
        <img id="LoginQrcode" src="/OA/webbll/LoginQrcode.ashx?id=4545445111" />-->
        <div class="logo"><img src="../../res/img/storesaler/chatllogo.png" /></div>
        <div class="login-box">
            <div class="qrcode">
                <img id="LoginQrcode" class="img" src="/OA/webbll/LoginQrcode.ashx?id=4545445111" />
                <p class="sub-title">扫描二维码登录系统</p>
                <div class="extension">
                    <div class="item floatfix">
                        <div class="icon" style="background-image: url(../../res/img/storesaler/phoneicon.jpg);"></div>
                        <div class="content">
                            <p>登录手机微信</p>
                            <p>手机上安装并登录微信</p>
                        </div>
                    </div>
                    <div class="item floatfix">
                        <div class="icon" style="background-image: url(../../res/img/storesaler/scanicon.jpg);"></div>
                        <div class="content">
                            <p>进入“扫一扫”</p>
                            <p>扫码登录利郎VIP综合维护系统</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="copyright">&copy;2016 利郎信息技术部提供技术支持</div>
    </div>

    <div class="chat-container center-translate hide">
        <div class="title">利郎VIP综合维护系统 V1.1</div>
        <div class="off-btn">状态切换：<span id="admin-status">在线</span></div>
        <div class="side-bar">
            <!--<div class="headimg backimage" style="background-image: url(../../res/img/storesaler/chatllogo.png)"></div>-->
        </div>
        <div class="user-list">
            <div class="search-input">
                <input type="text" placeholder="搜索" id="searchtxt" oninput="searchFunc()" />
                <i class="fa fa-search"></i>
            </div>
            <div class="chat-list">
                <ul id="chat-list">                    
<!--                    <li class="current not-read">
                        <div class="user-img backimage" style="background-image:url(vip1.jpg);"></div>
                        <div class="message">
                            <p class="username">李家的风</p>
                            <p class="talk">早上好</p>
                        </div>
                        <div class="time">11:30</div>
                        <div class="guider">李清峰</div>
                    </li> -->                   
                </ul>
            </div>
        </div>
        <div class="chat-area">
            <div class="chat-top">
                <p class="current-chat"><i class="fa fa-angle-down"></i></p>
                <div id="userinfo" class="hide">
                </div>
                <div class="chat-content">
                    <!--<p class="record-time">6月1日 15：30</p>-->
                </div>
            </div>
            <div class="chat-bot">
                <div class="tools">
                    <i class="fa fa-folder-o" id="imgSelect"></i>
                </div>
                <textarea placeholder="在这里说点什么吧..." id="sendContent"></textarea>
                <input type="button" value="发送(Ctrl + Enter)" id="btnSend" />
            </div>
        </div>        
    </div>    
    <div class="mask">
        <div class="loader">
            <div>
                <i class="fa fa-2x fa-spinner fa-pulse"></i>
            </div>
            <p id="loadtext">正在加载...</p>
        </div>
    </div>
    <div class="review">
    </div>
    <!--离线状态层-->
    <div class="offline">
        <div class="circle"></div>
        <p class="off-txt">离开 -> 在线</p>
    </div>
    <script src="../../res/js/jquery.js"></script>
    <script src="../../res/js/jquery.tmpl.min.js"></script>
    <script src="/chat/socket.io-1.3.7.js"></script>
    <script type="text/javascript" src="../../res/js/storesaler/ajaxupload.js"></script>
    <script type="text/javascript" src="../../res/js/storesaler/iNotify.min.js"></script>    
    <script type="text/javascript">
        var curr,TimeCount=0;//TimeCount聊天记录计数器每五条显示一次时间
        var socket = null;
        var iNotify = new iNotify().init();//通知对象
        window.onload = function () {
            //$(".qrlogin").addClass("hide");
            //$(".chat-container").removeClass("hide");
        }

        $(document).ready(function (e) {
            var button = $("#imgSelect");
            var filename = "";
            new AjaxUpload(button, {
                action: '/OA/webbll/ChatImageSend.aspx',
                name: 'myfile',
                onSubmit: function (file, ext) {
                    showLoader("loading", "图片传输中...");
                    this.setData({ "wxid": curr.id });
                    if (!(ext && /^(jpg|jpeg|JPG|JPEG|png|PNG|bmp|BMP|)$/.test(ext))) {
                        showLoader("error", "图片格式不正确！");
                        return false;
                    }
                },

                onComplete: function (file, response) {
                    //file 本地文件名称，response 服务器端传回的信息
                    var data = { Content: '<img src="{0}" />'.format(response), MsgType: 2, Order:1 };
                    $('#tmpchatdetail').tmpl(data).appendTo(".chat-content");

                    setTimeout(function () {
                        $(".mask").hide();
                    }, 1000);
                }
            });//end new AjaxUpload

            socket = io.connect('http://tm.lilanz.com/chat');

            socket.on('connect', function () {
                //console.log(socket.id);
                $("#LoginQrcode").attr("src", "/OA/webbll/LoginQrcode.ashx?id={0}".format(socket.id));
            });

            //接收到消息时
            socket.on('newmessage', function (data) {
                if (curr && (data.wxid == curr.id)) {
                    //修改列表中最后一次的聊天内容
                    $(".talk", "#" + data.wxid).text(data.message[0]);
                    $(".time", "#" + data.wxid).text(new Date().Format("hh:mm"));
                    var data = { Content: data.message, MsgType: 1, Order:1 };
                    if (TimeCount == 5) {
                        $(".chat-content").append("<p class='record-time'>" + new Date().Format("MM月dd日 hh:mm") + "</p>");
                        TimeCount = 0;
                    } else
                        TimeCount++;
                    $('#tmpchatdetail').tmpl(data).appendTo(".chat-content");                    
                    $(".chat-content").scrollTop($(".chat-content")[0].scrollHeight);
                }
                else {
                    var msg = {
                        Wxid: data.wxid,
                        Nick: data.nick,
                        MsgCount: 0,
                        LastActive: new Date().Format("hh:mm"),
                        HeaderUrl: data.header
                    };
                    
                    //置顶
                    $(document.getElementById(data.wxid)).remove();
                    $('#tmpchat').tmpl(msg).prependTo("#chat-list");
                    //修改列表中最后一次的聊天信息
                    $(".talk", "#" + data.wxid).text(data.message[0]);
                    $(".time", "#" + data.wxid).text(new Date().Format("hh:mm"));
                    $("#" + data.wxid).addClass("twinkle");
                }

                //发起桌面通知
                if (iNotify != undefined && iNotify != null)
                    iNotify.notify({
                        title: "利郎VIP综合维护系统",
                        body: "收到VIP客户消息,请注意查看！"
                    });
            });

            socket.on('login', function (data) {
                $(".qrlogin").addClass("hide");
                $(".chat-container").removeClass("hide");

                //加载聊天列表
                showLoader("loading", "正在加载用户列表");                
                var url = "/oa/webbll/chat.ashx?id=" + data.userid;
                $.getJSON(url, function (data) {                    
                    $('#tmpchat').tmpl(data).appendTo("#chat-list");
                    $(".mask").hide();
                });
            });

            //点击按钮发送消息
            $("#btnSend").click(function () {
                send();
            });

            //Ctrl+Enter发送消息
            document.onkeydown = function (e) {
                var theEvent = window.event || e;
                var code = theEvent.keyCode || theEvent.which;
                if (code == 13) {
                    send();
                }
            }
            //单击发送按钮事件
            function send() {
                var txt = $("#sendContent").val();
                if (txt != "") {
                    $("#sendContent").val(""); //清空发送栏。By:薛灵敏 20160330

                    //发送一个ACTION命令到后端还有DATA数据
                    var rel = socket.emit('sendMessage', { message: txt, touser: curr.id });
                    console.log(rel);
                    var data = { Content: txt, MsgType: 2, Order:1 };
                    if (TimeCount == 5) {
                        $(".chat-content").append("<p class='record-time'>" + new Date().Format("MM月dd日 hh:mm") + "</p>");
                        TimeCount = 0;
                    } else
                        TimeCount++;
                    $('#tmpchatdetail').tmpl(data).appendTo(".chat-content");
                    $(".chat-content .receive .chat-img").css("background-image", $(curr).find(".user-img").css("background-image"));
                    $(".chat-content .send .chat-img").css("background-image", "url(../../res/img/StoreSaler/lilanzlogo.jpg)");
                    $(".chat-content").scrollTop($(".chat-content")[0].scrollHeight);
                    $(".talk", curr).text(txt);
                }
            }

            $(".review").click(function (e) {
                $(this).hide();
            });
        });//end ready

        function reg() {
            var rel = socket.emit('reg', { userid: 249, type: 1 });
        }

        //单击聊天列表
        function Selected(obj) {
            if ($("#userinfo").hasClass("show"))
                $("#userinfo").removeClass("show").addClass("hide");

            if (curr)
                $(curr).removeClass("current");
            $(obj).addClass("current");
            $(obj).removeClass("twinkle");
            $(obj).removeClass("not-read");
            curr = obj;
            if ($(curr).find(".time").text() == "") {
                $("#btnSend").addClass("warning");
                showLoader("warn", "超过48小时无法发送客服消息");
                setTimeout(function () {
                    $(".mask").hide();
                }, 2000);
            } else
                $("#btnSend").removeClass("warning");
            $(".chat-content").html("");
            var url = "/oa/webbll/chatdetail.ashx?wxid=" + obj.id;
            $(".current-chat").html('<a href="javascript:GetUserInfo();">' + $(obj).find(".username").text() + "<i class=\"fa fa-angle-down\"></i></a>");
            LoadChat(url);
        }

        function LoadChat(url) {            
            $.getJSON(url, function (data) {
                //为对象增加序号用于后面显示聊天记录的时间
                for (var i = 0; i < data.length; i++) {
                    data[i].Order = i;
                }
                $('#tmpchatdetail').tmpl(data).appendTo(".chat-content");
                $(".chat-content .receive .chat-img").css("background-image", $(curr).find(".user-img").css("background-image"));
                $(".chat-content .send .chat-img").css("background-image", "url(../../res/img/StoreSaler/lilanzlogo.jpg)");
                $(".chat-content .item:last-child").before("<p class='record-time'>" + data[data.length-1].Cdate + "</p>");
                $(".chat-content").scrollTop($(".chat-content")[0].scrollHeight);
            });            
        }

        Date.prototype.Format = function (fmt) { //author: meizz 
            var o = {
                "M+": this.getMonth() + 1, //月份 
                "d+": this.getDate(), //日 
                "h+": this.getHours(), //小时 
                "m+": this.getMinutes(), //分 
                "s+": this.getSeconds(), //秒 
                "q+": Math.floor((this.getMonth() + 3) / 3), //季度 
                "S": this.getMilliseconds() //毫秒 
            };
            if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
            for (var k in o)
                if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
            return fmt;
        }

        function GetDate(jsonDate) {
            var value = new Date(jsonDate);
            var now = new Date();
            if ((now - value) / 3600 / 1000 > 48)
                return '';
            return value.Format('hh:mm');
        }

        function showLoader(type, txt) {
            $(".loader").show();
            switch (type) {
                case "loading":
                    $(".mask .fa").removeAttr("class").addClass("fa fa-2x fa-spinner fa-pulse");
                    $("#loadtext").text(txt);
                    $(".mask").show();
                    break;
                case "successed":
                    $(".mask .fa").removeAttr("class").addClass("fa fa-2x fa-check");
                    $("#loadtext").text(txt);
                    $(".mask").show();
                    setTimeout(function () {
                        $(".mask").fadeOut(500);
                    }, 1500);
                    break;
                case "error":
                    $(".mask .fa").removeAttr("class").addClass("fa fa-2x fa-close (alias)");
                    $("#loadtext").text(txt);
                    $(".mask").show();
                    setTimeout(function () {
                        $(".mask").fadeOut(500);
                    }, 1500);
                    break;
                case "warn":
                    $(".mask .fa").removeAttr("class").addClass("fa fa-2x fa-warning (alias)");
                    $("#loadtext").text(txt);
                    $(".mask").show();
                    setTimeout(function () {
                        $(".mask").fadeOut(500);
                    }, 1500);
                    break;
            }
        }

        String.prototype.format = function (args) {
            var result = this;
            for (var i = 0; i < arguments.length; i++) {
                var reg = new RegExp("({[" + i + "]})", "g");
                result = result.replace(reg, arguments[i]);
            }
            return result;
        }

        //加载用户信息
        function GetUserInfo() {
            if ($("#userinfo").hasClass("hide")) {                
                var url = "/OA/webbll/UserDetail.ashx?wxid={0}".format(curr.id);
                $.getJSON(url, function (data) {
                    $("#userinfo").html("<p>姓名：{0}</p><p>手机号码：{1}</p><p>注册日期：{2}</p>".format(data.Cname, data.Mobile, data.Cdate));
                    $("#userinfo").removeClass("hide").addClass("show");
                    $(".mask").hide();
                });
            }
            else
                $("#userinfo").removeClass("show").addClass("hide");
        }

        function ReviewImage(obj) {
            var content = "<img src='{0}'></img>".format(obj.src.replace('/small', ''));
            $(".review").html(content);
            $(".review").show();

        }

        //搜索功能
        $.expr[":"].Contains = function (a, i, m) {
            return (a.textContent || a.innerText || "").toUpperCase().indexOf(m[3].toUpperCase()) >= 0;
        };

        function searchFunc() {
            var obj = $("#chat-list .username");
            if (obj.length > 0) {
                var filter = $("#searchtxt").val();
                if (filter) {
                    $matches = $("#chat-list .message").find("p:Contains(" + filter + ")").parent().parent();
                    $("li", $("#chat-list")).not($matches).hide();
                    $matches.show();                                                            
                } else {
                    $("#chat-list").find("li").show();
                }
            }
        }

        $(".off-btn").click(function () {
            $(".loader").hide();
            $(".mask").css("background-color","rgba(0,0,0,0.1)");
            $(".mask").show();            
            $(".chat-container").addClass("glass");
            $("#admin-status").text("离开");
            $(".offline").show();          
        });

        $(".off-txt").click(function () {
            $("#admin-status").text("在线");            
            $(".mask").fadeOut(500);
            $(".offline").fadeOut(500);
            $(".chat-container").removeClass("glass");
        });
    </script>
    <script id="tmpchat" type="text/x-jquery-tmpl">
        <li class="" onclick="Selected(this)" id="${Wxid}" lasttime='${LastActive}'>
            <div class="user-img backimage" style="background-image: url(${HeaderUrl});"></div>
            <div class="message">
                <p class="username">${Nick}</p>
                <p class="talk">${MsgCount}</p>
            </div>
            <div class="time">${GetDate(LastActive)}</div>
        </li>
    </script>
    <script id="tmpchatdetail" type="text/x-jquery-tmpl">
        {{if Order != undefined && Order%5 == 0}} <p class='record-time'>${Cdate}</p> {{/if}}      
        <div class="item  {{if MsgType == 1}} receive {{else}} send {{/if}}">
            <div class="chat-img backimage"></div>
            <div class="chat-txt">
                {{html Content}}
            </div>
        </div>
    </script>
</body>
</html>
