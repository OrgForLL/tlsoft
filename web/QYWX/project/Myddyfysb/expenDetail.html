<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0,maximum-scale=1" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <title></title>
    <link rel="stylesheet" type="text/css" href="./css/LeePageSlider.css" />
    <link rel="stylesheet" type="text/css" href="./css/expenDetailStyle.css" />
    <title></title>
</head>

<body ontouchstart>
    <!--全局遮罩层-->
    <div class="global_mask"></div>
    <div class="dialog">
        <div class="dialog_hd"><strong>系统提示</strong></div>
        <div class="dialog_bd">弹窗内容区</div>
        <div class="dialog_ft">
            <a href="javascript:;" class="dialog_btn cancle" style="color:#353535;">取 消</a>
            <a href="javascript:;" class="dialog_btn confirm">确 认</a>
        </div>
    </div>
    <div class="loading">
        <img src="./my_loading.gif" />
        <p class="loading_txt">加载中..</p>
    </div>
    <div class="prompt">
        <i class="iconfont icon-successed"></i>
        <p class="prompt_txt">成功!</p>
    </div>
    <div class="wrap-page">
        <div class="page page-not-footer" id="detail">
            <div class="top">
                <div class="form_item">
                    <label><i class="iconfont icon-calendar"></i>年月</label>
                    <div class="bd">
                        <input type="month" name="yearmonth" value="">
                        <i class="iconfont icon-down"></i>
                    </div>
                </div>
                <div class="form_item">
                    <label><i class="iconfont icon-time" style="font-size:1.28em;"></i>时间</label>
                    <div class="bd">
                        <input type="date" name="yearmonth" value="">
                        <i class="iconfont icon-down"></i>
                    </div>
                </div>
                <div class="form_item">
                    <label><i class="iconfont icon-kh" style="font-size:1.3em;"></i>客户</label>
                    <div class="bd">
                        <select id="client_sel">
                        </select>
                        <i class="iconfont icon-down"></i>
                    </div>
                </div>
            </div>
            <div class="bot">
                <!-- <div class="row">
                    <div class="order">1</div>
                    <div class="row_del">移除</div>
                    <div class="row_item title">
                        <i class="iconfont icon-remark" style="vertical-align:middle"></i>
                        <span>摘 要</span>
                    </div>
                    <div class="remark">
                        <textarea placeholder="请输入文字.." rows="4" wrap="virtual"></textarea>
                    </div>
                    <div class="row_item flex">
                        <div class="left">
                            <span class="title">类 型</span>
                        </div>
                        <select>
                            <option>日常费用一</option>
                            <option>日常费用二</option>
                        </select>
                        <i class="iconfont icon-down" style="font-size:14px;"></i>
                    </div>
                    <div class="row_item flex">
                        <div class="left">
                            <span class="title">报销金额</span>
                        </div>
                        <input type="number" placeholder="请输入报销金额.." />
                    </div>
                    <div class="row_item flex">
                        <div class="left">
                            <span class="title">备 注</span>
                        </div>
                        <input type="number" placeholder="备注信息.." />
                    </div>
                    <div class="row_item title">
                        <i class="iconfont icon-attach" style="vertical-align:middle"></i>
                        <span>附 件(图片)</span>
                    </div>
                    <div class="attach_wrap">
                        <div class="attach_item" style="background-image:url(http://tm.lilanz.com/qywx/res/img/storesaler/cloth.jpg)">
                            <i class="iconfont icon-remove"></i>
                        </div>
                        <div class="attach_item" style="background-image:url(http://tm.lilanz.com/qywx/res/img/storesaler/cloth.jpg)">
                            <i class="iconfont icon-remove"></i>
                        </div>
                        <div class="attach_item" style="background-image:url(http://tm.lilanz.com/qywx/res/img/storesaler/cloth.jpg)">
                            <i class="iconfont icon-remove"></i>
                        </div>
                        <div class="attach_item" style="background-image:url(http://tm.lilanz.com/qywx/res/img/storesaler/cloth.jpg)">
                            <i class="iconfont icon-remove"></i>
                        </div>
                        <div class="attach_item" style="background-image:url(http://tm.lilanz.com/qywx/res/img/storesaler/cloth.jpg)">
                            <i class="iconfont icon-remove"></i>
                        </div>
                        <div class="attach_item add">
                            <i class="iconfont icon-plus"></i>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="order">2</div>
                    <div class="row_del">移除</div>
                    <div class="row_item title">
                        <i class="iconfont icon-remark" style="vertical-align:middle"></i>
                        <span>摘 要</span>
                    </div>
                    <div class="remark">
                        <textarea placeholder="请输入文字.." rows="4" wrap="virtual"></textarea>
                    </div>
                    <div class="row_item flex">
                        <div class="left">
                            <span class="title">类 型</span>
                        </div>
                        <select>
                            <option>日常费用一</option>
                            <option>日常费用二</option>
                        </select>
                        <i class="iconfont icon-down" style="font-size:14px;"></i>
                    </div>
                    <div class="row_item flex">
                        <div class="left">
                            <span class="title">报销金额</span>
                        </div>
                        <input type="number" placeholder="请输入报销金额.." />
                    </div>
                    <div class="row_item flex">
                        <div class="left">
                            <span class="title">备 注</span>
                        </div>
                        <input type="number" placeholder="备注信息.." />
                    </div>
                    <div class="row_item title">
                        <i class="iconfont icon-attach" style="vertical-align:middle"></i>
                        <span>附 件(图片)</span>
                    </div>
                    <div class="attach_wrap">
                        <div class="attach_item">
                            <i class="iconfont icon-remove"></i>
                        </div>
                        <div class="attach_item">
                            <i class="iconfont icon-remove"></i>
                        </div>
                        <div class="attach_item">
                            <i class="iconfont icon-remove"></i>
                        </div>
                        <div class="attach_item">
                            <i class="iconfont icon-remove"></i>
                        </div>
                        <div class="attach_item">
                            <i class="iconfont icon-remove"></i>
                        </div>
                        <div class="attach_item add">
                            <i class="iconfont icon-plus"></i>
                        </div>
                    </div>
                </div> -->
            </div>
        </div>
    </div>
    <div class="footer">
        <!-- <a href="javascript:;" class="btn btn_save">保 存</a> -->
        <a href="javascript:;" class="btn btn_oa">发起审批</a>
    </div>
    <!-- <a href="javascript:;" class="btn btn_addrow"><i class="iconfont icon-plus"></i></a> -->
    <!-- 客户列表模板 -->
    <script type="text/html" id="tpl_client">
        <option value="-1">请选择客户</option>
        {{each list}}
        <option value="{{$value.id}}">{{$value.mc}}</option>
        {{/each}}
    </script>
    <!-- 类型列表模板 -->
    <script type="text/html" id="tpl_type">
        <option value="-1">请选择类型</option>
        {{each list}}
        <option value="{{$value.id}}">{{$value.mc}}</option>
        {{/each}}
    </script>
    <!-- 新增记录单模板 -->
    <script type="text/html" id="tpl_detail_add">
        <div class="row" id="">
            <div class="order">{{order}}</div>
            <div class="row_del">移除</div>
            <div class="row_item title">
                <i class="iconfont icon-remark" style="vertical-align:middle"></i>
                <span>摘 要</span>
            </div>
            <div class="remark">
                <textarea class="remark-textarea" placeholder="请输入文字.." rows="4" wrap="virtual"></textarea>
            </div>
            <div class="row_item flex">
                <div class="left">
                    <span class="title">类 型</span>
                </div>
                <select class="type_sel" id="type_sel{{order}}">
                    {{loadType("", order)}}
                </select>
                <i class="iconfont icon-down" style="font-size:14px;"></i>
            </div>
            <div class="row_item flex">
                <div class="left">
                    <span class="title">报销金额</span>
                </div>
                <input class="bxje-input" type="number" placeholder="请输入报销金额.." />
            </div>
            <div class="row_item flex">
                <div class="left">
                    <span class="title">备 注</span>
                </div>
                <input class="bz-input" type="text" placeholder="备注信息.." />
            </div>
            <div class="row_item title">
                <i class="iconfont icon-attach" style="vertical-align:middle"></i>
                <span>附 件(图片)</span>
            </div>
            <div class="attach_wrap">
                <div class="attach_item fj" style="background-image:url(http://tm.lilanz.com/qywx/res/img/storesaler/cloth.jpg)">
                    <i class="iconfont icon-remove"></i>
                </div>
                <div class="attach_item add">
                    <i class="iconfont icon-plus"></i>
                </div>
            </div>
        </div>
    </script>
    <!-- 加载记录单模板 -->
    <script type="text/html" id="tpl_detail_view">
        {{each detail}}
        <div class="row" id="{{$value.mxid}}">
            <div class="order">{{$value.xh}}</div>
            <!-- <div class="row_del">移除</div> -->
            <div class="row_item title">
                <i class="iconfont icon-remark" style="vertical-align:middle"></i>
                <span>摘 要</span>
            </div>
            <div class="remark">
                <textarea class="remark-textarea" placeholder="请输入文字.." rows="4" wrap="virtual">{{$value.zy}}</textarea>
            </div>
            <div class="row_item flex">
                <div class="left">
                    <span class="title">类 型</span>
                </div>
                <select class="type_sel" id="type_sel{{$value.xh}}">
                    {{loadType($value.yslx, $value.xh)}}
                </select>
                <i class="iconfont icon-down" style="font-size:14px;"></i>
            </div>
            <div class="row_item flex">
                <div class="left">
                    <span class="title">报销金额</span>
                </div>
                <input class="bxje-input" type="number" placeholder="请输入报销金额.." value="{{$value.bxje}}" />
            </div>
            <div class="row_item flex">
                <div class="left">
                    <span class="title">备 注</span>
                </div>
                <input class="bz-input" type="text" placeholder="备注信息.." value="{{$value.bz}}" />
            </div>
            <div class="row_item title">
                <i class="iconfont icon-attach" style="vertical-align:middle"></i>
                <span>附 件(图片)</span>
            </div>
            <div class="attach_wrap" data-fjs="{{$value.fjs}}">
                {{loadImage($value.mxid)}}
            </div>
        </div>
        {{/each}}
    </script>
    <!-- 上传附件模板 -->
    <script type="text/html" id="tpl_image">
        {{each list}}
        <div id="{{$value.id}}" data-name="{{$value.mc}}" class="attach_item fj" style="background-image:url({{formatURL($value.path)}})">
            <i class="iconfont icon-remove"></i>
        </div>
        {{/each}}
        <div class="attach_item add">
            <i class="iconfont icon-plus"></i>
        </div>
    </script>
    <script type="text/javascript" src="./js/jquery.js"></script>
    <script type="text/javascript" src="./js/template.js"></script>
    <script type="text/javascript" src="./js/fastclick.min.js"></script>
    <script type="text/javascript" src="./js/lilanzAppWVJBridge-0.1.5.min.js"></script>
    <script type="text/javascript">
    $(function() {
        var baseApi = "MyddyfysbApi.aspx";
        var apptoken = getUrlParam("apptoken");
        template.helper('loadType', function(data1, data2) {
            return loadType(data1, data2);
        });
        template.helper('loadImage', function(data) {
            return loadImage(data);
        });
        template.helper('formatURL', function(url) {
            return formatURL(url);
        });

        function showLoading(text) {
            text = text || '加载中..';
            $(".loading_txt").text(text);
            $(".global_mask").show();
            $(".loading").css("display", "flex");
        };

        function hideLoading() {
            $(".global_mask").add(".loading").hide();
        }

        function showDialog(text, surefunc, cancelfunc) {
            $(".dialog .dialog_bd").text(text);
            $(".global_mask").add(".dialog").show();
            $(".cancle").unbind().bind("click", cancelfunc);
            $(".confirm").unbind().bind("click", surefunc);
        }

        function dialogSure(item) {
            $(".global_mask").add(".dialog").hide();
            item.remove();
        }

        function dialogSureFj(item, fjid, mxid) {
            $(".global_mask").add(".dialog").hide();
            setTimeout(function() {
                $.ajax({
                    type: "POST",
                    timeout: 5 * 1000,
                    contentType: "application/x-www-form-urlencoded; charset=utf-8",
                    data: {
                        method: "delImg",
                        apptoken: apptoken,
                        id: fjid,
                        mxid: mxid
                    },
                    url: baseApi
                }).done(function(msg) {
                    // alert(msg);
                    var data = JSON.parse(msg);
                    if (data.code == 200) {
                        item.remove();
                        showPrompt("successed", "删除成功！");
                    } else {
                        showPrompt("error", "删除失败！")
                    }
                }).fail(function(XMLHttpRequest, textStatus, errorThrown) {
                    console.log(XMLHttpRequest.status + "|" + XMLHttpRequest.statusText);
                });
            }, 50);
        }

        function dialogCancel() {
            $(".global_mask").add(".dialog").hide();
        }

        function showPrompt(type, txt) {
            $(".prompt").css("display", "flex");
            switch (type) {
                case "successed":
                    $(".prompt .iconfont").attr("class", ".iconfont .icon-successed");
                    $(".prompt_txt").text(txt);
                    break;
                case "error":
                    $(".prompt .iconfont").attr("class", ".iconfont .icon-error");
                    $(".prompt_txt").text(txt);
                    break;
                default:
                    break;
            }
            setTimeout(function() {
                $(".prompt").fadeOut(500);
            }, 1200);
        }


        //获取地址栏参数
        function getUrlParam(name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
            var r = window.location.search.substr(1).match(reg);
            if (r != null) return unescape(r[2]);
            return null;
        }

        // 格式化图片路径
        function formatURL(url) {
            // 测试地址http://192.168.35.231
            var server = "http://webt.lilang.com:9001";
            url = server + "/" + url.replace(/\.\.\//g, "");
            return url;
        }

        // 加载客户
        function loadClient() {
            $.ajax({
                type: "POST",
                timeout: 5 * 1000,
                contentType: "application/x-www-form-urlencoded; charset=utf-8",
                data: {
                    method: "getKhList",
                    apptoken: apptoken
                },
                url: baseApi
            }).done(function(msg) {
                var data = JSON.parse(msg);
                if (data.code == 200) {
                    $("#client_sel").html(template("tpl_client", data));

                } else {
                    showLoading(data.msg);
                }

            }).fail(function(XMLHttpRequest, textStatus, errorThrown) {
                console.log(XMLHttpRequest.status + "|" + XMLHttpRequest.statusText);
            });
        }

        //加载记录单数据
        function loadDetailsData() {
            var id = getUrlParam("id");
            if (id != 0) {
                showLoading("正在加载数据..");
                setTimeout(function() {
                    $.ajax({
                        type: "POST",
                        timeout: 5 * 1000,
                        contentType: "application/x-www-form-urlencoded; charset=utf-8",
                        data: {
                            method: "getYfysbInfo",
                            id: id,
                            apptoken: apptoken
                        },
                        url: baseApi
                    }).done(function(msg) {
                        // console.log(msg);
                        var data = JSON.parse(msg);
                        if (data.code == 200) {
                            var head_info = data.info.main[0];
                            $("input[type='month']").val(head_info.ny.replace(/^(\d{4})(\d{2})$/, "$1-$2"));
                            $("input[type='date']").val(head_info.rq);
                            $("#client_sel").val(head_info.khid);
                            $(".bot").html(template("tpl_detail_view", data.info));
                            hideLoading();
                        } else {
                            showLoading(data.msg);
                        }
                    }).fail(function(XMLHttpRequest, textStatus, errorThrown) {
                        console.log(XMLHttpRequest.status + "|" + XMLHttpRequest.statusText);
                    });
                }, 50);
            } else {
                $(".bot").html(template("tpl_detail_add", {
                    order: 1
                }));
            }
        }

        // 加载附件图片
        function loadImage(mxid) {

            $.ajax({
                type: "POST",
                timeout: 5 * 1000,
                contentType: "application/x-www-form-urlencoded; charset=utf-8",
                data: {
                    method: "getImgList",
                    apptoken: apptoken,
                    mxid: mxid
                },
                url: baseApi
            }).done(function(msg) {
                var data = JSON.parse(msg);
                if (data.code == 200) {
                    $(".row[id='" + mxid + "']").find(".attach_wrap").html(template("tpl_image", data));

                } else {
                    showPrompt("error", "加载图片失败");
                }

            }).fail(function(XMLHttpRequest, textStatus, errorThrown) {
                console.log(XMLHttpRequest.status + "|" + XMLHttpRequest.statusText);

            });

        }

        // 加载类型
        function loadType(yslx, idnum) {

            $.ajax({
                type: "POST",
                timeout: 5 * 1000,
                contentType: "application/x-www-form-urlencoded; charset=utf-8",
                data: {
                    method: "getYslxList",
                    apptoken: apptoken
                },
                url: baseApi
            }).done(function(msg) {
                var data = JSON.parse(msg);
                if (data.code == 200) {
                    $("#type_sel" + idnum).html(template("tpl_type", data));
                    if (yslx != "") {
                        $("#type_sel" + idnum).val(yslx);
                    }

                } else {
                    showLoading(data.msg);
                }


            }).fail(function(XMLHttpRequest, textStatus, errorThrown) {
                console.log(XMLHttpRequest.status + "|" + XMLHttpRequest.statusText);

            });

        }

        // 发起审批
        function sendOA() {
            var id = getUrlParam("id");
            showLoading("正在发起审批..");
            setTimeout(function() {
                $.ajax({
                    type: "POST",
                    timeout: 5 * 1000,
                    contentType: "application/x-www-form-urlencoded; charset=utf-8",
                    data: {
                        method: "flowStart",
                        id: id,
                        apptoken: apptoken
                    },
                    url: baseApi
                }).done(function(msg) {
                    // console.log(msg);
                    var data = JSON.parse(msg);
                    if (data.code == 200) {
                        var maininfo = data.info.main
                        var tzid = maininfo.tzid;
                        var docid = maininfo.docid;
                        var dxid = maininfo.dxid;
                        var flowid = maininfo.flowid;
                        var gourl = "docDetailData.aspx?tzid=" + tzid + "&docid=" + docid + "&dxid=" + dxid + "&flowid=" + flowid;
                        //测试地址 http://192.168.35.231/mobileOA/WXAppOuthRedirect.aspx?
                        window.location.replace("../WXAppOuthRedirect.aspx?gourl=" + encodeURIComponent(gourl) + "&systemid=1&apptoken=" + apptoken);

                    } else {
                        showLoading(data.msg);
                    }
                }).fail(function(XMLHttpRequest, textStatus, errorThrown) {
                    console.log(XMLHttpRequest.status + "|" + XMLHttpRequest.statusText);
                });
            }, 50);


        }

        // 打包要提交的数据
        function savaData() {
            var postdata = {},
                mainArray = [],
                detailArray = [];
            // 表头数据
            var id = parseInt(getUrlParam("id"));
            var rq = $("input[type='date']").val();
            var ny = $("input[type='month']").val();
            var khid = parseInt($("#client_sel option:selected").val());
            mainArray.push({
                id: id,
                rq: rq,
                ny: ny,
                khid: khid
            });

            // 分录明细数据
            for (var i = 0; i < $(".row").length; i++) {
                var obj = $(".row").eq(i);
                var mxid, zy, yslx, bxje, fjs, bz;
                if (obj.attr("id") != "") {
                    mxid = parseInt(obj.attr("id"));
                } else {
                    mxid = 0;
                }
                zy = $(".remark-textarea", obj).val();
                yslx = parseInt($(".type_sel option:selected", obj).val());
                bxje = parseFloat($(".bxje-input", obj).val());
                fjs = parseInt($(".fj", obj).length);
                bz = $(".bz-input", obj).val();
                detailArray.push({
                    mxid: mxid,
                    zy: zy,
                    yslx: yslx,
                    bxje: bxje,
                    fjs: fjs,
                    bz: bz
                });
            }

            postdata.main = mainArray;
            postdata.detail = detailArray;
            console.log(JSON.stringify(postdata));

        }

        function init() {
            llApp.init().then(function(msg) {
                llApp.setStatusBar("#209ba3", "white");
            });
            FastClick.attach(document.body);

            loadClient();
            loadDetailsData();

        }


        function bindEvent() {
            // 移除分录项按钮
            $(".bot").on("click", ".row_del", function() {
                var cur_row = $(this).parent(".row");
                showDialog("确定要移除该记录吗？", function() {
                    dialogSure(cur_row);
                }, dialogCancel);
            });

            // 新增按钮
            $(".btn_addrow").click(function() {
                var last_order = $(".row:last").find(".order").text();
                var cur_order, data = {};

                if (last_order != "") {
                    cur_order = parseInt(last_order) + 1;
                } else {
                    cur_order = 1;
                }
                data = {
                    order: cur_order
                };

                $(".bot").append(template("tpl_detail_add", data));

                $(".bot").animate({
                    scrollTop: last_order * 526
                }, 500);
            });

            // 保存按钮
            $(".btn_save").click(function() {
                savaData();
            });

            // 移除附件
            $(".bot").on("click", ".icon-remove", function() {
                var cur_fj = $(this).parent(".attach_item");
                var mxid = $(this).parent(".attach_item").parent(".attach_wrap").parent(".row").attr("id");
                var fjid = $(this).parent(".attach_item").attr("id");
                showDialog("确定要移除该附件吗？", function() {
                    dialogSureFj(cur_fj, fjid, mxid);

                }, dialogCancel);
            });

            // 上传附件图片
            $(".bot").on("click", ".add", function() {
                var mxid = $(this).parent(".attach_wrap").parent(".row").attr("id");
                var path = baseApi + "?method=saveImg&mxid=" + mxid + "&apptoken=" + apptoken;

                llApp.imageUpload(path, function(picScr) {

                    var data = JSON.parse(picScr);
                    if (data.code == 200) {
                        showPrompt("successed", data.msg);
                        loadImage(mxid);
                    } else {
                        showPrompt("error", data.msg);
                    }
                });

            });

            // 发起审批
            $(".btn_oa").click(sendOA);
        }

        init();
        bindEvent();
    });
    </script>
</body>

</html>
