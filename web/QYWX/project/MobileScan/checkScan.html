<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0,maximum-scale=1" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <title>移动盘点</title>
    <link type="text/css" rel="stylesheet" href="./layerui/css/layui.css" />
    <link type="text/css" rel="stylesheet" href="../../res/css/LeePageSlider.css" />
    <style type="text/css">
        .mask {
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.4);
            z-index: 2000;
            display: none;
        }

        .loading_mask {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,.5);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .loading_text {
            color: #fff;
            font-weight: bold;
        }

        .page {
            -webkit-tap-highlight-color: transparent;
        }

        @font-face {
            font-family: "iconfont";
            src: url('../res/fonts/J-brushcode.ttf') format('truetype');
        }

        .iconfont {
            font-family: "iconfont" !important;
            font-size: 16px;
            font-style: normal;
            -webkit-font-smoothing: antialiased;
            -webkit-text-stroke-width: 0.2px;
            -moz-osx-font-smoothing: grayscale;
        }

        /*扫码页面*/
        #scanCode_page {
            padding: 0;
            bottom: 40px;
            background-color: #f3f3f3;
            display: -webkit-flex;
            display: flex;
            flex-direction: column;
        }

        .footer {
            height: 40px;
            display: -webkit-flex;
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: center;
            color: #fff;
        }

            .footer > div {
                width: 50%;
                height: 40px;
                line-height: 40px;
                font-size: 15px;
            }

        .btn_scanBack {
            background-color: #6f6d6d;
        }

        .btn_scanBack1 {
            background-color: #6f6d6d;
        }

        .btn_scanCode {
            background-color: #000;
        }

        .btn_scanCode1 {
            background-color: #000;
        }

        .btn_submit {
            background-color: #0b9444;
        }

        .last_info {
            background-color: #fff;
            padding: 10px 15px;
            width: 100%;
            border-bottom: 1px solid #f3f3f3;
            -webkit-box-shadow: 0 2px 2px rgba(221, 221, 221, 0.6);
            box-shadow: 0 2px 2px rgba(221, 221, 221, 0.6);
            font-weight: 600;
            display: -webkit-flex;
            display: flex;
            justify-content: space-between;
        }

        .icon-r-arrow:before {
            content: "\e605";
            color: #888;
            font-size: 15px;
        }

        .scanCode_wrap {
            padding: 10px 15px;
            color: #666;
            overflow-y: auto;
            flex: 1;
            -webkit-overflow-scroll: touch;
        }

            .scanCode_wrap .total_num {
                background-color: #0b9444;
                color: #fff;
                font-style: normal;
                padding: 2px 6px;
                margin-left: 10px;
                border-radius: 3px;
                font-weight: 600;
                line-height: 1;
            }

        .scanCode_wrap1 {
            padding: 10px 15px;
            color: #666;
            z-index:888;
            -webkit-overflow-scroll: touch;
        }

            .scanCode_wrap1 .total_num {
                background-color: #0b9444;
                color: #fff;
                font-style: normal;
                padding: 2px 6px;
                margin-left: 10px;
                border-radius: 3px;
                font-weight: 600;
                line-height: 1;
            }

        .ycode-list {
            background-color: #fff;
            border: 1px dashed #ddd;
            font-style: normal;
            color: #333;
            margin-top: 10px;
        }

            .ycode-list .code_item {
                padding: 8px 6px;
                display: -webkit-flex;
                display: flex;
                align-items: center;
                justify-content: space-between;
                border-bottom: 1px solid #eee;
            }

        .code_item:first-child {
            background-color: #e6f3e0;
        }

        .code_item:last-child {
            border-bottom: none;
        }

        .code_item .btn_remove {
            background-color: #f24205;
            color: #fff;
            padding: 4px 15px;
            border-radius: 3px;
        }
        /*底部弹出层*/
        #bot_panel {
            height: 60%;
            bottom: 0;
            top: 40%;
            z-index: 3000;
            padding: 0;
        }

        .panel_title {
            padding: 0 15px;
            font-weight: 600;
            border-bottom: 1px solid #f3f3f3;
            -webkit-box-shadow: 0 2px 2px rgba(221, 221, 221, 0.6);
            box-shadow: 0 2px 2px rgba(221, 221, 221, 0.6);
            height: 40px;
            line-height: 40px;
        }

        .panel_con {
            padding: 10px 15px;
            position: absolute;
            top: 40px;
            bottom: 40px;
            left: 0;
            right: 0;
            overflow-y: auto;
            -webkit-overflow-scroll: touch;
        }

        .form_item {
            display: -webkit-flex;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

            .form_item span {
                min-width: 22%;
            }

            .form_item input,
            .form_item select {
                flex: 1;
                border: 0;
                border-radius: 0;
                background-color: rgba(0, 0, 0, 0.1);
                height: 30px;
                outline: 0;
                -webkit-appearance: none;
                font-size: 14px;
                color: #555;
                padding-left: 5px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                width: 100%;
            }

        .panel_footer {
            display: -webkit-flex;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 40px;
        }

            .panel_footer > div {
                width: 50%;
                text-align: center;
                height: 40px;
                line-height: 40px;
                color: #fff;
            }

        .btn_cancel {
            background-color: #000;
        }

        .btn_sure {
            background-color: #0b9444;
        }
    </style>
    <style>
        .layui-layer-dialog {
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%,-50%);
        }

        .layui-layer-hui .layui-layer-content {
            padding: 12px !important;
        }

        #layui-layer1 {
            top: 50% !important;
            left: 50% !important;
            width: auto !important;
        }
    </style>
</head>

<body>
    <div class="loading_mask">
        <span class="loading_text">正在保存，请耐心等待..</span>
    </div>
    <div class="mask"></div>
    <div class="wrap-page">
        <div class="page page-not-footer" id="scanCode_page">
            <!-- 前一单信息 -->
            <!--<div class="last_info">
                <span>上一单: Q12536679</span>
                <div>
                    <span>12</span>
                    <i class="iconfont icon-r-arrow"></i>
                </div>
            </div>-->
            <!-- 本次刷码 -->
            <div class="scanCode_wrap1">
                <p style="position: fixed; left: auto; right: auto; bottom: auto;">单据<span class="total_num" id="last_num">0</span> 
                    已刷<span class="total_num" id="total_num">0</span><b style="">用户<span class="total_num" id="username"></span></b>
                    <span class="total_num" id="dqkhid">客户切换</span></p>
            </div>
            <div class="scanCode_wrap">

                <!--唯一码列表-->
                <ul class="ycode-list"></ul>
            </div>
        </div>
        <!-- 底部弹出层 -->
        <div class="page page-bot" id="bot_panel">
            <p class="panel_title">移动盘点</p>
            <div class="panel_con">
                <div class="form_item">
                    <span>日期</span>
                    <input type="date" id="mydate">
                </div>
                <div class="form_item">
                    <span>客户</span>
                    <select id="khid"></select>
                </div>
                <div class="form_item">
                    <span>仓库</span>
                    <select id="ckid"></select>
                </div>
                <div class="form_item">
                    <span>备注</span>
                    <input id="bz" />
                </div>
            </div>
            <div class="panel_footer">
                <div class="btn_cancel">取 消</div>
                <div class="btn_sure" onclick="mysave()">提 交</div>
            </div>
        </div>
    </div>
    <div class="footer">
        <div class="btn_scanBack" onclick="BackQRCodeNoHide()">刷 退</div>
        <div class="btn_scanBack1" style="display: none;" onclick="closeShowQRCodeNoHide()">取消刷退</div>
        <div class="btn_scanCode" style="" onclick="ShowQRCodeNoHide()">扫 码</div>
        <div class="btn_scanCode1" style="display: none;" onclick="closeShowQRCodeNoHide()">取消扫码</div>
        <div class="btn_submit">提 交</div>
    </div>
    <script type="text/javascript" src="http://tm.lilanz.com/oa/api/lilanzAppWVJBridge-0.1.6.min.js?ver=0.1"></script>
    <script type="text/javascript" src="../../res/js/jquery.js"></script>
    <script type="text/javascript" src="./layerui/layui.js"></script>
    <script type="text/javascript" src="../../res/js/fastclick.min.js"></script>
    <script type="text/javascript" src="jmtool.js"></script>
    <script type="text/javascript">
        //补单：之前的记录不显示出来但是仍然能判断有没有重复
        //查看：列出存入数据库的唯一码
        //汇总：汇总查看
        var app_tzid = localStorage.getItem("app_tzid");
        if (app_tzid === null || app_tzid === undefined)
            app_tzid = "";
        var xh = 1;
        var layer = null;
        var dept = "", name = "", tzid = "", userid = "";
        var $list = $(".ycode-list");
        var oldScanData = {};//已存入数据库的记录
        var newScanData = {};//缓存扫描记录
        //var apptoken = UrlSearch();
        var apptoken = getQueryString("apptoken");
        var djid = getQueryString("id");
        djid = djid == "" ? 0 : djid;
        var mode = getQueryString("mode");//bd补单、ck查看
        //object.onbeforeunload = function () { alert(1) };
        //alert(window.onbeforeunload());
        //获取用户身份
        function getUser() {
            var para = {
                action: "getUserinfo",
                token: apptoken,
                dept: "",
                Parameter: [app_tzid],
                orgid :0
            };
            return new Promise(function (resolve, reject) {
                showLoading("正在登陆..");
                $.ajax({
                    url: "./checkScan.ashx",
                    type: "POST",
                    dataType: "text",
                    contentType: "application/x-www-form-urlencoded; charset=UTF-8",
                    timeout: 60000,
                    data: JSON.stringify(para),
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        reject("request error:" + textStatus);
                    },
                    success: function (data) {
                        console.log(data);
                        var dt = JSON.parse(data);
                        if (dt.code == 200) {
                            dept = dt.data.dept;
                            name = dt.data.cname;
                            tzid = dt.data.tzid;
                            userid = dt.data.userid;

                            $("#username").text(name);
                            resolve();
                        } else {
                            reject("登陆失败：" + dt.message);
                        }
                    }
                });//end ajax
            })
        }
        //今日日期
        function mydate() {
            var ddd = new Date();
            var day = ddd.getDate();
            if (ddd.getMonth() + 1 < 10) {
                var month = "0" + (ddd.getMonth() + 1);
            } else {
                var month = ddd.getMonth() + 1;
            }

            if (ddd.getDate() < 10) {
                day = "0" + ddd.getDate();
            }

            var datew = ddd.getFullYear() + "-" + month + "-" + day;
            console.log(datew);
            $("#mydate").val(datew);
        }

        //获取仓库列表
        function getDepot() {
            showLoading("获取仓库列表");
            return new Promise(function (resolve, reject) {
                var para = {};
                para.action = "getDepot";
                para.token = apptoken;
                para.dept = dept;
                para.Parameter = [tzid, userid];
                para.orgid = tzid;
                $.ajax({
                    url: "./checkScan.ashx",
                    type: "POST",
                    dataType: "text",
                    contentType: "application/x-www-form-urlencoded; charset=UTF-8",
                    timeout: 60000,
                    data: JSON.stringify(para),
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        reject("获取仓库列表失败！");
                    },
                    success: function (data) {
                        var dt = JSON.parse(data);
                        //alert(data);
                        console.log(dt);
                        if (dt.code == 200) {
                            for (var m = 0; m < dt.data.length; m++) {
                                $("#ckid").append("<option value='" + dt.data[m].id + "'>" + dt.data[m].mc + "</option>");
                            }
                        } else {
                            //alert("仓库信息获取失败！");
                            //layer.msg("仓库信息获取失败！", { time: 20 * 1000 });
                            //reject("获取仓库列表失败！！");
                        }
                        resolve();
                    }//end success
                });
            })
        }

        //获取客户列表
        function getCompanyname() {
            showLoading("获取客户列表");
            return new Promise(function (resolve, reject) {
                var para = {};
                para.action = "getCompanyname";
                para.token = apptoken;
                para.dept = dept;
                para.Parameter = [tzid, userid];
                para.orgid = tzid;
                $.ajax({
                    url: "./checkScan.ashx",
                    type: "POST",
                    dataType: "text",
                    contentType: "application/x-www-form-urlencoded; charset=UTF-8",
                    timeout: 60000,
                    data: JSON.stringify(para),
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        reject("客户信息获取失败！");
                    },
                    success: function (data) {
                        var dt = JSON.parse(data);
                        console.log(dt);
                        if (dt.code == 200) {
                            for (var m = 0; m < dt.data.length; m++) {
                                $("#khid").append("<option value='" + dt.data[m].khid + "'>" + dt.data[m].khmc + "</option>");
                            }
                        } else {
                            //alert("客户信息获取失败！");
                            //layer.msg("客户信息获取失败！", { time: 20 * 1000 });
                            //reject("客户信息获取失败！！");
                        }
                        resolve();
                    }//end success
                });
            })
        }

        function bindEvents() {
            // 取消按钮
            $(".btn_cancel").click(hideBotPanel);

            // 点击背景蒙版
            $(".mask").click(hideBotPanel);

            // 移除按钮
            $(".ycode-list").on("click", ".btn_remove", function () {
                var code = $(this).parent().find(".code").text();
                if (oldScanData[code]) {
                    layer.msg("已保存的数据不允许修改！", { time: 2000 });
                } else if (newScanData[code]) {
                    $(this).parent("li").remove();
                    $("#total_num").text(Number($("#total_num").text()) - 1);
                    delete (newScanData[code]);
                    localStorage.setItem("_llCheckScanCache_", JSON.stringify(Object.keys(newScanData)));
                }
            });

            // 查看上一单
            //$(".last_info").click(function () {
                //window.location.href = "lastCodeInfo.html"
            //});

            // 扫码、刷退提交按钮
            $(".btn_submit").click(function () {
                closeShowQRCodeNoHide();
                if ($("li", $list).length == 0)
                    layer.msg("无数据，无需提交！", { time: 2000 });
                else {
                    if (djid > 0) {
                        mysave();
                    } else if (djid == 0) {
                        $(".mask").show();
                        $("#bot_panel").removeClass("page-bot");
                    }

                }
            });
        }

        // 隐藏底部面板
        function hideBotPanel() {
            $("#bot_panel").addClass("page-bot");
            $(".mask").hide();
        }

        //获取URL参数
        function UrlSearch() {
            var name, value;
            var str = location.href; //取得整个地址栏
            var num = str.indexOf("?")
            str = str.substr(num + 1); //取得所有参数   stringvar.substr(start [, length ]

            var arr = str.split("&"); //各个参数放到数组里
            return arr[0].split('=')[1];
        }

        //扫码
        function ShowQRCodeNoHide() {
            //var checkScan = { result: "http://tm.lilanz.com/tm.aspx?id=KC7778C4G8W7V3ZYG", scanType: "QRCODE" };
            //scanResultHandle(checkScan);
            //return;
            $(".btn_scanCode").css("display", "none");
            $(".btn_scanCode1").css("display", "block");
            $(".btn_scanBack").css("display", "none");
            $(".btn_scanBack1").css("display", "none");

            llApp.CloseQRCodeNoHide();
            llApp.ShowQRCodeNoHide({
                scanType: ["QRCODE", "BARCODE"],
                time: 100,
                sound: false,
                success: scanResultHandle
            });
        }

        //刷退
        function BackQRCodeNoHide() {
            //var checkScan = { result: "http://tm.lilanz.com/tm.aspx?id=KC7778C4G8W7V3ZYG", scanType: "QRCODE" };
            //backScanResultHandle(checkScan);
            //return;
            $(".btn_scanCode").css("display", "none");
            $(".btn_scanCode1").css("display", "none");
            $(".btn_scanBack").css("display", "none");
            $(".btn_scanBack1").css("display", "block");

            //先尝试关闭
            llApp.CloseQRCodeNoHide();
            llApp.ShowQRCodeNoHide({
                scanType: ["QRCODE", "BARCODE"],
                time: 100,
                sound: false,
                success: backScanResultHandle
            });
        }

        //取消扫码、刷退
        function closeShowQRCodeNoHide() {
            $(".btn_scanCode").css("display", "block");
            $(".btn_scanCode1").css("display", "none");
            $(".btn_scanBack").css("display", "block");
            $(".btn_scanBack1").css("display", "none");

            if (llApp && llApp.isInApp)
                llApp.CloseQRCodeNoHide();
        }

        //保存前的检查
        function checkBeforeSave() {
            var rq = $("#mydate").val();
            var khid = $("#khid").val();
            var ckid = $("#ckid").val();
            var bz = $("#bz").val();
            if (rq == '') {
                layer.msg("日期不能为空！", { time: 1500 });
                return false;
            }
            if (khid == '') {
                layer.msg("客户不能为空！", { time: 1500 });
                return false;
            }
            if (ckid == '') {
                layer.msg("仓库不能为空！", { time: 1500 });
                return false;
            } else if (Object.keys(newScanData).length <= 0) {
                layer.msg("无数据变化！", { time: 1500 });
                return false;
            } else
                return true;
        }
        var tjpd = 0;//防止在提交保存时重复点击提交
        //提交保存
        function mysave() {
            if (tjpd != 0) {
                return;
            }
            tjpd = 1;
            $(".btn_sure").css("background-color", "#6f6d6d");
            if (!checkBeforeSave())
                return;
            var rq = $("#mydate").val();
            var khid = $("#khid").val();
            var ckid = $("#ckid").val();
            var bz = $("#bz").val();
            var par = [djid, rq, khid, ckid, bz, name];

            var _nsd = Object.keys(newScanData);
            _nsd.forEach(function (item) {
                par.push([item, "1"]);
                //par.push({ tm: '', sl: 1 });
            });

            var para = {};
            para.action = "saveInfo";
            para.token = apptoken;
            para.dept = dept;
            para.Parameter = par;
            para.orgid = tzid;
            //alert(par); return;
            //layer.msg(JSON.stringify(para))
            //return;
            function Save() {
                $(".loading_mask .loading_text").text("正在保存，请耐心等待..");
                $(".loading_mask").css("display", "flex");
                $.ajax({
                    url: "./checkScan.ashx",
                    type: "POST",
                    dataType: "text",
                    contentType: "application/x-www-form-urlencoded; charset=UTF-8",
                    timeout: 60 * 1000,
                    data: JSON.stringify(para),
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        alert("保存失败！！" + textStatus);
                        $(".loading_mask").hide();
                    },
                    success: function (data) {
                        console.log(data);
                        $(".loading_mask").hide();
                        //alert(data);
                        var dt = JSON.parse(data);
                        if (dt.code == 200) {
                            //$(".ycode-list").empty();
                            //$(".total_num").text(0);
                            //$("#bot_panel").addClass("page-bot");
                            //$(".mask").hide();
                            layer.alert(dt.message, { icon: 2, title: '提示' }, function (index) {
                                localStorage.removeItem("_llCheckScanCache_");
                                layer.close(index);
                                window.location.href = "";
                            });
                        } else {
                            alert("保存失败！" + dt.message);
                        }
                        tjpd = 0;
                        $(".btn_sure").css("background-color", "#0b9444");
                    }//end success
                });
            }
            Save();
        }

        //刷码结果处理
        function scanResultHandle(res) {
            var sphh = "";
            if (res.scanType == "QRCODE") {
                if ((res.result.indexOf("http:") > -1 || res.result.indexOf("https:") > -1)) {
                    var scanResult = res.result.split("?id=")[1];
                    sphh = jmtool.DNC(scanResult);
                } else {
                    sphh = res.result;
                    var Regx = /^[A-Za-z0-9]*$/;
                    if (!Regx.test(sphh)) { layer.msg("无效条码！", { time: 1000 }); playTipSound("error"); return; }

                }
            } else if (res.scanType == "CODE128") {
                sphh = res.result;
            } else {
                layer.msg("无效条码！", { time: 1000 });
                playTipSound("error");
                return;
            }

            //判断是否已经在列表中
            if (oldScanData[sphh] || newScanData[sphh]) {
                layer.msg('此唯一码已刷过，请勿重复！', { time: 1200 });
                playTipSound("error");
            } else {

                var dom = $("<li class='code_item'><span>" + xh + "</span><span class='code'>" + sphh + "</span><span class='item_num'>1</span><span class='btn_remove'>移除</span></li>")
                xh = xh + 1;
                newScanData[sphh] = { dom: dom };

                //写入localstorage
                localStorage.setItem("_llCheckScanCache_", JSON.stringify(Object.keys(newScanData)));
                $("#total_num").text(Number($("#total_num").text()) + 1);
                $list.prepend(dom);
                playTipSound("success");
            }
        }

        //播放提示音 type='success'||'error'
        function playTipSound(type) {
            if (llApp && llApp.isInApp) {
                llApp.playPromptSound(type);
            }
        }

        //刷退处理
        function backScanResultHandle(res) {
            var sphh = "";
            if (res.scanType == "QRCODE" && (res.result.indexOf("http:") > -1 || res.result.indexOf("https:") > -1)) {
                var _code = res.result.split("?id=")[1];
                sphh = jmtool.DNC(_code);
            } else if (res.scanType == "CODE128") {
                sphh = res.result;
            } else {
                layer.msg("条码无效，请重试！", { time: 1500 });
                playTipSound("error");
                return;
            }

            if (oldScanData[sphh]) {
                layer.msg("已保存的数据不允许修改！", { time: 2000 });
                playTipSound("error");
            } else if (newScanData[sphh]) {
                newScanData[sphh].dom.remove();
                delete (newScanData[sphh]);
                localStorage.setItem("_llCheckScanCache_", JSON.stringify(Object.keys(newScanData)));
                $("#total_num").text(Number($("#total_num").text()) - 1);
                playTipSound("success");
            } else {
                layer.msg("当前条码不在列表中！", { time: 1200 });
                playTipSound("error");
            }
        }

        //将上一次页面中的缓存渲染到页面中
        function renderFromStorage() {
            var xrxh = 1;
            var cache = localStorage.getItem("_llCheckScanCache_");
            var cacheData = JSON.parse(cache), counts = 0;
            cacheData.forEach(function (item, index) {
                if (!oldScanData[item]) {
                    var dom = $("<li class='code_item'><span>" + xrxh + "</span><span class='code'>" + item + "</span><span class='item_num'>1</span><span class='btn_remove'>移除</span></li>");
                    xh = xh + 1;
                    xrxh = xrxh + 1;
                    newScanData[item] = { dom: dom };
                    $list.prepend(dom);
                    counts++;
                }
            });

            //只显示新扫码的数量
            $("#total_num").text(counts);
        }

        function hasCache() {
            var result = false;
            var cache = localStorage.getItem("_llCheckScanCache_");
            if (cache) {
                var _cd = JSON.parse(cache);
                if (_cd instanceof Array && _cd.length > 0)
                    result = true;
            }

            return result;
        }

        //获取URL参数
        function getQueryString(name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
            var r = window.location.search.substr(1).match(reg);
            if (r != null) return unescape(r[2]);
            return "";
        };

        function showLoading(text) {
            $(".loading_mask .loading_text").text(text);
            $(".loading_mask").css("display", "flex");
        }

        function hideLoading() {
            $(".loading_mask").hide();
        }

        //查询某一单据唯一码明细数据
        function queryCodeBill(id) {
            return new Promise(function (resolve, reject) {
                var para = {
                    action: 'getGoodsinfo',
                    Parameter: [id, "wym"],
                    token: apptoken,
                    dept: dept,
                    orgid:tzid
                };
                $(".footer>div").hide();

                $.ajax({
                    url: "./checkScan.ashx",
                    type: "POST",
                    dataType: "text",
                    contentType: "application/x-www-form-urlencoded; charset=UTF-8",
                    timeout: 60 * 1000,
                    data: JSON.stringify(para),
                    error: function (XMLHttpRequest, textStatus, errorThrown) { reject() },
                    success: function (data) {
                        console.log(data);
                        var res = JSON.parse(data);
                        if (res.code == 200) {
                            var counts = 0;
                            res.data.forEach(function (item) {
                                var dom = null;
                                if (mode == "ck") {
                                    dom = $("<li class='code_item'><span class='code'>" + item.spid + "</span><span class='item_num'>1</span></li>");
                                    $list.prepend(dom);
                                }
                                oldScanData[item.spid] = { dom: dom };
                                counts++;
                            });
                            xh = counts + 1;
                            $("#total_num").text(counts);

                            if (mode != "ck") {
                                $(".btn_scanCode").css("display", "block");
                                $(".btn_scanBack").css("display", "block");
                                $(".btn_submit").css("display", "block");
                            }
                            resolve();
                        } else {
                            layer.msg("查询数据失败：" + res.message);
                            reject();
                        }
                    }
                });//end ajax
            })
        }

        //获取单据数量
        function getList() {
            return new Promise(function (resolve, reject) {
                var para = {};
                var par = new Array();
                par[0] = tzid;
                par[1] = name;
                para.action = "getGoodslist";
                para.token = apptoken;
                para.dept = dept;
                para.Parameter = par;
                para.orgid = tzid;
                $.ajax({
                    url: "./checkScan.ashx",
                    type: "POST",
                    dataType: "text",
                    contentType: "application/x-www-form-urlencoded; charset=UTF-8",
                    timeout: 60000,
                    data: JSON.stringify(para),
                    error: function (XMLHttpRequest, textStatus, errorThrown) { },
                    success: function (data) {
                        console.log(data);
                        var dt = JSON.parse(data);
                        //alert(dt.data.length);
                        if (dt.code == 200) {
                            $("#last_num").text(dt.data.length);
                        } else {
                            $("#last_num").text(0);
                        }
                        resolve();
                    }//end success
                });
            })
        }

        $("#last_num").on("click", function () {
            if ($("#last_num").text() == "0") {
                layer.msg('当前无已提交单据！', { time: 1200 });
            } else {
                window.location.href = "scanList.html?apptoken=" + apptoken;
            }
        });
        $("#dqkhid").on("click", function () {
            if (userid > 0) {
                window.location.href = "checkScan_Org.html?apptoken=" + apptoken + "&userid=" + userid + "&dept=" + dept;
            } else {
                layer.msg('无人资，不能切换！', { time: 1200 });
            }
        });
        //程序入口
        function main() {
            if ((mode == "bd" || mode == "ck") && parseInt(djid) > 0) {
                //查询出本单数据更新oldScanData但是不显示到界面上
                queryCodeBill(djid)

            }
            if (mode == "bd") {
                $(".btn_scanBack").css("display", "block");
            }
            if (mode == "" && parseInt(djid) > 0) {
                $(".footer>div").hide();
            }

            //补单或新单时才去判断缓存
            if (mode != "ck" && hasCache()) {
                //有缓存
                layer.confirm('系统检测到缓存中有数据，确定读取缓存，取消则清空缓存？', { icon: 3, title: '提示' }, function (index) {
                    renderFromStorage();
                    layer.close(index);
                }, function (index) {
                    localStorage.removeItem("_llCheckScanCache_");
                });
            }
        }

        layui.use(['layer'], function () {
            layer = layui.layer;
            layer.config({
                anim: 5,
                isOutAnim: false
            })

            getUser().then(getDepot)
            .then(getCompanyname)
            .then(getList)
            .then(function () {
                hideLoading();
                mydate();
                FastClick.attach($(".btn_submit")[0]);
                bindEvents();
                llApp.init();
                //如果是新建动作需要先判断缓存中有没有数据，打开已有单不判断
                main();
            })
            .catch(function (errmsg) {
                showLoading(errmsg);
                $(".footer > div").hide();
                setTimeout(function () {
                    layer.confirm(errmsg + '，是否刷新重试？', {
                        icon: 3, title: '提示', btn: ['刷新'], cancel: function () {
                            window.location.href = "";
                        }
                    }, function () {
                        window.location.href = "";
                    });
                }, 500);
            });

            //getUser().then(function (res) {
            //    mydate();
            //    FastClick.attach($(".btn_submit")[0]);
            //    bindEvents();
            //    llApp.init();
            //    //如果是新建动作需要先判断缓存中有没有数据，打开已有单不判断
            //    main();
            //}).catch(function (err) {
            //    layer.msg(err, { time: 60 * 1000 });
            //    $(".footer > div").hide();
            //})

            //getDepot(apptoken, dept, [tzid, userid]);
            //getCompanyname(apptoken, dept, [tzid, userid]);
            //getList();
        });
    </script>
</body>

</html>
