2017-8-22 10:33:57  declare @ksny varchar(6); 
declare @jsny varchar(6); 
declare @tqksny varchar(6); 
declare @tqjsny varchar(6); 
declare @jsrq datetime ;
declare @ksrq datetime ;
declare @tqjsrq varchar(10); 
declare @tqksrq varchar(10);

select @ksny=convert(varchar(6),cast('2017-08-01' as datetime),112);
select @jsny=convert(varchar(6),cast('2017-08-22' as datetime),112);
select @tqksny=convert(varchar(6),dateadd(year,-1,cast('2017-08-01' as datetime)),112);/*上一年度*/
select @tqjsny=convert(varchar(6),dateadd(year,-1,cast('2017-08-22' as datetime)),112);
set @ksrq='2017-08-01' ;
set @jsrq='2017-08-22' ;
select @tqksrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-01' as datetime)) ,120); 
select @tqjsrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-22' as datetime)) ,120); 

select a.* into #tmp_khb from ( 
    select distinct b.khid,a.khid sskhid,a.khdm as sskhdm,a.khjc as sskhmc,b.khmc,b.ccid,gx.ksny,gx.jsny,b.ssid,c.mc as sfmc,a.lxr,
           case when Convert(varchar(6),isnull(gx.sjkyrq,'1900-01-01'),112) between @ksny and @jsny then 1 else 0 end as xdbs   
    from yx_t_khb a 
    left join  [192.168.35.10].tlsoft.dbo.yx_t_khsfdm c on a.sfdm=c.dm   
    inner join yx_t_khb b on a.ssid=1 and a.khlbdm<>'g' and (b.ccid+'-' like a.ccid+'-%')  and a.khid>1 
    left outer join yx_t_khgxb gx on gx.khid=case when b.khlbdm in ('D','d') then b.ssid else a.khid end and b.khid=gx.gxid and (gx.ksny<=@jsny and gx.jsny>=@ksny) 
    where 1=1 and a.khid not in(85,1384,14204) and len(a.dzbbpx)>0 and b.khmc not like '%直销户%' and b.ty=0 
          and a.khfl like 'x%' and isnull(gx.qtlx,0)=0   /*and b.khfl='xz'*/
) as a ; 

select * into #jhb from (
    select 'ys' as cs,b.ny,1 as xh,a.sskhid,a.khid,
           sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-1 then b.je else 0 end) as ys_gsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=0 then b.je else 0 end) as ys_ddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=0 then b.je else 0 end) as ys_ddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=1 then b.je else 0 end) as ys_xdddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=1 then b.je else 0 end) as ys_xdddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny then b.je else 0 end) as ys_hjfy, 
	sum(b.je) as ys_allfy 
    from #tmp_khb a inner join zw_t_fyjh_kz b on a.khid=b.tzid where b.nd=left(@ksny,4) and b.djlx=12457 /*(b.ny>=@ksny and b.ny<=@jsny) */
    and b.ny>=a.ksny and b.ny<=a.jsny
    group by b.ny,a.sskhid,a.khid    
) a ;
 /*同期实际开支*/
   select 'sjfy' as cs,b.nd,b.ny,1 as xh,a.sskhid,a.khid,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' then b.je else 0 end) as sj_gsfy,  
   sum(case when a.khid=b.khid and b.sjlx='ddmy' and a.xdbs=0 then b.je else 0 end) as sj_ddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=0 then b.je else 0 end) as sj_ddfy,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddfy
   /*,sum(b.je) as sj_hjfy*/
   into #fyb2 
   from #tmp_khb a inner join  [192.168.35.10].tlsoft.dbo.rs_t_yxsjfyb b on a.khid=b.khid 
   where b.nd=2016 and b.khid>0 and b.sjlx in ('sjfy','ddmy') and b.ny>='201603' and b.ny<='201702' 
         and ((b.ny>=@ksny and b.ny<=@jsny) or (b.ny>=@tqksny and b.ny<=@tqjsny) )
    group by b.nd,b.ny,a.sskhid,a.khid;
 /*本期实际开支*/
 select a.* into #fyb1 from (
   /*日常开支，店租费用，税务费用，个人借款，个人花费，差旅费，工资,固定资产*/
   select a.cs,dbo.f_Zw_kjnd(a.khid,a.rq) as nd,convert(varchar(6),a.rq,112) as ny,1 as xh,kh.sskhid,kh.khid,
   sum(case when ((a.jb='xf' and a.bxlx=0) or (a.bxlx=1 and a.jb!='xz')) then a.hdje else 0 end) as sj_gsfy,  
   sum(case when a.jb='mydd' and a.bxlx=0 and kh.xdbs=0  then a.hdje else 0 end) as sj_ddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=0 then a.hdje else 0 end) as sj_ddfy, 
   sum(case when a.jb='mydd'  and a.bxlx=0 and kh.xdbs=1  then a.hdje else 0 end) as sj_xdddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=1 then a.hdje else 0 end) as sj_xdddfy  
  from zw_v_sjkzfy a
  inner join #tmp_khb kh on a.khid=kh.khid 
  where a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.pzbs=1
  group by dbo.f_Zw_kjnd(a.khid,a.rq),convert(varchar(6),a.rq,112) ,kh.sskhid,kh.khid,a.cs
) a 


select *,sj_gsfy+sj_ddgsfy+sj_ddfy+sj_xdddgsfy+sj_xdddfy as sj_hjfy into #fyb 
from (
   select * from #fyb1   
   union all 
   select * from #fyb2 
) a ;

 /*往来款*/
 select a.tzid,sum(jfje) as sr,sum(dfje) as zc
 into #wlk 
 from Zw_T_Cnrjz as a 
 inner join ( select kmdm from zw_t_kmsdb where djlx='12460' and xjdfkm=6982 and tzid=1 and scxe=1  ) b on a.dfkm=b.kmdm
 where a.lylx in (311,312,316,321,322,323,0,826) 
  and  a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.nd=dbo.f_zw_kjnd(a.tzid,@jsrq) 
 group by a.tzid


  select a.sskhid,km.kmdm into #sykmdm from (select sskhid from #tmp_khb group by sskhid) a 
  inner join zw_t_zwkmb km on a.sskhid=km.tzid 
  where km.nd=2017 and km.kzlb=1 
  group by a.sskhid,km.kmdm ;

 select a.sskhid,sum(xjcnzc) as xjcnzc,sum(xxjcnzc) as xxjcnzc,sum(sjcnzc) as sjcnzc,sum(ddcnzc) as ddcnzc,sum(xdddcnzc) as xdddcnzc 
        into #cnzc 
 from (
    select a.sskhid,sum(case when b.khid>0  and b.khid!=b.tzid and isnull(kh.xdbs,0)=0 then b.dfje else 0 end) as xjcnzc,
           sum(case when b.khid>0  and b.khid!=b.tzid and kh.xdbs=1 then b.dfje else 0 end) as xxjcnzc,
           sum(case when (b.khid=0 or b.khid=b.tzid) then b.dfje else 0 end) as sjcnzc,0 as ddcnzc,0 as xdddcnzc
    from #sykmdm a inner join zw_t_cnrjz b on a.sskhid=b.tzid and a.kmdm=b.dfkm and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq)   
    left outer join #tmp_khb kh on b.khid=kh.khid 
    group by a.sskhid 
    union all 
    select a.sskhid,0 as xjcnzc,0 as xxjcnzc,0 as sjcnzc,sum(case when a.xdbs=0 then dfje else 0 end) as ddcnzc,
           sum(case when a.xdbs=1 then dfje else 0 end) as xdddcnzc 
	from (select sskhid,khid,xdbs from #tmp_khb group by sskhid,khid,xdbs) a 
    inner join zw_t_cnrjz b on a.sskhid=b.tzid and b.khid=a.khid and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq) and b.dfkm='122111' 
    and b.khid>0 group by a.sskhid 
 ) a group by a.sskhid;


/*资金余额[对公，对私]*/
 select a.tzid,sum(case when a.kmdm in ('100201','100202') then a.qmje else 0 end) as dgje 
              ,sum(case when a.kmdm in ('100101','100102','1012') then a.qmje else 0 end) as dsje 
 into #zjyezb 
 from ds_t_cnrjzzzb a where 1=1 and ny=@jsny and a.kmdm in ('100201','100202','100101','100102','1012') group by a.tzid ;


if '2'='1' 
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,max(zj.dgje) as dgje,
       max(zj.dsje) as dsje,max(zc.sjcnzc) as sjcnzc,max(zc.xjcnzc) as xjcnzc,max(zc.ddcnzc) as ddcnzc,
       max(zc.xxjcnzc) as xxjcnzc,max(zc.xdddcnzc) as xdddcnzc,
       max(zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc) as cnzc,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
       sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
       sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy,
       max(allys.ys_allgsfy) as ys_allgsfy, max(allys.ys_allddfy) as ys_allddfy 
       ,max(wl.sr) as wlsr,max(wl.zc) as wlzc,max(wl.zc)-max(wl.sr) as wlce    
   from #tmp_khb kh left outer join #fyb a on kh.sskhid=a.sskhid and kh.khid=a.khid  and a.ny>=@ksny and a.ny<=@jsny
   left outer join #jhb b on kh.sskhid=b.sskhid and kh.khid=b.khid and b.ny>=@ksny and b.ny>=@jsny  
   left outer join #fyb c on kh.sskhid=c.sskhid and kh.khid=c.khid and c.ny>=@tqksny and c.ny<=@tqjsny and right(a.ny,2)=right(c.ny,2) 
        and a.sj_hjfy>0 and c.sj_hjfy>0 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.sskhid=allys.sskhid 
   left outer join #cnzc zc on kh.sskhid=zc.sskhid 
   left outer join #zjyezb zj on kh.sskhid=zj.tzid  
   left join #wlk wl on kh.sskhid=wl.tzid
   where 1=1 
   group by kh.sskhid,kh.sskhmc,kh.sskhdm,kh.sfmc   
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 

if '2'='2' or '2'=''
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb 
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq   
       ,zj.dgje,zj.dsje,zc.sjcnzc,zc.xjcnzc,zc.ddcnzc, 
       zc.xxjcnzc,zc.xdddcnzc,
       zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc as cnzc,
       allys.ys_allgsfy,allys.ys_allddfy  
       ,wl.sr as wlsr,wl.zc as wlzc,wl.zc-wl.sr as wlce 
    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.tq_gsfy) as tq_gsfy, sum(c.tq_ddgsfy) as tq_ddgsfy,
       sum(c.tq_ddfy) as tq_ddfy, sum(c.tq_xdddgsfy) as tq_xdddgsfy,
       sum(c.tq_xdddfy) as tq_xdddfy,sum(c.tq_hjfy) as tq_hjfy
   from #tmp_khb kh 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as sj_gsfy, sum(c.sj_ddgsfy) as sj_ddgsfy,
              sum(c.sj_ddfy) as sj_ddfy, sum(c.sj_xdddgsfy) as sj_xdddgsfy,
              sum(c.sj_xdddfy) as sj_xdddfy,sum(c.sj_hjfy) as sj_hjfy  
       from #fyb c where c.ny>=@ksny and c.ny<=@jsny group by c.sskhid,c.khid 
   ) a on kh.sskhid=a.sskhid and kh.khid=a.khid 
   left outer join (select sskhid,khid,sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy from #jhb b where b.ny>=@ksny and b.ny<=@jsny group by sskhid,khid) b 
   on kh.sskhid=b.sskhid and kh.khid=b.khid 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
              sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
              sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy  
       from #fyb c where c.ny>=@tqksny and c.ny<=@tqjsny group by c.sskhid,c.khid 
   ) c on kh.sskhid=c.sskhid and kh.khid=c.khid 
   group by kh.sskhdm,kh.sskhid,kh.sskhmc,kh.sfmc  
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.khid=allys.sskhid 
   left outer join #cnzc zc on a.khid=zc.sskhid 
   left outer join #zjyezb zj on a.khid=zj.tzid 
   left join #wlk wl on a.khid=wl.tzid;

drop table #tmp_khb;
drop table #jhb;
drop table #fyb1 ;
drop table #fyb2 ;
drop table #fyb ;
drop table #sykmdm ;
drop table #cnzc ;
drop table #zjyezb ;
drop table #wlk;
 

2017-8-22 10:37:42  declare @ksny varchar(6); 
declare @jsny varchar(6); 
declare @tqksny varchar(6); 
declare @tqjsny varchar(6); 
declare @jsrq datetime ;
declare @ksrq datetime ;
declare @tqjsrq varchar(10); 
declare @tqksrq varchar(10);

select @ksny=convert(varchar(6),cast('2017-08-01' as datetime),112);
select @jsny=convert(varchar(6),cast('2017-08-22' as datetime),112);
select @tqksny=convert(varchar(6),dateadd(year,-1,cast('2017-08-01' as datetime)),112);/*上一年度*/
select @tqjsny=convert(varchar(6),dateadd(year,-1,cast('2017-08-22' as datetime)),112);
set @ksrq='2017-08-01' ;
set @jsrq='2017-08-22' ;
select @tqksrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-01' as datetime)) ,120); 
select @tqjsrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-22' as datetime)) ,120); 

select a.* into #tmp_khb from ( 
    select distinct b.khid,a.khid sskhid,a.khdm as sskhdm,a.khjc as sskhmc,b.khmc,b.ccid,gx.ksny,gx.jsny,b.ssid,c.mc as sfmc,a.lxr,
           case when Convert(varchar(6),isnull(gx.sjkyrq,'1900-01-01'),112) between @ksny and @jsny then 1 else 0 end as xdbs   
    from yx_t_khb a 
    left join  [192.168.35.10].tlsoft.dbo.yx_t_khsfdm c on a.sfdm=c.dm   
    inner join yx_t_khb b on a.ssid=1 and a.khlbdm<>'g' and (b.ccid+'-' like a.ccid+'-%')  and a.khid>1 
    left outer join yx_t_khgxb gx on gx.khid=case when b.khlbdm in ('D','d') then b.ssid else a.khid end and b.khid=gx.gxid and (gx.ksny<=@jsny and gx.jsny>=@ksny) 
    where 1=1 and a.khid not in(85,1384,14204) and len(a.dzbbpx)>0 and b.khmc not like '%直销户%' and b.ty=0 
          and a.khfl like 'x%' and isnull(gx.qtlx,0)=0   /*and b.khfl='xz'*/
) as a ; 

select * into #jhb from (
    select 'ys' as cs,b.ny,1 as xh,a.sskhid,a.khid,
           sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-1 then b.je else 0 end) as ys_gsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=0 then b.je else 0 end) as ys_ddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=0 then b.je else 0 end) as ys_ddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=1 then b.je else 0 end) as ys_xdddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=1 then b.je else 0 end) as ys_xdddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny then b.je else 0 end) as ys_hjfy, 
	sum(b.je) as ys_allfy 
    from #tmp_khb a inner join zw_t_fyjh_kz b on a.khid=b.tzid where b.nd=left(@ksny,4) and b.djlx=12457 /*(b.ny>=@ksny and b.ny<=@jsny) */
    and b.ny>=a.ksny and b.ny<=a.jsny
    group by b.ny,a.sskhid,a.khid    
) a ;
 /*同期实际开支*/
   select 'sjfy' as cs,b.nd,b.ny,1 as xh,a.sskhid,a.khid,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' then b.je else 0 end) as sj_gsfy,  
   sum(case when a.khid=b.khid and b.sjlx='ddmy' and a.xdbs=0 then b.je else 0 end) as sj_ddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=0 then b.je else 0 end) as sj_ddfy,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddfy
   /*,sum(b.je) as sj_hjfy*/
   into #fyb2 
   from #tmp_khb a inner join  [192.168.35.10].tlsoft.dbo.rs_t_yxsjfyb b on a.khid=b.khid 
   where b.nd=2016 and b.khid>0 and b.sjlx in ('sjfy','ddmy') and b.ny>='201603' and b.ny<='201702' 
         and ((b.ny>=@ksny and b.ny<=@jsny) or (b.ny>=@tqksny and b.ny<=@tqjsny) )
    group by b.nd,b.ny,a.sskhid,a.khid;
 /*本期实际开支*/
 select a.* into #fyb1 from (
   /*日常开支，店租费用，税务费用，个人借款，个人花费，差旅费，工资,固定资产*/
   select a.cs,dbo.f_Zw_kjnd(a.khid,a.rq) as nd,convert(varchar(6),a.rq,112) as ny,1 as xh,kh.sskhid,kh.khid,
   sum(case when ((a.jb='xf' and a.bxlx=0) or (a.bxlx=1 and a.jb!='xz')) then a.hdje else 0 end) as sj_gsfy,  
   sum(case when a.jb='mydd' and a.bxlx=0 and kh.xdbs=0  then a.hdje else 0 end) as sj_ddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=0 then a.hdje else 0 end) as sj_ddfy, 
   sum(case when a.jb='mydd'  and a.bxlx=0 and kh.xdbs=1  then a.hdje else 0 end) as sj_xdddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=1 then a.hdje else 0 end) as sj_xdddfy  
  from zw_v_sjkzfy a
  inner join #tmp_khb kh on a.khid=kh.khid 
  where a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.pzbs=1
  group by dbo.f_Zw_kjnd(a.khid,a.rq),convert(varchar(6),a.rq,112) ,kh.sskhid,kh.khid,a.cs
) a 


select *,sj_gsfy+sj_ddgsfy+sj_ddfy+sj_xdddgsfy+sj_xdddfy as sj_hjfy into #fyb 
from (
   select * from #fyb1   
   union all 
   select * from #fyb2 
) a ;

 /*往来款*/
 select a.tzid,sum(jfje) as sr,sum(dfje) as zc
 into #wlk 
 from Zw_T_Cnrjz as a 
 inner join ( select kmdm from zw_t_kmsdb where djlx='12460' and xjdfkm=6982 and tzid=1 and scxe=1  ) b on a.dfkm=b.kmdm
 where a.lylx in (311,312,316,321,322,323,0,826) 
  and  a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.nd=dbo.f_zw_kjnd(a.tzid,@jsrq) 
 group by a.tzid


  select a.sskhid,km.kmdm into #sykmdm from (select sskhid from #tmp_khb group by sskhid) a 
  inner join zw_t_zwkmb km on a.sskhid=km.tzid 
  where km.nd=2017 and km.kzlb=1 
  group by a.sskhid,km.kmdm ;

 select a.sskhid,sum(xjcnzc) as xjcnzc,sum(xxjcnzc) as xxjcnzc,sum(sjcnzc) as sjcnzc,sum(ddcnzc) as ddcnzc,sum(xdddcnzc) as xdddcnzc 
        into #cnzc 
 from (
    select a.sskhid,sum(case when b.khid>0  and b.khid!=b.tzid and isnull(kh.xdbs,0)=0 then b.dfje else 0 end) as xjcnzc,
           sum(case when b.khid>0  and b.khid!=b.tzid and kh.xdbs=1 then b.dfje else 0 end) as xxjcnzc,
           sum(case when (b.khid=0 or b.khid=b.tzid) then b.dfje else 0 end) as sjcnzc,0 as ddcnzc,0 as xdddcnzc
    from #sykmdm a inner join zw_t_cnrjz b on a.sskhid=b.tzid and a.kmdm=b.dfkm and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq)   
    left outer join #tmp_khb kh on b.khid=kh.khid 
    group by a.sskhid 
    union all 
    select a.sskhid,0 as xjcnzc,0 as xxjcnzc,0 as sjcnzc,sum(case when a.xdbs=0 then dfje else 0 end) as ddcnzc,
           sum(case when a.xdbs=1 then dfje else 0 end) as xdddcnzc 
	from (select sskhid,khid,xdbs from #tmp_khb group by sskhid,khid,xdbs) a 
    inner join zw_t_cnrjz b on a.sskhid=b.tzid and b.khid=a.khid and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq) and b.dfkm='122111' 
    and b.khid>0 group by a.sskhid 
 ) a group by a.sskhid;


/*资金余额[对公，对私]*/
 select a.tzid,sum(case when a.kmdm in ('100201','100202') then a.qmje else 0 end) as dgje 
              ,sum(case when a.kmdm in ('100101','100102','1012') then a.qmje else 0 end) as dsje 
 into #zjyezb 
 from ds_t_cnrjzzzb a where 1=1 and ny=@jsny and a.kmdm in ('100201','100202','100101','100102','1012') group by a.tzid ;


if '2'='1' 
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,max(zj.dgje) as dgje,
       max(zj.dsje) as dsje,max(zc.sjcnzc) as sjcnzc,max(zc.xjcnzc) as xjcnzc,max(zc.ddcnzc) as ddcnzc,
       max(zc.xxjcnzc) as xxjcnzc,max(zc.xdddcnzc) as xdddcnzc,
       max(zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc) as cnzc,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
       sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
       sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy,
       max(allys.ys_allgsfy) as ys_allgsfy, max(allys.ys_allddfy) as ys_allddfy 
       ,max(wl.sr) as wlsr,max(wl.zc) as wlzc,max(wl.zc)-max(wl.sr) as wlce    
   from #tmp_khb kh left outer join #fyb a on kh.sskhid=a.sskhid and kh.khid=a.khid  and a.ny>=@ksny and a.ny<=@jsny
   left outer join #jhb b on kh.sskhid=b.sskhid and kh.khid=b.khid and b.ny>=@ksny and b.ny>=@jsny  
   left outer join #fyb c on kh.sskhid=c.sskhid and kh.khid=c.khid and c.ny>=@tqksny and c.ny<=@tqjsny and right(a.ny,2)=right(c.ny,2) 
        and a.sj_hjfy>0 and c.sj_hjfy>0 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.sskhid=allys.sskhid 
   left outer join #cnzc zc on kh.sskhid=zc.sskhid 
   left outer join #zjyezb zj on kh.sskhid=zj.tzid  
   left join #wlk wl on kh.sskhid=wl.tzid
   where 1=1 
   group by kh.sskhid,kh.sskhmc,kh.sskhdm,kh.sfmc   
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 

if '2'='2' or '2'=''
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb 
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq   
       ,zj.dgje,zj.dsje,zc.sjcnzc,zc.xjcnzc,zc.ddcnzc, 
       zc.xxjcnzc,zc.xdddcnzc,
       zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc as cnzc,
       allys.ys_allgsfy,allys.ys_allddfy  
       ,wl.sr as wlsr,wl.zc as wlzc,wl.zc-wl.sr as wlce 
    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.tq_gsfy) as tq_gsfy, sum(c.tq_ddgsfy) as tq_ddgsfy,
       sum(c.tq_ddfy) as tq_ddfy, sum(c.tq_xdddgsfy) as tq_xdddgsfy,
       sum(c.tq_xdddfy) as tq_xdddfy,sum(c.tq_hjfy) as tq_hjfy
   from #tmp_khb kh 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as sj_gsfy, sum(c.sj_ddgsfy) as sj_ddgsfy,
              sum(c.sj_ddfy) as sj_ddfy, sum(c.sj_xdddgsfy) as sj_xdddgsfy,
              sum(c.sj_xdddfy) as sj_xdddfy,sum(c.sj_hjfy) as sj_hjfy  
       from #fyb c where c.ny>=@ksny and c.ny<=@jsny group by c.sskhid,c.khid 
   ) a on kh.sskhid=a.sskhid and kh.khid=a.khid 
   left outer join (select sskhid,khid,sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy from #jhb b where b.ny>=@ksny and b.ny<=@jsny group by sskhid,khid) b 
   on kh.sskhid=b.sskhid and kh.khid=b.khid 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
              sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
              sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy  
       from #fyb c where c.ny>=@tqksny and c.ny<=@tqjsny group by c.sskhid,c.khid 
   ) c on kh.sskhid=c.sskhid and kh.khid=c.khid 
   group by kh.sskhdm,kh.sskhid,kh.sskhmc,kh.sfmc  
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.khid=allys.sskhid 
   left outer join #cnzc zc on a.khid=zc.sskhid 
   left outer join #zjyezb zj on a.khid=zj.tzid 
   left join #wlk wl on a.khid=wl.tzid;

drop table #tmp_khb;
drop table #jhb;
drop table #fyb1 ;
drop table #fyb2 ;
drop table #fyb ;
drop table #sykmdm ;
drop table #cnzc ;
drop table #zjyezb ;
drop table #wlk;
 

2017-8-22 10:39:49  declare @ksny varchar(6); 
declare @jsny varchar(6); 
declare @tqksny varchar(6); 
declare @tqjsny varchar(6); 
declare @jsrq datetime ;
declare @ksrq datetime ;
declare @tqjsrq varchar(10); 
declare @tqksrq varchar(10);

select @ksny=convert(varchar(6),cast('2017-08-01' as datetime),112);
select @jsny=convert(varchar(6),cast('2017-08-22' as datetime),112);
select @tqksny=convert(varchar(6),dateadd(year,-1,cast('2017-08-01' as datetime)),112);/*上一年度*/
select @tqjsny=convert(varchar(6),dateadd(year,-1,cast('2017-08-22' as datetime)),112);
set @ksrq='2017-08-01' ;
set @jsrq='2017-08-22' ;
select @tqksrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-01' as datetime)) ,120); 
select @tqjsrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-22' as datetime)) ,120); 

select a.* into #tmp_khb from ( 
    select distinct b.khid,a.khid sskhid,a.khdm as sskhdm,a.khjc as sskhmc,b.khmc,b.ccid,gx.ksny,gx.jsny,b.ssid,c.mc as sfmc,a.lxr,
           case when Convert(varchar(6),isnull(gx.sjkyrq,'1900-01-01'),112) between @ksny and @jsny then 1 else 0 end as xdbs   
    from yx_t_khb a 
    left join  [192.168.35.10].tlsoft.dbo.yx_t_khsfdm c on a.sfdm=c.dm   
    inner join yx_t_khb b on a.ssid=1 and a.khlbdm<>'g' and (b.ccid+'-' like a.ccid+'-%')  and a.khid>1 
    left outer join yx_t_khgxb gx on gx.khid=case when b.khlbdm in ('D','d') then b.ssid else a.khid end and b.khid=gx.gxid and (gx.ksny<=@jsny and gx.jsny>=@ksny) 
    where 1=1 and a.khid not in(85,1384,14204) and len(a.dzbbpx)>0 and b.khmc not like '%直销户%' and b.ty=0 
          and a.khfl like 'x%' and isnull(gx.qtlx,0)=0   /*and b.khfl='xz'*/
) as a ; 

select * into #jhb from (
    select 'ys' as cs,b.ny,1 as xh,a.sskhid,a.khid,
           sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-1 then b.je else 0 end) as ys_gsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=0 then b.je else 0 end) as ys_ddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=0 then b.je else 0 end) as ys_ddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=1 then b.je else 0 end) as ys_xdddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=1 then b.je else 0 end) as ys_xdddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny then b.je else 0 end) as ys_hjfy, 
	sum(b.je) as ys_allfy 
    from #tmp_khb a inner join zw_t_fyjh_kz b on a.khid=b.tzid where b.nd=left(@ksny,4) and b.djlx=12457 /*(b.ny>=@ksny and b.ny<=@jsny) */
    and b.ny>=a.ksny and b.ny<=a.jsny
    group by b.ny,a.sskhid,a.khid    
) a ;
 /*同期实际开支*/
   select 'sjfy' as cs,b.nd,b.ny,1 as xh,a.sskhid,a.khid,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' then b.je else 0 end) as sj_gsfy,  
   sum(case when a.khid=b.khid and b.sjlx='ddmy' and a.xdbs=0 then b.je else 0 end) as sj_ddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=0 then b.je else 0 end) as sj_ddfy,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddfy
   /*,sum(b.je) as sj_hjfy*/
   into #fyb2 
   from #tmp_khb a inner join  [192.168.35.10].tlsoft.dbo.rs_t_yxsjfyb b on a.khid=b.khid 
   where b.nd=2016 and b.khid>0 and b.sjlx in ('sjfy','ddmy') and b.ny>='201603' and b.ny<='201702' 
         and ((b.ny>=@ksny and b.ny<=@jsny) or (b.ny>=@tqksny and b.ny<=@tqjsny) )
    group by b.nd,b.ny,a.sskhid,a.khid;
 /*本期实际开支*/
 select a.* into #fyb1 from (
   /*日常开支，店租费用，税务费用，个人借款，个人花费，差旅费，工资,固定资产*/
   select a.cs,dbo.f_Zw_kjnd(a.khid,a.rq) as nd,convert(varchar(6),a.rq,112) as ny,1 as xh,kh.sskhid,kh.khid,
   sum(case when ((a.jb='xf' and a.bxlx=0) or (a.bxlx=1 and a.jb!='xz')) then a.hdje else 0 end) as sj_gsfy,  
   sum(case when a.jb='mydd' and a.bxlx=0 and kh.xdbs=0  then a.hdje else 0 end) as sj_ddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=0 then a.hdje else 0 end) as sj_ddfy, 
   sum(case when a.jb='mydd'  and a.bxlx=0 and kh.xdbs=1  then a.hdje else 0 end) as sj_xdddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=1 then a.hdje else 0 end) as sj_xdddfy  
  from zw_v_sjkzfy a
  inner join #tmp_khb kh on a.khid=kh.khid 
  where a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.pzbs=1
  group by dbo.f_Zw_kjnd(a.khid,a.rq),convert(varchar(6),a.rq,112) ,kh.sskhid,kh.khid,a.cs
) a 


select *,sj_gsfy+sj_ddgsfy+sj_ddfy+sj_xdddgsfy+sj_xdddfy as sj_hjfy into #fyb 
from (
   select * from #fyb1   
   union all 
   select * from #fyb2 
) a ;

 /*往来款*/
 select a.tzid,sum(jfje) as sr,sum(dfje) as zc
 into #wlk 
 from Zw_T_Cnrjz as a 
 inner join ( select kmdm from zw_t_kmsdb where djlx='12460' and xjdfkm=6982 and tzid=1 and scxe=1  ) b on a.dfkm=b.kmdm
 where a.lylx in (311,312,316,321,322,323,0,826) 
  and  a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.nd=dbo.f_zw_kjnd(a.tzid,@jsrq) 
 group by a.tzid


  select a.sskhid,km.kmdm into #sykmdm from (select sskhid from #tmp_khb group by sskhid) a 
  inner join zw_t_zwkmb km on a.sskhid=km.tzid 
  where km.nd=2017 and km.kzlb=1 
  group by a.sskhid,km.kmdm ;

 select a.sskhid,sum(xjcnzc) as xjcnzc,sum(xxjcnzc) as xxjcnzc,sum(sjcnzc) as sjcnzc,sum(ddcnzc) as ddcnzc,sum(xdddcnzc) as xdddcnzc 
        into #cnzc 
 from (
    select a.sskhid,sum(case when b.khid>0  and b.khid!=b.tzid and isnull(kh.xdbs,0)=0 then b.dfje else 0 end) as xjcnzc,
           sum(case when b.khid>0  and b.khid!=b.tzid and kh.xdbs=1 then b.dfje else 0 end) as xxjcnzc,
           sum(case when (b.khid=0 or b.khid=b.tzid) then b.dfje else 0 end) as sjcnzc,0 as ddcnzc,0 as xdddcnzc
    from #sykmdm a inner join zw_t_cnrjz b on a.sskhid=b.tzid and a.kmdm=b.dfkm and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq)   
    left outer join #tmp_khb kh on b.khid=kh.khid 
    group by a.sskhid 
    union all 
    select a.sskhid,0 as xjcnzc,0 as xxjcnzc,0 as sjcnzc,sum(case when a.xdbs=0 then dfje else 0 end) as ddcnzc,
           sum(case when a.xdbs=1 then dfje else 0 end) as xdddcnzc 
	from (select sskhid,khid,xdbs from #tmp_khb group by sskhid,khid,xdbs) a 
    inner join zw_t_cnrjz b on a.sskhid=b.tzid and b.khid=a.khid and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq) and b.dfkm='122111' 
    and b.khid>0 group by a.sskhid 
 ) a group by a.sskhid;


/*资金余额[对公，对私]*/
 select a.tzid,sum(case when a.kmdm in ('100201','100202') then a.qmje else 0 end) as dgje 
              ,sum(case when a.kmdm in ('100101','100102','1012') then a.qmje else 0 end) as dsje 
 into #zjyezb 
 from ds_t_cnrjzzzb a where 1=1 and ny=@jsny and a.kmdm in ('100201','100202','100101','100102','1012') group by a.tzid ;


if '2'='1' 
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,max(zj.dgje) as dgje,
       max(zj.dsje) as dsje,max(zc.sjcnzc) as sjcnzc,max(zc.xjcnzc) as xjcnzc,max(zc.ddcnzc) as ddcnzc,
       max(zc.xxjcnzc) as xxjcnzc,max(zc.xdddcnzc) as xdddcnzc,
       max(zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc) as cnzc,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
       sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
       sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy,
       max(allys.ys_allgsfy) as ys_allgsfy, max(allys.ys_allddfy) as ys_allddfy 
       ,max(wl.sr) as wlsr,max(wl.zc) as wlzc,max(wl.zc)-max(wl.sr) as wlce    
   from #tmp_khb kh left outer join #fyb a on kh.sskhid=a.sskhid and kh.khid=a.khid  and a.ny>=@ksny and a.ny<=@jsny
   left outer join #jhb b on kh.sskhid=b.sskhid and kh.khid=b.khid and b.ny>=@ksny and b.ny>=@jsny  
   left outer join #fyb c on kh.sskhid=c.sskhid and kh.khid=c.khid and c.ny>=@tqksny and c.ny<=@tqjsny and right(a.ny,2)=right(c.ny,2) 
        and a.sj_hjfy>0 and c.sj_hjfy>0 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.sskhid=allys.sskhid 
   left outer join #cnzc zc on kh.sskhid=zc.sskhid 
   left outer join #zjyezb zj on kh.sskhid=zj.tzid  
   left join #wlk wl on kh.sskhid=wl.tzid
   where 1=1 
   group by kh.sskhid,kh.sskhmc,kh.sskhdm,kh.sfmc   
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 

if '2'='2' or '2'=''
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb 
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq   
       ,zj.dgje,zj.dsje,zc.sjcnzc,zc.xjcnzc,zc.ddcnzc, 
       zc.xxjcnzc,zc.xdddcnzc,
       zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc as cnzc,
       allys.ys_allgsfy,allys.ys_allddfy  
       ,wl.sr as wlsr,wl.zc as wlzc,wl.zc-wl.sr as wlce 
    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.tq_gsfy) as tq_gsfy, sum(c.tq_ddgsfy) as tq_ddgsfy,
       sum(c.tq_ddfy) as tq_ddfy, sum(c.tq_xdddgsfy) as tq_xdddgsfy,
       sum(c.tq_xdddfy) as tq_xdddfy,sum(c.tq_hjfy) as tq_hjfy
   from #tmp_khb kh 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as sj_gsfy, sum(c.sj_ddgsfy) as sj_ddgsfy,
              sum(c.sj_ddfy) as sj_ddfy, sum(c.sj_xdddgsfy) as sj_xdddgsfy,
              sum(c.sj_xdddfy) as sj_xdddfy,sum(c.sj_hjfy) as sj_hjfy  
       from #fyb c where c.ny>=@ksny and c.ny<=@jsny group by c.sskhid,c.khid 
   ) a on kh.sskhid=a.sskhid and kh.khid=a.khid 
   left outer join (select sskhid,khid,sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy from #jhb b where b.ny>=@ksny and b.ny<=@jsny group by sskhid,khid) b 
   on kh.sskhid=b.sskhid and kh.khid=b.khid 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
              sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
              sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy  
       from #fyb c where c.ny>=@tqksny and c.ny<=@tqjsny group by c.sskhid,c.khid 
   ) c on kh.sskhid=c.sskhid and kh.khid=c.khid 
   group by kh.sskhdm,kh.sskhid,kh.sskhmc,kh.sfmc  
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.khid=allys.sskhid 
   left outer join #cnzc zc on a.khid=zc.sskhid 
   left outer join #zjyezb zj on a.khid=zj.tzid 
   left join #wlk wl on a.khid=wl.tzid;

drop table #tmp_khb;
drop table #jhb;
drop table #fyb1 ;
drop table #fyb2 ;
drop table #fyb ;
drop table #sykmdm ;
drop table #cnzc ;
drop table #zjyezb ;
drop table #wlk;
 

2017-8-22 10:41:32  declare @ksny varchar(6); 
declare @jsny varchar(6); 
declare @tqksny varchar(6); 
declare @tqjsny varchar(6); 
declare @jsrq datetime ;
declare @ksrq datetime ;
declare @tqjsrq varchar(10); 
declare @tqksrq varchar(10);

select @ksny=convert(varchar(6),cast('2017-08-01' as datetime),112);
select @jsny=convert(varchar(6),cast('2017-08-22' as datetime),112);
select @tqksny=convert(varchar(6),dateadd(year,-1,cast('2017-08-01' as datetime)),112);/*上一年度*/
select @tqjsny=convert(varchar(6),dateadd(year,-1,cast('2017-08-22' as datetime)),112);
set @ksrq='2017-08-01' ;
set @jsrq='2017-08-22' ;
select @tqksrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-01' as datetime)) ,120); 
select @tqjsrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-22' as datetime)) ,120); 

select a.* into #tmp_khb from ( 
    select distinct b.khid,a.khid sskhid,a.khdm as sskhdm,a.khjc as sskhmc,b.khmc,b.ccid,gx.ksny,gx.jsny,b.ssid,c.mc as sfmc,a.lxr,
           case when Convert(varchar(6),isnull(gx.sjkyrq,'1900-01-01'),112) between @ksny and @jsny then 1 else 0 end as xdbs   
    from yx_t_khb a 
    left join  [192.168.35.10].tlsoft.dbo.yx_t_khsfdm c on a.sfdm=c.dm   
    inner join yx_t_khb b on a.ssid=1 and a.khlbdm<>'g' and (b.ccid+'-' like a.ccid+'-%')  and a.khid>1 
    left outer join yx_t_khgxb gx on gx.khid=case when b.khlbdm in ('D','d') then b.ssid else a.khid end and b.khid=gx.gxid and (gx.ksny<=@jsny and gx.jsny>=@ksny) 
    where 1=1 and a.khid not in(85,1384,14204) and len(a.dzbbpx)>0 and b.khmc not like '%直销户%' and b.ty=0 
          and a.khfl like 'x%' and isnull(gx.qtlx,0)=0   /*and b.khfl='xz'*/
) as a ; 

select * into #jhb from (
    select 'ys' as cs,b.ny,1 as xh,a.sskhid,a.khid,
           sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-1 then b.je else 0 end) as ys_gsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=0 then b.je else 0 end) as ys_ddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=0 then b.je else 0 end) as ys_ddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=1 then b.je else 0 end) as ys_xdddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=1 then b.je else 0 end) as ys_xdddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny then b.je else 0 end) as ys_hjfy, 
	sum(b.je) as ys_allfy 
    from #tmp_khb a inner join zw_t_fyjh_kz b on a.khid=b.tzid where b.nd=left(@ksny,4) and b.djlx=12457 /*(b.ny>=@ksny and b.ny<=@jsny) */
    and b.ny>=a.ksny and b.ny<=a.jsny
    group by b.ny,a.sskhid,a.khid    
) a ;
 /*同期实际开支*/
   select 'sjfy' as cs,b.nd,b.ny,1 as xh,a.sskhid,a.khid,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' then b.je else 0 end) as sj_gsfy,  
   sum(case when a.khid=b.khid and b.sjlx='ddmy' and a.xdbs=0 then b.je else 0 end) as sj_ddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=0 then b.je else 0 end) as sj_ddfy,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddfy
   /*,sum(b.je) as sj_hjfy*/
   into #fyb2 
   from #tmp_khb a inner join  [192.168.35.10].tlsoft.dbo.rs_t_yxsjfyb b on a.khid=b.khid 
   where b.nd=2016 and b.khid>0 and b.sjlx in ('sjfy','ddmy') and b.ny>='201603' and b.ny<='201702' 
         and ((b.ny>=@ksny and b.ny<=@jsny) or (b.ny>=@tqksny and b.ny<=@tqjsny) )
    group by b.nd,b.ny,a.sskhid,a.khid;
 /*本期实际开支*/
 select a.* into #fyb1 from (
   /*日常开支，店租费用，税务费用，个人借款，个人花费，差旅费，工资,固定资产*/
   select a.cs,dbo.f_Zw_kjnd(a.khid,a.rq) as nd,convert(varchar(6),a.rq,112) as ny,1 as xh,kh.sskhid,kh.khid,
   sum(case when ((a.jb='xf' and a.bxlx=0) or (a.bxlx=1 and a.jb!='xz')) then a.hdje else 0 end) as sj_gsfy,  
   sum(case when a.jb='mydd' and a.bxlx=0 and kh.xdbs=0  then a.hdje else 0 end) as sj_ddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=0 then a.hdje else 0 end) as sj_ddfy, 
   sum(case when a.jb='mydd'  and a.bxlx=0 and kh.xdbs=1  then a.hdje else 0 end) as sj_xdddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=1 then a.hdje else 0 end) as sj_xdddfy  
  from zw_v_sjkzfy a
  inner join #tmp_khb kh on a.khid=kh.khid 
  where a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.pzbs=1
  group by dbo.f_Zw_kjnd(a.khid,a.rq),convert(varchar(6),a.rq,112) ,kh.sskhid,kh.khid,a.cs
) a 


select *,sj_gsfy+sj_ddgsfy+sj_ddfy+sj_xdddgsfy+sj_xdddfy as sj_hjfy into #fyb 
from (
   select * from #fyb1   
   union all 
   select * from #fyb2 
) a ;

 /*往来款*/
 select a.tzid,sum(jfje) as sr,sum(dfje) as zc
 into #wlk 
 from Zw_T_Cnrjz as a 
 inner join ( select kmdm from zw_t_kmsdb where djlx='12460' and xjdfkm=6982 and tzid=1 and scxe=1  ) b on a.dfkm=b.kmdm
 where a.lylx in (311,312,316,321,322,323,0,826) 
  and  a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.nd=dbo.f_zw_kjnd(a.tzid,@jsrq) 
 group by a.tzid


  select a.sskhid,km.kmdm into #sykmdm from (select sskhid from #tmp_khb group by sskhid) a 
  inner join zw_t_zwkmb km on a.sskhid=km.tzid 
  where km.nd=2017 and km.kzlb=1 
  group by a.sskhid,km.kmdm ;

 select a.sskhid,sum(xjcnzc) as xjcnzc,sum(xxjcnzc) as xxjcnzc,sum(sjcnzc) as sjcnzc,sum(ddcnzc) as ddcnzc,sum(xdddcnzc) as xdddcnzc 
        into #cnzc 
 from (
    select a.sskhid,sum(case when b.khid>0  and b.khid!=b.tzid and isnull(kh.xdbs,0)=0 then b.dfje else 0 end) as xjcnzc,
           sum(case when b.khid>0  and b.khid!=b.tzid and kh.xdbs=1 then b.dfje else 0 end) as xxjcnzc,
           sum(case when (b.khid=0 or b.khid=b.tzid) then b.dfje else 0 end) as sjcnzc,0 as ddcnzc,0 as xdddcnzc
    from #sykmdm a inner join zw_t_cnrjz b on a.sskhid=b.tzid and a.kmdm=b.dfkm and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq)   
    left outer join #tmp_khb kh on b.khid=kh.khid 
    group by a.sskhid 
    union all 
    select a.sskhid,0 as xjcnzc,0 as xxjcnzc,0 as sjcnzc,sum(case when a.xdbs=0 then dfje else 0 end) as ddcnzc,
           sum(case when a.xdbs=1 then dfje else 0 end) as xdddcnzc 
	from (select sskhid,khid,xdbs from #tmp_khb group by sskhid,khid,xdbs) a 
    inner join zw_t_cnrjz b on a.sskhid=b.tzid and b.khid=a.khid and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq) and b.dfkm='122111' 
    and b.khid>0 group by a.sskhid 
 ) a group by a.sskhid;


/*资金余额[对公，对私]*/
 select a.tzid,sum(case when a.kmdm in ('100201','100202') then a.qmje else 0 end) as dgje 
              ,sum(case when a.kmdm in ('100101','100102','1012') then a.qmje else 0 end) as dsje 
 into #zjyezb 
 from ds_t_cnrjzzzb a where 1=1 and ny=@jsny and a.kmdm in ('100201','100202','100101','100102','1012') group by a.tzid ;


if '2'='1' 
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,max(zj.dgje) as dgje,
       max(zj.dsje) as dsje,max(zc.sjcnzc) as sjcnzc,max(zc.xjcnzc) as xjcnzc,max(zc.ddcnzc) as ddcnzc,
       max(zc.xxjcnzc) as xxjcnzc,max(zc.xdddcnzc) as xdddcnzc,
       max(zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc) as cnzc,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
       sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
       sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy,
       max(allys.ys_allgsfy) as ys_allgsfy, max(allys.ys_allddfy) as ys_allddfy 
       ,max(wl.sr) as wlsr,max(wl.zc) as wlzc,max(wl.zc)-max(wl.sr) as wlce    
   from #tmp_khb kh left outer join #fyb a on kh.sskhid=a.sskhid and kh.khid=a.khid  and a.ny>=@ksny and a.ny<=@jsny
   left outer join #jhb b on kh.sskhid=b.sskhid and kh.khid=b.khid and b.ny>=@ksny and b.ny>=@jsny  
   left outer join #fyb c on kh.sskhid=c.sskhid and kh.khid=c.khid and c.ny>=@tqksny and c.ny<=@tqjsny and right(a.ny,2)=right(c.ny,2) 
        and a.sj_hjfy>0 and c.sj_hjfy>0 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.sskhid=allys.sskhid 
   left outer join #cnzc zc on kh.sskhid=zc.sskhid 
   left outer join #zjyezb zj on kh.sskhid=zj.tzid  
   left join #wlk wl on kh.sskhid=wl.tzid
   where 1=1 
   group by kh.sskhid,kh.sskhmc,kh.sskhdm,kh.sfmc   
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 

if '2'='2' or '2'=''
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb 
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq   
       ,zj.dgje,zj.dsje,zc.sjcnzc,zc.xjcnzc,zc.ddcnzc, 
       zc.xxjcnzc,zc.xdddcnzc,
       zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc as cnzc,
       allys.ys_allgsfy,allys.ys_allddfy  
       ,wl.sr as wlsr,wl.zc as wlzc,wl.zc-wl.sr as wlce 
    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.tq_gsfy) as tq_gsfy, sum(c.tq_ddgsfy) as tq_ddgsfy,
       sum(c.tq_ddfy) as tq_ddfy, sum(c.tq_xdddgsfy) as tq_xdddgsfy,
       sum(c.tq_xdddfy) as tq_xdddfy,sum(c.tq_hjfy) as tq_hjfy
   from #tmp_khb kh 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as sj_gsfy, sum(c.sj_ddgsfy) as sj_ddgsfy,
              sum(c.sj_ddfy) as sj_ddfy, sum(c.sj_xdddgsfy) as sj_xdddgsfy,
              sum(c.sj_xdddfy) as sj_xdddfy,sum(c.sj_hjfy) as sj_hjfy  
       from #fyb c where c.ny>=@ksny and c.ny<=@jsny group by c.sskhid,c.khid 
   ) a on kh.sskhid=a.sskhid and kh.khid=a.khid 
   left outer join (select sskhid,khid,sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy from #jhb b where b.ny>=@ksny and b.ny<=@jsny group by sskhid,khid) b 
   on kh.sskhid=b.sskhid and kh.khid=b.khid 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
              sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
              sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy  
       from #fyb c where c.ny>=@tqksny and c.ny<=@tqjsny group by c.sskhid,c.khid 
   ) c on kh.sskhid=c.sskhid and kh.khid=c.khid 
   group by kh.sskhdm,kh.sskhid,kh.sskhmc,kh.sfmc  
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.khid=allys.sskhid 
   left outer join #cnzc zc on a.khid=zc.sskhid 
   left outer join #zjyezb zj on a.khid=zj.tzid 
   left join #wlk wl on a.khid=wl.tzid;

drop table #tmp_khb;
drop table #jhb;
drop table #fyb1 ;
drop table #fyb2 ;
drop table #fyb ;
drop table #sykmdm ;
drop table #cnzc ;
drop table #zjyezb ;
drop table #wlk;
 

2017-8-22 10:43:47  declare @ksny varchar(6); 
declare @jsny varchar(6); 
declare @tqksny varchar(6); 
declare @tqjsny varchar(6); 
declare @jsrq datetime ;
declare @ksrq datetime ;
declare @tqjsrq varchar(10); 
declare @tqksrq varchar(10);

select @ksny=convert(varchar(6),cast('2017-08-01' as datetime),112);
select @jsny=convert(varchar(6),cast('2017-08-22' as datetime),112);
select @tqksny=convert(varchar(6),dateadd(year,-1,cast('2017-08-01' as datetime)),112);/*上一年度*/
select @tqjsny=convert(varchar(6),dateadd(year,-1,cast('2017-08-22' as datetime)),112);
set @ksrq='2017-08-01' ;
set @jsrq='2017-08-22' ;
select @tqksrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-01' as datetime)) ,120); 
select @tqjsrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-22' as datetime)) ,120); 

select a.* into #tmp_khb from ( 
    select distinct b.khid,a.khid sskhid,a.khdm as sskhdm,a.khjc as sskhmc,b.khmc,b.ccid,gx.ksny,gx.jsny,b.ssid,c.mc as sfmc,a.lxr,
           case when Convert(varchar(6),isnull(gx.sjkyrq,'1900-01-01'),112) between @ksny and @jsny then 1 else 0 end as xdbs   
    from yx_t_khb a 
    left join  [192.168.35.10].tlsoft.dbo.yx_t_khsfdm c on a.sfdm=c.dm   
    inner join yx_t_khb b on a.ssid=1 and a.khlbdm<>'g' and (b.ccid+'-' like a.ccid+'-%')  and a.khid>1 
    left outer join yx_t_khgxb gx on gx.khid=case when b.khlbdm in ('D','d') then b.ssid else a.khid end and b.khid=gx.gxid and (gx.ksny<=@jsny and gx.jsny>=@ksny) 
    where 1=1 and a.khid not in(85,1384,14204) and len(a.dzbbpx)>0 and b.khmc not like '%直销户%' and b.ty=0 
          and a.khfl like 'x%' and isnull(gx.qtlx,0)=0   /*and b.khfl='xz'*/
) as a ; 

select * into #jhb from (
    select 'ys' as cs,b.ny,1 as xh,a.sskhid,a.khid,
           sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-1 then b.je else 0 end) as ys_gsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=0 then b.je else 0 end) as ys_ddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=0 then b.je else 0 end) as ys_ddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=1 then b.je else 0 end) as ys_xdddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=1 then b.je else 0 end) as ys_xdddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny then b.je else 0 end) as ys_hjfy, 
	sum(b.je) as ys_allfy 
    from #tmp_khb a inner join zw_t_fyjh_kz b on a.khid=b.tzid where b.nd=left(@ksny,4) and b.djlx=12457 /*(b.ny>=@ksny and b.ny<=@jsny) */
    and b.ny>=a.ksny and b.ny<=a.jsny
    group by b.ny,a.sskhid,a.khid    
) a ;
 /*同期实际开支*/
   select 'sjfy' as cs,b.nd,b.ny,1 as xh,a.sskhid,a.khid,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' then b.je else 0 end) as sj_gsfy,  
   sum(case when a.khid=b.khid and b.sjlx='ddmy' and a.xdbs=0 then b.je else 0 end) as sj_ddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=0 then b.je else 0 end) as sj_ddfy,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddfy
   /*,sum(b.je) as sj_hjfy*/
   into #fyb2 
   from #tmp_khb a inner join  [192.168.35.10].tlsoft.dbo.rs_t_yxsjfyb b on a.khid=b.khid 
   where b.nd=2016 and b.khid>0 and b.sjlx in ('sjfy','ddmy') and b.ny>='201603' and b.ny<='201702' 
         and ((b.ny>=@ksny and b.ny<=@jsny) or (b.ny>=@tqksny and b.ny<=@tqjsny) )
    group by b.nd,b.ny,a.sskhid,a.khid;
 /*本期实际开支*/
 select a.* into #fyb1 from (
   /*日常开支，店租费用，税务费用，个人借款，个人花费，差旅费，工资,固定资产*/
   select a.cs,dbo.f_Zw_kjnd(a.khid,a.rq) as nd,convert(varchar(6),a.rq,112) as ny,1 as xh,kh.sskhid,kh.khid,
   sum(case when ((a.jb='xf' and a.bxlx=0) or (a.bxlx=1 and a.jb!='xz')) then a.hdje else 0 end) as sj_gsfy,  
   sum(case when a.jb='mydd' and a.bxlx=0 and kh.xdbs=0  then a.hdje else 0 end) as sj_ddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=0 then a.hdje else 0 end) as sj_ddfy, 
   sum(case when a.jb='mydd'  and a.bxlx=0 and kh.xdbs=1  then a.hdje else 0 end) as sj_xdddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=1 then a.hdje else 0 end) as sj_xdddfy  
  from zw_v_sjkzfy a
  inner join #tmp_khb kh on a.khid=kh.khid 
  where a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.pzbs=1
  group by dbo.f_Zw_kjnd(a.khid,a.rq),convert(varchar(6),a.rq,112) ,kh.sskhid,kh.khid,a.cs
) a 


select *,sj_gsfy+sj_ddgsfy+sj_ddfy+sj_xdddgsfy+sj_xdddfy as sj_hjfy into #fyb 
from (
   select * from #fyb1   
   union all 
   select * from #fyb2 
) a ;

 /*往来款*/
 select a.tzid,sum(jfje) as sr,sum(dfje) as zc
 into #wlk 
 from Zw_T_Cnrjz as a 
 inner join ( select kmdm from zw_t_kmsdb where djlx='12460' and xjdfkm=6982 and tzid=1 and scxe=1  ) b on a.dfkm=b.kmdm
 where a.lylx in (311,312,316,321,322,323,0,826) 
  and  a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.nd=dbo.f_zw_kjnd(a.tzid,@jsrq) 
 group by a.tzid


  select a.sskhid,km.kmdm into #sykmdm from (select sskhid from #tmp_khb group by sskhid) a 
  inner join zw_t_zwkmb km on a.sskhid=km.tzid 
  where km.nd=2017 and km.kzlb=1 
  group by a.sskhid,km.kmdm ;

 select a.sskhid,sum(xjcnzc) as xjcnzc,sum(xxjcnzc) as xxjcnzc,sum(sjcnzc) as sjcnzc,sum(ddcnzc) as ddcnzc,sum(xdddcnzc) as xdddcnzc 
        into #cnzc 
 from (
    select a.sskhid,sum(case when b.khid>0  and b.khid!=b.tzid and isnull(kh.xdbs,0)=0 then b.dfje else 0 end) as xjcnzc,
           sum(case when b.khid>0  and b.khid!=b.tzid and kh.xdbs=1 then b.dfje else 0 end) as xxjcnzc,
           sum(case when (b.khid=0 or b.khid=b.tzid) then b.dfje else 0 end) as sjcnzc,0 as ddcnzc,0 as xdddcnzc
    from #sykmdm a inner join zw_t_cnrjz b on a.sskhid=b.tzid and a.kmdm=b.dfkm and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq)   
    left outer join #tmp_khb kh on b.khid=kh.khid 
    group by a.sskhid 
    union all 
    select a.sskhid,0 as xjcnzc,0 as xxjcnzc,0 as sjcnzc,sum(case when a.xdbs=0 then dfje else 0 end) as ddcnzc,
           sum(case when a.xdbs=1 then dfje else 0 end) as xdddcnzc 
	from (select sskhid,khid,xdbs from #tmp_khb group by sskhid,khid,xdbs) a 
    inner join zw_t_cnrjz b on a.sskhid=b.tzid and b.khid=a.khid and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq) and b.dfkm='122111' 
    and b.khid>0 group by a.sskhid 
 ) a group by a.sskhid;


/*资金余额[对公，对私]*/
 select a.tzid,sum(case when a.kmdm in ('100201','100202') then a.qmje else 0 end) as dgje 
              ,sum(case when a.kmdm in ('100101','100102','1012') then a.qmje else 0 end) as dsje 
 into #zjyezb 
 from ds_t_cnrjzzzb a where 1=1 and ny=@jsny and a.kmdm in ('100201','100202','100101','100102','1012') group by a.tzid ;


if '2'='1' 
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,max(zj.dgje) as dgje,
       max(zj.dsje) as dsje,max(zc.sjcnzc) as sjcnzc,max(zc.xjcnzc) as xjcnzc,max(zc.ddcnzc) as ddcnzc,
       max(zc.xxjcnzc) as xxjcnzc,max(zc.xdddcnzc) as xdddcnzc,
       max(zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc) as cnzc,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
       sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
       sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy,
       max(allys.ys_allgsfy) as ys_allgsfy, max(allys.ys_allddfy) as ys_allddfy 
       ,max(wl.sr) as wlsr,max(wl.zc) as wlzc,max(wl.zc)-max(wl.sr) as wlce    
   from #tmp_khb kh left outer join #fyb a on kh.sskhid=a.sskhid and kh.khid=a.khid  and a.ny>=@ksny and a.ny<=@jsny
   left outer join #jhb b on kh.sskhid=b.sskhid and kh.khid=b.khid and b.ny>=@ksny and b.ny>=@jsny  
   left outer join #fyb c on kh.sskhid=c.sskhid and kh.khid=c.khid and c.ny>=@tqksny and c.ny<=@tqjsny and right(a.ny,2)=right(c.ny,2) 
        and a.sj_hjfy>0 and c.sj_hjfy>0 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.sskhid=allys.sskhid 
   left outer join #cnzc zc on kh.sskhid=zc.sskhid 
   left outer join #zjyezb zj on kh.sskhid=zj.tzid  
   left join #wlk wl on kh.sskhid=wl.tzid
   where 1=1 
   group by kh.sskhid,kh.sskhmc,kh.sskhdm,kh.sfmc   
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 

if '2'='2' or '2'=''
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb 
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq   
       ,zj.dgje,zj.dsje,zc.sjcnzc,zc.xjcnzc,zc.ddcnzc, 
       zc.xxjcnzc,zc.xdddcnzc,
       zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc as cnzc,
       allys.ys_allgsfy,allys.ys_allddfy  
       ,wl.sr as wlsr,wl.zc as wlzc,wl.zc-wl.sr as wlce 
    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.tq_gsfy) as tq_gsfy, sum(c.tq_ddgsfy) as tq_ddgsfy,
       sum(c.tq_ddfy) as tq_ddfy, sum(c.tq_xdddgsfy) as tq_xdddgsfy,
       sum(c.tq_xdddfy) as tq_xdddfy,sum(c.tq_hjfy) as tq_hjfy
   from #tmp_khb kh 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as sj_gsfy, sum(c.sj_ddgsfy) as sj_ddgsfy,
              sum(c.sj_ddfy) as sj_ddfy, sum(c.sj_xdddgsfy) as sj_xdddgsfy,
              sum(c.sj_xdddfy) as sj_xdddfy,sum(c.sj_hjfy) as sj_hjfy  
       from #fyb c where c.ny>=@ksny and c.ny<=@jsny group by c.sskhid,c.khid 
   ) a on kh.sskhid=a.sskhid and kh.khid=a.khid 
   left outer join (select sskhid,khid,sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy from #jhb b where b.ny>=@ksny and b.ny<=@jsny group by sskhid,khid) b 
   on kh.sskhid=b.sskhid and kh.khid=b.khid 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
              sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
              sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy  
       from #fyb c where c.ny>=@tqksny and c.ny<=@tqjsny group by c.sskhid,c.khid 
   ) c on kh.sskhid=c.sskhid and kh.khid=c.khid 
   group by kh.sskhdm,kh.sskhid,kh.sskhmc,kh.sfmc  
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.khid=allys.sskhid 
   left outer join #cnzc zc on a.khid=zc.sskhid 
   left outer join #zjyezb zj on a.khid=zj.tzid 
   left join #wlk wl on a.khid=wl.tzid;

drop table #tmp_khb;
drop table #jhb;
drop table #fyb1 ;
drop table #fyb2 ;
drop table #fyb ;
drop table #sykmdm ;
drop table #cnzc ;
drop table #zjyezb ;
drop table #wlk;
 

2017-8-22 10:44:28  declare @ksny varchar(6); 
declare @jsny varchar(6); 
declare @tqksny varchar(6); 
declare @tqjsny varchar(6); 
declare @jsrq datetime ;
declare @ksrq datetime ;
declare @tqjsrq varchar(10); 
declare @tqksrq varchar(10);

select @ksny=convert(varchar(6),cast('2017-08-01' as datetime),112);
select @jsny=convert(varchar(6),cast('2017-08-22' as datetime),112);
select @tqksny=convert(varchar(6),dateadd(year,-1,cast('2017-08-01' as datetime)),112);/*上一年度*/
select @tqjsny=convert(varchar(6),dateadd(year,-1,cast('2017-08-22' as datetime)),112);
set @ksrq='2017-08-01' ;
set @jsrq='2017-08-22' ;
select @tqksrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-01' as datetime)) ,120); 
select @tqjsrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-22' as datetime)) ,120); 

select a.* into #tmp_khb from ( 
    select distinct b.khid,a.khid sskhid,a.khdm as sskhdm,a.khjc as sskhmc,b.khmc,b.ccid,gx.ksny,gx.jsny,b.ssid,c.mc as sfmc,a.lxr,
           case when Convert(varchar(6),isnull(gx.sjkyrq,'1900-01-01'),112) between @ksny and @jsny then 1 else 0 end as xdbs   
    from yx_t_khb a 
    left join  [192.168.35.10].tlsoft.dbo.yx_t_khsfdm c on a.sfdm=c.dm   
    inner join yx_t_khb b on a.ssid=1 and a.khlbdm<>'g' and (b.ccid+'-' like a.ccid+'-%')  and a.khid>1 
    left outer join yx_t_khgxb gx on gx.khid=case when b.khlbdm in ('D','d') then b.ssid else a.khid end and b.khid=gx.gxid and (gx.ksny<=@jsny and gx.jsny>=@ksny) 
    where 1=1 and a.khid not in(85,1384,14204) and len(a.dzbbpx)>0 and b.khmc not like '%直销户%' and b.ty=0 
          and a.khfl like 'x%' and isnull(gx.qtlx,0)=0   /*and b.khfl='xz'*/
) as a ; 

select * into #jhb from (
    select 'ys' as cs,b.ny,1 as xh,a.sskhid,a.khid,
           sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-1 then b.je else 0 end) as ys_gsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=0 then b.je else 0 end) as ys_ddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=0 then b.je else 0 end) as ys_ddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=1 then b.je else 0 end) as ys_xdddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=1 then b.je else 0 end) as ys_xdddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny then b.je else 0 end) as ys_hjfy, 
	sum(b.je) as ys_allfy 
    from #tmp_khb a inner join zw_t_fyjh_kz b on a.khid=b.tzid where b.nd=left(@ksny,4) and b.djlx=12457 /*(b.ny>=@ksny and b.ny<=@jsny) */
    and b.ny>=a.ksny and b.ny<=a.jsny
    group by b.ny,a.sskhid,a.khid    
) a ;
 /*同期实际开支*/
   select 'sjfy' as cs,b.nd,b.ny,1 as xh,a.sskhid,a.khid,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' then b.je else 0 end) as sj_gsfy,  
   sum(case when a.khid=b.khid and b.sjlx='ddmy' and a.xdbs=0 then b.je else 0 end) as sj_ddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=0 then b.je else 0 end) as sj_ddfy,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddfy
   /*,sum(b.je) as sj_hjfy*/
   into #fyb2 
   from #tmp_khb a inner join  [192.168.35.10].tlsoft.dbo.rs_t_yxsjfyb b on a.khid=b.khid 
   where b.nd=2016 and b.khid>0 and b.sjlx in ('sjfy','ddmy') and b.ny>='201603' and b.ny<='201702' 
         and ((b.ny>=@ksny and b.ny<=@jsny) or (b.ny>=@tqksny and b.ny<=@tqjsny) )
    group by b.nd,b.ny,a.sskhid,a.khid;
 /*本期实际开支*/
 select a.* into #fyb1 from (
   /*日常开支，店租费用，税务费用，个人借款，个人花费，差旅费，工资,固定资产*/
   select a.cs,dbo.f_Zw_kjnd(a.khid,a.rq) as nd,convert(varchar(6),a.rq,112) as ny,1 as xh,kh.sskhid,kh.khid,
   sum(case when ((a.jb='xf' and a.bxlx=0) or (a.bxlx=1 and a.jb!='xz')) then a.hdje else 0 end) as sj_gsfy,  
   sum(case when a.jb='mydd' and a.bxlx=0 and kh.xdbs=0  then a.hdje else 0 end) as sj_ddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=0 then a.hdje else 0 end) as sj_ddfy, 
   sum(case when a.jb='mydd'  and a.bxlx=0 and kh.xdbs=1  then a.hdje else 0 end) as sj_xdddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=1 then a.hdje else 0 end) as sj_xdddfy  
  from zw_v_sjkzfy a
  inner join #tmp_khb kh on a.khid=kh.khid 
  where a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.pzbs=1
  group by dbo.f_Zw_kjnd(a.khid,a.rq),convert(varchar(6),a.rq,112) ,kh.sskhid,kh.khid,a.cs
) a 


select *,sj_gsfy+sj_ddgsfy+sj_ddfy+sj_xdddgsfy+sj_xdddfy as sj_hjfy into #fyb 
from (
   select * from #fyb1   
   union all 
   select * from #fyb2 
) a ;

 /*往来款*/
 select a.tzid,sum(jfje) as sr,sum(dfje) as zc
 into #wlk 
 from Zw_T_Cnrjz as a 
 inner join ( select kmdm from zw_t_kmsdb where djlx='12460' and xjdfkm=6982 and tzid=1 and scxe=1  ) b on a.dfkm=b.kmdm
 where a.lylx in (311,312,316,321,322,323,0,826) 
  and  a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.nd=dbo.f_zw_kjnd(a.tzid,@jsrq) 
 group by a.tzid


  select a.sskhid,km.kmdm into #sykmdm from (select sskhid from #tmp_khb group by sskhid) a 
  inner join zw_t_zwkmb km on a.sskhid=km.tzid 
  where km.nd=2017 and km.kzlb=1 
  group by a.sskhid,km.kmdm ;

 select a.sskhid,sum(xjcnzc) as xjcnzc,sum(xxjcnzc) as xxjcnzc,sum(sjcnzc) as sjcnzc,sum(ddcnzc) as ddcnzc,sum(xdddcnzc) as xdddcnzc 
        into #cnzc 
 from (
    select a.sskhid,sum(case when b.khid>0  and b.khid!=b.tzid and isnull(kh.xdbs,0)=0 then b.dfje else 0 end) as xjcnzc,
           sum(case when b.khid>0  and b.khid!=b.tzid and kh.xdbs=1 then b.dfje else 0 end) as xxjcnzc,
           sum(case when (b.khid=0 or b.khid=b.tzid) then b.dfje else 0 end) as sjcnzc,0 as ddcnzc,0 as xdddcnzc
    from #sykmdm a inner join zw_t_cnrjz b on a.sskhid=b.tzid and a.kmdm=b.dfkm and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq)   
    left outer join #tmp_khb kh on b.khid=kh.khid 
    group by a.sskhid 
    union all 
    select a.sskhid,0 as xjcnzc,0 as xxjcnzc,0 as sjcnzc,sum(case when a.xdbs=0 then dfje else 0 end) as ddcnzc,
           sum(case when a.xdbs=1 then dfje else 0 end) as xdddcnzc 
	from (select sskhid,khid,xdbs from #tmp_khb group by sskhid,khid,xdbs) a 
    inner join zw_t_cnrjz b on a.sskhid=b.tzid and b.khid=a.khid and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq) and b.dfkm='122111' 
    and b.khid>0 group by a.sskhid 
 ) a group by a.sskhid;


/*资金余额[对公，对私]*/
 select a.tzid,sum(case when a.kmdm in ('100201','100202') then a.qmje else 0 end) as dgje 
              ,sum(case when a.kmdm in ('100101','100102','1012') then a.qmje else 0 end) as dsje 
 into #zjyezb 
 from ds_t_cnrjzzzb a where 1=1 and ny=@jsny and a.kmdm in ('100201','100202','100101','100102','1012') group by a.tzid ;


if '2'='1' 
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,max(zj.dgje) as dgje,
       max(zj.dsje) as dsje,max(zc.sjcnzc) as sjcnzc,max(zc.xjcnzc) as xjcnzc,max(zc.ddcnzc) as ddcnzc,
       max(zc.xxjcnzc) as xxjcnzc,max(zc.xdddcnzc) as xdddcnzc,
       max(zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc) as cnzc,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
       sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
       sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy,
       max(allys.ys_allgsfy) as ys_allgsfy, max(allys.ys_allddfy) as ys_allddfy 
       ,max(wl.sr) as wlsr,max(wl.zc) as wlzc,max(wl.zc)-max(wl.sr) as wlce    
   from #tmp_khb kh left outer join #fyb a on kh.sskhid=a.sskhid and kh.khid=a.khid  and a.ny>=@ksny and a.ny<=@jsny
   left outer join #jhb b on kh.sskhid=b.sskhid and kh.khid=b.khid and b.ny>=@ksny and b.ny>=@jsny  
   left outer join #fyb c on kh.sskhid=c.sskhid and kh.khid=c.khid and c.ny>=@tqksny and c.ny<=@tqjsny and right(a.ny,2)=right(c.ny,2) 
        and a.sj_hjfy>0 and c.sj_hjfy>0 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.sskhid=allys.sskhid 
   left outer join #cnzc zc on kh.sskhid=zc.sskhid 
   left outer join #zjyezb zj on kh.sskhid=zj.tzid  
   left join #wlk wl on kh.sskhid=wl.tzid
   where 1=1 
   group by kh.sskhid,kh.sskhmc,kh.sskhdm,kh.sfmc   
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 

if '2'='2' or '2'=''
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb 
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq   
       ,zj.dgje,zj.dsje,zc.sjcnzc,zc.xjcnzc,zc.ddcnzc, 
       zc.xxjcnzc,zc.xdddcnzc,
       zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc as cnzc,
       allys.ys_allgsfy,allys.ys_allddfy  
       ,wl.sr as wlsr,wl.zc as wlzc,wl.zc-wl.sr as wlce 
    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.tq_gsfy) as tq_gsfy, sum(c.tq_ddgsfy) as tq_ddgsfy,
       sum(c.tq_ddfy) as tq_ddfy, sum(c.tq_xdddgsfy) as tq_xdddgsfy,
       sum(c.tq_xdddfy) as tq_xdddfy,sum(c.tq_hjfy) as tq_hjfy
   from #tmp_khb kh 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as sj_gsfy, sum(c.sj_ddgsfy) as sj_ddgsfy,
              sum(c.sj_ddfy) as sj_ddfy, sum(c.sj_xdddgsfy) as sj_xdddgsfy,
              sum(c.sj_xdddfy) as sj_xdddfy,sum(c.sj_hjfy) as sj_hjfy  
       from #fyb c where c.ny>=@ksny and c.ny<=@jsny group by c.sskhid,c.khid 
   ) a on kh.sskhid=a.sskhid and kh.khid=a.khid 
   left outer join (select sskhid,khid,sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy from #jhb b where b.ny>=@ksny and b.ny<=@jsny group by sskhid,khid) b 
   on kh.sskhid=b.sskhid and kh.khid=b.khid 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
              sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
              sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy  
       from #fyb c where c.ny>=@tqksny and c.ny<=@tqjsny group by c.sskhid,c.khid 
   ) c on kh.sskhid=c.sskhid and kh.khid=c.khid 
   group by kh.sskhdm,kh.sskhid,kh.sskhmc,kh.sfmc  
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.khid=allys.sskhid 
   left outer join #cnzc zc on a.khid=zc.sskhid 
   left outer join #zjyezb zj on a.khid=zj.tzid 
   left join #wlk wl on a.khid=wl.tzid;

drop table #tmp_khb;
drop table #jhb;
drop table #fyb1 ;
drop table #fyb2 ;
drop table #fyb ;
drop table #sykmdm ;
drop table #cnzc ;
drop table #zjyezb ;
drop table #wlk;
 

2017-8-22 10:45:07  declare @ksny varchar(6); 
declare @jsny varchar(6); 
declare @tqksny varchar(6); 
declare @tqjsny varchar(6); 
declare @jsrq datetime ;
declare @ksrq datetime ;
declare @tqjsrq varchar(10); 
declare @tqksrq varchar(10);

select @ksny=convert(varchar(6),cast('2017-08-01' as datetime),112);
select @jsny=convert(varchar(6),cast('2017-08-22' as datetime),112);
select @tqksny=convert(varchar(6),dateadd(year,-1,cast('2017-08-01' as datetime)),112);/*上一年度*/
select @tqjsny=convert(varchar(6),dateadd(year,-1,cast('2017-08-22' as datetime)),112);
set @ksrq='2017-08-01' ;
set @jsrq='2017-08-22' ;
select @tqksrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-01' as datetime)) ,120); 
select @tqjsrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-22' as datetime)) ,120); 

select a.* into #tmp_khb from ( 
    select distinct b.khid,a.khid sskhid,a.khdm as sskhdm,a.khjc as sskhmc,b.khmc,b.ccid,gx.ksny,gx.jsny,b.ssid,c.mc as sfmc,a.lxr,
           case when Convert(varchar(6),isnull(gx.sjkyrq,'1900-01-01'),112) between @ksny and @jsny then 1 else 0 end as xdbs   
    from yx_t_khb a 
    left join  [192.168.35.10].tlsoft.dbo.yx_t_khsfdm c on a.sfdm=c.dm   
    inner join yx_t_khb b on a.ssid=1 and a.khlbdm<>'g' and (b.ccid+'-' like a.ccid+'-%')  and a.khid>1 
    left outer join yx_t_khgxb gx on gx.khid=case when b.khlbdm in ('D','d') then b.ssid else a.khid end and b.khid=gx.gxid and (gx.ksny<=@jsny and gx.jsny>=@ksny) 
    where 1=1 and a.khid not in(85,1384,14204) and len(a.dzbbpx)>0 and b.khmc not like '%直销户%' and b.ty=0 
          and a.khfl like 'x%' and isnull(gx.qtlx,0)=0   /*and b.khfl='xz'*/
) as a ; 

select * into #jhb from (
    select 'ys' as cs,b.ny,1 as xh,a.sskhid,a.khid,
           sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-1 then b.je else 0 end) as ys_gsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=0 then b.je else 0 end) as ys_ddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=0 then b.je else 0 end) as ys_ddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=1 then b.je else 0 end) as ys_xdddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=1 then b.je else 0 end) as ys_xdddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny then b.je else 0 end) as ys_hjfy, 
	sum(b.je) as ys_allfy 
    from #tmp_khb a inner join zw_t_fyjh_kz b on a.khid=b.tzid where b.nd=left(@ksny,4) and b.djlx=12457 /*(b.ny>=@ksny and b.ny<=@jsny) */
    and b.ny>=a.ksny and b.ny<=a.jsny
    group by b.ny,a.sskhid,a.khid    
) a ;
 /*同期实际开支*/
   select 'sjfy' as cs,b.nd,b.ny,1 as xh,a.sskhid,a.khid,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' then b.je else 0 end) as sj_gsfy,  
   sum(case when a.khid=b.khid and b.sjlx='ddmy' and a.xdbs=0 then b.je else 0 end) as sj_ddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=0 then b.je else 0 end) as sj_ddfy,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddfy
   /*,sum(b.je) as sj_hjfy*/
   into #fyb2 
   from #tmp_khb a inner join  [192.168.35.10].tlsoft.dbo.rs_t_yxsjfyb b on a.khid=b.khid 
   where b.nd=2016 and b.khid>0 and b.sjlx in ('sjfy','ddmy') and b.ny>='201603' and b.ny<='201702' 
         and ((b.ny>=@ksny and b.ny<=@jsny) or (b.ny>=@tqksny and b.ny<=@tqjsny) )
    group by b.nd,b.ny,a.sskhid,a.khid;
 /*本期实际开支*/
 select a.* into #fyb1 from (
   /*日常开支，店租费用，税务费用，个人借款，个人花费，差旅费，工资,固定资产*/
   select a.cs,dbo.f_Zw_kjnd(a.khid,a.rq) as nd,convert(varchar(6),a.rq,112) as ny,1 as xh,kh.sskhid,kh.khid,
   sum(case when ((a.jb='xf' and a.bxlx=0) or (a.bxlx=1 and a.jb!='xz')) then a.hdje else 0 end) as sj_gsfy,  
   sum(case when a.jb='mydd' and a.bxlx=0 and kh.xdbs=0  then a.hdje else 0 end) as sj_ddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=0 then a.hdje else 0 end) as sj_ddfy, 
   sum(case when a.jb='mydd'  and a.bxlx=0 and kh.xdbs=1  then a.hdje else 0 end) as sj_xdddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=1 then a.hdje else 0 end) as sj_xdddfy  
  from zw_v_sjkzfy a
  inner join #tmp_khb kh on a.khid=kh.khid 
  where a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.pzbs=1
  group by dbo.f_Zw_kjnd(a.khid,a.rq),convert(varchar(6),a.rq,112) ,kh.sskhid,kh.khid,a.cs
) a 


select *,sj_gsfy+sj_ddgsfy+sj_ddfy+sj_xdddgsfy+sj_xdddfy as sj_hjfy into #fyb 
from (
   select * from #fyb1   
   union all 
   select * from #fyb2 
) a ;

 /*往来款*/
 select a.tzid,sum(jfje) as sr,sum(dfje) as zc
 into #wlk 
 from Zw_T_Cnrjz as a 
 inner join ( select kmdm from zw_t_kmsdb where djlx='12460' and xjdfkm=6982 and tzid=1 and scxe=1  ) b on a.dfkm=b.kmdm
 where a.lylx in (311,312,316,321,322,323,0,826) 
  and  a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.nd=dbo.f_zw_kjnd(a.tzid,@jsrq) 
 group by a.tzid


  select a.sskhid,km.kmdm into #sykmdm from (select sskhid from #tmp_khb group by sskhid) a 
  inner join zw_t_zwkmb km on a.sskhid=km.tzid 
  where km.nd=2017 and km.kzlb=1 
  group by a.sskhid,km.kmdm ;

 select a.sskhid,sum(xjcnzc) as xjcnzc,sum(xxjcnzc) as xxjcnzc,sum(sjcnzc) as sjcnzc,sum(ddcnzc) as ddcnzc,sum(xdddcnzc) as xdddcnzc 
        into #cnzc 
 from (
    select a.sskhid,sum(case when b.khid>0  and b.khid!=b.tzid and isnull(kh.xdbs,0)=0 then b.dfje else 0 end) as xjcnzc,
           sum(case when b.khid>0  and b.khid!=b.tzid and kh.xdbs=1 then b.dfje else 0 end) as xxjcnzc,
           sum(case when (b.khid=0 or b.khid=b.tzid) then b.dfje else 0 end) as sjcnzc,0 as ddcnzc,0 as xdddcnzc
    from #sykmdm a inner join zw_t_cnrjz b on a.sskhid=b.tzid and a.kmdm=b.dfkm and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq)   
    left outer join #tmp_khb kh on b.khid=kh.khid 
    group by a.sskhid 
    union all 
    select a.sskhid,0 as xjcnzc,0 as xxjcnzc,0 as sjcnzc,sum(case when a.xdbs=0 then dfje else 0 end) as ddcnzc,
           sum(case when a.xdbs=1 then dfje else 0 end) as xdddcnzc 
	from (select sskhid,khid,xdbs from #tmp_khb group by sskhid,khid,xdbs) a 
    inner join zw_t_cnrjz b on a.sskhid=b.tzid and b.khid=a.khid and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq) and b.dfkm='122111' 
    and b.khid>0 group by a.sskhid 
 ) a group by a.sskhid;


/*资金余额[对公，对私]*/
 select a.tzid,sum(case when a.kmdm in ('100201','100202') then a.qmje else 0 end) as dgje 
              ,sum(case when a.kmdm in ('100101','100102','1012') then a.qmje else 0 end) as dsje 
 into #zjyezb 
 from ds_t_cnrjzzzb a where 1=1 and ny=@jsny and a.kmdm in ('100201','100202','100101','100102','1012') group by a.tzid ;


if '2'='1' 
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,max(zj.dgje) as dgje,
       max(zj.dsje) as dsje,max(zc.sjcnzc) as sjcnzc,max(zc.xjcnzc) as xjcnzc,max(zc.ddcnzc) as ddcnzc,
       max(zc.xxjcnzc) as xxjcnzc,max(zc.xdddcnzc) as xdddcnzc,
       max(zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc) as cnzc,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
       sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
       sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy,
       max(allys.ys_allgsfy) as ys_allgsfy, max(allys.ys_allddfy) as ys_allddfy 
       ,max(wl.sr) as wlsr,max(wl.zc) as wlzc,max(wl.zc)-max(wl.sr) as wlce    
   from #tmp_khb kh left outer join #fyb a on kh.sskhid=a.sskhid and kh.khid=a.khid  and a.ny>=@ksny and a.ny<=@jsny
   left outer join #jhb b on kh.sskhid=b.sskhid and kh.khid=b.khid and b.ny>=@ksny and b.ny>=@jsny  
   left outer join #fyb c on kh.sskhid=c.sskhid and kh.khid=c.khid and c.ny>=@tqksny and c.ny<=@tqjsny and right(a.ny,2)=right(c.ny,2) 
        and a.sj_hjfy>0 and c.sj_hjfy>0 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.sskhid=allys.sskhid 
   left outer join #cnzc zc on kh.sskhid=zc.sskhid 
   left outer join #zjyezb zj on kh.sskhid=zj.tzid  
   left join #wlk wl on kh.sskhid=wl.tzid
   where 1=1 
   group by kh.sskhid,kh.sskhmc,kh.sskhdm,kh.sfmc   
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 

if '2'='2' or '2'=''
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb 
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq   
       ,zj.dgje,zj.dsje,zc.sjcnzc,zc.xjcnzc,zc.ddcnzc, 
       zc.xxjcnzc,zc.xdddcnzc,
       zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc as cnzc,
       allys.ys_allgsfy,allys.ys_allddfy  
       ,wl.sr as wlsr,wl.zc as wlzc,wl.zc-wl.sr as wlce 
    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.tq_gsfy) as tq_gsfy, sum(c.tq_ddgsfy) as tq_ddgsfy,
       sum(c.tq_ddfy) as tq_ddfy, sum(c.tq_xdddgsfy) as tq_xdddgsfy,
       sum(c.tq_xdddfy) as tq_xdddfy,sum(c.tq_hjfy) as tq_hjfy
   from #tmp_khb kh 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as sj_gsfy, sum(c.sj_ddgsfy) as sj_ddgsfy,
              sum(c.sj_ddfy) as sj_ddfy, sum(c.sj_xdddgsfy) as sj_xdddgsfy,
              sum(c.sj_xdddfy) as sj_xdddfy,sum(c.sj_hjfy) as sj_hjfy  
       from #fyb c where c.ny>=@ksny and c.ny<=@jsny group by c.sskhid,c.khid 
   ) a on kh.sskhid=a.sskhid and kh.khid=a.khid 
   left outer join (select sskhid,khid,sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy from #jhb b where b.ny>=@ksny and b.ny<=@jsny group by sskhid,khid) b 
   on kh.sskhid=b.sskhid and kh.khid=b.khid 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
              sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
              sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy  
       from #fyb c where c.ny>=@tqksny and c.ny<=@tqjsny group by c.sskhid,c.khid 
   ) c on kh.sskhid=c.sskhid and kh.khid=c.khid 
   group by kh.sskhdm,kh.sskhid,kh.sskhmc,kh.sfmc  
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.khid=allys.sskhid 
   left outer join #cnzc zc on a.khid=zc.sskhid 
   left outer join #zjyezb zj on a.khid=zj.tzid 
   left join #wlk wl on a.khid=wl.tzid;

drop table #tmp_khb;
drop table #jhb;
drop table #fyb1 ;
drop table #fyb2 ;
drop table #fyb ;
drop table #sykmdm ;
drop table #cnzc ;
drop table #zjyezb ;
drop table #wlk;
 

2017-8-22 10:47:35  declare @ksny varchar(6); 
declare @jsny varchar(6); 
declare @tqksny varchar(6); 
declare @tqjsny varchar(6); 
declare @jsrq datetime ;
declare @ksrq datetime ;
declare @tqjsrq varchar(10); 
declare @tqksrq varchar(10);

select @ksny=convert(varchar(6),cast('2017-08-01' as datetime),112);
select @jsny=convert(varchar(6),cast('2017-08-22' as datetime),112);
select @tqksny=convert(varchar(6),dateadd(year,-1,cast('2017-08-01' as datetime)),112);/*上一年度*/
select @tqjsny=convert(varchar(6),dateadd(year,-1,cast('2017-08-22' as datetime)),112);
set @ksrq='2017-08-01' ;
set @jsrq='2017-08-22' ;
select @tqksrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-01' as datetime)) ,120); 
select @tqjsrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-22' as datetime)) ,120); 

select a.* into #tmp_khb from ( 
    select distinct b.khid,a.khid sskhid,a.khdm as sskhdm,a.khjc as sskhmc,b.khmc,b.ccid,gx.ksny,gx.jsny,b.ssid,c.mc as sfmc,a.lxr,
           case when Convert(varchar(6),isnull(gx.sjkyrq,'1900-01-01'),112) between @ksny and @jsny then 1 else 0 end as xdbs   
    from yx_t_khb a 
    left join  [192.168.35.10].tlsoft.dbo.yx_t_khsfdm c on a.sfdm=c.dm   
    inner join yx_t_khb b on a.ssid=1 and a.khlbdm<>'g' and (b.ccid+'-' like a.ccid+'-%')  and a.khid>1 
    left outer join yx_t_khgxb gx on gx.khid=case when b.khlbdm in ('D','d') then b.ssid else a.khid end and b.khid=gx.gxid and (gx.ksny<=@jsny and gx.jsny>=@ksny) 
    where 1=1 and a.khid not in(85,1384,14204) and len(a.dzbbpx)>0 and b.khmc not like '%直销户%' and b.ty=0 
          and a.khfl like 'x%' and isnull(gx.qtlx,0)=0   /*and b.khfl='xz'*/
) as a ; 

select * into #jhb from (
    select 'ys' as cs,b.ny,1 as xh,a.sskhid,a.khid,
           sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-1 then b.je else 0 end) as ys_gsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=0 then b.je else 0 end) as ys_ddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=0 then b.je else 0 end) as ys_ddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=1 then b.je else 0 end) as ys_xdddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=1 then b.je else 0 end) as ys_xdddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny then b.je else 0 end) as ys_hjfy, 
	sum(b.je) as ys_allfy 
    from #tmp_khb a inner join zw_t_fyjh_kz b on a.khid=b.tzid where b.nd=left(@ksny,4) and b.djlx=12457 /*(b.ny>=@ksny and b.ny<=@jsny) */
    and b.ny>=a.ksny and b.ny<=a.jsny
    group by b.ny,a.sskhid,a.khid    
) a ;
 /*同期实际开支*/
   select 'sjfy' as cs,b.nd,b.ny,1 as xh,a.sskhid,a.khid,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' then b.je else 0 end) as sj_gsfy,  
   sum(case when a.khid=b.khid and b.sjlx='ddmy' and a.xdbs=0 then b.je else 0 end) as sj_ddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=0 then b.je else 0 end) as sj_ddfy,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddfy
   /*,sum(b.je) as sj_hjfy*/
   into #fyb2 
   from #tmp_khb a inner join  [192.168.35.10].tlsoft.dbo.rs_t_yxsjfyb b on a.khid=b.khid 
   where b.nd=2016 and b.khid>0 and b.sjlx in ('sjfy','ddmy') and b.ny>='201603' and b.ny<='201702' 
         and ((b.ny>=@ksny and b.ny<=@jsny) or (b.ny>=@tqksny and b.ny<=@tqjsny) )
    group by b.nd,b.ny,a.sskhid,a.khid;
 /*本期实际开支*/
 select a.* into #fyb1 from (
   /*日常开支，店租费用，税务费用，个人借款，个人花费，差旅费，工资,固定资产*/
   select a.cs,dbo.f_Zw_kjnd(a.khid,a.rq) as nd,convert(varchar(6),a.rq,112) as ny,1 as xh,kh.sskhid,kh.khid,
   sum(case when ((a.jb='xf' and a.bxlx=0) or (a.bxlx=1 and a.jb!='xz')) then a.hdje else 0 end) as sj_gsfy,  
   sum(case when a.jb='mydd' and a.bxlx=0 and kh.xdbs=0  then a.hdje else 0 end) as sj_ddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=0 then a.hdje else 0 end) as sj_ddfy, 
   sum(case when a.jb='mydd'  and a.bxlx=0 and kh.xdbs=1  then a.hdje else 0 end) as sj_xdddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=1 then a.hdje else 0 end) as sj_xdddfy  
  from zw_v_sjkzfy a
  inner join #tmp_khb kh on a.khid=kh.khid 
  where a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.pzbs=1
  group by dbo.f_Zw_kjnd(a.khid,a.rq),convert(varchar(6),a.rq,112) ,kh.sskhid,kh.khid,a.cs
) a 


select *,sj_gsfy+sj_ddgsfy+sj_ddfy+sj_xdddgsfy+sj_xdddfy as sj_hjfy into #fyb 
from (
   select * from #fyb1   
   union all 
   select * from #fyb2 
) a ;

 /*往来款*/
 select a.tzid,sum(jfje) as sr,sum(dfje) as zc
 into #wlk 
 from Zw_T_Cnrjz as a 
 inner join ( select kmdm from zw_t_kmsdb where djlx='12460' and xjdfkm=6982 and tzid=1 and scxe=1  ) b on a.dfkm=b.kmdm
 where a.lylx in (311,312,316,321,322,323,0,826) 
  and  a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.nd=dbo.f_zw_kjnd(a.tzid,@jsrq) 
 group by a.tzid


  select a.sskhid,km.kmdm into #sykmdm from (select sskhid from #tmp_khb group by sskhid) a 
  inner join zw_t_zwkmb km on a.sskhid=km.tzid 
  where km.nd=2017 and km.kzlb=1 
  group by a.sskhid,km.kmdm ;

 select a.sskhid,sum(xjcnzc) as xjcnzc,sum(xxjcnzc) as xxjcnzc,sum(sjcnzc) as sjcnzc,sum(ddcnzc) as ddcnzc,sum(xdddcnzc) as xdddcnzc 
        into #cnzc 
 from (
    select a.sskhid,sum(case when b.khid>0  and b.khid!=b.tzid and isnull(kh.xdbs,0)=0 then b.dfje else 0 end) as xjcnzc,
           sum(case when b.khid>0  and b.khid!=b.tzid and kh.xdbs=1 then b.dfje else 0 end) as xxjcnzc,
           sum(case when (b.khid=0 or b.khid=b.tzid) then b.dfje else 0 end) as sjcnzc,0 as ddcnzc,0 as xdddcnzc
    from #sykmdm a inner join zw_t_cnrjz b on a.sskhid=b.tzid and a.kmdm=b.dfkm and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq)   
    left outer join #tmp_khb kh on b.khid=kh.khid 
    group by a.sskhid 
    union all 
    select a.sskhid,0 as xjcnzc,0 as xxjcnzc,0 as sjcnzc,sum(case when a.xdbs=0 then dfje else 0 end) as ddcnzc,
           sum(case when a.xdbs=1 then dfje else 0 end) as xdddcnzc 
	from (select sskhid,khid,xdbs from #tmp_khb group by sskhid,khid,xdbs) a 
    inner join zw_t_cnrjz b on a.sskhid=b.tzid and b.khid=a.khid and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq) and b.dfkm='122111' 
    and b.khid>0 group by a.sskhid 
 ) a group by a.sskhid;


/*资金余额[对公，对私]*/
 select a.tzid,sum(case when a.kmdm in ('100201','100202') then a.qmje else 0 end) as dgje 
              ,sum(case when a.kmdm in ('100101','100102','1012') then a.qmje else 0 end) as dsje 
 into #zjyezb 
 from ds_t_cnrjzzzb a where 1=1 and ny=@jsny and a.kmdm in ('100201','100202','100101','100102','1012') group by a.tzid ;


if '2'='1' 
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,max(zj.dgje) as dgje,
       max(zj.dsje) as dsje,max(zc.sjcnzc) as sjcnzc,max(zc.xjcnzc) as xjcnzc,max(zc.ddcnzc) as ddcnzc,
       max(zc.xxjcnzc) as xxjcnzc,max(zc.xdddcnzc) as xdddcnzc,
       max(zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc) as cnzc,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
       sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
       sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy,
       max(allys.ys_allgsfy) as ys_allgsfy, max(allys.ys_allddfy) as ys_allddfy 
       ,max(wl.sr) as wlsr,max(wl.zc) as wlzc,max(wl.zc)-max(wl.sr) as wlce    
   from #tmp_khb kh left outer join #fyb a on kh.sskhid=a.sskhid and kh.khid=a.khid  and a.ny>=@ksny and a.ny<=@jsny
   left outer join #jhb b on kh.sskhid=b.sskhid and kh.khid=b.khid and b.ny>=@ksny and b.ny>=@jsny  
   left outer join #fyb c on kh.sskhid=c.sskhid and kh.khid=c.khid and c.ny>=@tqksny and c.ny<=@tqjsny and right(a.ny,2)=right(c.ny,2) 
        and a.sj_hjfy>0 and c.sj_hjfy>0 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.sskhid=allys.sskhid 
   left outer join #cnzc zc on kh.sskhid=zc.sskhid 
   left outer join #zjyezb zj on kh.sskhid=zj.tzid  
   left join #wlk wl on kh.sskhid=wl.tzid
   where 1=1 
   group by kh.sskhid,kh.sskhmc,kh.sskhdm,kh.sfmc   
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 

if '2'='2' or '2'=''
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb 
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq   
       ,zj.dgje,zj.dsje,zc.sjcnzc,zc.xjcnzc,zc.ddcnzc, 
       zc.xxjcnzc,zc.xdddcnzc,
       zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc as cnzc,
       allys.ys_allgsfy,allys.ys_allddfy  
       ,wl.sr as wlsr,wl.zc as wlzc,wl.zc-wl.sr as wlce 
    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.tq_gsfy) as tq_gsfy, sum(c.tq_ddgsfy) as tq_ddgsfy,
       sum(c.tq_ddfy) as tq_ddfy, sum(c.tq_xdddgsfy) as tq_xdddgsfy,
       sum(c.tq_xdddfy) as tq_xdddfy,sum(c.tq_hjfy) as tq_hjfy
   from #tmp_khb kh 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as sj_gsfy, sum(c.sj_ddgsfy) as sj_ddgsfy,
              sum(c.sj_ddfy) as sj_ddfy, sum(c.sj_xdddgsfy) as sj_xdddgsfy,
              sum(c.sj_xdddfy) as sj_xdddfy,sum(c.sj_hjfy) as sj_hjfy  
       from #fyb c where c.ny>=@ksny and c.ny<=@jsny group by c.sskhid,c.khid 
   ) a on kh.sskhid=a.sskhid and kh.khid=a.khid 
   left outer join (select sskhid,khid,sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy from #jhb b where b.ny>=@ksny and b.ny<=@jsny group by sskhid,khid) b 
   on kh.sskhid=b.sskhid and kh.khid=b.khid 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
              sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
              sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy  
       from #fyb c where c.ny>=@tqksny and c.ny<=@tqjsny group by c.sskhid,c.khid 
   ) c on kh.sskhid=c.sskhid and kh.khid=c.khid 
   group by kh.sskhdm,kh.sskhid,kh.sskhmc,kh.sfmc  
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.khid=allys.sskhid 
   left outer join #cnzc zc on a.khid=zc.sskhid 
   left outer join #zjyezb zj on a.khid=zj.tzid 
   left join #wlk wl on a.khid=wl.tzid;

drop table #tmp_khb;
drop table #jhb;
drop table #fyb1 ;
drop table #fyb2 ;
drop table #fyb ;
drop table #sykmdm ;
drop table #cnzc ;
drop table #zjyezb ;
drop table #wlk;
 

2017-8-22 10:48:15  declare @ksny varchar(6); 
declare @jsny varchar(6); 
declare @tqksny varchar(6); 
declare @tqjsny varchar(6); 
declare @jsrq datetime ;
declare @ksrq datetime ;
declare @tqjsrq varchar(10); 
declare @tqksrq varchar(10);

select @ksny=convert(varchar(6),cast('2017-08-01' as datetime),112);
select @jsny=convert(varchar(6),cast('2017-08-22' as datetime),112);
select @tqksny=convert(varchar(6),dateadd(year,-1,cast('2017-08-01' as datetime)),112);/*上一年度*/
select @tqjsny=convert(varchar(6),dateadd(year,-1,cast('2017-08-22' as datetime)),112);
set @ksrq='2017-08-01' ;
set @jsrq='2017-08-22' ;
select @tqksrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-01' as datetime)) ,120); 
select @tqjsrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-22' as datetime)) ,120); 

select a.* into #tmp_khb from ( 
    select distinct b.khid,a.khid sskhid,a.khdm as sskhdm,a.khjc as sskhmc,b.khmc,b.ccid,gx.ksny,gx.jsny,b.ssid,c.mc as sfmc,a.lxr,
           case when Convert(varchar(6),isnull(gx.sjkyrq,'1900-01-01'),112) between @ksny and @jsny then 1 else 0 end as xdbs   
    from yx_t_khb a 
    left join  [192.168.35.10].tlsoft.dbo.yx_t_khsfdm c on a.sfdm=c.dm   
    inner join yx_t_khb b on a.ssid=1 and a.khlbdm<>'g' and (b.ccid+'-' like a.ccid+'-%')  and a.khid>1 
    left outer join yx_t_khgxb gx on gx.khid=case when b.khlbdm in ('D','d') then b.ssid else a.khid end and b.khid=gx.gxid and (gx.ksny<=@jsny and gx.jsny>=@ksny) 
    where 1=1 and a.khid not in(85,1384,14204) and len(a.dzbbpx)>0 and b.khmc not like '%直销户%' and b.ty=0 
          and a.khfl like 'x%' and isnull(gx.qtlx,0)=0   /*and b.khfl='xz'*/
) as a ; 

select * into #jhb from (
    select 'ys' as cs,b.ny,1 as xh,a.sskhid,a.khid,
           sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-1 then b.je else 0 end) as ys_gsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=0 then b.je else 0 end) as ys_ddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=0 then b.je else 0 end) as ys_ddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=1 then b.je else 0 end) as ys_xdddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=1 then b.je else 0 end) as ys_xdddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny then b.je else 0 end) as ys_hjfy, 
	sum(b.je) as ys_allfy 
    from #tmp_khb a inner join zw_t_fyjh_kz b on a.khid=b.tzid where b.nd=left(@ksny,4) and b.djlx=12457 /*(b.ny>=@ksny and b.ny<=@jsny) */
    and b.ny>=a.ksny and b.ny<=a.jsny
    group by b.ny,a.sskhid,a.khid    
) a ;
 /*同期实际开支*/
   select 'sjfy' as cs,b.nd,b.ny,1 as xh,a.sskhid,a.khid,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' then b.je else 0 end) as sj_gsfy,  
   sum(case when a.khid=b.khid and b.sjlx='ddmy' and a.xdbs=0 then b.je else 0 end) as sj_ddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=0 then b.je else 0 end) as sj_ddfy,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddfy
   /*,sum(b.je) as sj_hjfy*/
   into #fyb2 
   from #tmp_khb a inner join  [192.168.35.10].tlsoft.dbo.rs_t_yxsjfyb b on a.khid=b.khid 
   where b.nd=2016 and b.khid>0 and b.sjlx in ('sjfy','ddmy') and b.ny>='201603' and b.ny<='201702' 
         and ((b.ny>=@ksny and b.ny<=@jsny) or (b.ny>=@tqksny and b.ny<=@tqjsny) )
    group by b.nd,b.ny,a.sskhid,a.khid;
 /*本期实际开支*/
 select a.* into #fyb1 from (
   /*日常开支，店租费用，税务费用，个人借款，个人花费，差旅费，工资,固定资产*/
   select a.cs,dbo.f_Zw_kjnd(a.khid,a.rq) as nd,convert(varchar(6),a.rq,112) as ny,1 as xh,kh.sskhid,kh.khid,
   sum(case when ((a.jb='xf' and a.bxlx=0) or (a.bxlx=1 and a.jb!='xz')) then a.hdje else 0 end) as sj_gsfy,  
   sum(case when a.jb='mydd' and a.bxlx=0 and kh.xdbs=0  then a.hdje else 0 end) as sj_ddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=0 then a.hdje else 0 end) as sj_ddfy, 
   sum(case when a.jb='mydd'  and a.bxlx=0 and kh.xdbs=1  then a.hdje else 0 end) as sj_xdddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=1 then a.hdje else 0 end) as sj_xdddfy  
  from zw_v_sjkzfy a
  inner join #tmp_khb kh on a.khid=kh.khid 
  where a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.pzbs=1
  group by dbo.f_Zw_kjnd(a.khid,a.rq),convert(varchar(6),a.rq,112) ,kh.sskhid,kh.khid,a.cs
) a 


select *,sj_gsfy+sj_ddgsfy+sj_ddfy+sj_xdddgsfy+sj_xdddfy as sj_hjfy into #fyb 
from (
   select * from #fyb1   
   union all 
   select * from #fyb2 
) a ;

 /*往来款*/
 select a.tzid,sum(jfje) as sr,sum(dfje) as zc
 into #wlk 
 from Zw_T_Cnrjz as a 
 inner join ( select kmdm from zw_t_kmsdb where djlx='12460' and xjdfkm=6982 and tzid=1 and scxe=1  ) b on a.dfkm=b.kmdm
 where a.lylx in (311,312,316,321,322,323,0,826) 
  and  a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.nd=dbo.f_zw_kjnd(a.tzid,@jsrq) 
 group by a.tzid


  select a.sskhid,km.kmdm into #sykmdm from (select sskhid from #tmp_khb group by sskhid) a 
  inner join zw_t_zwkmb km on a.sskhid=km.tzid 
  where km.nd=2017 and km.kzlb=1 
  group by a.sskhid,km.kmdm ;

 select a.sskhid,sum(xjcnzc) as xjcnzc,sum(xxjcnzc) as xxjcnzc,sum(sjcnzc) as sjcnzc,sum(ddcnzc) as ddcnzc,sum(xdddcnzc) as xdddcnzc 
        into #cnzc 
 from (
    select a.sskhid,sum(case when b.khid>0  and b.khid!=b.tzid and isnull(kh.xdbs,0)=0 then b.dfje else 0 end) as xjcnzc,
           sum(case when b.khid>0  and b.khid!=b.tzid and kh.xdbs=1 then b.dfje else 0 end) as xxjcnzc,
           sum(case when (b.khid=0 or b.khid=b.tzid) then b.dfje else 0 end) as sjcnzc,0 as ddcnzc,0 as xdddcnzc
    from #sykmdm a inner join zw_t_cnrjz b on a.sskhid=b.tzid and a.kmdm=b.dfkm and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq)   
    left outer join #tmp_khb kh on b.khid=kh.khid 
    group by a.sskhid 
    union all 
    select a.sskhid,0 as xjcnzc,0 as xxjcnzc,0 as sjcnzc,sum(case when a.xdbs=0 then dfje else 0 end) as ddcnzc,
           sum(case when a.xdbs=1 then dfje else 0 end) as xdddcnzc 
	from (select sskhid,khid,xdbs from #tmp_khb group by sskhid,khid,xdbs) a 
    inner join zw_t_cnrjz b on a.sskhid=b.tzid and b.khid=a.khid and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq) and b.dfkm='122111' 
    and b.khid>0 group by a.sskhid 
 ) a group by a.sskhid;


/*资金余额[对公，对私]*/
 select a.tzid,sum(case when a.kmdm in ('100201','100202') then a.qmje else 0 end) as dgje 
              ,sum(case when a.kmdm in ('100101','100102','1012') then a.qmje else 0 end) as dsje 
 into #zjyezb 
 from ds_t_cnrjzzzb a where 1=1 and ny=@jsny and a.kmdm in ('100201','100202','100101','100102','1012') group by a.tzid ;


if '2'='1' 
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,max(zj.dgje) as dgje,
       max(zj.dsje) as dsje,max(zc.sjcnzc) as sjcnzc,max(zc.xjcnzc) as xjcnzc,max(zc.ddcnzc) as ddcnzc,
       max(zc.xxjcnzc) as xxjcnzc,max(zc.xdddcnzc) as xdddcnzc,
       max(zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc) as cnzc,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
       sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
       sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy,
       max(allys.ys_allgsfy) as ys_allgsfy, max(allys.ys_allddfy) as ys_allddfy 
       ,max(wl.sr) as wlsr,max(wl.zc) as wlzc,max(wl.zc)-max(wl.sr) as wlce    
   from #tmp_khb kh left outer join #fyb a on kh.sskhid=a.sskhid and kh.khid=a.khid  and a.ny>=@ksny and a.ny<=@jsny
   left outer join #jhb b on kh.sskhid=b.sskhid and kh.khid=b.khid and b.ny>=@ksny and b.ny>=@jsny  
   left outer join #fyb c on kh.sskhid=c.sskhid and kh.khid=c.khid and c.ny>=@tqksny and c.ny<=@tqjsny and right(a.ny,2)=right(c.ny,2) 
        and a.sj_hjfy>0 and c.sj_hjfy>0 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.sskhid=allys.sskhid 
   left outer join #cnzc zc on kh.sskhid=zc.sskhid 
   left outer join #zjyezb zj on kh.sskhid=zj.tzid  
   left join #wlk wl on kh.sskhid=wl.tzid
   where 1=1 
   group by kh.sskhid,kh.sskhmc,kh.sskhdm,kh.sfmc   
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 

if '2'='2' or '2'=''
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb 
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq   
       ,zj.dgje,zj.dsje,zc.sjcnzc,zc.xjcnzc,zc.ddcnzc, 
       zc.xxjcnzc,zc.xdddcnzc,
       zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc as cnzc,
       allys.ys_allgsfy,allys.ys_allddfy  
       ,wl.sr as wlsr,wl.zc as wlzc,wl.zc-wl.sr as wlce 
    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.tq_gsfy) as tq_gsfy, sum(c.tq_ddgsfy) as tq_ddgsfy,
       sum(c.tq_ddfy) as tq_ddfy, sum(c.tq_xdddgsfy) as tq_xdddgsfy,
       sum(c.tq_xdddfy) as tq_xdddfy,sum(c.tq_hjfy) as tq_hjfy
   from #tmp_khb kh 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as sj_gsfy, sum(c.sj_ddgsfy) as sj_ddgsfy,
              sum(c.sj_ddfy) as sj_ddfy, sum(c.sj_xdddgsfy) as sj_xdddgsfy,
              sum(c.sj_xdddfy) as sj_xdddfy,sum(c.sj_hjfy) as sj_hjfy  
       from #fyb c where c.ny>=@ksny and c.ny<=@jsny group by c.sskhid,c.khid 
   ) a on kh.sskhid=a.sskhid and kh.khid=a.khid 
   left outer join (select sskhid,khid,sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy from #jhb b where b.ny>=@ksny and b.ny<=@jsny group by sskhid,khid) b 
   on kh.sskhid=b.sskhid and kh.khid=b.khid 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
              sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
              sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy  
       from #fyb c where c.ny>=@tqksny and c.ny<=@tqjsny group by c.sskhid,c.khid 
   ) c on kh.sskhid=c.sskhid and kh.khid=c.khid 
   group by kh.sskhdm,kh.sskhid,kh.sskhmc,kh.sfmc  
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.khid=allys.sskhid 
   left outer join #cnzc zc on a.khid=zc.sskhid 
   left outer join #zjyezb zj on a.khid=zj.tzid 
   left join #wlk wl on a.khid=wl.tzid;

drop table #tmp_khb;
drop table #jhb;
drop table #fyb1 ;
drop table #fyb2 ;
drop table #fyb ;
drop table #sykmdm ;
drop table #cnzc ;
drop table #zjyezb ;
drop table #wlk;
 

2017-8-22 10:50:04  declare @ksny varchar(6); 
declare @jsny varchar(6); 
declare @tqksny varchar(6); 
declare @tqjsny varchar(6); 
declare @jsrq datetime ;
declare @ksrq datetime ;
declare @tqjsrq varchar(10); 
declare @tqksrq varchar(10);

select @ksny=convert(varchar(6),cast('2017-08-01' as datetime),112);
select @jsny=convert(varchar(6),cast('2017-08-22' as datetime),112);
select @tqksny=convert(varchar(6),dateadd(year,-1,cast('2017-08-01' as datetime)),112);/*上一年度*/
select @tqjsny=convert(varchar(6),dateadd(year,-1,cast('2017-08-22' as datetime)),112);
set @ksrq='2017-08-01' ;
set @jsrq='2017-08-22' ;
select @tqksrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-01' as datetime)) ,120); 
select @tqjsrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-22' as datetime)) ,120); 

select a.* into #tmp_khb from ( 
    select distinct b.khid,a.khid sskhid,a.khdm as sskhdm,a.khjc as sskhmc,b.khmc,b.ccid,gx.ksny,gx.jsny,b.ssid,c.mc as sfmc,a.lxr,
           case when Convert(varchar(6),isnull(gx.sjkyrq,'1900-01-01'),112) between @ksny and @jsny then 1 else 0 end as xdbs   
    from yx_t_khb a 
    left join  [192.168.35.10].tlsoft.dbo.yx_t_khsfdm c on a.sfdm=c.dm   
    inner join yx_t_khb b on a.ssid=1 and a.khlbdm<>'g' and (b.ccid+'-' like a.ccid+'-%')  and a.khid>1 
    left outer join yx_t_khgxb gx on gx.khid=case when b.khlbdm in ('D','d') then b.ssid else a.khid end and b.khid=gx.gxid and (gx.ksny<=@jsny and gx.jsny>=@ksny) 
    where 1=1 and a.khid not in(85,1384,14204) and len(a.dzbbpx)>0 and b.khmc not like '%直销户%' and b.ty=0 
          and a.khfl like 'x%' and isnull(gx.qtlx,0)=0   /*and b.khfl='xz'*/
) as a ; 

select * into #jhb from (
    select 'ys' as cs,b.ny,1 as xh,a.sskhid,a.khid,
           sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-1 then b.je else 0 end) as ys_gsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=0 then b.je else 0 end) as ys_ddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=0 then b.je else 0 end) as ys_ddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=1 then b.je else 0 end) as ys_xdddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=1 then b.je else 0 end) as ys_xdddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny then b.je else 0 end) as ys_hjfy, 
	sum(b.je) as ys_allfy 
    from #tmp_khb a inner join zw_t_fyjh_kz b on a.khid=b.tzid where b.nd=left(@ksny,4) and b.djlx=12457 /*(b.ny>=@ksny and b.ny<=@jsny) */
    and b.ny>=a.ksny and b.ny<=a.jsny
    group by b.ny,a.sskhid,a.khid    
) a ;
 /*同期实际开支*/
   select 'sjfy' as cs,b.nd,b.ny,1 as xh,a.sskhid,a.khid,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' then b.je else 0 end) as sj_gsfy,  
   sum(case when a.khid=b.khid and b.sjlx='ddmy' and a.xdbs=0 then b.je else 0 end) as sj_ddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=0 then b.je else 0 end) as sj_ddfy,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddfy
   /*,sum(b.je) as sj_hjfy*/
   into #fyb2 
   from #tmp_khb a inner join  [192.168.35.10].tlsoft.dbo.rs_t_yxsjfyb b on a.khid=b.khid 
   where b.nd=2016 and b.khid>0 and b.sjlx in ('sjfy','ddmy') and b.ny>='201603' and b.ny<='201702' 
         and ((b.ny>=@ksny and b.ny<=@jsny) or (b.ny>=@tqksny and b.ny<=@tqjsny) )
    group by b.nd,b.ny,a.sskhid,a.khid;
 /*本期实际开支*/
 select a.* into #fyb1 from (
   /*日常开支，店租费用，税务费用，个人借款，个人花费，差旅费，工资,固定资产*/
   select a.cs,dbo.f_Zw_kjnd(a.khid,a.rq) as nd,convert(varchar(6),a.rq,112) as ny,1 as xh,kh.sskhid,kh.khid,
   sum(case when ((a.jb='xf' and a.bxlx=0) or (a.bxlx=1 and a.jb!='xz')) then a.hdje else 0 end) as sj_gsfy,  
   sum(case when a.jb='mydd' and a.bxlx=0 and kh.xdbs=0  then a.hdje else 0 end) as sj_ddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=0 then a.hdje else 0 end) as sj_ddfy, 
   sum(case when a.jb='mydd'  and a.bxlx=0 and kh.xdbs=1  then a.hdje else 0 end) as sj_xdddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=1 then a.hdje else 0 end) as sj_xdddfy  
  from zw_v_sjkzfy a
  inner join #tmp_khb kh on a.khid=kh.khid 
  where a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.pzbs=1
  group by dbo.f_Zw_kjnd(a.khid,a.rq),convert(varchar(6),a.rq,112) ,kh.sskhid,kh.khid,a.cs
) a 


select *,sj_gsfy+sj_ddgsfy+sj_ddfy+sj_xdddgsfy+sj_xdddfy as sj_hjfy into #fyb 
from (
   select * from #fyb1   
   union all 
   select * from #fyb2 
) a ;

 /*往来款*/
 select a.tzid,sum(jfje) as sr,sum(dfje) as zc
 into #wlk 
 from Zw_T_Cnrjz as a 
 inner join ( select kmdm from zw_t_kmsdb where djlx='12460' and xjdfkm=6982 and tzid=1 and scxe=1  ) b on a.dfkm=b.kmdm
 where a.lylx in (311,312,316,321,322,323,0,826) 
  and  a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.nd=dbo.f_zw_kjnd(a.tzid,@jsrq) 
 group by a.tzid


  select a.sskhid,km.kmdm into #sykmdm from (select sskhid from #tmp_khb group by sskhid) a 
  inner join zw_t_zwkmb km on a.sskhid=km.tzid 
  where km.nd=2017 and km.kzlb=1 
  group by a.sskhid,km.kmdm ;

 select a.sskhid,sum(xjcnzc) as xjcnzc,sum(xxjcnzc) as xxjcnzc,sum(sjcnzc) as sjcnzc,sum(ddcnzc) as ddcnzc,sum(xdddcnzc) as xdddcnzc 
        into #cnzc 
 from (
    select a.sskhid,sum(case when b.khid>0  and b.khid!=b.tzid and isnull(kh.xdbs,0)=0 then b.dfje else 0 end) as xjcnzc,
           sum(case when b.khid>0  and b.khid!=b.tzid and kh.xdbs=1 then b.dfje else 0 end) as xxjcnzc,
           sum(case when (b.khid=0 or b.khid=b.tzid) then b.dfje else 0 end) as sjcnzc,0 as ddcnzc,0 as xdddcnzc
    from #sykmdm a inner join zw_t_cnrjz b on a.sskhid=b.tzid and a.kmdm=b.dfkm and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq)   
    left outer join #tmp_khb kh on b.khid=kh.khid 
    group by a.sskhid 
    union all 
    select a.sskhid,0 as xjcnzc,0 as xxjcnzc,0 as sjcnzc,sum(case when a.xdbs=0 then dfje else 0 end) as ddcnzc,
           sum(case when a.xdbs=1 then dfje else 0 end) as xdddcnzc 
	from (select sskhid,khid,xdbs from #tmp_khb group by sskhid,khid,xdbs) a 
    inner join zw_t_cnrjz b on a.sskhid=b.tzid and b.khid=a.khid and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq) and b.dfkm='122111' 
    and b.khid>0 group by a.sskhid 
 ) a group by a.sskhid;


/*资金余额[对公，对私]*/
 select a.tzid,sum(case when a.kmdm in ('100201','100202') then a.qmje else 0 end) as dgje 
              ,sum(case when a.kmdm in ('100101','100102','1012') then a.qmje else 0 end) as dsje 
 into #zjyezb 
 from ds_t_cnrjzzzb a where 1=1 and ny=@jsny and a.kmdm in ('100201','100202','100101','100102','1012') group by a.tzid ;


if '2'='1' 
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,max(zj.dgje) as dgje,
       max(zj.dsje) as dsje,max(zc.sjcnzc) as sjcnzc,max(zc.xjcnzc) as xjcnzc,max(zc.ddcnzc) as ddcnzc,
       max(zc.xxjcnzc) as xxjcnzc,max(zc.xdddcnzc) as xdddcnzc,
       max(zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc) as cnzc,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
       sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
       sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy,
       max(allys.ys_allgsfy) as ys_allgsfy, max(allys.ys_allddfy) as ys_allddfy 
       ,max(wl.sr) as wlsr,max(wl.zc) as wlzc,max(wl.zc)-max(wl.sr) as wlce    
   from #tmp_khb kh left outer join #fyb a on kh.sskhid=a.sskhid and kh.khid=a.khid  and a.ny>=@ksny and a.ny<=@jsny
   left outer join #jhb b on kh.sskhid=b.sskhid and kh.khid=b.khid and b.ny>=@ksny and b.ny>=@jsny  
   left outer join #fyb c on kh.sskhid=c.sskhid and kh.khid=c.khid and c.ny>=@tqksny and c.ny<=@tqjsny and right(a.ny,2)=right(c.ny,2) 
        and a.sj_hjfy>0 and c.sj_hjfy>0 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.sskhid=allys.sskhid 
   left outer join #cnzc zc on kh.sskhid=zc.sskhid 
   left outer join #zjyezb zj on kh.sskhid=zj.tzid  
   left join #wlk wl on kh.sskhid=wl.tzid
   where 1=1 
   group by kh.sskhid,kh.sskhmc,kh.sskhdm,kh.sfmc   
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 

if '2'='2' or '2'=''
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb 
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq   
       ,zj.dgje,zj.dsje,zc.sjcnzc,zc.xjcnzc,zc.ddcnzc, 
       zc.xxjcnzc,zc.xdddcnzc,
       zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc as cnzc,
       allys.ys_allgsfy,allys.ys_allddfy  
       ,wl.sr as wlsr,wl.zc as wlzc,wl.zc-wl.sr as wlce 
    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.tq_gsfy) as tq_gsfy, sum(c.tq_ddgsfy) as tq_ddgsfy,
       sum(c.tq_ddfy) as tq_ddfy, sum(c.tq_xdddgsfy) as tq_xdddgsfy,
       sum(c.tq_xdddfy) as tq_xdddfy,sum(c.tq_hjfy) as tq_hjfy
   from #tmp_khb kh 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as sj_gsfy, sum(c.sj_ddgsfy) as sj_ddgsfy,
              sum(c.sj_ddfy) as sj_ddfy, sum(c.sj_xdddgsfy) as sj_xdddgsfy,
              sum(c.sj_xdddfy) as sj_xdddfy,sum(c.sj_hjfy) as sj_hjfy  
       from #fyb c where c.ny>=@ksny and c.ny<=@jsny group by c.sskhid,c.khid 
   ) a on kh.sskhid=a.sskhid and kh.khid=a.khid 
   left outer join (select sskhid,khid,sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy from #jhb b where b.ny>=@ksny and b.ny<=@jsny group by sskhid,khid) b 
   on kh.sskhid=b.sskhid and kh.khid=b.khid 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
              sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
              sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy  
       from #fyb c where c.ny>=@tqksny and c.ny<=@tqjsny group by c.sskhid,c.khid 
   ) c on kh.sskhid=c.sskhid and kh.khid=c.khid 
   group by kh.sskhdm,kh.sskhid,kh.sskhmc,kh.sfmc  
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.khid=allys.sskhid 
   left outer join #cnzc zc on a.khid=zc.sskhid 
   left outer join #zjyezb zj on a.khid=zj.tzid 
   left join #wlk wl on a.khid=wl.tzid;

drop table #tmp_khb;
drop table #jhb;
drop table #fyb1 ;
drop table #fyb2 ;
drop table #fyb ;
drop table #sykmdm ;
drop table #cnzc ;
drop table #zjyezb ;
drop table #wlk;
 

2017-8-22 10:51:14  declare @ksny varchar(6); 
declare @jsny varchar(6); 
declare @tqksny varchar(6); 
declare @tqjsny varchar(6); 
declare @jsrq datetime ;
declare @ksrq datetime ;
declare @tqjsrq varchar(10); 
declare @tqksrq varchar(10);

select @ksny=convert(varchar(6),cast('2017-08-01' as datetime),112);
select @jsny=convert(varchar(6),cast('2017-08-22' as datetime),112);
select @tqksny=convert(varchar(6),dateadd(year,-1,cast('2017-08-01' as datetime)),112);/*上一年度*/
select @tqjsny=convert(varchar(6),dateadd(year,-1,cast('2017-08-22' as datetime)),112);
set @ksrq='2017-08-01' ;
set @jsrq='2017-08-22' ;
select @tqksrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-01' as datetime)) ,120); 
select @tqjsrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-22' as datetime)) ,120); 

select a.* into #tmp_khb from ( 
    select distinct b.khid,a.khid sskhid,a.khdm as sskhdm,a.khjc as sskhmc,b.khmc,b.ccid,gx.ksny,gx.jsny,b.ssid,c.mc as sfmc,a.lxr,
           case when Convert(varchar(6),isnull(gx.sjkyrq,'1900-01-01'),112) between @ksny and @jsny then 1 else 0 end as xdbs   
    from yx_t_khb a 
    left join  [192.168.35.10].tlsoft.dbo.yx_t_khsfdm c on a.sfdm=c.dm   
    inner join yx_t_khb b on a.ssid=1 and a.khlbdm<>'g' and (b.ccid+'-' like a.ccid+'-%')  and a.khid>1 
    left outer join yx_t_khgxb gx on gx.khid=case when b.khlbdm in ('D','d') then b.ssid else a.khid end and b.khid=gx.gxid and (gx.ksny<=@jsny and gx.jsny>=@ksny) 
    where 1=1 and a.khid not in(85,1384,14204) and len(a.dzbbpx)>0 and b.khmc not like '%直销户%' and b.ty=0 
          and a.khfl like 'x%' and isnull(gx.qtlx,0)=0   /*and b.khfl='xz'*/
) as a ; 

select * into #jhb from (
    select 'ys' as cs,b.ny,1 as xh,a.sskhid,a.khid,
           sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-1 then b.je else 0 end) as ys_gsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=0 then b.je else 0 end) as ys_ddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=0 then b.je else 0 end) as ys_ddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=1 then b.je else 0 end) as ys_xdddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=1 then b.je else 0 end) as ys_xdddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny then b.je else 0 end) as ys_hjfy, 
	sum(b.je) as ys_allfy 
    from #tmp_khb a inner join zw_t_fyjh_kz b on a.khid=b.tzid where b.nd=left(@ksny,4) and b.djlx=12457 /*(b.ny>=@ksny and b.ny<=@jsny) */
    and b.ny>=a.ksny and b.ny<=a.jsny
    group by b.ny,a.sskhid,a.khid    
) a ;
 /*同期实际开支*/
   select 'sjfy' as cs,b.nd,b.ny,1 as xh,a.sskhid,a.khid,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' then b.je else 0 end) as sj_gsfy,  
   sum(case when a.khid=b.khid and b.sjlx='ddmy' and a.xdbs=0 then b.je else 0 end) as sj_ddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=0 then b.je else 0 end) as sj_ddfy,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddfy
   /*,sum(b.je) as sj_hjfy*/
   into #fyb2 
   from #tmp_khb a inner join  [192.168.35.10].tlsoft.dbo.rs_t_yxsjfyb b on a.khid=b.khid 
   where b.nd=2016 and b.khid>0 and b.sjlx in ('sjfy','ddmy') and b.ny>='201603' and b.ny<='201702' 
         and ((b.ny>=@ksny and b.ny<=@jsny) or (b.ny>=@tqksny and b.ny<=@tqjsny) )
    group by b.nd,b.ny,a.sskhid,a.khid;
 /*本期实际开支*/
 select a.* into #fyb1 from (
   /*日常开支，店租费用，税务费用，个人借款，个人花费，差旅费，工资,固定资产*/
   select a.cs,dbo.f_Zw_kjnd(a.khid,a.rq) as nd,convert(varchar(6),a.rq,112) as ny,1 as xh,kh.sskhid,kh.khid,
   sum(case when ((a.jb='xf' and a.bxlx=0) or (a.bxlx=1 and a.jb!='xz')) then a.hdje else 0 end) as sj_gsfy,  
   sum(case when a.jb='mydd' and a.bxlx=0 and kh.xdbs=0  then a.hdje else 0 end) as sj_ddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=0 then a.hdje else 0 end) as sj_ddfy, 
   sum(case when a.jb='mydd'  and a.bxlx=0 and kh.xdbs=1  then a.hdje else 0 end) as sj_xdddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=1 then a.hdje else 0 end) as sj_xdddfy  
  from zw_v_sjkzfy a
  inner join #tmp_khb kh on a.khid=kh.khid 
  where a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.pzbs=1
  group by dbo.f_Zw_kjnd(a.khid,a.rq),convert(varchar(6),a.rq,112) ,kh.sskhid,kh.khid,a.cs
) a 


select *,sj_gsfy+sj_ddgsfy+sj_ddfy+sj_xdddgsfy+sj_xdddfy as sj_hjfy into #fyb 
from (
   select * from #fyb1   
   union all 
   select * from #fyb2 
) a ;

 /*往来款*/
 select a.tzid,sum(jfje) as sr,sum(dfje) as zc
 into #wlk 
 from Zw_T_Cnrjz as a 
 inner join ( select kmdm from zw_t_kmsdb where djlx='12460' and xjdfkm=6982 and tzid=1 and scxe=1  ) b on a.dfkm=b.kmdm
 where a.lylx in (311,312,316,321,322,323,0,826) 
  and  a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.nd=dbo.f_zw_kjnd(a.tzid,@jsrq) 
 group by a.tzid


  select a.sskhid,km.kmdm into #sykmdm from (select sskhid from #tmp_khb group by sskhid) a 
  inner join zw_t_zwkmb km on a.sskhid=km.tzid 
  where km.nd=2017 and km.kzlb=1 
  group by a.sskhid,km.kmdm ;

 select a.sskhid,sum(xjcnzc) as xjcnzc,sum(xxjcnzc) as xxjcnzc,sum(sjcnzc) as sjcnzc,sum(ddcnzc) as ddcnzc,sum(xdddcnzc) as xdddcnzc 
        into #cnzc 
 from (
    select a.sskhid,sum(case when b.khid>0  and b.khid!=b.tzid and isnull(kh.xdbs,0)=0 then b.dfje else 0 end) as xjcnzc,
           sum(case when b.khid>0  and b.khid!=b.tzid and kh.xdbs=1 then b.dfje else 0 end) as xxjcnzc,
           sum(case when (b.khid=0 or b.khid=b.tzid) then b.dfje else 0 end) as sjcnzc,0 as ddcnzc,0 as xdddcnzc
    from #sykmdm a inner join zw_t_cnrjz b on a.sskhid=b.tzid and a.kmdm=b.dfkm and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq)   
    left outer join #tmp_khb kh on b.khid=kh.khid 
    group by a.sskhid 
    union all 
    select a.sskhid,0 as xjcnzc,0 as xxjcnzc,0 as sjcnzc,sum(case when a.xdbs=0 then dfje else 0 end) as ddcnzc,
           sum(case when a.xdbs=1 then dfje else 0 end) as xdddcnzc 
	from (select sskhid,khid,xdbs from #tmp_khb group by sskhid,khid,xdbs) a 
    inner join zw_t_cnrjz b on a.sskhid=b.tzid and b.khid=a.khid and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq) and b.dfkm='122111' 
    and b.khid>0 group by a.sskhid 
 ) a group by a.sskhid;


/*资金余额[对公，对私]*/
 select a.tzid,sum(case when a.kmdm in ('100201','100202') then a.qmje else 0 end) as dgje 
              ,sum(case when a.kmdm in ('100101','100102','1012') then a.qmje else 0 end) as dsje 
 into #zjyezb 
 from ds_t_cnrjzzzb a where 1=1 and ny=@jsny and a.kmdm in ('100201','100202','100101','100102','1012') group by a.tzid ;


if '2'='1' 
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,max(zj.dgje) as dgje,
       max(zj.dsje) as dsje,max(zc.sjcnzc) as sjcnzc,max(zc.xjcnzc) as xjcnzc,max(zc.ddcnzc) as ddcnzc,
       max(zc.xxjcnzc) as xxjcnzc,max(zc.xdddcnzc) as xdddcnzc,
       max(zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc) as cnzc,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
       sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
       sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy,
       max(allys.ys_allgsfy) as ys_allgsfy, max(allys.ys_allddfy) as ys_allddfy 
       ,max(wl.sr) as wlsr,max(wl.zc) as wlzc,max(wl.zc)-max(wl.sr) as wlce    
   from #tmp_khb kh left outer join #fyb a on kh.sskhid=a.sskhid and kh.khid=a.khid  and a.ny>=@ksny and a.ny<=@jsny
   left outer join #jhb b on kh.sskhid=b.sskhid and kh.khid=b.khid and b.ny>=@ksny and b.ny>=@jsny  
   left outer join #fyb c on kh.sskhid=c.sskhid and kh.khid=c.khid and c.ny>=@tqksny and c.ny<=@tqjsny and right(a.ny,2)=right(c.ny,2) 
        and a.sj_hjfy>0 and c.sj_hjfy>0 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.sskhid=allys.sskhid 
   left outer join #cnzc zc on kh.sskhid=zc.sskhid 
   left outer join #zjyezb zj on kh.sskhid=zj.tzid  
   left join #wlk wl on kh.sskhid=wl.tzid
   where 1=1 
   group by kh.sskhid,kh.sskhmc,kh.sskhdm,kh.sfmc   
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 

if '2'='2' or '2'=''
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb 
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq   
       ,zj.dgje,zj.dsje,zc.sjcnzc,zc.xjcnzc,zc.ddcnzc, 
       zc.xxjcnzc,zc.xdddcnzc,
       zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc as cnzc,
       allys.ys_allgsfy,allys.ys_allddfy  
       ,wl.sr as wlsr,wl.zc as wlzc,wl.zc-wl.sr as wlce 
    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.tq_gsfy) as tq_gsfy, sum(c.tq_ddgsfy) as tq_ddgsfy,
       sum(c.tq_ddfy) as tq_ddfy, sum(c.tq_xdddgsfy) as tq_xdddgsfy,
       sum(c.tq_xdddfy) as tq_xdddfy,sum(c.tq_hjfy) as tq_hjfy
   from #tmp_khb kh 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as sj_gsfy, sum(c.sj_ddgsfy) as sj_ddgsfy,
              sum(c.sj_ddfy) as sj_ddfy, sum(c.sj_xdddgsfy) as sj_xdddgsfy,
              sum(c.sj_xdddfy) as sj_xdddfy,sum(c.sj_hjfy) as sj_hjfy  
       from #fyb c where c.ny>=@ksny and c.ny<=@jsny group by c.sskhid,c.khid 
   ) a on kh.sskhid=a.sskhid and kh.khid=a.khid 
   left outer join (select sskhid,khid,sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy from #jhb b where b.ny>=@ksny and b.ny<=@jsny group by sskhid,khid) b 
   on kh.sskhid=b.sskhid and kh.khid=b.khid 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
              sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
              sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy  
       from #fyb c where c.ny>=@tqksny and c.ny<=@tqjsny group by c.sskhid,c.khid 
   ) c on kh.sskhid=c.sskhid and kh.khid=c.khid 
   group by kh.sskhdm,kh.sskhid,kh.sskhmc,kh.sfmc  
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.khid=allys.sskhid 
   left outer join #cnzc zc on a.khid=zc.sskhid 
   left outer join #zjyezb zj on a.khid=zj.tzid 
   left join #wlk wl on a.khid=wl.tzid;

drop table #tmp_khb;
drop table #jhb;
drop table #fyb1 ;
drop table #fyb2 ;
drop table #fyb ;
drop table #sykmdm ;
drop table #cnzc ;
drop table #zjyezb ;
drop table #wlk;
 

2017-8-22 10:52:33  declare @ksny varchar(6); 
declare @jsny varchar(6); 
declare @tqksny varchar(6); 
declare @tqjsny varchar(6); 
declare @jsrq datetime ;
declare @ksrq datetime ;
declare @tqjsrq varchar(10); 
declare @tqksrq varchar(10);

select @ksny=convert(varchar(6),cast('2017-08-01' as datetime),112);
select @jsny=convert(varchar(6),cast('2017-08-22' as datetime),112);
select @tqksny=convert(varchar(6),dateadd(year,-1,cast('2017-08-01' as datetime)),112);/*上一年度*/
select @tqjsny=convert(varchar(6),dateadd(year,-1,cast('2017-08-22' as datetime)),112);
set @ksrq='2017-08-01' ;
set @jsrq='2017-08-22' ;
select @tqksrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-01' as datetime)) ,120); 
select @tqjsrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-22' as datetime)) ,120); 

select a.* into #tmp_khb from ( 
    select distinct b.khid,a.khid sskhid,a.khdm as sskhdm,a.khjc as sskhmc,b.khmc,b.ccid,gx.ksny,gx.jsny,b.ssid,c.mc as sfmc,a.lxr,
           case when Convert(varchar(6),isnull(gx.sjkyrq,'1900-01-01'),112) between @ksny and @jsny then 1 else 0 end as xdbs   
    from yx_t_khb a 
    left join  [192.168.35.10].tlsoft.dbo.yx_t_khsfdm c on a.sfdm=c.dm   
    inner join yx_t_khb b on a.ssid=1 and a.khlbdm<>'g' and (b.ccid+'-' like a.ccid+'-%')  and a.khid>1 
    left outer join yx_t_khgxb gx on gx.khid=case when b.khlbdm in ('D','d') then b.ssid else a.khid end and b.khid=gx.gxid and (gx.ksny<=@jsny and gx.jsny>=@ksny) 
    where 1=1 and a.khid not in(85,1384,14204) and len(a.dzbbpx)>0 and b.khmc not like '%直销户%' and b.ty=0 
          and a.khfl like 'x%' and isnull(gx.qtlx,0)=0   /*and b.khfl='xz'*/
) as a ; 

select * into #jhb from (
    select 'ys' as cs,b.ny,1 as xh,a.sskhid,a.khid,
           sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-1 then b.je else 0 end) as ys_gsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=0 then b.je else 0 end) as ys_ddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=0 then b.je else 0 end) as ys_ddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=1 then b.je else 0 end) as ys_xdddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=1 then b.je else 0 end) as ys_xdddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny then b.je else 0 end) as ys_hjfy, 
	sum(b.je) as ys_allfy 
    from #tmp_khb a inner join zw_t_fyjh_kz b on a.khid=b.tzid where b.nd=left(@ksny,4) and b.djlx=12457 /*(b.ny>=@ksny and b.ny<=@jsny) */
    and b.ny>=a.ksny and b.ny<=a.jsny
    group by b.ny,a.sskhid,a.khid    
) a ;
 /*同期实际开支*/
   select 'sjfy' as cs,b.nd,b.ny,1 as xh,a.sskhid,a.khid,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' then b.je else 0 end) as sj_gsfy,  
   sum(case when a.khid=b.khid and b.sjlx='ddmy' and a.xdbs=0 then b.je else 0 end) as sj_ddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=0 then b.je else 0 end) as sj_ddfy,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddfy
   /*,sum(b.je) as sj_hjfy*/
   into #fyb2 
   from #tmp_khb a inner join  [192.168.35.10].tlsoft.dbo.rs_t_yxsjfyb b on a.khid=b.khid 
   where b.nd=2016 and b.khid>0 and b.sjlx in ('sjfy','ddmy') and b.ny>='201603' and b.ny<='201702' 
         and ((b.ny>=@ksny and b.ny<=@jsny) or (b.ny>=@tqksny and b.ny<=@tqjsny) )
    group by b.nd,b.ny,a.sskhid,a.khid;
 /*本期实际开支*/
 select a.* into #fyb1 from (
   /*日常开支，店租费用，税务费用，个人借款，个人花费，差旅费，工资,固定资产*/
   select a.cs,dbo.f_Zw_kjnd(a.khid,a.rq) as nd,convert(varchar(6),a.rq,112) as ny,1 as xh,kh.sskhid,kh.khid,
   sum(case when ((a.jb='xf' and a.bxlx=0) or (a.bxlx=1 and a.jb!='xz')) then a.hdje else 0 end) as sj_gsfy,  
   sum(case when a.jb='mydd' and a.bxlx=0 and kh.xdbs=0  then a.hdje else 0 end) as sj_ddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=0 then a.hdje else 0 end) as sj_ddfy, 
   sum(case when a.jb='mydd'  and a.bxlx=0 and kh.xdbs=1  then a.hdje else 0 end) as sj_xdddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=1 then a.hdje else 0 end) as sj_xdddfy  
  from zw_v_sjkzfy a
  inner join #tmp_khb kh on a.khid=kh.khid 
  where a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.pzbs=1
  group by dbo.f_Zw_kjnd(a.khid,a.rq),convert(varchar(6),a.rq,112) ,kh.sskhid,kh.khid,a.cs
) a 


select *,sj_gsfy+sj_ddgsfy+sj_ddfy+sj_xdddgsfy+sj_xdddfy as sj_hjfy into #fyb 
from (
   select * from #fyb1   
   union all 
   select * from #fyb2 
) a ;

 /*往来款*/
 select a.tzid,sum(jfje) as sr,sum(dfje) as zc
 into #wlk 
 from Zw_T_Cnrjz as a 
 inner join ( select kmdm from zw_t_kmsdb where djlx='12460' and xjdfkm=6982 and tzid=1 and scxe=1  ) b on a.dfkm=b.kmdm
 where a.lylx in (311,312,316,321,322,323,0,826) 
  and  a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.nd=dbo.f_zw_kjnd(a.tzid,@jsrq) 
 group by a.tzid


  select a.sskhid,km.kmdm into #sykmdm from (select sskhid from #tmp_khb group by sskhid) a 
  inner join zw_t_zwkmb km on a.sskhid=km.tzid 
  where km.nd=2017 and km.kzlb=1 
  group by a.sskhid,km.kmdm ;

 select a.sskhid,sum(xjcnzc) as xjcnzc,sum(xxjcnzc) as xxjcnzc,sum(sjcnzc) as sjcnzc,sum(ddcnzc) as ddcnzc,sum(xdddcnzc) as xdddcnzc 
        into #cnzc 
 from (
    select a.sskhid,sum(case when b.khid>0  and b.khid!=b.tzid and isnull(kh.xdbs,0)=0 then b.dfje else 0 end) as xjcnzc,
           sum(case when b.khid>0  and b.khid!=b.tzid and kh.xdbs=1 then b.dfje else 0 end) as xxjcnzc,
           sum(case when (b.khid=0 or b.khid=b.tzid) then b.dfje else 0 end) as sjcnzc,0 as ddcnzc,0 as xdddcnzc
    from #sykmdm a inner join zw_t_cnrjz b on a.sskhid=b.tzid and a.kmdm=b.dfkm and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq)   
    left outer join #tmp_khb kh on b.khid=kh.khid 
    group by a.sskhid 
    union all 
    select a.sskhid,0 as xjcnzc,0 as xxjcnzc,0 as sjcnzc,sum(case when a.xdbs=0 then dfje else 0 end) as ddcnzc,
           sum(case when a.xdbs=1 then dfje else 0 end) as xdddcnzc 
	from (select sskhid,khid,xdbs from #tmp_khb group by sskhid,khid,xdbs) a 
    inner join zw_t_cnrjz b on a.sskhid=b.tzid and b.khid=a.khid and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq) and b.dfkm='122111' 
    and b.khid>0 group by a.sskhid 
 ) a group by a.sskhid;


/*资金余额[对公，对私]*/
 select a.tzid,sum(case when a.kmdm in ('100201','100202') then a.qmje else 0 end) as dgje 
              ,sum(case when a.kmdm in ('100101','100102','1012') then a.qmje else 0 end) as dsje 
 into #zjyezb 
 from ds_t_cnrjzzzb a where 1=1 and ny=@jsny and a.kmdm in ('100201','100202','100101','100102','1012') group by a.tzid ;


if '2'='1' 
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,max(zj.dgje) as dgje,
       max(zj.dsje) as dsje,max(zc.sjcnzc) as sjcnzc,max(zc.xjcnzc) as xjcnzc,max(zc.ddcnzc) as ddcnzc,
       max(zc.xxjcnzc) as xxjcnzc,max(zc.xdddcnzc) as xdddcnzc,
       max(zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc) as cnzc,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
       sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
       sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy,
       max(allys.ys_allgsfy) as ys_allgsfy, max(allys.ys_allddfy) as ys_allddfy 
       ,max(wl.sr) as wlsr,max(wl.zc) as wlzc,max(wl.zc)-max(wl.sr) as wlce    
   from #tmp_khb kh left outer join #fyb a on kh.sskhid=a.sskhid and kh.khid=a.khid  and a.ny>=@ksny and a.ny<=@jsny
   left outer join #jhb b on kh.sskhid=b.sskhid and kh.khid=b.khid and b.ny>=@ksny and b.ny>=@jsny  
   left outer join #fyb c on kh.sskhid=c.sskhid and kh.khid=c.khid and c.ny>=@tqksny and c.ny<=@tqjsny and right(a.ny,2)=right(c.ny,2) 
        and a.sj_hjfy>0 and c.sj_hjfy>0 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.sskhid=allys.sskhid 
   left outer join #cnzc zc on kh.sskhid=zc.sskhid 
   left outer join #zjyezb zj on kh.sskhid=zj.tzid  
   left join #wlk wl on kh.sskhid=wl.tzid
   where 1=1 
   group by kh.sskhid,kh.sskhmc,kh.sskhdm,kh.sfmc   
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 

if '2'='2' or '2'=''
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb 
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq   
       ,zj.dgje,zj.dsje,zc.sjcnzc,zc.xjcnzc,zc.ddcnzc, 
       zc.xxjcnzc,zc.xdddcnzc,
       zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc as cnzc,
       allys.ys_allgsfy,allys.ys_allddfy  
       ,wl.sr as wlsr,wl.zc as wlzc,wl.zc-wl.sr as wlce 
    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.tq_gsfy) as tq_gsfy, sum(c.tq_ddgsfy) as tq_ddgsfy,
       sum(c.tq_ddfy) as tq_ddfy, sum(c.tq_xdddgsfy) as tq_xdddgsfy,
       sum(c.tq_xdddfy) as tq_xdddfy,sum(c.tq_hjfy) as tq_hjfy
   from #tmp_khb kh 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as sj_gsfy, sum(c.sj_ddgsfy) as sj_ddgsfy,
              sum(c.sj_ddfy) as sj_ddfy, sum(c.sj_xdddgsfy) as sj_xdddgsfy,
              sum(c.sj_xdddfy) as sj_xdddfy,sum(c.sj_hjfy) as sj_hjfy  
       from #fyb c where c.ny>=@ksny and c.ny<=@jsny group by c.sskhid,c.khid 
   ) a on kh.sskhid=a.sskhid and kh.khid=a.khid 
   left outer join (select sskhid,khid,sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy from #jhb b where b.ny>=@ksny and b.ny<=@jsny group by sskhid,khid) b 
   on kh.sskhid=b.sskhid and kh.khid=b.khid 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
              sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
              sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy  
       from #fyb c where c.ny>=@tqksny and c.ny<=@tqjsny group by c.sskhid,c.khid 
   ) c on kh.sskhid=c.sskhid and kh.khid=c.khid 
   group by kh.sskhdm,kh.sskhid,kh.sskhmc,kh.sfmc  
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.khid=allys.sskhid 
   left outer join #cnzc zc on a.khid=zc.sskhid 
   left outer join #zjyezb zj on a.khid=zj.tzid 
   left join #wlk wl on a.khid=wl.tzid;

drop table #tmp_khb;
drop table #jhb;
drop table #fyb1 ;
drop table #fyb2 ;
drop table #fyb ;
drop table #sykmdm ;
drop table #cnzc ;
drop table #zjyezb ;
drop table #wlk;
 

2017-8-22 10:53:54  declare @ksny varchar(6); 
declare @jsny varchar(6); 
declare @tqksny varchar(6); 
declare @tqjsny varchar(6); 
declare @jsrq datetime ;
declare @ksrq datetime ;
declare @tqjsrq varchar(10); 
declare @tqksrq varchar(10);

select @ksny=convert(varchar(6),cast('2017-08-01' as datetime),112);
select @jsny=convert(varchar(6),cast('2017-08-22' as datetime),112);
select @tqksny=convert(varchar(6),dateadd(year,-1,cast('2017-08-01' as datetime)),112);/*上一年度*/
select @tqjsny=convert(varchar(6),dateadd(year,-1,cast('2017-08-22' as datetime)),112);
set @ksrq='2017-08-01' ;
set @jsrq='2017-08-22' ;
select @tqksrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-01' as datetime)) ,120); 
select @tqjsrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-22' as datetime)) ,120); 

select a.* into #tmp_khb from ( 
    select distinct b.khid,a.khid sskhid,a.khdm as sskhdm,a.khjc as sskhmc,b.khmc,b.ccid,gx.ksny,gx.jsny,b.ssid,c.mc as sfmc,a.lxr,
           case when Convert(varchar(6),isnull(gx.sjkyrq,'1900-01-01'),112) between @ksny and @jsny then 1 else 0 end as xdbs   
    from yx_t_khb a 
    left join  [192.168.35.10].tlsoft.dbo.yx_t_khsfdm c on a.sfdm=c.dm   
    inner join yx_t_khb b on a.ssid=1 and a.khlbdm<>'g' and (b.ccid+'-' like a.ccid+'-%')  and a.khid>1 
    left outer join yx_t_khgxb gx on gx.khid=case when b.khlbdm in ('D','d') then b.ssid else a.khid end and b.khid=gx.gxid and (gx.ksny<=@jsny and gx.jsny>=@ksny) 
    where 1=1 and a.khid not in(85,1384,14204) and len(a.dzbbpx)>0 and b.khmc not like '%直销户%' and b.ty=0 
          and a.khfl like 'x%' and isnull(gx.qtlx,0)=0   /*and b.khfl='xz'*/
) as a ; 

select * into #jhb from (
    select 'ys' as cs,b.ny,1 as xh,a.sskhid,a.khid,
           sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-1 then b.je else 0 end) as ys_gsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=0 then b.je else 0 end) as ys_ddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=0 then b.je else 0 end) as ys_ddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=1 then b.je else 0 end) as ys_xdddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=1 then b.je else 0 end) as ys_xdddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny then b.je else 0 end) as ys_hjfy, 
	sum(b.je) as ys_allfy 
    from #tmp_khb a inner join zw_t_fyjh_kz b on a.khid=b.tzid where b.nd=left(@ksny,4) and b.djlx=12457 /*(b.ny>=@ksny and b.ny<=@jsny) */
    and b.ny>=a.ksny and b.ny<=a.jsny
    group by b.ny,a.sskhid,a.khid    
) a ;
 /*同期实际开支*/
   select 'sjfy' as cs,b.nd,b.ny,1 as xh,a.sskhid,a.khid,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' then b.je else 0 end) as sj_gsfy,  
   sum(case when a.khid=b.khid and b.sjlx='ddmy' and a.xdbs=0 then b.je else 0 end) as sj_ddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=0 then b.je else 0 end) as sj_ddfy,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddfy
   /*,sum(b.je) as sj_hjfy*/
   into #fyb2 
   from #tmp_khb a inner join  [192.168.35.10].tlsoft.dbo.rs_t_yxsjfyb b on a.khid=b.khid 
   where b.nd=2016 and b.khid>0 and b.sjlx in ('sjfy','ddmy') and b.ny>='201603' and b.ny<='201702' 
         and ((b.ny>=@ksny and b.ny<=@jsny) or (b.ny>=@tqksny and b.ny<=@tqjsny) )
    group by b.nd,b.ny,a.sskhid,a.khid;
 /*本期实际开支*/
 select a.* into #fyb1 from (
   /*日常开支，店租费用，税务费用，个人借款，个人花费，差旅费，工资,固定资产*/
   select a.cs,dbo.f_Zw_kjnd(a.khid,a.rq) as nd,convert(varchar(6),a.rq,112) as ny,1 as xh,kh.sskhid,kh.khid,
   sum(case when ((a.jb='xf' and a.bxlx=0) or (a.bxlx=1 and a.jb!='xz')) then a.hdje else 0 end) as sj_gsfy,  
   sum(case when a.jb='mydd' and a.bxlx=0 and kh.xdbs=0  then a.hdje else 0 end) as sj_ddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=0 then a.hdje else 0 end) as sj_ddfy, 
   sum(case when a.jb='mydd'  and a.bxlx=0 and kh.xdbs=1  then a.hdje else 0 end) as sj_xdddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=1 then a.hdje else 0 end) as sj_xdddfy  
  from zw_v_sjkzfy a
  inner join #tmp_khb kh on a.khid=kh.khid 
  where a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.pzbs=1
  group by dbo.f_Zw_kjnd(a.khid,a.rq),convert(varchar(6),a.rq,112) ,kh.sskhid,kh.khid,a.cs
) a 


select *,sj_gsfy+sj_ddgsfy+sj_ddfy+sj_xdddgsfy+sj_xdddfy as sj_hjfy into #fyb 
from (
   select * from #fyb1   
   union all 
   select * from #fyb2 
) a ;

 /*往来款*/
 select a.tzid,sum(jfje) as sr,sum(dfje) as zc
 into #wlk 
 from Zw_T_Cnrjz as a 
 inner join ( select kmdm from zw_t_kmsdb where djlx='12460' and xjdfkm=6982 and tzid=1 and scxe=1  ) b on a.dfkm=b.kmdm
 where a.lylx in (311,312,316,321,322,323,0,826) 
  and  a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.nd=dbo.f_zw_kjnd(a.tzid,@jsrq) 
 group by a.tzid


  select a.sskhid,km.kmdm into #sykmdm from (select sskhid from #tmp_khb group by sskhid) a 
  inner join zw_t_zwkmb km on a.sskhid=km.tzid 
  where km.nd=2017 and km.kzlb=1 
  group by a.sskhid,km.kmdm ;

 select a.sskhid,sum(xjcnzc) as xjcnzc,sum(xxjcnzc) as xxjcnzc,sum(sjcnzc) as sjcnzc,sum(ddcnzc) as ddcnzc,sum(xdddcnzc) as xdddcnzc 
        into #cnzc 
 from (
    select a.sskhid,sum(case when b.khid>0  and b.khid!=b.tzid and isnull(kh.xdbs,0)=0 then b.dfje else 0 end) as xjcnzc,
           sum(case when b.khid>0  and b.khid!=b.tzid and kh.xdbs=1 then b.dfje else 0 end) as xxjcnzc,
           sum(case when (b.khid=0 or b.khid=b.tzid) then b.dfje else 0 end) as sjcnzc,0 as ddcnzc,0 as xdddcnzc
    from #sykmdm a inner join zw_t_cnrjz b on a.sskhid=b.tzid and a.kmdm=b.dfkm and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq)   
    left outer join #tmp_khb kh on b.khid=kh.khid 
    group by a.sskhid 
    union all 
    select a.sskhid,0 as xjcnzc,0 as xxjcnzc,0 as sjcnzc,sum(case when a.xdbs=0 then dfje else 0 end) as ddcnzc,
           sum(case when a.xdbs=1 then dfje else 0 end) as xdddcnzc 
	from (select sskhid,khid,xdbs from #tmp_khb group by sskhid,khid,xdbs) a 
    inner join zw_t_cnrjz b on a.sskhid=b.tzid and b.khid=a.khid and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq) and b.dfkm='122111' 
    and b.khid>0 group by a.sskhid 
 ) a group by a.sskhid;


/*资金余额[对公，对私]*/
 select a.tzid,sum(case when a.kmdm in ('100201','100202') then a.qmje else 0 end) as dgje 
              ,sum(case when a.kmdm in ('100101','100102','1012') then a.qmje else 0 end) as dsje 
 into #zjyezb 
 from ds_t_cnrjzzzb a where 1=1 and ny=@jsny and a.kmdm in ('100201','100202','100101','100102','1012') group by a.tzid ;


if '2'='1' 
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,max(zj.dgje) as dgje,
       max(zj.dsje) as dsje,max(zc.sjcnzc) as sjcnzc,max(zc.xjcnzc) as xjcnzc,max(zc.ddcnzc) as ddcnzc,
       max(zc.xxjcnzc) as xxjcnzc,max(zc.xdddcnzc) as xdddcnzc,
       max(zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc) as cnzc,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
       sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
       sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy,
       max(allys.ys_allgsfy) as ys_allgsfy, max(allys.ys_allddfy) as ys_allddfy 
       ,max(wl.sr) as wlsr,max(wl.zc) as wlzc,max(wl.zc)-max(wl.sr) as wlce    
   from #tmp_khb kh left outer join #fyb a on kh.sskhid=a.sskhid and kh.khid=a.khid  and a.ny>=@ksny and a.ny<=@jsny
   left outer join #jhb b on kh.sskhid=b.sskhid and kh.khid=b.khid and b.ny>=@ksny and b.ny>=@jsny  
   left outer join #fyb c on kh.sskhid=c.sskhid and kh.khid=c.khid and c.ny>=@tqksny and c.ny<=@tqjsny and right(a.ny,2)=right(c.ny,2) 
        and a.sj_hjfy>0 and c.sj_hjfy>0 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.sskhid=allys.sskhid 
   left outer join #cnzc zc on kh.sskhid=zc.sskhid 
   left outer join #zjyezb zj on kh.sskhid=zj.tzid  
   left join #wlk wl on kh.sskhid=wl.tzid
   where 1=1 
   group by kh.sskhid,kh.sskhmc,kh.sskhdm,kh.sfmc   
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 

if '2'='2' or '2'=''
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb 
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq   
       ,zj.dgje,zj.dsje,zc.sjcnzc,zc.xjcnzc,zc.ddcnzc, 
       zc.xxjcnzc,zc.xdddcnzc,
       zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc as cnzc,
       allys.ys_allgsfy,allys.ys_allddfy  
       ,wl.sr as wlsr,wl.zc as wlzc,wl.zc-wl.sr as wlce 
    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.tq_gsfy) as tq_gsfy, sum(c.tq_ddgsfy) as tq_ddgsfy,
       sum(c.tq_ddfy) as tq_ddfy, sum(c.tq_xdddgsfy) as tq_xdddgsfy,
       sum(c.tq_xdddfy) as tq_xdddfy,sum(c.tq_hjfy) as tq_hjfy
   from #tmp_khb kh 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as sj_gsfy, sum(c.sj_ddgsfy) as sj_ddgsfy,
              sum(c.sj_ddfy) as sj_ddfy, sum(c.sj_xdddgsfy) as sj_xdddgsfy,
              sum(c.sj_xdddfy) as sj_xdddfy,sum(c.sj_hjfy) as sj_hjfy  
       from #fyb c where c.ny>=@ksny and c.ny<=@jsny group by c.sskhid,c.khid 
   ) a on kh.sskhid=a.sskhid and kh.khid=a.khid 
   left outer join (select sskhid,khid,sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy from #jhb b where b.ny>=@ksny and b.ny<=@jsny group by sskhid,khid) b 
   on kh.sskhid=b.sskhid and kh.khid=b.khid 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
              sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
              sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy  
       from #fyb c where c.ny>=@tqksny and c.ny<=@tqjsny group by c.sskhid,c.khid 
   ) c on kh.sskhid=c.sskhid and kh.khid=c.khid 
   group by kh.sskhdm,kh.sskhid,kh.sskhmc,kh.sfmc  
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.khid=allys.sskhid 
   left outer join #cnzc zc on a.khid=zc.sskhid 
   left outer join #zjyezb zj on a.khid=zj.tzid 
   left join #wlk wl on a.khid=wl.tzid;

drop table #tmp_khb;
drop table #jhb;
drop table #fyb1 ;
drop table #fyb2 ;
drop table #fyb ;
drop table #sykmdm ;
drop table #cnzc ;
drop table #zjyezb ;
drop table #wlk;
 

2017-8-22 10:54:58  declare @ksny varchar(6); 
declare @jsny varchar(6); 
declare @tqksny varchar(6); 
declare @tqjsny varchar(6); 
declare @jsrq datetime ;
declare @ksrq datetime ;
declare @tqjsrq varchar(10); 
declare @tqksrq varchar(10);

select @ksny=convert(varchar(6),cast('2017-08-01' as datetime),112);
select @jsny=convert(varchar(6),cast('2017-08-22' as datetime),112);
select @tqksny=convert(varchar(6),dateadd(year,-1,cast('2017-08-01' as datetime)),112);/*上一年度*/
select @tqjsny=convert(varchar(6),dateadd(year,-1,cast('2017-08-22' as datetime)),112);
set @ksrq='2017-08-01' ;
set @jsrq='2017-08-22' ;
select @tqksrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-01' as datetime)) ,120); 
select @tqjsrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-22' as datetime)) ,120); 

select a.* into #tmp_khb from ( 
    select distinct b.khid,a.khid sskhid,a.khdm as sskhdm,a.khjc as sskhmc,b.khmc,b.ccid,gx.ksny,gx.jsny,b.ssid,c.mc as sfmc,a.lxr,
           case when Convert(varchar(6),isnull(gx.sjkyrq,'1900-01-01'),112) between @ksny and @jsny then 1 else 0 end as xdbs   
    from yx_t_khb a 
    left join  [192.168.35.10].tlsoft.dbo.yx_t_khsfdm c on a.sfdm=c.dm   
    inner join yx_t_khb b on a.ssid=1 and a.khlbdm<>'g' and (b.ccid+'-' like a.ccid+'-%')  and a.khid>1 
    left outer join yx_t_khgxb gx on gx.khid=case when b.khlbdm in ('D','d') then b.ssid else a.khid end and b.khid=gx.gxid and (gx.ksny<=@jsny and gx.jsny>=@ksny) 
    where 1=1 and a.khid not in(85,1384,14204) and len(a.dzbbpx)>0 and b.khmc not like '%直销户%' and b.ty=0 
          and a.khfl like 'x%' and isnull(gx.qtlx,0)=0   /*and b.khfl='xz'*/
) as a ; 

select * into #jhb from (
    select 'ys' as cs,b.ny,1 as xh,a.sskhid,a.khid,
           sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-1 then b.je else 0 end) as ys_gsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=0 then b.je else 0 end) as ys_ddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=0 then b.je else 0 end) as ys_ddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=1 then b.je else 0 end) as ys_xdddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=1 then b.je else 0 end) as ys_xdddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny then b.je else 0 end) as ys_hjfy, 
	sum(b.je) as ys_allfy 
    from #tmp_khb a inner join zw_t_fyjh_kz b on a.khid=b.tzid where b.nd=left(@ksny,4) and b.djlx=12457 /*(b.ny>=@ksny and b.ny<=@jsny) */
    and b.ny>=a.ksny and b.ny<=a.jsny
    group by b.ny,a.sskhid,a.khid    
) a ;
 /*同期实际开支*/
   select 'sjfy' as cs,b.nd,b.ny,1 as xh,a.sskhid,a.khid,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' then b.je else 0 end) as sj_gsfy,  
   sum(case when a.khid=b.khid and b.sjlx='ddmy' and a.xdbs=0 then b.je else 0 end) as sj_ddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=0 then b.je else 0 end) as sj_ddfy,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddfy
   /*,sum(b.je) as sj_hjfy*/
   into #fyb2 
   from #tmp_khb a inner join  [192.168.35.10].tlsoft.dbo.rs_t_yxsjfyb b on a.khid=b.khid 
   where b.nd=2016 and b.khid>0 and b.sjlx in ('sjfy','ddmy') and b.ny>='201603' and b.ny<='201702' 
         and ((b.ny>=@ksny and b.ny<=@jsny) or (b.ny>=@tqksny and b.ny<=@tqjsny) )
    group by b.nd,b.ny,a.sskhid,a.khid;
 /*本期实际开支*/
 select a.* into #fyb1 from (
   /*日常开支，店租费用，税务费用，个人借款，个人花费，差旅费，工资,固定资产*/
   select a.cs,dbo.f_Zw_kjnd(a.khid,a.rq) as nd,convert(varchar(6),a.rq,112) as ny,1 as xh,kh.sskhid,kh.khid,
   sum(case when ((a.jb='xf' and a.bxlx=0) or (a.bxlx=1 and a.jb!='xz')) then a.hdje else 0 end) as sj_gsfy,  
   sum(case when a.jb='mydd' and a.bxlx=0 and kh.xdbs=0  then a.hdje else 0 end) as sj_ddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=0 then a.hdje else 0 end) as sj_ddfy, 
   sum(case when a.jb='mydd'  and a.bxlx=0 and kh.xdbs=1  then a.hdje else 0 end) as sj_xdddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=1 then a.hdje else 0 end) as sj_xdddfy  
  from zw_v_sjkzfy a
  inner join #tmp_khb kh on a.khid=kh.khid 
  where a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.pzbs=1
  group by dbo.f_Zw_kjnd(a.khid,a.rq),convert(varchar(6),a.rq,112) ,kh.sskhid,kh.khid,a.cs
) a 


select *,sj_gsfy+sj_ddgsfy+sj_ddfy+sj_xdddgsfy+sj_xdddfy as sj_hjfy into #fyb 
from (
   select * from #fyb1   
   union all 
   select * from #fyb2 
) a ;

 /*往来款*/
 select a.tzid,sum(jfje) as sr,sum(dfje) as zc
 into #wlk 
 from Zw_T_Cnrjz as a 
 inner join ( select kmdm from zw_t_kmsdb where djlx='12460' and xjdfkm=6982 and tzid=1 and scxe=1  ) b on a.dfkm=b.kmdm
 where a.lylx in (311,312,316,321,322,323,0,826) 
  and  a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.nd=dbo.f_zw_kjnd(a.tzid,@jsrq) 
 group by a.tzid


  select a.sskhid,km.kmdm into #sykmdm from (select sskhid from #tmp_khb group by sskhid) a 
  inner join zw_t_zwkmb km on a.sskhid=km.tzid 
  where km.nd=2017 and km.kzlb=1 
  group by a.sskhid,km.kmdm ;

 select a.sskhid,sum(xjcnzc) as xjcnzc,sum(xxjcnzc) as xxjcnzc,sum(sjcnzc) as sjcnzc,sum(ddcnzc) as ddcnzc,sum(xdddcnzc) as xdddcnzc 
        into #cnzc 
 from (
    select a.sskhid,sum(case when b.khid>0  and b.khid!=b.tzid and isnull(kh.xdbs,0)=0 then b.dfje else 0 end) as xjcnzc,
           sum(case when b.khid>0  and b.khid!=b.tzid and kh.xdbs=1 then b.dfje else 0 end) as xxjcnzc,
           sum(case when (b.khid=0 or b.khid=b.tzid) then b.dfje else 0 end) as sjcnzc,0 as ddcnzc,0 as xdddcnzc
    from #sykmdm a inner join zw_t_cnrjz b on a.sskhid=b.tzid and a.kmdm=b.dfkm and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq)   
    left outer join #tmp_khb kh on b.khid=kh.khid 
    group by a.sskhid 
    union all 
    select a.sskhid,0 as xjcnzc,0 as xxjcnzc,0 as sjcnzc,sum(case when a.xdbs=0 then dfje else 0 end) as ddcnzc,
           sum(case when a.xdbs=1 then dfje else 0 end) as xdddcnzc 
	from (select sskhid,khid,xdbs from #tmp_khb group by sskhid,khid,xdbs) a 
    inner join zw_t_cnrjz b on a.sskhid=b.tzid and b.khid=a.khid and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq) and b.dfkm='122111' 
    and b.khid>0 group by a.sskhid 
 ) a group by a.sskhid;


/*资金余额[对公，对私]*/
 select a.tzid,sum(case when a.kmdm in ('100201','100202') then a.qmje else 0 end) as dgje 
              ,sum(case when a.kmdm in ('100101','100102','1012') then a.qmje else 0 end) as dsje 
 into #zjyezb 
 from ds_t_cnrjzzzb a where 1=1 and ny=@jsny and a.kmdm in ('100201','100202','100101','100102','1012') group by a.tzid ;


if '2'='1' 
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,max(zj.dgje) as dgje,
       max(zj.dsje) as dsje,max(zc.sjcnzc) as sjcnzc,max(zc.xjcnzc) as xjcnzc,max(zc.ddcnzc) as ddcnzc,
       max(zc.xxjcnzc) as xxjcnzc,max(zc.xdddcnzc) as xdddcnzc,
       max(zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc) as cnzc,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
       sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
       sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy,
       max(allys.ys_allgsfy) as ys_allgsfy, max(allys.ys_allddfy) as ys_allddfy 
       ,max(wl.sr) as wlsr,max(wl.zc) as wlzc,max(wl.zc)-max(wl.sr) as wlce    
   from #tmp_khb kh left outer join #fyb a on kh.sskhid=a.sskhid and kh.khid=a.khid  and a.ny>=@ksny and a.ny<=@jsny
   left outer join #jhb b on kh.sskhid=b.sskhid and kh.khid=b.khid and b.ny>=@ksny and b.ny>=@jsny  
   left outer join #fyb c on kh.sskhid=c.sskhid and kh.khid=c.khid and c.ny>=@tqksny and c.ny<=@tqjsny and right(a.ny,2)=right(c.ny,2) 
        and a.sj_hjfy>0 and c.sj_hjfy>0 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.sskhid=allys.sskhid 
   left outer join #cnzc zc on kh.sskhid=zc.sskhid 
   left outer join #zjyezb zj on kh.sskhid=zj.tzid  
   left join #wlk wl on kh.sskhid=wl.tzid
   where 1=1 
   group by kh.sskhid,kh.sskhmc,kh.sskhdm,kh.sfmc   
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 

if '2'='2' or '2'=''
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb 
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq   
       ,zj.dgje,zj.dsje,zc.sjcnzc,zc.xjcnzc,zc.ddcnzc, 
       zc.xxjcnzc,zc.xdddcnzc,
       zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc as cnzc,
       allys.ys_allgsfy,allys.ys_allddfy  
       ,wl.sr as wlsr,wl.zc as wlzc,wl.zc-wl.sr as wlce 
    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.tq_gsfy) as tq_gsfy, sum(c.tq_ddgsfy) as tq_ddgsfy,
       sum(c.tq_ddfy) as tq_ddfy, sum(c.tq_xdddgsfy) as tq_xdddgsfy,
       sum(c.tq_xdddfy) as tq_xdddfy,sum(c.tq_hjfy) as tq_hjfy
   from #tmp_khb kh 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as sj_gsfy, sum(c.sj_ddgsfy) as sj_ddgsfy,
              sum(c.sj_ddfy) as sj_ddfy, sum(c.sj_xdddgsfy) as sj_xdddgsfy,
              sum(c.sj_xdddfy) as sj_xdddfy,sum(c.sj_hjfy) as sj_hjfy  
       from #fyb c where c.ny>=@ksny and c.ny<=@jsny group by c.sskhid,c.khid 
   ) a on kh.sskhid=a.sskhid and kh.khid=a.khid 
   left outer join (select sskhid,khid,sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy from #jhb b where b.ny>=@ksny and b.ny<=@jsny group by sskhid,khid) b 
   on kh.sskhid=b.sskhid and kh.khid=b.khid 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
              sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
              sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy  
       from #fyb c where c.ny>=@tqksny and c.ny<=@tqjsny group by c.sskhid,c.khid 
   ) c on kh.sskhid=c.sskhid and kh.khid=c.khid 
   group by kh.sskhdm,kh.sskhid,kh.sskhmc,kh.sfmc  
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.khid=allys.sskhid 
   left outer join #cnzc zc on a.khid=zc.sskhid 
   left outer join #zjyezb zj on a.khid=zj.tzid 
   left join #wlk wl on a.khid=wl.tzid;

drop table #tmp_khb;
drop table #jhb;
drop table #fyb1 ;
drop table #fyb2 ;
drop table #fyb ;
drop table #sykmdm ;
drop table #cnzc ;
drop table #zjyezb ;
drop table #wlk;
 

2017-8-22 10:55:26  declare @ksny varchar(6); 
declare @jsny varchar(6); 
declare @tqksny varchar(6); 
declare @tqjsny varchar(6); 
declare @jsrq datetime ;
declare @ksrq datetime ;
declare @tqjsrq varchar(10); 
declare @tqksrq varchar(10);

select @ksny=convert(varchar(6),cast('2017-08-01' as datetime),112);
select @jsny=convert(varchar(6),cast('2017-08-22' as datetime),112);
select @tqksny=convert(varchar(6),dateadd(year,-1,cast('2017-08-01' as datetime)),112);/*上一年度*/
select @tqjsny=convert(varchar(6),dateadd(year,-1,cast('2017-08-22' as datetime)),112);
set @ksrq='2017-08-01' ;
set @jsrq='2017-08-22' ;
select @tqksrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-01' as datetime)) ,120); 
select @tqjsrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-22' as datetime)) ,120); 

select a.* into #tmp_khb from ( 
    select distinct b.khid,a.khid sskhid,a.khdm as sskhdm,a.khjc as sskhmc,b.khmc,b.ccid,gx.ksny,gx.jsny,b.ssid,c.mc as sfmc,a.lxr,
           case when Convert(varchar(6),isnull(gx.sjkyrq,'1900-01-01'),112) between @ksny and @jsny then 1 else 0 end as xdbs   
    from yx_t_khb a 
    left join  [192.168.35.10].tlsoft.dbo.yx_t_khsfdm c on a.sfdm=c.dm   
    inner join yx_t_khb b on a.ssid=1 and a.khlbdm<>'g' and (b.ccid+'-' like a.ccid+'-%')  and a.khid>1 
    left outer join yx_t_khgxb gx on gx.khid=case when b.khlbdm in ('D','d') then b.ssid else a.khid end and b.khid=gx.gxid and (gx.ksny<=@jsny and gx.jsny>=@ksny) 
    where 1=1 and a.khid not in(85,1384,14204) and len(a.dzbbpx)>0 and b.khmc not like '%直销户%' and b.ty=0 
          and a.khfl like 'x%' and isnull(gx.qtlx,0)=0   /*and b.khfl='xz'*/
) as a ; 

select * into #jhb from (
    select 'ys' as cs,b.ny,1 as xh,a.sskhid,a.khid,
           sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-1 then b.je else 0 end) as ys_gsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=0 then b.je else 0 end) as ys_ddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=0 then b.je else 0 end) as ys_ddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=1 then b.je else 0 end) as ys_xdddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=1 then b.je else 0 end) as ys_xdddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny then b.je else 0 end) as ys_hjfy, 
	sum(b.je) as ys_allfy 
    from #tmp_khb a inner join zw_t_fyjh_kz b on a.khid=b.tzid where b.nd=left(@ksny,4) and b.djlx=12457 /*(b.ny>=@ksny and b.ny<=@jsny) */
    and b.ny>=a.ksny and b.ny<=a.jsny
    group by b.ny,a.sskhid,a.khid    
) a ;
 /*同期实际开支*/
   select 'sjfy' as cs,b.nd,b.ny,1 as xh,a.sskhid,a.khid,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' then b.je else 0 end) as sj_gsfy,  
   sum(case when a.khid=b.khid and b.sjlx='ddmy' and a.xdbs=0 then b.je else 0 end) as sj_ddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=0 then b.je else 0 end) as sj_ddfy,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddfy
   /*,sum(b.je) as sj_hjfy*/
   into #fyb2 
   from #tmp_khb a inner join  [192.168.35.10].tlsoft.dbo.rs_t_yxsjfyb b on a.khid=b.khid 
   where b.nd=2016 and b.khid>0 and b.sjlx in ('sjfy','ddmy') and b.ny>='201603' and b.ny<='201702' 
         and ((b.ny>=@ksny and b.ny<=@jsny) or (b.ny>=@tqksny and b.ny<=@tqjsny) )
    group by b.nd,b.ny,a.sskhid,a.khid;
 /*本期实际开支*/
 select a.* into #fyb1 from (
   /*日常开支，店租费用，税务费用，个人借款，个人花费，差旅费，工资,固定资产*/
   select a.cs,dbo.f_Zw_kjnd(a.khid,a.rq) as nd,convert(varchar(6),a.rq,112) as ny,1 as xh,kh.sskhid,kh.khid,
   sum(case when ((a.jb='xf' and a.bxlx=0) or (a.bxlx=1 and a.jb!='xz')) then a.hdje else 0 end) as sj_gsfy,  
   sum(case when a.jb='mydd' and a.bxlx=0 and kh.xdbs=0  then a.hdje else 0 end) as sj_ddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=0 then a.hdje else 0 end) as sj_ddfy, 
   sum(case when a.jb='mydd'  and a.bxlx=0 and kh.xdbs=1  then a.hdje else 0 end) as sj_xdddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=1 then a.hdje else 0 end) as sj_xdddfy  
  from zw_v_sjkzfy a
  inner join #tmp_khb kh on a.khid=kh.khid 
  where a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.pzbs=1
  group by dbo.f_Zw_kjnd(a.khid,a.rq),convert(varchar(6),a.rq,112) ,kh.sskhid,kh.khid,a.cs
) a 


select *,sj_gsfy+sj_ddgsfy+sj_ddfy+sj_xdddgsfy+sj_xdddfy as sj_hjfy into #fyb 
from (
   select * from #fyb1   
   union all 
   select * from #fyb2 
) a ;

 /*往来款*/
 select a.tzid,sum(jfje) as sr,sum(dfje) as zc
 into #wlk 
 from Zw_T_Cnrjz as a 
 inner join ( select kmdm from zw_t_kmsdb where djlx='12460' and xjdfkm=6982 and tzid=1 and scxe=1  ) b on a.dfkm=b.kmdm
 where a.lylx in (311,312,316,321,322,323,0,826) 
  and  a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.nd=dbo.f_zw_kjnd(a.tzid,@jsrq) 
 group by a.tzid


  select a.sskhid,km.kmdm into #sykmdm from (select sskhid from #tmp_khb group by sskhid) a 
  inner join zw_t_zwkmb km on a.sskhid=km.tzid 
  where km.nd=2017 and km.kzlb=1 
  group by a.sskhid,km.kmdm ;

 select a.sskhid,sum(xjcnzc) as xjcnzc,sum(xxjcnzc) as xxjcnzc,sum(sjcnzc) as sjcnzc,sum(ddcnzc) as ddcnzc,sum(xdddcnzc) as xdddcnzc 
        into #cnzc 
 from (
    select a.sskhid,sum(case when b.khid>0  and b.khid!=b.tzid and isnull(kh.xdbs,0)=0 then b.dfje else 0 end) as xjcnzc,
           sum(case when b.khid>0  and b.khid!=b.tzid and kh.xdbs=1 then b.dfje else 0 end) as xxjcnzc,
           sum(case when (b.khid=0 or b.khid=b.tzid) then b.dfje else 0 end) as sjcnzc,0 as ddcnzc,0 as xdddcnzc
    from #sykmdm a inner join zw_t_cnrjz b on a.sskhid=b.tzid and a.kmdm=b.dfkm and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq)   
    left outer join #tmp_khb kh on b.khid=kh.khid 
    group by a.sskhid 
    union all 
    select a.sskhid,0 as xjcnzc,0 as xxjcnzc,0 as sjcnzc,sum(case when a.xdbs=0 then dfje else 0 end) as ddcnzc,
           sum(case when a.xdbs=1 then dfje else 0 end) as xdddcnzc 
	from (select sskhid,khid,xdbs from #tmp_khb group by sskhid,khid,xdbs) a 
    inner join zw_t_cnrjz b on a.sskhid=b.tzid and b.khid=a.khid and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq) and b.dfkm='122111' 
    and b.khid>0 group by a.sskhid 
 ) a group by a.sskhid;


/*资金余额[对公，对私]*/
 select a.tzid,sum(case when a.kmdm in ('100201','100202') then a.qmje else 0 end) as dgje 
              ,sum(case when a.kmdm in ('100101','100102','1012') then a.qmje else 0 end) as dsje 
 into #zjyezb 
 from ds_t_cnrjzzzb a where 1=1 and ny=@jsny and a.kmdm in ('100201','100202','100101','100102','1012') group by a.tzid ;


if '2'='1' 
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,max(zj.dgje) as dgje,
       max(zj.dsje) as dsje,max(zc.sjcnzc) as sjcnzc,max(zc.xjcnzc) as xjcnzc,max(zc.ddcnzc) as ddcnzc,
       max(zc.xxjcnzc) as xxjcnzc,max(zc.xdddcnzc) as xdddcnzc,
       max(zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc) as cnzc,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
       sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
       sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy,
       max(allys.ys_allgsfy) as ys_allgsfy, max(allys.ys_allddfy) as ys_allddfy 
       ,max(wl.sr) as wlsr,max(wl.zc) as wlzc,max(wl.zc)-max(wl.sr) as wlce    
   from #tmp_khb kh left outer join #fyb a on kh.sskhid=a.sskhid and kh.khid=a.khid  and a.ny>=@ksny and a.ny<=@jsny
   left outer join #jhb b on kh.sskhid=b.sskhid and kh.khid=b.khid and b.ny>=@ksny and b.ny>=@jsny  
   left outer join #fyb c on kh.sskhid=c.sskhid and kh.khid=c.khid and c.ny>=@tqksny and c.ny<=@tqjsny and right(a.ny,2)=right(c.ny,2) 
        and a.sj_hjfy>0 and c.sj_hjfy>0 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.sskhid=allys.sskhid 
   left outer join #cnzc zc on kh.sskhid=zc.sskhid 
   left outer join #zjyezb zj on kh.sskhid=zj.tzid  
   left join #wlk wl on kh.sskhid=wl.tzid
   where 1=1 
   group by kh.sskhid,kh.sskhmc,kh.sskhdm,kh.sfmc   
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 

if '2'='2' or '2'=''
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb 
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq   
       ,zj.dgje,zj.dsje,zc.sjcnzc,zc.xjcnzc,zc.ddcnzc, 
       zc.xxjcnzc,zc.xdddcnzc,
       zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc as cnzc,
       allys.ys_allgsfy,allys.ys_allddfy  
       ,wl.sr as wlsr,wl.zc as wlzc,wl.zc-wl.sr as wlce 
    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.tq_gsfy) as tq_gsfy, sum(c.tq_ddgsfy) as tq_ddgsfy,
       sum(c.tq_ddfy) as tq_ddfy, sum(c.tq_xdddgsfy) as tq_xdddgsfy,
       sum(c.tq_xdddfy) as tq_xdddfy,sum(c.tq_hjfy) as tq_hjfy
   from #tmp_khb kh 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as sj_gsfy, sum(c.sj_ddgsfy) as sj_ddgsfy,
              sum(c.sj_ddfy) as sj_ddfy, sum(c.sj_xdddgsfy) as sj_xdddgsfy,
              sum(c.sj_xdddfy) as sj_xdddfy,sum(c.sj_hjfy) as sj_hjfy  
       from #fyb c where c.ny>=@ksny and c.ny<=@jsny group by c.sskhid,c.khid 
   ) a on kh.sskhid=a.sskhid and kh.khid=a.khid 
   left outer join (select sskhid,khid,sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy from #jhb b where b.ny>=@ksny and b.ny<=@jsny group by sskhid,khid) b 
   on kh.sskhid=b.sskhid and kh.khid=b.khid 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
              sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
              sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy  
       from #fyb c where c.ny>=@tqksny and c.ny<=@tqjsny group by c.sskhid,c.khid 
   ) c on kh.sskhid=c.sskhid and kh.khid=c.khid 
   group by kh.sskhdm,kh.sskhid,kh.sskhmc,kh.sfmc  
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.khid=allys.sskhid 
   left outer join #cnzc zc on a.khid=zc.sskhid 
   left outer join #zjyezb zj on a.khid=zj.tzid 
   left join #wlk wl on a.khid=wl.tzid;

drop table #tmp_khb;
drop table #jhb;
drop table #fyb1 ;
drop table #fyb2 ;
drop table #fyb ;
drop table #sykmdm ;
drop table #cnzc ;
drop table #zjyezb ;
drop table #wlk;
 

2017-8-22 10:57:11  declare @ksny varchar(6); 
declare @jsny varchar(6); 
declare @tqksny varchar(6); 
declare @tqjsny varchar(6); 
declare @jsrq datetime ;
declare @ksrq datetime ;
declare @tqjsrq varchar(10); 
declare @tqksrq varchar(10);

select @ksny=convert(varchar(6),cast('2017-08-01' as datetime),112);
select @jsny=convert(varchar(6),cast('2017-08-22' as datetime),112);
select @tqksny=convert(varchar(6),dateadd(year,-1,cast('2017-08-01' as datetime)),112);/*上一年度*/
select @tqjsny=convert(varchar(6),dateadd(year,-1,cast('2017-08-22' as datetime)),112);
set @ksrq='2017-08-01' ;
set @jsrq='2017-08-22' ;
select @tqksrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-01' as datetime)) ,120); 
select @tqjsrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-22' as datetime)) ,120); 

select a.* into #tmp_khb from ( 
    select distinct b.khid,a.khid sskhid,a.khdm as sskhdm,a.khjc as sskhmc,b.khmc,b.ccid,gx.ksny,gx.jsny,b.ssid,c.mc as sfmc,a.lxr,
           case when Convert(varchar(6),isnull(gx.sjkyrq,'1900-01-01'),112) between @ksny and @jsny then 1 else 0 end as xdbs   
    from yx_t_khb a 
    left join  [192.168.35.10].tlsoft.dbo.yx_t_khsfdm c on a.sfdm=c.dm   
    inner join yx_t_khb b on a.ssid=1 and a.khlbdm<>'g' and (b.ccid+'-' like a.ccid+'-%')  and a.khid>1 
    left outer join yx_t_khgxb gx on gx.khid=case when b.khlbdm in ('D','d') then b.ssid else a.khid end and b.khid=gx.gxid and (gx.ksny<=@jsny and gx.jsny>=@ksny) 
    where 1=1 and a.khid not in(85,1384,14204) and len(a.dzbbpx)>0 and b.khmc not like '%直销户%' and b.ty=0 
          and a.khfl like 'x%' and isnull(gx.qtlx,0)=0   /*and b.khfl='xz'*/
) as a ; 

select * into #jhb from (
    select 'ys' as cs,b.ny,1 as xh,a.sskhid,a.khid,
           sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-1 then b.je else 0 end) as ys_gsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=0 then b.je else 0 end) as ys_ddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=0 then b.je else 0 end) as ys_ddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=1 then b.je else 0 end) as ys_xdddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=1 then b.je else 0 end) as ys_xdddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny then b.je else 0 end) as ys_hjfy, 
	sum(b.je) as ys_allfy 
    from #tmp_khb a inner join zw_t_fyjh_kz b on a.khid=b.tzid where b.nd=left(@ksny,4) and b.djlx=12457 /*(b.ny>=@ksny and b.ny<=@jsny) */
    and b.ny>=a.ksny and b.ny<=a.jsny
    group by b.ny,a.sskhid,a.khid    
) a ;
 /*同期实际开支*/
   select 'sjfy' as cs,b.nd,b.ny,1 as xh,a.sskhid,a.khid,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' then b.je else 0 end) as sj_gsfy,  
   sum(case when a.khid=b.khid and b.sjlx='ddmy' and a.xdbs=0 then b.je else 0 end) as sj_ddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=0 then b.je else 0 end) as sj_ddfy,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddfy
   /*,sum(b.je) as sj_hjfy*/
   into #fyb2 
   from #tmp_khb a inner join  [192.168.35.10].tlsoft.dbo.rs_t_yxsjfyb b on a.khid=b.khid 
   where b.nd=2016 and b.khid>0 and b.sjlx in ('sjfy','ddmy') and b.ny>='201603' and b.ny<='201702' 
         and ((b.ny>=@ksny and b.ny<=@jsny) or (b.ny>=@tqksny and b.ny<=@tqjsny) )
    group by b.nd,b.ny,a.sskhid,a.khid;
 /*本期实际开支*/
 select a.* into #fyb1 from (
   /*日常开支，店租费用，税务费用，个人借款，个人花费，差旅费，工资,固定资产*/
   select a.cs,dbo.f_Zw_kjnd(a.khid,a.rq) as nd,convert(varchar(6),a.rq,112) as ny,1 as xh,kh.sskhid,kh.khid,
   sum(case when ((a.jb='xf' and a.bxlx=0) or (a.bxlx=1 and a.jb!='xz')) then a.hdje else 0 end) as sj_gsfy,  
   sum(case when a.jb='mydd' and a.bxlx=0 and kh.xdbs=0  then a.hdje else 0 end) as sj_ddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=0 then a.hdje else 0 end) as sj_ddfy, 
   sum(case when a.jb='mydd'  and a.bxlx=0 and kh.xdbs=1  then a.hdje else 0 end) as sj_xdddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=1 then a.hdje else 0 end) as sj_xdddfy  
  from zw_v_sjkzfy a
  inner join #tmp_khb kh on a.khid=kh.khid 
  where a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.pzbs=1
  group by dbo.f_Zw_kjnd(a.khid,a.rq),convert(varchar(6),a.rq,112) ,kh.sskhid,kh.khid,a.cs
) a 


select *,sj_gsfy+sj_ddgsfy+sj_ddfy+sj_xdddgsfy+sj_xdddfy as sj_hjfy into #fyb 
from (
   select * from #fyb1   
   union all 
   select * from #fyb2 
) a ;

 /*往来款*/
 select a.tzid,sum(jfje) as sr,sum(dfje) as zc
 into #wlk 
 from Zw_T_Cnrjz as a 
 inner join ( select kmdm from zw_t_kmsdb where djlx='12460' and xjdfkm=6982 and tzid=1 and scxe=1  ) b on a.dfkm=b.kmdm
 where a.lylx in (311,312,316,321,322,323,0,826) 
  and  a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.nd=dbo.f_zw_kjnd(a.tzid,@jsrq) 
 group by a.tzid


  select a.sskhid,km.kmdm into #sykmdm from (select sskhid from #tmp_khb group by sskhid) a 
  inner join zw_t_zwkmb km on a.sskhid=km.tzid 
  where km.nd=2017 and km.kzlb=1 
  group by a.sskhid,km.kmdm ;

 select a.sskhid,sum(xjcnzc) as xjcnzc,sum(xxjcnzc) as xxjcnzc,sum(sjcnzc) as sjcnzc,sum(ddcnzc) as ddcnzc,sum(xdddcnzc) as xdddcnzc 
        into #cnzc 
 from (
    select a.sskhid,sum(case when b.khid>0  and b.khid!=b.tzid and isnull(kh.xdbs,0)=0 then b.dfje else 0 end) as xjcnzc,
           sum(case when b.khid>0  and b.khid!=b.tzid and kh.xdbs=1 then b.dfje else 0 end) as xxjcnzc,
           sum(case when (b.khid=0 or b.khid=b.tzid) then b.dfje else 0 end) as sjcnzc,0 as ddcnzc,0 as xdddcnzc
    from #sykmdm a inner join zw_t_cnrjz b on a.sskhid=b.tzid and a.kmdm=b.dfkm and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq)   
    left outer join #tmp_khb kh on b.khid=kh.khid 
    group by a.sskhid 
    union all 
    select a.sskhid,0 as xjcnzc,0 as xxjcnzc,0 as sjcnzc,sum(case when a.xdbs=0 then dfje else 0 end) as ddcnzc,
           sum(case when a.xdbs=1 then dfje else 0 end) as xdddcnzc 
	from (select sskhid,khid,xdbs from #tmp_khb group by sskhid,khid,xdbs) a 
    inner join zw_t_cnrjz b on a.sskhid=b.tzid and b.khid=a.khid and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq) and b.dfkm='122111' 
    and b.khid>0 group by a.sskhid 
 ) a group by a.sskhid;


/*资金余额[对公，对私]*/
 select a.tzid,sum(case when a.kmdm in ('100201','100202') then a.qmje else 0 end) as dgje 
              ,sum(case when a.kmdm in ('100101','100102','1012') then a.qmje else 0 end) as dsje 
 into #zjyezb 
 from ds_t_cnrjzzzb a where 1=1 and ny=@jsny and a.kmdm in ('100201','100202','100101','100102','1012') group by a.tzid ;


if '2'='1' 
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,max(zj.dgje) as dgje,
       max(zj.dsje) as dsje,max(zc.sjcnzc) as sjcnzc,max(zc.xjcnzc) as xjcnzc,max(zc.ddcnzc) as ddcnzc,
       max(zc.xxjcnzc) as xxjcnzc,max(zc.xdddcnzc) as xdddcnzc,
       max(zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc) as cnzc,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
       sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
       sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy,
       max(allys.ys_allgsfy) as ys_allgsfy, max(allys.ys_allddfy) as ys_allddfy 
       ,max(wl.sr) as wlsr,max(wl.zc) as wlzc,max(wl.zc)-max(wl.sr) as wlce    
   from #tmp_khb kh left outer join #fyb a on kh.sskhid=a.sskhid and kh.khid=a.khid  and a.ny>=@ksny and a.ny<=@jsny
   left outer join #jhb b on kh.sskhid=b.sskhid and kh.khid=b.khid and b.ny>=@ksny and b.ny>=@jsny  
   left outer join #fyb c on kh.sskhid=c.sskhid and kh.khid=c.khid and c.ny>=@tqksny and c.ny<=@tqjsny and right(a.ny,2)=right(c.ny,2) 
        and a.sj_hjfy>0 and c.sj_hjfy>0 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.sskhid=allys.sskhid 
   left outer join #cnzc zc on kh.sskhid=zc.sskhid 
   left outer join #zjyezb zj on kh.sskhid=zj.tzid  
   left join #wlk wl on kh.sskhid=wl.tzid
   where 1=1 
   group by kh.sskhid,kh.sskhmc,kh.sskhdm,kh.sfmc   
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 

if '2'='2' or '2'=''
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb 
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq   
       ,zj.dgje,zj.dsje,zc.sjcnzc,zc.xjcnzc,zc.ddcnzc, 
       zc.xxjcnzc,zc.xdddcnzc,
       zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc as cnzc,
       allys.ys_allgsfy,allys.ys_allddfy  
       ,wl.sr as wlsr,wl.zc as wlzc,wl.zc-wl.sr as wlce 
    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.tq_gsfy) as tq_gsfy, sum(c.tq_ddgsfy) as tq_ddgsfy,
       sum(c.tq_ddfy) as tq_ddfy, sum(c.tq_xdddgsfy) as tq_xdddgsfy,
       sum(c.tq_xdddfy) as tq_xdddfy,sum(c.tq_hjfy) as tq_hjfy
   from #tmp_khb kh 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as sj_gsfy, sum(c.sj_ddgsfy) as sj_ddgsfy,
              sum(c.sj_ddfy) as sj_ddfy, sum(c.sj_xdddgsfy) as sj_xdddgsfy,
              sum(c.sj_xdddfy) as sj_xdddfy,sum(c.sj_hjfy) as sj_hjfy  
       from #fyb c where c.ny>=@ksny and c.ny<=@jsny group by c.sskhid,c.khid 
   ) a on kh.sskhid=a.sskhid and kh.khid=a.khid 
   left outer join (select sskhid,khid,sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy from #jhb b where b.ny>=@ksny and b.ny<=@jsny group by sskhid,khid) b 
   on kh.sskhid=b.sskhid and kh.khid=b.khid 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
              sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
              sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy  
       from #fyb c where c.ny>=@tqksny and c.ny<=@tqjsny group by c.sskhid,c.khid 
   ) c on kh.sskhid=c.sskhid and kh.khid=c.khid 
   group by kh.sskhdm,kh.sskhid,kh.sskhmc,kh.sfmc  
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.khid=allys.sskhid 
   left outer join #cnzc zc on a.khid=zc.sskhid 
   left outer join #zjyezb zj on a.khid=zj.tzid 
   left join #wlk wl on a.khid=wl.tzid;

drop table #tmp_khb;
drop table #jhb;
drop table #fyb1 ;
drop table #fyb2 ;
drop table #fyb ;
drop table #sykmdm ;
drop table #cnzc ;
drop table #zjyezb ;
drop table #wlk;
 

2017-8-22 10:57:45  declare @ksny varchar(6); 
declare @jsny varchar(6); 
declare @tqksny varchar(6); 
declare @tqjsny varchar(6); 
declare @jsrq datetime ;
declare @ksrq datetime ;
declare @tqjsrq varchar(10); 
declare @tqksrq varchar(10);

select @ksny=convert(varchar(6),cast('2017-08-01' as datetime),112);
select @jsny=convert(varchar(6),cast('2017-08-22' as datetime),112);
select @tqksny=convert(varchar(6),dateadd(year,-1,cast('2017-08-01' as datetime)),112);/*上一年度*/
select @tqjsny=convert(varchar(6),dateadd(year,-1,cast('2017-08-22' as datetime)),112);
set @ksrq='2017-08-01' ;
set @jsrq='2017-08-22' ;
select @tqksrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-01' as datetime)) ,120); 
select @tqjsrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-22' as datetime)) ,120); 

select a.* into #tmp_khb from ( 
    select distinct b.khid,a.khid sskhid,a.khdm as sskhdm,a.khjc as sskhmc,b.khmc,b.ccid,gx.ksny,gx.jsny,b.ssid,c.mc as sfmc,a.lxr,
           case when Convert(varchar(6),isnull(gx.sjkyrq,'1900-01-01'),112) between @ksny and @jsny then 1 else 0 end as xdbs   
    from yx_t_khb a 
    left join  [192.168.35.10].tlsoft.dbo.yx_t_khsfdm c on a.sfdm=c.dm   
    inner join yx_t_khb b on a.ssid=1 and a.khlbdm<>'g' and (b.ccid+'-' like a.ccid+'-%')  and a.khid>1 
    left outer join yx_t_khgxb gx on gx.khid=case when b.khlbdm in ('D','d') then b.ssid else a.khid end and b.khid=gx.gxid and (gx.ksny<=@jsny and gx.jsny>=@ksny) 
    where 1=1 and a.khid not in(85,1384,14204) and len(a.dzbbpx)>0 and b.khmc not like '%直销户%' and b.ty=0 
          and a.khfl like 'x%' and isnull(gx.qtlx,0)=0   /*and b.khfl='xz'*/
) as a ; 

select * into #jhb from (
    select 'ys' as cs,b.ny,1 as xh,a.sskhid,a.khid,
           sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-1 then b.je else 0 end) as ys_gsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=0 then b.je else 0 end) as ys_ddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=0 then b.je else 0 end) as ys_ddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=1 then b.je else 0 end) as ys_xdddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=1 then b.je else 0 end) as ys_xdddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny then b.je else 0 end) as ys_hjfy, 
	sum(b.je) as ys_allfy 
    from #tmp_khb a inner join zw_t_fyjh_kz b on a.khid=b.tzid where b.nd=left(@ksny,4) and b.djlx=12457 /*(b.ny>=@ksny and b.ny<=@jsny) */
    and b.ny>=a.ksny and b.ny<=a.jsny
    group by b.ny,a.sskhid,a.khid    
) a ;
 /*同期实际开支*/
   select 'sjfy' as cs,b.nd,b.ny,1 as xh,a.sskhid,a.khid,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' then b.je else 0 end) as sj_gsfy,  
   sum(case when a.khid=b.khid and b.sjlx='ddmy' and a.xdbs=0 then b.je else 0 end) as sj_ddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=0 then b.je else 0 end) as sj_ddfy,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddfy
   /*,sum(b.je) as sj_hjfy*/
   into #fyb2 
   from #tmp_khb a inner join  [192.168.35.10].tlsoft.dbo.rs_t_yxsjfyb b on a.khid=b.khid 
   where b.nd=2016 and b.khid>0 and b.sjlx in ('sjfy','ddmy') and b.ny>='201603' and b.ny<='201702' 
         and ((b.ny>=@ksny and b.ny<=@jsny) or (b.ny>=@tqksny and b.ny<=@tqjsny) )
    group by b.nd,b.ny,a.sskhid,a.khid;
 /*本期实际开支*/
 select a.* into #fyb1 from (
   /*日常开支，店租费用，税务费用，个人借款，个人花费，差旅费，工资,固定资产*/
   select a.cs,dbo.f_Zw_kjnd(a.khid,a.rq) as nd,convert(varchar(6),a.rq,112) as ny,1 as xh,kh.sskhid,kh.khid,
   sum(case when ((a.jb='xf' and a.bxlx=0) or (a.bxlx=1 and a.jb!='xz')) then a.hdje else 0 end) as sj_gsfy,  
   sum(case when a.jb='mydd' and a.bxlx=0 and kh.xdbs=0  then a.hdje else 0 end) as sj_ddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=0 then a.hdje else 0 end) as sj_ddfy, 
   sum(case when a.jb='mydd'  and a.bxlx=0 and kh.xdbs=1  then a.hdje else 0 end) as sj_xdddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=1 then a.hdje else 0 end) as sj_xdddfy  
  from zw_v_sjkzfy a
  inner join #tmp_khb kh on a.khid=kh.khid 
  where a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.pzbs=1
  group by dbo.f_Zw_kjnd(a.khid,a.rq),convert(varchar(6),a.rq,112) ,kh.sskhid,kh.khid,a.cs
) a 


select *,sj_gsfy+sj_ddgsfy+sj_ddfy+sj_xdddgsfy+sj_xdddfy as sj_hjfy into #fyb 
from (
   select * from #fyb1   
   union all 
   select * from #fyb2 
) a ;

 /*往来款*/
 select a.tzid,sum(jfje) as sr,sum(dfje) as zc
 into #wlk 
 from Zw_T_Cnrjz as a 
 inner join ( select kmdm from zw_t_kmsdb where djlx='12460' and xjdfkm=6982 and tzid=1 and scxe=1  ) b on a.dfkm=b.kmdm
 where a.lylx in (311,312,316,321,322,323,0,826) 
  and  a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.nd=dbo.f_zw_kjnd(a.tzid,@jsrq) 
 group by a.tzid


  select a.sskhid,km.kmdm into #sykmdm from (select sskhid from #tmp_khb group by sskhid) a 
  inner join zw_t_zwkmb km on a.sskhid=km.tzid 
  where km.nd=2017 and km.kzlb=1 
  group by a.sskhid,km.kmdm ;

 select a.sskhid,sum(xjcnzc) as xjcnzc,sum(xxjcnzc) as xxjcnzc,sum(sjcnzc) as sjcnzc,sum(ddcnzc) as ddcnzc,sum(xdddcnzc) as xdddcnzc 
        into #cnzc 
 from (
    select a.sskhid,sum(case when b.khid>0  and b.khid!=b.tzid and isnull(kh.xdbs,0)=0 then b.dfje else 0 end) as xjcnzc,
           sum(case when b.khid>0  and b.khid!=b.tzid and kh.xdbs=1 then b.dfje else 0 end) as xxjcnzc,
           sum(case when (b.khid=0 or b.khid=b.tzid) then b.dfje else 0 end) as sjcnzc,0 as ddcnzc,0 as xdddcnzc
    from #sykmdm a inner join zw_t_cnrjz b on a.sskhid=b.tzid and a.kmdm=b.dfkm and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq)   
    left outer join #tmp_khb kh on b.khid=kh.khid 
    group by a.sskhid 
    union all 
    select a.sskhid,0 as xjcnzc,0 as xxjcnzc,0 as sjcnzc,sum(case when a.xdbs=0 then dfje else 0 end) as ddcnzc,
           sum(case when a.xdbs=1 then dfje else 0 end) as xdddcnzc 
	from (select sskhid,khid,xdbs from #tmp_khb group by sskhid,khid,xdbs) a 
    inner join zw_t_cnrjz b on a.sskhid=b.tzid and b.khid=a.khid and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq) and b.dfkm='122111' 
    and b.khid>0 group by a.sskhid 
 ) a group by a.sskhid;


/*资金余额[对公，对私]*/
 select a.tzid,sum(case when a.kmdm in ('100201','100202') then a.qmje else 0 end) as dgje 
              ,sum(case when a.kmdm in ('100101','100102','1012') then a.qmje else 0 end) as dsje 
 into #zjyezb 
 from ds_t_cnrjzzzb a where 1=1 and ny=@jsny and a.kmdm in ('100201','100202','100101','100102','1012') group by a.tzid ;


if '2'='1' 
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,max(zj.dgje) as dgje,
       max(zj.dsje) as dsje,max(zc.sjcnzc) as sjcnzc,max(zc.xjcnzc) as xjcnzc,max(zc.ddcnzc) as ddcnzc,
       max(zc.xxjcnzc) as xxjcnzc,max(zc.xdddcnzc) as xdddcnzc,
       max(zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc) as cnzc,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
       sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
       sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy,
       max(allys.ys_allgsfy) as ys_allgsfy, max(allys.ys_allddfy) as ys_allddfy 
       ,max(wl.sr) as wlsr,max(wl.zc) as wlzc,max(wl.zc)-max(wl.sr) as wlce    
   from #tmp_khb kh left outer join #fyb a on kh.sskhid=a.sskhid and kh.khid=a.khid  and a.ny>=@ksny and a.ny<=@jsny
   left outer join #jhb b on kh.sskhid=b.sskhid and kh.khid=b.khid and b.ny>=@ksny and b.ny>=@jsny  
   left outer join #fyb c on kh.sskhid=c.sskhid and kh.khid=c.khid and c.ny>=@tqksny and c.ny<=@tqjsny and right(a.ny,2)=right(c.ny,2) 
        and a.sj_hjfy>0 and c.sj_hjfy>0 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.sskhid=allys.sskhid 
   left outer join #cnzc zc on kh.sskhid=zc.sskhid 
   left outer join #zjyezb zj on kh.sskhid=zj.tzid  
   left join #wlk wl on kh.sskhid=wl.tzid
   where 1=1 
   group by kh.sskhid,kh.sskhmc,kh.sskhdm,kh.sfmc   
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 

if '2'='2' or '2'=''
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb 
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq   
       ,zj.dgje,zj.dsje,zc.sjcnzc,zc.xjcnzc,zc.ddcnzc, 
       zc.xxjcnzc,zc.xdddcnzc,
       zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc as cnzc,
       allys.ys_allgsfy,allys.ys_allddfy  
       ,wl.sr as wlsr,wl.zc as wlzc,wl.zc-wl.sr as wlce 
    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.tq_gsfy) as tq_gsfy, sum(c.tq_ddgsfy) as tq_ddgsfy,
       sum(c.tq_ddfy) as tq_ddfy, sum(c.tq_xdddgsfy) as tq_xdddgsfy,
       sum(c.tq_xdddfy) as tq_xdddfy,sum(c.tq_hjfy) as tq_hjfy
   from #tmp_khb kh 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as sj_gsfy, sum(c.sj_ddgsfy) as sj_ddgsfy,
              sum(c.sj_ddfy) as sj_ddfy, sum(c.sj_xdddgsfy) as sj_xdddgsfy,
              sum(c.sj_xdddfy) as sj_xdddfy,sum(c.sj_hjfy) as sj_hjfy  
       from #fyb c where c.ny>=@ksny and c.ny<=@jsny group by c.sskhid,c.khid 
   ) a on kh.sskhid=a.sskhid and kh.khid=a.khid 
   left outer join (select sskhid,khid,sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy from #jhb b where b.ny>=@ksny and b.ny<=@jsny group by sskhid,khid) b 
   on kh.sskhid=b.sskhid and kh.khid=b.khid 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
              sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
              sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy  
       from #fyb c where c.ny>=@tqksny and c.ny<=@tqjsny group by c.sskhid,c.khid 
   ) c on kh.sskhid=c.sskhid and kh.khid=c.khid 
   group by kh.sskhdm,kh.sskhid,kh.sskhmc,kh.sfmc  
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.khid=allys.sskhid 
   left outer join #cnzc zc on a.khid=zc.sskhid 
   left outer join #zjyezb zj on a.khid=zj.tzid 
   left join #wlk wl on a.khid=wl.tzid;

drop table #tmp_khb;
drop table #jhb;
drop table #fyb1 ;
drop table #fyb2 ;
drop table #fyb ;
drop table #sykmdm ;
drop table #cnzc ;
drop table #zjyezb ;
drop table #wlk;
 

2017-8-22 10:58:59  declare @ksny varchar(6); 
declare @jsny varchar(6); 
declare @tqksny varchar(6); 
declare @tqjsny varchar(6); 
declare @jsrq datetime ;
declare @ksrq datetime ;
declare @tqjsrq varchar(10); 
declare @tqksrq varchar(10);

select @ksny=convert(varchar(6),cast('2017-08-01' as datetime),112);
select @jsny=convert(varchar(6),cast('2017-08-22' as datetime),112);
select @tqksny=convert(varchar(6),dateadd(year,-1,cast('2017-08-01' as datetime)),112);/*上一年度*/
select @tqjsny=convert(varchar(6),dateadd(year,-1,cast('2017-08-22' as datetime)),112);
set @ksrq='2017-08-01' ;
set @jsrq='2017-08-22' ;
select @tqksrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-01' as datetime)) ,120); 
select @tqjsrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-22' as datetime)) ,120); 

select a.* into #tmp_khb from ( 
    select distinct b.khid,a.khid sskhid,a.khdm as sskhdm,a.khjc as sskhmc,b.khmc,b.ccid,gx.ksny,gx.jsny,b.ssid,c.mc as sfmc,a.lxr,
           case when Convert(varchar(6),isnull(gx.sjkyrq,'1900-01-01'),112) between @ksny and @jsny then 1 else 0 end as xdbs   
    from yx_t_khb a 
    left join  [192.168.35.10].tlsoft.dbo.yx_t_khsfdm c on a.sfdm=c.dm   
    inner join yx_t_khb b on a.ssid=1 and a.khlbdm<>'g' and (b.ccid+'-' like a.ccid+'-%')  and a.khid>1 
    left outer join yx_t_khgxb gx on gx.khid=case when b.khlbdm in ('D','d') then b.ssid else a.khid end and b.khid=gx.gxid and (gx.ksny<=@jsny and gx.jsny>=@ksny) 
    where 1=1 and a.khid not in(85,1384,14204) and len(a.dzbbpx)>0 and b.khmc not like '%直销户%' and b.ty=0 
          and a.khfl like 'x%' and isnull(gx.qtlx,0)=0   /*and b.khfl='xz'*/
) as a ; 

select * into #jhb from (
    select 'ys' as cs,b.ny,1 as xh,a.sskhid,a.khid,
           sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-1 then b.je else 0 end) as ys_gsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=0 then b.je else 0 end) as ys_ddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=0 then b.je else 0 end) as ys_ddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=1 then b.je else 0 end) as ys_xdddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=1 then b.je else 0 end) as ys_xdddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny then b.je else 0 end) as ys_hjfy, 
	sum(b.je) as ys_allfy 
    from #tmp_khb a inner join zw_t_fyjh_kz b on a.khid=b.tzid where b.nd=left(@ksny,4) and b.djlx=12457 /*(b.ny>=@ksny and b.ny<=@jsny) */
    and b.ny>=a.ksny and b.ny<=a.jsny
    group by b.ny,a.sskhid,a.khid    
) a ;
 /*同期实际开支*/
   select 'sjfy' as cs,b.nd,b.ny,1 as xh,a.sskhid,a.khid,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' then b.je else 0 end) as sj_gsfy,  
   sum(case when a.khid=b.khid and b.sjlx='ddmy' and a.xdbs=0 then b.je else 0 end) as sj_ddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=0 then b.je else 0 end) as sj_ddfy,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddfy
   /*,sum(b.je) as sj_hjfy*/
   into #fyb2 
   from #tmp_khb a inner join  [192.168.35.10].tlsoft.dbo.rs_t_yxsjfyb b on a.khid=b.khid 
   where b.nd=2016 and b.khid>0 and b.sjlx in ('sjfy','ddmy') and b.ny>='201603' and b.ny<='201702' 
         and ((b.ny>=@ksny and b.ny<=@jsny) or (b.ny>=@tqksny and b.ny<=@tqjsny) )
    group by b.nd,b.ny,a.sskhid,a.khid;
 /*本期实际开支*/
 select a.* into #fyb1 from (
   /*日常开支，店租费用，税务费用，个人借款，个人花费，差旅费，工资,固定资产*/
   select a.cs,dbo.f_Zw_kjnd(a.khid,a.rq) as nd,convert(varchar(6),a.rq,112) as ny,1 as xh,kh.sskhid,kh.khid,
   sum(case when ((a.jb='xf' and a.bxlx=0) or (a.bxlx=1 and a.jb!='xz')) then a.hdje else 0 end) as sj_gsfy,  
   sum(case when a.jb='mydd' and a.bxlx=0 and kh.xdbs=0  then a.hdje else 0 end) as sj_ddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=0 then a.hdje else 0 end) as sj_ddfy, 
   sum(case when a.jb='mydd'  and a.bxlx=0 and kh.xdbs=1  then a.hdje else 0 end) as sj_xdddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=1 then a.hdje else 0 end) as sj_xdddfy  
  from zw_v_sjkzfy a
  inner join #tmp_khb kh on a.khid=kh.khid 
  where a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.pzbs=1
  group by dbo.f_Zw_kjnd(a.khid,a.rq),convert(varchar(6),a.rq,112) ,kh.sskhid,kh.khid,a.cs
) a 


select *,sj_gsfy+sj_ddgsfy+sj_ddfy+sj_xdddgsfy+sj_xdddfy as sj_hjfy into #fyb 
from (
   select * from #fyb1   
   union all 
   select * from #fyb2 
) a ;

 /*往来款*/
 select a.tzid,sum(jfje) as sr,sum(dfje) as zc
 into #wlk 
 from Zw_T_Cnrjz as a 
 inner join ( select kmdm from zw_t_kmsdb where djlx='12460' and xjdfkm=6982 and tzid=1 and scxe=1  ) b on a.dfkm=b.kmdm
 where a.lylx in (311,312,316,321,322,323,0,826) 
  and  a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.nd=dbo.f_zw_kjnd(a.tzid,@jsrq) 
 group by a.tzid


  select a.sskhid,km.kmdm into #sykmdm from (select sskhid from #tmp_khb group by sskhid) a 
  inner join zw_t_zwkmb km on a.sskhid=km.tzid 
  where km.nd=2017 and km.kzlb=1 
  group by a.sskhid,km.kmdm ;

 select a.sskhid,sum(xjcnzc) as xjcnzc,sum(xxjcnzc) as xxjcnzc,sum(sjcnzc) as sjcnzc,sum(ddcnzc) as ddcnzc,sum(xdddcnzc) as xdddcnzc 
        into #cnzc 
 from (
    select a.sskhid,sum(case when b.khid>0  and b.khid!=b.tzid and isnull(kh.xdbs,0)=0 then b.dfje else 0 end) as xjcnzc,
           sum(case when b.khid>0  and b.khid!=b.tzid and kh.xdbs=1 then b.dfje else 0 end) as xxjcnzc,
           sum(case when (b.khid=0 or b.khid=b.tzid) then b.dfje else 0 end) as sjcnzc,0 as ddcnzc,0 as xdddcnzc
    from #sykmdm a inner join zw_t_cnrjz b on a.sskhid=b.tzid and a.kmdm=b.dfkm and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq)   
    left outer join #tmp_khb kh on b.khid=kh.khid 
    group by a.sskhid 
    union all 
    select a.sskhid,0 as xjcnzc,0 as xxjcnzc,0 as sjcnzc,sum(case when a.xdbs=0 then dfje else 0 end) as ddcnzc,
           sum(case when a.xdbs=1 then dfje else 0 end) as xdddcnzc 
	from (select sskhid,khid,xdbs from #tmp_khb group by sskhid,khid,xdbs) a 
    inner join zw_t_cnrjz b on a.sskhid=b.tzid and b.khid=a.khid and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq) and b.dfkm='122111' 
    and b.khid>0 group by a.sskhid 
 ) a group by a.sskhid;


/*资金余额[对公，对私]*/
 select a.tzid,sum(case when a.kmdm in ('100201','100202') then a.qmje else 0 end) as dgje 
              ,sum(case when a.kmdm in ('100101','100102','1012') then a.qmje else 0 end) as dsje 
 into #zjyezb 
 from ds_t_cnrjzzzb a where 1=1 and ny=@jsny and a.kmdm in ('100201','100202','100101','100102','1012') group by a.tzid ;


if '2'='1' 
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,max(zj.dgje) as dgje,
       max(zj.dsje) as dsje,max(zc.sjcnzc) as sjcnzc,max(zc.xjcnzc) as xjcnzc,max(zc.ddcnzc) as ddcnzc,
       max(zc.xxjcnzc) as xxjcnzc,max(zc.xdddcnzc) as xdddcnzc,
       max(zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc) as cnzc,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
       sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
       sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy,
       max(allys.ys_allgsfy) as ys_allgsfy, max(allys.ys_allddfy) as ys_allddfy 
       ,max(wl.sr) as wlsr,max(wl.zc) as wlzc,max(wl.zc)-max(wl.sr) as wlce    
   from #tmp_khb kh left outer join #fyb a on kh.sskhid=a.sskhid and kh.khid=a.khid  and a.ny>=@ksny and a.ny<=@jsny
   left outer join #jhb b on kh.sskhid=b.sskhid and kh.khid=b.khid and b.ny>=@ksny and b.ny>=@jsny  
   left outer join #fyb c on kh.sskhid=c.sskhid and kh.khid=c.khid and c.ny>=@tqksny and c.ny<=@tqjsny and right(a.ny,2)=right(c.ny,2) 
        and a.sj_hjfy>0 and c.sj_hjfy>0 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.sskhid=allys.sskhid 
   left outer join #cnzc zc on kh.sskhid=zc.sskhid 
   left outer join #zjyezb zj on kh.sskhid=zj.tzid  
   left join #wlk wl on kh.sskhid=wl.tzid
   where 1=1 
   group by kh.sskhid,kh.sskhmc,kh.sskhdm,kh.sfmc   
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 

if '2'='2' or '2'=''
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb 
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq   
       ,zj.dgje,zj.dsje,zc.sjcnzc,zc.xjcnzc,zc.ddcnzc, 
       zc.xxjcnzc,zc.xdddcnzc,
       zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc as cnzc,
       allys.ys_allgsfy,allys.ys_allddfy  
       ,wl.sr as wlsr,wl.zc as wlzc,wl.zc-wl.sr as wlce 
    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.tq_gsfy) as tq_gsfy, sum(c.tq_ddgsfy) as tq_ddgsfy,
       sum(c.tq_ddfy) as tq_ddfy, sum(c.tq_xdddgsfy) as tq_xdddgsfy,
       sum(c.tq_xdddfy) as tq_xdddfy,sum(c.tq_hjfy) as tq_hjfy
   from #tmp_khb kh 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as sj_gsfy, sum(c.sj_ddgsfy) as sj_ddgsfy,
              sum(c.sj_ddfy) as sj_ddfy, sum(c.sj_xdddgsfy) as sj_xdddgsfy,
              sum(c.sj_xdddfy) as sj_xdddfy,sum(c.sj_hjfy) as sj_hjfy  
       from #fyb c where c.ny>=@ksny and c.ny<=@jsny group by c.sskhid,c.khid 
   ) a on kh.sskhid=a.sskhid and kh.khid=a.khid 
   left outer join (select sskhid,khid,sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy from #jhb b where b.ny>=@ksny and b.ny<=@jsny group by sskhid,khid) b 
   on kh.sskhid=b.sskhid and kh.khid=b.khid 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
              sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
              sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy  
       from #fyb c where c.ny>=@tqksny and c.ny<=@tqjsny group by c.sskhid,c.khid 
   ) c on kh.sskhid=c.sskhid and kh.khid=c.khid 
   group by kh.sskhdm,kh.sskhid,kh.sskhmc,kh.sfmc  
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.khid=allys.sskhid 
   left outer join #cnzc zc on a.khid=zc.sskhid 
   left outer join #zjyezb zj on a.khid=zj.tzid 
   left join #wlk wl on a.khid=wl.tzid;

drop table #tmp_khb;
drop table #jhb;
drop table #fyb1 ;
drop table #fyb2 ;
drop table #fyb ;
drop table #sykmdm ;
drop table #cnzc ;
drop table #zjyezb ;
drop table #wlk;
 

2017-8-22 11:09:14  declare @ksny varchar(6); 
declare @jsny varchar(6); 
declare @tqksny varchar(6); 
declare @tqjsny varchar(6); 
declare @jsrq datetime ;
declare @ksrq datetime ;
declare @tqjsrq varchar(10); 
declare @tqksrq varchar(10);

select @ksny=convert(varchar(6),cast('2017-08-01' as datetime),112);
select @jsny=convert(varchar(6),cast('2017-08-22' as datetime),112);
select @tqksny=convert(varchar(6),dateadd(year,-1,cast('2017-08-01' as datetime)),112);/*上一年度*/
select @tqjsny=convert(varchar(6),dateadd(year,-1,cast('2017-08-22' as datetime)),112);
set @ksrq='2017-08-01' ;
set @jsrq='2017-08-22' ;
select @tqksrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-01' as datetime)) ,120); 
select @tqjsrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-22' as datetime)) ,120); 

select a.* into #tmp_khb from ( 
    select distinct b.khid,a.khid sskhid,a.khdm as sskhdm,a.khjc as sskhmc,b.khmc,b.ccid,gx.ksny,gx.jsny,b.ssid,c.mc as sfmc,a.lxr,
           case when Convert(varchar(6),isnull(gx.sjkyrq,'1900-01-01'),112) between @ksny and @jsny then 1 else 0 end as xdbs   
    from yx_t_khb a 
    left join  [192.168.35.10].tlsoft.dbo.yx_t_khsfdm c on a.sfdm=c.dm   
    inner join yx_t_khb b on a.ssid=1 and a.khlbdm<>'g' and (b.ccid+'-' like a.ccid+'-%')  and a.khid>1 
    left outer join yx_t_khgxb gx on gx.khid=case when b.khlbdm in ('D','d') then b.ssid else a.khid end and b.khid=gx.gxid and (gx.ksny<=@jsny and gx.jsny>=@ksny) 
    where 1=1 and a.khid not in(85,1384,14204) and len(a.dzbbpx)>0 and b.khmc not like '%直销户%' and b.ty=0 
          and a.khfl like 'x%' and isnull(gx.qtlx,0)=0   /*and b.khfl='xz'*/
) as a ; 

select * into #jhb from (
    select 'ys' as cs,b.ny,1 as xh,a.sskhid,a.khid,
           sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-1 then b.je else 0 end) as ys_gsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=0 then b.je else 0 end) as ys_ddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=0 then b.je else 0 end) as ys_ddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=1 then b.je else 0 end) as ys_xdddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=1 then b.je else 0 end) as ys_xdddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny then b.je else 0 end) as ys_hjfy, 
	sum(b.je) as ys_allfy 
    from #tmp_khb a inner join zw_t_fyjh_kz b on a.khid=b.tzid where b.nd=left(@ksny,4) and b.djlx=12457 /*(b.ny>=@ksny and b.ny<=@jsny) */
    and b.ny>=a.ksny and b.ny<=a.jsny
    group by b.ny,a.sskhid,a.khid    
) a ;
 /*同期实际开支*/
   select 'sjfy' as cs,b.nd,b.ny,1 as xh,a.sskhid,a.khid,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' then b.je else 0 end) as sj_gsfy,  
   sum(case when a.khid=b.khid and b.sjlx='ddmy' and a.xdbs=0 then b.je else 0 end) as sj_ddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=0 then b.je else 0 end) as sj_ddfy,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddfy
   /*,sum(b.je) as sj_hjfy*/
   into #fyb2 
   from #tmp_khb a inner join  [192.168.35.10].tlsoft.dbo.rs_t_yxsjfyb b on a.khid=b.khid 
   where b.nd=2016 and b.khid>0 and b.sjlx in ('sjfy','ddmy') and b.ny>='201603' and b.ny<='201702' 
         and ((b.ny>=@ksny and b.ny<=@jsny) or (b.ny>=@tqksny and b.ny<=@tqjsny) )
    group by b.nd,b.ny,a.sskhid,a.khid;
 /*本期实际开支*/
 select a.* into #fyb1 from (
   /*日常开支，店租费用，税务费用，个人借款，个人花费，差旅费，工资,固定资产*/
   select a.cs,dbo.f_Zw_kjnd(a.khid,a.rq) as nd,convert(varchar(6),a.rq,112) as ny,1 as xh,kh.sskhid,kh.khid,
   sum(case when ((a.jb='xf' and a.bxlx=0) or (a.bxlx=1 and a.jb!='xz')) then a.hdje else 0 end) as sj_gsfy,  
   sum(case when a.jb='mydd' and a.bxlx=0 and kh.xdbs=0  then a.hdje else 0 end) as sj_ddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=0 then a.hdje else 0 end) as sj_ddfy, 
   sum(case when a.jb='mydd'  and a.bxlx=0 and kh.xdbs=1  then a.hdje else 0 end) as sj_xdddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=1 then a.hdje else 0 end) as sj_xdddfy  
  from zw_v_sjkzfy a
  inner join #tmp_khb kh on a.khid=kh.khid 
  where a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.pzbs=1
  group by dbo.f_Zw_kjnd(a.khid,a.rq),convert(varchar(6),a.rq,112) ,kh.sskhid,kh.khid,a.cs
) a 


select *,sj_gsfy+sj_ddgsfy+sj_ddfy+sj_xdddgsfy+sj_xdddfy as sj_hjfy into #fyb 
from (
   select * from #fyb1   
   union all 
   select * from #fyb2 
) a ;

 /*往来款*/
 select a.tzid,sum(jfje) as sr,sum(dfje) as zc
 into #wlk 
 from Zw_T_Cnrjz as a 
 inner join ( select kmdm from zw_t_kmsdb where djlx='12460' and xjdfkm=6982 and tzid=1 and scxe=1  ) b on a.dfkm=b.kmdm
 where a.lylx in (311,312,316,321,322,323,0,826) 
  and  a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.nd=dbo.f_zw_kjnd(a.tzid,@jsrq) 
 group by a.tzid


  select a.sskhid,km.kmdm into #sykmdm from (select sskhid from #tmp_khb group by sskhid) a 
  inner join zw_t_zwkmb km on a.sskhid=km.tzid 
  where km.nd=2017 and km.kzlb=1 
  group by a.sskhid,km.kmdm ;

 select a.sskhid,sum(xjcnzc) as xjcnzc,sum(xxjcnzc) as xxjcnzc,sum(sjcnzc) as sjcnzc,sum(ddcnzc) as ddcnzc,sum(xdddcnzc) as xdddcnzc 
        into #cnzc 
 from (
    select a.sskhid,sum(case when b.khid>0  and b.khid!=b.tzid and isnull(kh.xdbs,0)=0 then b.dfje else 0 end) as xjcnzc,
           sum(case when b.khid>0  and b.khid!=b.tzid and kh.xdbs=1 then b.dfje else 0 end) as xxjcnzc,
           sum(case when (b.khid=0 or b.khid=b.tzid) then b.dfje else 0 end) as sjcnzc,0 as ddcnzc,0 as xdddcnzc
    from #sykmdm a inner join zw_t_cnrjz b on a.sskhid=b.tzid and a.kmdm=b.dfkm and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq)   
    left outer join #tmp_khb kh on b.khid=kh.khid 
    group by a.sskhid 
    union all 
    select a.sskhid,0 as xjcnzc,0 as xxjcnzc,0 as sjcnzc,sum(case when a.xdbs=0 then dfje else 0 end) as ddcnzc,
           sum(case when a.xdbs=1 then dfje else 0 end) as xdddcnzc 
	from (select sskhid,khid,xdbs from #tmp_khb group by sskhid,khid,xdbs) a 
    inner join zw_t_cnrjz b on a.sskhid=b.tzid and b.khid=a.khid and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq) and b.dfkm='122111' 
    and b.khid>0 group by a.sskhid 
 ) a group by a.sskhid;


/*资金余额[对公，对私]*/
 select a.tzid,sum(case when a.kmdm in ('100201','100202') then a.qmje else 0 end) as dgje 
              ,sum(case when a.kmdm in ('100101','100102','1012') then a.qmje else 0 end) as dsje 
 into #zjyezb 
 from ds_t_cnrjzzzb a where 1=1 and ny=@jsny and a.kmdm in ('100201','100202','100101','100102','1012') group by a.tzid ;


if '2'='1' 
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,max(zj.dgje) as dgje,
       max(zj.dsje) as dsje,max(zc.sjcnzc) as sjcnzc,max(zc.xjcnzc) as xjcnzc,max(zc.ddcnzc) as ddcnzc,
       max(zc.xxjcnzc) as xxjcnzc,max(zc.xdddcnzc) as xdddcnzc,
       max(zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc) as cnzc,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
       sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
       sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy,
       max(allys.ys_allgsfy) as ys_allgsfy, max(allys.ys_allddfy) as ys_allddfy 
       ,max(wl.sr) as wlsr,max(wl.zc) as wlzc,max(wl.zc)-max(wl.sr) as wlce    
   from #tmp_khb kh left outer join #fyb a on kh.sskhid=a.sskhid and kh.khid=a.khid  and a.ny>=@ksny and a.ny<=@jsny
   left outer join #jhb b on kh.sskhid=b.sskhid and kh.khid=b.khid and b.ny>=@ksny and b.ny>=@jsny  
   left outer join #fyb c on kh.sskhid=c.sskhid and kh.khid=c.khid and c.ny>=@tqksny and c.ny<=@tqjsny and right(a.ny,2)=right(c.ny,2) 
        and a.sj_hjfy>0 and c.sj_hjfy>0 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.sskhid=allys.sskhid 
   left outer join #cnzc zc on kh.sskhid=zc.sskhid 
   left outer join #zjyezb zj on kh.sskhid=zj.tzid  
   left join #wlk wl on kh.sskhid=wl.tzid
   where 1=1 
   group by kh.sskhid,kh.sskhmc,kh.sskhdm,kh.sfmc   
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 

if '2'='2' or '2'=''
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb 
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq   
       ,zj.dgje,zj.dsje,zc.sjcnzc,zc.xjcnzc,zc.ddcnzc, 
       zc.xxjcnzc,zc.xdddcnzc,
       zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc as cnzc,
       allys.ys_allgsfy,allys.ys_allddfy  
       ,wl.sr as wlsr,wl.zc as wlzc,wl.zc-wl.sr as wlce 
    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.tq_gsfy) as tq_gsfy, sum(c.tq_ddgsfy) as tq_ddgsfy,
       sum(c.tq_ddfy) as tq_ddfy, sum(c.tq_xdddgsfy) as tq_xdddgsfy,
       sum(c.tq_xdddfy) as tq_xdddfy,sum(c.tq_hjfy) as tq_hjfy
   from #tmp_khb kh 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as sj_gsfy, sum(c.sj_ddgsfy) as sj_ddgsfy,
              sum(c.sj_ddfy) as sj_ddfy, sum(c.sj_xdddgsfy) as sj_xdddgsfy,
              sum(c.sj_xdddfy) as sj_xdddfy,sum(c.sj_hjfy) as sj_hjfy  
       from #fyb c where c.ny>=@ksny and c.ny<=@jsny group by c.sskhid,c.khid 
   ) a on kh.sskhid=a.sskhid and kh.khid=a.khid 
   left outer join (select sskhid,khid,sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy from #jhb b where b.ny>=@ksny and b.ny<=@jsny group by sskhid,khid) b 
   on kh.sskhid=b.sskhid and kh.khid=b.khid 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
              sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
              sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy  
       from #fyb c where c.ny>=@tqksny and c.ny<=@tqjsny group by c.sskhid,c.khid 
   ) c on kh.sskhid=c.sskhid and kh.khid=c.khid 
   group by kh.sskhdm,kh.sskhid,kh.sskhmc,kh.sfmc  
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.khid=allys.sskhid 
   left outer join #cnzc zc on a.khid=zc.sskhid 
   left outer join #zjyezb zj on a.khid=zj.tzid 
   left join #wlk wl on a.khid=wl.tzid;

drop table #tmp_khb;
drop table #jhb;
drop table #fyb1 ;
drop table #fyb2 ;
drop table #fyb ;
drop table #sykmdm ;
drop table #cnzc ;
drop table #zjyezb ;
drop table #wlk;
 

2017-8-22 11:09:49  declare @ksny varchar(6); 
declare @jsny varchar(6); 
declare @tqksny varchar(6); 
declare @tqjsny varchar(6); 
declare @jsrq datetime ;
declare @ksrq datetime ;
declare @tqjsrq varchar(10); 
declare @tqksrq varchar(10);

select @ksny=convert(varchar(6),cast('2017-08-01' as datetime),112);
select @jsny=convert(varchar(6),cast('2017-08-22' as datetime),112);
select @tqksny=convert(varchar(6),dateadd(year,-1,cast('2017-08-01' as datetime)),112);/*上一年度*/
select @tqjsny=convert(varchar(6),dateadd(year,-1,cast('2017-08-22' as datetime)),112);
set @ksrq='2017-08-01' ;
set @jsrq='2017-08-22' ;
select @tqksrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-01' as datetime)) ,120); 
select @tqjsrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-22' as datetime)) ,120); 

select a.* into #tmp_khb from ( 
    select distinct b.khid,a.khid sskhid,a.khdm as sskhdm,a.khjc as sskhmc,b.khmc,b.ccid,gx.ksny,gx.jsny,b.ssid,c.mc as sfmc,a.lxr,
           case when Convert(varchar(6),isnull(gx.sjkyrq,'1900-01-01'),112) between @ksny and @jsny then 1 else 0 end as xdbs   
    from yx_t_khb a 
    left join  [192.168.35.10].tlsoft.dbo.yx_t_khsfdm c on a.sfdm=c.dm   
    inner join yx_t_khb b on a.ssid=1 and a.khlbdm<>'g' and (b.ccid+'-' like a.ccid+'-%')  and a.khid>1 
    left outer join yx_t_khgxb gx on gx.khid=case when b.khlbdm in ('D','d') then b.ssid else a.khid end and b.khid=gx.gxid and (gx.ksny<=@jsny and gx.jsny>=@ksny) 
    where 1=1 and a.khid not in(85,1384,14204) and len(a.dzbbpx)>0 and b.khmc not like '%直销户%' and b.ty=0 
          and a.khfl like 'x%' and isnull(gx.qtlx,0)=0   /*and b.khfl='xz'*/
) as a ; 

select * into #jhb from (
    select 'ys' as cs,b.ny,1 as xh,a.sskhid,a.khid,
           sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-1 then b.je else 0 end) as ys_gsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=0 then b.je else 0 end) as ys_ddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=0 then b.je else 0 end) as ys_ddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=1 then b.je else 0 end) as ys_xdddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=1 then b.je else 0 end) as ys_xdddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny then b.je else 0 end) as ys_hjfy, 
	sum(b.je) as ys_allfy 
    from #tmp_khb a inner join zw_t_fyjh_kz b on a.khid=b.tzid where b.nd=left(@ksny,4) and b.djlx=12457 /*(b.ny>=@ksny and b.ny<=@jsny) */
    and b.ny>=a.ksny and b.ny<=a.jsny
    group by b.ny,a.sskhid,a.khid    
) a ;
 /*同期实际开支*/
   select 'sjfy' as cs,b.nd,b.ny,1 as xh,a.sskhid,a.khid,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' then b.je else 0 end) as sj_gsfy,  
   sum(case when a.khid=b.khid and b.sjlx='ddmy' and a.xdbs=0 then b.je else 0 end) as sj_ddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=0 then b.je else 0 end) as sj_ddfy,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddfy
   /*,sum(b.je) as sj_hjfy*/
   into #fyb2 
   from #tmp_khb a inner join  [192.168.35.10].tlsoft.dbo.rs_t_yxsjfyb b on a.khid=b.khid 
   where b.nd=2016 and b.khid>0 and b.sjlx in ('sjfy','ddmy') and b.ny>='201603' and b.ny<='201702' 
         and ((b.ny>=@ksny and b.ny<=@jsny) or (b.ny>=@tqksny and b.ny<=@tqjsny) )
    group by b.nd,b.ny,a.sskhid,a.khid;
 /*本期实际开支*/
 select a.* into #fyb1 from (
   /*日常开支，店租费用，税务费用，个人借款，个人花费，差旅费，工资,固定资产*/
   select a.cs,dbo.f_Zw_kjnd(a.khid,a.rq) as nd,convert(varchar(6),a.rq,112) as ny,1 as xh,kh.sskhid,kh.khid,
   sum(case when ((a.jb='xf' and a.bxlx=0) or (a.bxlx=1 and a.jb!='xz')) then a.hdje else 0 end) as sj_gsfy,  
   sum(case when a.jb='mydd' and a.bxlx=0 and kh.xdbs=0  then a.hdje else 0 end) as sj_ddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=0 then a.hdje else 0 end) as sj_ddfy, 
   sum(case when a.jb='mydd'  and a.bxlx=0 and kh.xdbs=1  then a.hdje else 0 end) as sj_xdddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=1 then a.hdje else 0 end) as sj_xdddfy  
  from zw_v_sjkzfy a
  inner join #tmp_khb kh on a.khid=kh.khid 
  where a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.pzbs=1
  group by dbo.f_Zw_kjnd(a.khid,a.rq),convert(varchar(6),a.rq,112) ,kh.sskhid,kh.khid,a.cs
) a 


select *,sj_gsfy+sj_ddgsfy+sj_ddfy+sj_xdddgsfy+sj_xdddfy as sj_hjfy into #fyb 
from (
   select * from #fyb1   
   union all 
   select * from #fyb2 
) a ;

 /*往来款*/
 select a.tzid,sum(jfje) as sr,sum(dfje) as zc
 into #wlk 
 from Zw_T_Cnrjz as a 
 inner join ( select kmdm from zw_t_kmsdb where djlx='12460' and xjdfkm=6982 and tzid=1 and scxe=1  ) b on a.dfkm=b.kmdm
 where a.lylx in (311,312,316,321,322,323,0,826) 
  and  a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.nd=dbo.f_zw_kjnd(a.tzid,@jsrq) 
 group by a.tzid


  select a.sskhid,km.kmdm into #sykmdm from (select sskhid from #tmp_khb group by sskhid) a 
  inner join zw_t_zwkmb km on a.sskhid=km.tzid 
  where km.nd=2017 and km.kzlb=1 
  group by a.sskhid,km.kmdm ;

 select a.sskhid,sum(xjcnzc) as xjcnzc,sum(xxjcnzc) as xxjcnzc,sum(sjcnzc) as sjcnzc,sum(ddcnzc) as ddcnzc,sum(xdddcnzc) as xdddcnzc 
        into #cnzc 
 from (
    select a.sskhid,sum(case when b.khid>0  and b.khid!=b.tzid and isnull(kh.xdbs,0)=0 then b.dfje else 0 end) as xjcnzc,
           sum(case when b.khid>0  and b.khid!=b.tzid and kh.xdbs=1 then b.dfje else 0 end) as xxjcnzc,
           sum(case when (b.khid=0 or b.khid=b.tzid) then b.dfje else 0 end) as sjcnzc,0 as ddcnzc,0 as xdddcnzc
    from #sykmdm a inner join zw_t_cnrjz b on a.sskhid=b.tzid and a.kmdm=b.dfkm and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq)   
    left outer join #tmp_khb kh on b.khid=kh.khid 
    group by a.sskhid 
    union all 
    select a.sskhid,0 as xjcnzc,0 as xxjcnzc,0 as sjcnzc,sum(case when a.xdbs=0 then dfje else 0 end) as ddcnzc,
           sum(case when a.xdbs=1 then dfje else 0 end) as xdddcnzc 
	from (select sskhid,khid,xdbs from #tmp_khb group by sskhid,khid,xdbs) a 
    inner join zw_t_cnrjz b on a.sskhid=b.tzid and b.khid=a.khid and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq) and b.dfkm='122111' 
    and b.khid>0 group by a.sskhid 
 ) a group by a.sskhid;


/*资金余额[对公，对私]*/
 select a.tzid,sum(case when a.kmdm in ('100201','100202') then a.qmje else 0 end) as dgje 
              ,sum(case when a.kmdm in ('100101','100102','1012') then a.qmje else 0 end) as dsje 
 into #zjyezb 
 from ds_t_cnrjzzzb a where 1=1 and ny=@jsny and a.kmdm in ('100201','100202','100101','100102','1012') group by a.tzid ;


if '2'='1' 
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,max(zj.dgje) as dgje,
       max(zj.dsje) as dsje,max(zc.sjcnzc) as sjcnzc,max(zc.xjcnzc) as xjcnzc,max(zc.ddcnzc) as ddcnzc,
       max(zc.xxjcnzc) as xxjcnzc,max(zc.xdddcnzc) as xdddcnzc,
       max(zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc) as cnzc,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
       sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
       sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy,
       max(allys.ys_allgsfy) as ys_allgsfy, max(allys.ys_allddfy) as ys_allddfy 
       ,max(wl.sr) as wlsr,max(wl.zc) as wlzc,max(wl.zc)-max(wl.sr) as wlce    
   from #tmp_khb kh left outer join #fyb a on kh.sskhid=a.sskhid and kh.khid=a.khid  and a.ny>=@ksny and a.ny<=@jsny
   left outer join #jhb b on kh.sskhid=b.sskhid and kh.khid=b.khid and b.ny>=@ksny and b.ny>=@jsny  
   left outer join #fyb c on kh.sskhid=c.sskhid and kh.khid=c.khid and c.ny>=@tqksny and c.ny<=@tqjsny and right(a.ny,2)=right(c.ny,2) 
        and a.sj_hjfy>0 and c.sj_hjfy>0 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.sskhid=allys.sskhid 
   left outer join #cnzc zc on kh.sskhid=zc.sskhid 
   left outer join #zjyezb zj on kh.sskhid=zj.tzid  
   left join #wlk wl on kh.sskhid=wl.tzid
   where 1=1 
   group by kh.sskhid,kh.sskhmc,kh.sskhdm,kh.sfmc   
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 

if '2'='2' or '2'=''
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb 
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq   
       ,zj.dgje,zj.dsje,zc.sjcnzc,zc.xjcnzc,zc.ddcnzc, 
       zc.xxjcnzc,zc.xdddcnzc,
       zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc as cnzc,
       allys.ys_allgsfy,allys.ys_allddfy  
       ,wl.sr as wlsr,wl.zc as wlzc,wl.zc-wl.sr as wlce 
    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.tq_gsfy) as tq_gsfy, sum(c.tq_ddgsfy) as tq_ddgsfy,
       sum(c.tq_ddfy) as tq_ddfy, sum(c.tq_xdddgsfy) as tq_xdddgsfy,
       sum(c.tq_xdddfy) as tq_xdddfy,sum(c.tq_hjfy) as tq_hjfy
   from #tmp_khb kh 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as sj_gsfy, sum(c.sj_ddgsfy) as sj_ddgsfy,
              sum(c.sj_ddfy) as sj_ddfy, sum(c.sj_xdddgsfy) as sj_xdddgsfy,
              sum(c.sj_xdddfy) as sj_xdddfy,sum(c.sj_hjfy) as sj_hjfy  
       from #fyb c where c.ny>=@ksny and c.ny<=@jsny group by c.sskhid,c.khid 
   ) a on kh.sskhid=a.sskhid and kh.khid=a.khid 
   left outer join (select sskhid,khid,sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy from #jhb b where b.ny>=@ksny and b.ny<=@jsny group by sskhid,khid) b 
   on kh.sskhid=b.sskhid and kh.khid=b.khid 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
              sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
              sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy  
       from #fyb c where c.ny>=@tqksny and c.ny<=@tqjsny group by c.sskhid,c.khid 
   ) c on kh.sskhid=c.sskhid and kh.khid=c.khid 
   group by kh.sskhdm,kh.sskhid,kh.sskhmc,kh.sfmc  
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.khid=allys.sskhid 
   left outer join #cnzc zc on a.khid=zc.sskhid 
   left outer join #zjyezb zj on a.khid=zj.tzid 
   left join #wlk wl on a.khid=wl.tzid;

drop table #tmp_khb;
drop table #jhb;
drop table #fyb1 ;
drop table #fyb2 ;
drop table #fyb ;
drop table #sykmdm ;
drop table #cnzc ;
drop table #zjyezb ;
drop table #wlk;
 

2017-8-22 11:11:44  declare @ksny varchar(6); 
declare @jsny varchar(6); 
declare @tqksny varchar(6); 
declare @tqjsny varchar(6); 
declare @jsrq datetime ;
declare @ksrq datetime ;
declare @tqjsrq varchar(10); 
declare @tqksrq varchar(10);

select @ksny=convert(varchar(6),cast('2017-08-01' as datetime),112);
select @jsny=convert(varchar(6),cast('2017-08-22' as datetime),112);
select @tqksny=convert(varchar(6),dateadd(year,-1,cast('2017-08-01' as datetime)),112);/*上一年度*/
select @tqjsny=convert(varchar(6),dateadd(year,-1,cast('2017-08-22' as datetime)),112);
set @ksrq='2017-08-01' ;
set @jsrq='2017-08-22' ;
select @tqksrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-01' as datetime)) ,120); 
select @tqjsrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-22' as datetime)) ,120); 

select a.* into #tmp_khb from ( 
    select distinct b.khid,a.khid sskhid,a.khdm as sskhdm,a.khjc as sskhmc,b.khmc,b.ccid,gx.ksny,gx.jsny,b.ssid,c.mc as sfmc,a.lxr,
           case when Convert(varchar(6),isnull(gx.sjkyrq,'1900-01-01'),112) between @ksny and @jsny then 1 else 0 end as xdbs   
    from yx_t_khb a 
    left join  [192.168.35.10].tlsoft.dbo.yx_t_khsfdm c on a.sfdm=c.dm   
    inner join yx_t_khb b on a.ssid=1 and a.khlbdm<>'g' and (b.ccid+'-' like a.ccid+'-%')  and a.khid>1 
    left outer join yx_t_khgxb gx on gx.khid=case when b.khlbdm in ('D','d') then b.ssid else a.khid end and b.khid=gx.gxid and (gx.ksny<=@jsny and gx.jsny>=@ksny) 
    where 1=1 and a.khid not in(85,1384,14204) and len(a.dzbbpx)>0 and b.khmc not like '%直销户%' and b.ty=0 
          and a.khfl like 'x%' and isnull(gx.qtlx,0)=0   /*and b.khfl='xz'*/
) as a ; 

select * into #jhb from (
    select 'ys' as cs,b.ny,1 as xh,a.sskhid,a.khid,
           sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-1 then b.je else 0 end) as ys_gsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=0 then b.je else 0 end) as ys_ddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=0 then b.je else 0 end) as ys_ddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=1 then b.je else 0 end) as ys_xdddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=1 then b.je else 0 end) as ys_xdddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny then b.je else 0 end) as ys_hjfy, 
	sum(b.je) as ys_allfy 
    from #tmp_khb a inner join zw_t_fyjh_kz b on a.khid=b.tzid where b.nd=left(@ksny,4) and b.djlx=12457 /*(b.ny>=@ksny and b.ny<=@jsny) */
    and b.ny>=a.ksny and b.ny<=a.jsny
    group by b.ny,a.sskhid,a.khid    
) a ;
 /*同期实际开支*/
   select 'sjfy' as cs,b.nd,b.ny,1 as xh,a.sskhid,a.khid,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' then b.je else 0 end) as sj_gsfy,  
   sum(case when a.khid=b.khid and b.sjlx='ddmy' and a.xdbs=0 then b.je else 0 end) as sj_ddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=0 then b.je else 0 end) as sj_ddfy,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddfy
   /*,sum(b.je) as sj_hjfy*/
   into #fyb2 
   from #tmp_khb a inner join  [192.168.35.10].tlsoft.dbo.rs_t_yxsjfyb b on a.khid=b.khid 
   where b.nd=2016 and b.khid>0 and b.sjlx in ('sjfy','ddmy') and b.ny>='201603' and b.ny<='201702' 
         and ((b.ny>=@ksny and b.ny<=@jsny) or (b.ny>=@tqksny and b.ny<=@tqjsny) )
    group by b.nd,b.ny,a.sskhid,a.khid;
 /*本期实际开支*/
 select a.* into #fyb1 from (
   /*日常开支，店租费用，税务费用，个人借款，个人花费，差旅费，工资,固定资产*/
   select a.cs,dbo.f_Zw_kjnd(a.khid,a.rq) as nd,convert(varchar(6),a.rq,112) as ny,1 as xh,kh.sskhid,kh.khid,
   sum(case when ((a.jb='xf' and a.bxlx=0) or (a.bxlx=1 and a.jb!='xz')) then a.hdje else 0 end) as sj_gsfy,  
   sum(case when a.jb='mydd' and a.bxlx=0 and kh.xdbs=0  then a.hdje else 0 end) as sj_ddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=0 then a.hdje else 0 end) as sj_ddfy, 
   sum(case when a.jb='mydd'  and a.bxlx=0 and kh.xdbs=1  then a.hdje else 0 end) as sj_xdddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=1 then a.hdje else 0 end) as sj_xdddfy  
  from zw_v_sjkzfy a
  inner join #tmp_khb kh on a.khid=kh.khid 
  where a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.pzbs=1
  group by dbo.f_Zw_kjnd(a.khid,a.rq),convert(varchar(6),a.rq,112) ,kh.sskhid,kh.khid,a.cs
) a 


select *,sj_gsfy+sj_ddgsfy+sj_ddfy+sj_xdddgsfy+sj_xdddfy as sj_hjfy into #fyb 
from (
   select * from #fyb1   
   union all 
   select * from #fyb2 
) a ;

 /*往来款*/
 select a.tzid,sum(jfje) as sr,sum(dfje) as zc
 into #wlk 
 from Zw_T_Cnrjz as a 
 inner join ( select kmdm from zw_t_kmsdb where djlx='12460' and xjdfkm=6982 and tzid=1 and scxe=1  ) b on a.dfkm=b.kmdm
 where a.lylx in (311,312,316,321,322,323,0,826) 
  and  a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.nd=dbo.f_zw_kjnd(a.tzid,@jsrq) 
 group by a.tzid


  select a.sskhid,km.kmdm into #sykmdm from (select sskhid from #tmp_khb group by sskhid) a 
  inner join zw_t_zwkmb km on a.sskhid=km.tzid 
  where km.nd=2017 and km.kzlb=1 
  group by a.sskhid,km.kmdm ;

 select a.sskhid,sum(xjcnzc) as xjcnzc,sum(xxjcnzc) as xxjcnzc,sum(sjcnzc) as sjcnzc,sum(ddcnzc) as ddcnzc,sum(xdddcnzc) as xdddcnzc 
        into #cnzc 
 from (
    select a.sskhid,sum(case when b.khid>0  and b.khid!=b.tzid and isnull(kh.xdbs,0)=0 then b.dfje else 0 end) as xjcnzc,
           sum(case when b.khid>0  and b.khid!=b.tzid and kh.xdbs=1 then b.dfje else 0 end) as xxjcnzc,
           sum(case when (b.khid=0 or b.khid=b.tzid) then b.dfje else 0 end) as sjcnzc,0 as ddcnzc,0 as xdddcnzc
    from #sykmdm a inner join zw_t_cnrjz b on a.sskhid=b.tzid and a.kmdm=b.dfkm and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq)   
    left outer join #tmp_khb kh on b.khid=kh.khid 
    group by a.sskhid 
    union all 
    select a.sskhid,0 as xjcnzc,0 as xxjcnzc,0 as sjcnzc,sum(case when a.xdbs=0 then dfje else 0 end) as ddcnzc,
           sum(case when a.xdbs=1 then dfje else 0 end) as xdddcnzc 
	from (select sskhid,khid,xdbs from #tmp_khb group by sskhid,khid,xdbs) a 
    inner join zw_t_cnrjz b on a.sskhid=b.tzid and b.khid=a.khid and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq) and b.dfkm='122111' 
    and b.khid>0 group by a.sskhid 
 ) a group by a.sskhid;


/*资金余额[对公，对私]*/
 select a.tzid,sum(case when a.kmdm in ('100201','100202') then a.qmje else 0 end) as dgje 
              ,sum(case when a.kmdm in ('100101','100102','1012') then a.qmje else 0 end) as dsje 
 into #zjyezb 
 from ds_t_cnrjzzzb a where 1=1 and ny=@jsny and a.kmdm in ('100201','100202','100101','100102','1012') group by a.tzid ;


if '2'='1' 
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,max(zj.dgje) as dgje,
       max(zj.dsje) as dsje,max(zc.sjcnzc) as sjcnzc,max(zc.xjcnzc) as xjcnzc,max(zc.ddcnzc) as ddcnzc,
       max(zc.xxjcnzc) as xxjcnzc,max(zc.xdddcnzc) as xdddcnzc,
       max(zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc) as cnzc,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
       sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
       sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy,
       max(allys.ys_allgsfy) as ys_allgsfy, max(allys.ys_allddfy) as ys_allddfy 
       ,max(wl.sr) as wlsr,max(wl.zc) as wlzc,max(wl.zc)-max(wl.sr) as wlce    
   from #tmp_khb kh left outer join #fyb a on kh.sskhid=a.sskhid and kh.khid=a.khid  and a.ny>=@ksny and a.ny<=@jsny
   left outer join #jhb b on kh.sskhid=b.sskhid and kh.khid=b.khid and b.ny>=@ksny and b.ny>=@jsny  
   left outer join #fyb c on kh.sskhid=c.sskhid and kh.khid=c.khid and c.ny>=@tqksny and c.ny<=@tqjsny and right(a.ny,2)=right(c.ny,2) 
        and a.sj_hjfy>0 and c.sj_hjfy>0 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.sskhid=allys.sskhid 
   left outer join #cnzc zc on kh.sskhid=zc.sskhid 
   left outer join #zjyezb zj on kh.sskhid=zj.tzid  
   left join #wlk wl on kh.sskhid=wl.tzid
   where 1=1 
   group by kh.sskhid,kh.sskhmc,kh.sskhdm,kh.sfmc   
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 

if '2'='2' or '2'=''
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb 
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq   
       ,zj.dgje,zj.dsje,zc.sjcnzc,zc.xjcnzc,zc.ddcnzc, 
       zc.xxjcnzc,zc.xdddcnzc,
       zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc as cnzc,
       allys.ys_allgsfy,allys.ys_allddfy  
       ,wl.sr as wlsr,wl.zc as wlzc,wl.zc-wl.sr as wlce 
    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.tq_gsfy) as tq_gsfy, sum(c.tq_ddgsfy) as tq_ddgsfy,
       sum(c.tq_ddfy) as tq_ddfy, sum(c.tq_xdddgsfy) as tq_xdddgsfy,
       sum(c.tq_xdddfy) as tq_xdddfy,sum(c.tq_hjfy) as tq_hjfy
   from #tmp_khb kh 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as sj_gsfy, sum(c.sj_ddgsfy) as sj_ddgsfy,
              sum(c.sj_ddfy) as sj_ddfy, sum(c.sj_xdddgsfy) as sj_xdddgsfy,
              sum(c.sj_xdddfy) as sj_xdddfy,sum(c.sj_hjfy) as sj_hjfy  
       from #fyb c where c.ny>=@ksny and c.ny<=@jsny group by c.sskhid,c.khid 
   ) a on kh.sskhid=a.sskhid and kh.khid=a.khid 
   left outer join (select sskhid,khid,sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy from #jhb b where b.ny>=@ksny and b.ny<=@jsny group by sskhid,khid) b 
   on kh.sskhid=b.sskhid and kh.khid=b.khid 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
              sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
              sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy  
       from #fyb c where c.ny>=@tqksny and c.ny<=@tqjsny group by c.sskhid,c.khid 
   ) c on kh.sskhid=c.sskhid and kh.khid=c.khid 
   group by kh.sskhdm,kh.sskhid,kh.sskhmc,kh.sfmc  
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.khid=allys.sskhid 
   left outer join #cnzc zc on a.khid=zc.sskhid 
   left outer join #zjyezb zj on a.khid=zj.tzid 
   left join #wlk wl on a.khid=wl.tzid;

drop table #tmp_khb;
drop table #jhb;
drop table #fyb1 ;
drop table #fyb2 ;
drop table #fyb ;
drop table #sykmdm ;
drop table #cnzc ;
drop table #zjyezb ;
drop table #wlk;
 

2017-8-22 11:14:41  declare @ksny varchar(6); 
declare @jsny varchar(6); 
declare @tqksny varchar(6); 
declare @tqjsny varchar(6); 
declare @jsrq datetime ;
declare @ksrq datetime ;
declare @tqjsrq varchar(10); 
declare @tqksrq varchar(10);

select @ksny=convert(varchar(6),cast('2017-08-01' as datetime),112);
select @jsny=convert(varchar(6),cast('2017-08-22' as datetime),112);
select @tqksny=convert(varchar(6),dateadd(year,-1,cast('2017-08-01' as datetime)),112);/*上一年度*/
select @tqjsny=convert(varchar(6),dateadd(year,-1,cast('2017-08-22' as datetime)),112);
set @ksrq='2017-08-01' ;
set @jsrq='2017-08-22' ;
select @tqksrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-01' as datetime)) ,120); 
select @tqjsrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-22' as datetime)) ,120); 

select a.* into #tmp_khb from ( 
    select distinct b.khid,a.khid sskhid,a.khdm as sskhdm,a.khjc as sskhmc,b.khmc,b.ccid,gx.ksny,gx.jsny,b.ssid,c.mc as sfmc,a.lxr,
           case when Convert(varchar(6),isnull(gx.sjkyrq,'1900-01-01'),112) between @ksny and @jsny then 1 else 0 end as xdbs   
    from yx_t_khb a 
    left join  [192.168.35.10].tlsoft.dbo.yx_t_khsfdm c on a.sfdm=c.dm   
    inner join yx_t_khb b on a.ssid=1 and a.khlbdm<>'g' and (b.ccid+'-' like a.ccid+'-%')  and a.khid>1 
    left outer join yx_t_khgxb gx on gx.khid=case when b.khlbdm in ('D','d') then b.ssid else a.khid end and b.khid=gx.gxid and (gx.ksny<=@jsny and gx.jsny>=@ksny) 
    where 1=1 and a.khid not in(85,1384,14204) and len(a.dzbbpx)>0 and b.khmc not like '%直销户%' and b.ty=0 
          and a.khfl like 'x%' and isnull(gx.qtlx,0)=0   /*and b.khfl='xz'*/
) as a ; 

select * into #jhb from (
    select 'ys' as cs,b.ny,1 as xh,a.sskhid,a.khid,
           sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-1 then b.je else 0 end) as ys_gsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=0 then b.je else 0 end) as ys_ddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=0 then b.je else 0 end) as ys_ddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=1 then b.je else 0 end) as ys_xdddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=1 then b.je else 0 end) as ys_xdddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny then b.je else 0 end) as ys_hjfy, 
	sum(b.je) as ys_allfy 
    from #tmp_khb a inner join zw_t_fyjh_kz b on a.khid=b.tzid where b.nd=left(@ksny,4) and b.djlx=12457 /*(b.ny>=@ksny and b.ny<=@jsny) */
    and b.ny>=a.ksny and b.ny<=a.jsny
    group by b.ny,a.sskhid,a.khid    
) a ;
 /*同期实际开支*/
   select 'sjfy' as cs,b.nd,b.ny,1 as xh,a.sskhid,a.khid,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' then b.je else 0 end) as sj_gsfy,  
   sum(case when a.khid=b.khid and b.sjlx='ddmy' and a.xdbs=0 then b.je else 0 end) as sj_ddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=0 then b.je else 0 end) as sj_ddfy,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddfy
   /*,sum(b.je) as sj_hjfy*/
   into #fyb2 
   from #tmp_khb a inner join  [192.168.35.10].tlsoft.dbo.rs_t_yxsjfyb b on a.khid=b.khid 
   where b.nd=2016 and b.khid>0 and b.sjlx in ('sjfy','ddmy') and b.ny>='201603' and b.ny<='201702' 
         and ((b.ny>=@ksny and b.ny<=@jsny) or (b.ny>=@tqksny and b.ny<=@tqjsny) )
    group by b.nd,b.ny,a.sskhid,a.khid;
 /*本期实际开支*/
 select a.* into #fyb1 from (
   /*日常开支，店租费用，税务费用，个人借款，个人花费，差旅费，工资,固定资产*/
   select a.cs,dbo.f_Zw_kjnd(a.khid,a.rq) as nd,convert(varchar(6),a.rq,112) as ny,1 as xh,kh.sskhid,kh.khid,
   sum(case when ((a.jb='xf' and a.bxlx=0) or (a.bxlx=1 and a.jb!='xz')) then a.hdje else 0 end) as sj_gsfy,  
   sum(case when a.jb='mydd' and a.bxlx=0 and kh.xdbs=0  then a.hdje else 0 end) as sj_ddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=0 then a.hdje else 0 end) as sj_ddfy, 
   sum(case when a.jb='mydd'  and a.bxlx=0 and kh.xdbs=1  then a.hdje else 0 end) as sj_xdddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=1 then a.hdje else 0 end) as sj_xdddfy  
  from zw_v_sjkzfy a
  inner join #tmp_khb kh on a.khid=kh.khid 
  where a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.pzbs=1
  group by dbo.f_Zw_kjnd(a.khid,a.rq),convert(varchar(6),a.rq,112) ,kh.sskhid,kh.khid,a.cs
) a 


select *,sj_gsfy+sj_ddgsfy+sj_ddfy+sj_xdddgsfy+sj_xdddfy as sj_hjfy into #fyb 
from (
   select * from #fyb1   
   union all 
   select * from #fyb2 
) a ;

 /*往来款*/
 select a.tzid,sum(jfje) as sr,sum(dfje) as zc
 into #wlk 
 from Zw_T_Cnrjz as a 
 inner join ( select kmdm from zw_t_kmsdb where djlx='12460' and xjdfkm=6982 and tzid=1 and scxe=1  ) b on a.dfkm=b.kmdm
 where a.lylx in (311,312,316,321,322,323,0,826) 
  and  a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.nd=dbo.f_zw_kjnd(a.tzid,@jsrq) 
 group by a.tzid


  select a.sskhid,km.kmdm into #sykmdm from (select sskhid from #tmp_khb group by sskhid) a 
  inner join zw_t_zwkmb km on a.sskhid=km.tzid 
  where km.nd=2017 and km.kzlb=1 
  group by a.sskhid,km.kmdm ;

 select a.sskhid,sum(xjcnzc) as xjcnzc,sum(xxjcnzc) as xxjcnzc,sum(sjcnzc) as sjcnzc,sum(ddcnzc) as ddcnzc,sum(xdddcnzc) as xdddcnzc 
        into #cnzc 
 from (
    select a.sskhid,sum(case when b.khid>0  and b.khid!=b.tzid and isnull(kh.xdbs,0)=0 then b.dfje else 0 end) as xjcnzc,
           sum(case when b.khid>0  and b.khid!=b.tzid and kh.xdbs=1 then b.dfje else 0 end) as xxjcnzc,
           sum(case when (b.khid=0 or b.khid=b.tzid) then b.dfje else 0 end) as sjcnzc,0 as ddcnzc,0 as xdddcnzc
    from #sykmdm a inner join zw_t_cnrjz b on a.sskhid=b.tzid and a.kmdm=b.dfkm and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq)   
    left outer join #tmp_khb kh on b.khid=kh.khid 
    group by a.sskhid 
    union all 
    select a.sskhid,0 as xjcnzc,0 as xxjcnzc,0 as sjcnzc,sum(case when a.xdbs=0 then dfje else 0 end) as ddcnzc,
           sum(case when a.xdbs=1 then dfje else 0 end) as xdddcnzc 
	from (select sskhid,khid,xdbs from #tmp_khb group by sskhid,khid,xdbs) a 
    inner join zw_t_cnrjz b on a.sskhid=b.tzid and b.khid=a.khid and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq) and b.dfkm='122111' 
    and b.khid>0 group by a.sskhid 
 ) a group by a.sskhid;


/*资金余额[对公，对私]*/
 select a.tzid,sum(case when a.kmdm in ('100201','100202') then a.qmje else 0 end) as dgje 
              ,sum(case when a.kmdm in ('100101','100102','1012') then a.qmje else 0 end) as dsje 
 into #zjyezb 
 from ds_t_cnrjzzzb a where 1=1 and ny=@jsny and a.kmdm in ('100201','100202','100101','100102','1012') group by a.tzid ;


if '2'='1' 
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,max(zj.dgje) as dgje,
       max(zj.dsje) as dsje,max(zc.sjcnzc) as sjcnzc,max(zc.xjcnzc) as xjcnzc,max(zc.ddcnzc) as ddcnzc,
       max(zc.xxjcnzc) as xxjcnzc,max(zc.xdddcnzc) as xdddcnzc,
       max(zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc) as cnzc,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
       sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
       sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy,
       max(allys.ys_allgsfy) as ys_allgsfy, max(allys.ys_allddfy) as ys_allddfy 
       ,max(wl.sr) as wlsr,max(wl.zc) as wlzc,max(wl.zc)-max(wl.sr) as wlce    
   from #tmp_khb kh left outer join #fyb a on kh.sskhid=a.sskhid and kh.khid=a.khid  and a.ny>=@ksny and a.ny<=@jsny
   left outer join #jhb b on kh.sskhid=b.sskhid and kh.khid=b.khid and b.ny>=@ksny and b.ny>=@jsny  
   left outer join #fyb c on kh.sskhid=c.sskhid and kh.khid=c.khid and c.ny>=@tqksny and c.ny<=@tqjsny and right(a.ny,2)=right(c.ny,2) 
        and a.sj_hjfy>0 and c.sj_hjfy>0 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.sskhid=allys.sskhid 
   left outer join #cnzc zc on kh.sskhid=zc.sskhid 
   left outer join #zjyezb zj on kh.sskhid=zj.tzid  
   left join #wlk wl on kh.sskhid=wl.tzid
   where 1=1 
   group by kh.sskhid,kh.sskhmc,kh.sskhdm,kh.sfmc   
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 

if '2'='2' or '2'=''
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb 
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq   
       ,zj.dgje,zj.dsje,zc.sjcnzc,zc.xjcnzc,zc.ddcnzc, 
       zc.xxjcnzc,zc.xdddcnzc,
       zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc as cnzc,
       allys.ys_allgsfy,allys.ys_allddfy  
       ,wl.sr as wlsr,wl.zc as wlzc,wl.zc-wl.sr as wlce 
    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.tq_gsfy) as tq_gsfy, sum(c.tq_ddgsfy) as tq_ddgsfy,
       sum(c.tq_ddfy) as tq_ddfy, sum(c.tq_xdddgsfy) as tq_xdddgsfy,
       sum(c.tq_xdddfy) as tq_xdddfy,sum(c.tq_hjfy) as tq_hjfy
   from #tmp_khb kh 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as sj_gsfy, sum(c.sj_ddgsfy) as sj_ddgsfy,
              sum(c.sj_ddfy) as sj_ddfy, sum(c.sj_xdddgsfy) as sj_xdddgsfy,
              sum(c.sj_xdddfy) as sj_xdddfy,sum(c.sj_hjfy) as sj_hjfy  
       from #fyb c where c.ny>=@ksny and c.ny<=@jsny group by c.sskhid,c.khid 
   ) a on kh.sskhid=a.sskhid and kh.khid=a.khid 
   left outer join (select sskhid,khid,sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy from #jhb b where b.ny>=@ksny and b.ny<=@jsny group by sskhid,khid) b 
   on kh.sskhid=b.sskhid and kh.khid=b.khid 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
              sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
              sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy  
       from #fyb c where c.ny>=@tqksny and c.ny<=@tqjsny group by c.sskhid,c.khid 
   ) c on kh.sskhid=c.sskhid and kh.khid=c.khid 
   group by kh.sskhdm,kh.sskhid,kh.sskhmc,kh.sfmc  
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.khid=allys.sskhid 
   left outer join #cnzc zc on a.khid=zc.sskhid 
   left outer join #zjyezb zj on a.khid=zj.tzid 
   left join #wlk wl on a.khid=wl.tzid;

drop table #tmp_khb;
drop table #jhb;
drop table #fyb1 ;
drop table #fyb2 ;
drop table #fyb ;
drop table #sykmdm ;
drop table #cnzc ;
drop table #zjyezb ;
drop table #wlk;
 

2017-8-22 11:15:31  declare @ksny varchar(6); 
declare @jsny varchar(6); 
declare @tqksny varchar(6); 
declare @tqjsny varchar(6); 
declare @jsrq datetime ;
declare @ksrq datetime ;
declare @tqjsrq varchar(10); 
declare @tqksrq varchar(10);

select @ksny=convert(varchar(6),cast('2017-08-01' as datetime),112);
select @jsny=convert(varchar(6),cast('2017-08-22' as datetime),112);
select @tqksny=convert(varchar(6),dateadd(year,-1,cast('2017-08-01' as datetime)),112);/*上一年度*/
select @tqjsny=convert(varchar(6),dateadd(year,-1,cast('2017-08-22' as datetime)),112);
set @ksrq='2017-08-01' ;
set @jsrq='2017-08-22' ;
select @tqksrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-01' as datetime)) ,120); 
select @tqjsrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-22' as datetime)) ,120); 

select a.* into #tmp_khb from ( 
    select distinct b.khid,a.khid sskhid,a.khdm as sskhdm,a.khjc as sskhmc,b.khmc,b.ccid,gx.ksny,gx.jsny,b.ssid,c.mc as sfmc,a.lxr,
           case when Convert(varchar(6),isnull(gx.sjkyrq,'1900-01-01'),112) between @ksny and @jsny then 1 else 0 end as xdbs   
    from yx_t_khb a 
    left join  [192.168.35.10].tlsoft.dbo.yx_t_khsfdm c on a.sfdm=c.dm   
    inner join yx_t_khb b on a.ssid=1 and a.khlbdm<>'g' and (b.ccid+'-' like a.ccid+'-%')  and a.khid>1 
    left outer join yx_t_khgxb gx on gx.khid=case when b.khlbdm in ('D','d') then b.ssid else a.khid end and b.khid=gx.gxid and (gx.ksny<=@jsny and gx.jsny>=@ksny) 
    where 1=1 and a.khid not in(85,1384,14204) and len(a.dzbbpx)>0 and b.khmc not like '%直销户%' and b.ty=0 
          and a.khfl like 'x%' and isnull(gx.qtlx,0)=0   /*and b.khfl='xz'*/
) as a ; 

select * into #jhb from (
    select 'ys' as cs,b.ny,1 as xh,a.sskhid,a.khid,
           sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-1 then b.je else 0 end) as ys_gsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=0 then b.je else 0 end) as ys_ddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=0 then b.je else 0 end) as ys_ddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=1 then b.je else 0 end) as ys_xdddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=1 then b.je else 0 end) as ys_xdddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny then b.je else 0 end) as ys_hjfy, 
	sum(b.je) as ys_allfy 
    from #tmp_khb a inner join zw_t_fyjh_kz b on a.khid=b.tzid where b.nd=left(@ksny,4) and b.djlx=12457 /*(b.ny>=@ksny and b.ny<=@jsny) */
    and b.ny>=a.ksny and b.ny<=a.jsny
    group by b.ny,a.sskhid,a.khid    
) a ;
 /*同期实际开支*/
   select 'sjfy' as cs,b.nd,b.ny,1 as xh,a.sskhid,a.khid,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' then b.je else 0 end) as sj_gsfy,  
   sum(case when a.khid=b.khid and b.sjlx='ddmy' and a.xdbs=0 then b.je else 0 end) as sj_ddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=0 then b.je else 0 end) as sj_ddfy,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddfy
   /*,sum(b.je) as sj_hjfy*/
   into #fyb2 
   from #tmp_khb a inner join  [192.168.35.10].tlsoft.dbo.rs_t_yxsjfyb b on a.khid=b.khid 
   where b.nd=2016 and b.khid>0 and b.sjlx in ('sjfy','ddmy') and b.ny>='201603' and b.ny<='201702' 
         and ((b.ny>=@ksny and b.ny<=@jsny) or (b.ny>=@tqksny and b.ny<=@tqjsny) )
    group by b.nd,b.ny,a.sskhid,a.khid;
 /*本期实际开支*/
 select a.* into #fyb1 from (
   /*日常开支，店租费用，税务费用，个人借款，个人花费，差旅费，工资,固定资产*/
   select a.cs,dbo.f_Zw_kjnd(a.khid,a.rq) as nd,convert(varchar(6),a.rq,112) as ny,1 as xh,kh.sskhid,kh.khid,
   sum(case when ((a.jb='xf' and a.bxlx=0) or (a.bxlx=1 and a.jb!='xz')) then a.hdje else 0 end) as sj_gsfy,  
   sum(case when a.jb='mydd' and a.bxlx=0 and kh.xdbs=0  then a.hdje else 0 end) as sj_ddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=0 then a.hdje else 0 end) as sj_ddfy, 
   sum(case when a.jb='mydd'  and a.bxlx=0 and kh.xdbs=1  then a.hdje else 0 end) as sj_xdddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=1 then a.hdje else 0 end) as sj_xdddfy  
  from zw_v_sjkzfy a
  inner join #tmp_khb kh on a.khid=kh.khid 
  where a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.pzbs=1
  group by dbo.f_Zw_kjnd(a.khid,a.rq),convert(varchar(6),a.rq,112) ,kh.sskhid,kh.khid,a.cs
) a 


select *,sj_gsfy+sj_ddgsfy+sj_ddfy+sj_xdddgsfy+sj_xdddfy as sj_hjfy into #fyb 
from (
   select * from #fyb1   
   union all 
   select * from #fyb2 
) a ;

 /*往来款*/
 select a.tzid,sum(jfje) as sr,sum(dfje) as zc
 into #wlk 
 from Zw_T_Cnrjz as a 
 inner join ( select kmdm from zw_t_kmsdb where djlx='12460' and xjdfkm=6982 and tzid=1 and scxe=1  ) b on a.dfkm=b.kmdm
 where a.lylx in (311,312,316,321,322,323,0,826) 
  and  a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.nd=dbo.f_zw_kjnd(a.tzid,@jsrq) 
 group by a.tzid


  select a.sskhid,km.kmdm into #sykmdm from (select sskhid from #tmp_khb group by sskhid) a 
  inner join zw_t_zwkmb km on a.sskhid=km.tzid 
  where km.nd=2017 and km.kzlb=1 
  group by a.sskhid,km.kmdm ;

 select a.sskhid,sum(xjcnzc) as xjcnzc,sum(xxjcnzc) as xxjcnzc,sum(sjcnzc) as sjcnzc,sum(ddcnzc) as ddcnzc,sum(xdddcnzc) as xdddcnzc 
        into #cnzc 
 from (
    select a.sskhid,sum(case when b.khid>0  and b.khid!=b.tzid and isnull(kh.xdbs,0)=0 then b.dfje else 0 end) as xjcnzc,
           sum(case when b.khid>0  and b.khid!=b.tzid and kh.xdbs=1 then b.dfje else 0 end) as xxjcnzc,
           sum(case when (b.khid=0 or b.khid=b.tzid) then b.dfje else 0 end) as sjcnzc,0 as ddcnzc,0 as xdddcnzc
    from #sykmdm a inner join zw_t_cnrjz b on a.sskhid=b.tzid and a.kmdm=b.dfkm and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq)   
    left outer join #tmp_khb kh on b.khid=kh.khid 
    group by a.sskhid 
    union all 
    select a.sskhid,0 as xjcnzc,0 as xxjcnzc,0 as sjcnzc,sum(case when a.xdbs=0 then dfje else 0 end) as ddcnzc,
           sum(case when a.xdbs=1 then dfje else 0 end) as xdddcnzc 
	from (select sskhid,khid,xdbs from #tmp_khb group by sskhid,khid,xdbs) a 
    inner join zw_t_cnrjz b on a.sskhid=b.tzid and b.khid=a.khid and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq) and b.dfkm='122111' 
    and b.khid>0 group by a.sskhid 
 ) a group by a.sskhid;


/*资金余额[对公，对私]*/
 select a.tzid,sum(case when a.kmdm in ('100201','100202') then a.qmje else 0 end) as dgje 
              ,sum(case when a.kmdm in ('100101','100102','1012') then a.qmje else 0 end) as dsje 
 into #zjyezb 
 from ds_t_cnrjzzzb a where 1=1 and ny=@jsny and a.kmdm in ('100201','100202','100101','100102','1012') group by a.tzid ;


if '2'='1' 
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,max(zj.dgje) as dgje,
       max(zj.dsje) as dsje,max(zc.sjcnzc) as sjcnzc,max(zc.xjcnzc) as xjcnzc,max(zc.ddcnzc) as ddcnzc,
       max(zc.xxjcnzc) as xxjcnzc,max(zc.xdddcnzc) as xdddcnzc,
       max(zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc) as cnzc,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
       sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
       sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy,
       max(allys.ys_allgsfy) as ys_allgsfy, max(allys.ys_allddfy) as ys_allddfy 
       ,max(wl.sr) as wlsr,max(wl.zc) as wlzc,max(wl.zc)-max(wl.sr) as wlce    
   from #tmp_khb kh left outer join #fyb a on kh.sskhid=a.sskhid and kh.khid=a.khid  and a.ny>=@ksny and a.ny<=@jsny
   left outer join #jhb b on kh.sskhid=b.sskhid and kh.khid=b.khid and b.ny>=@ksny and b.ny>=@jsny  
   left outer join #fyb c on kh.sskhid=c.sskhid and kh.khid=c.khid and c.ny>=@tqksny and c.ny<=@tqjsny and right(a.ny,2)=right(c.ny,2) 
        and a.sj_hjfy>0 and c.sj_hjfy>0 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.sskhid=allys.sskhid 
   left outer join #cnzc zc on kh.sskhid=zc.sskhid 
   left outer join #zjyezb zj on kh.sskhid=zj.tzid  
   left join #wlk wl on kh.sskhid=wl.tzid
   where 1=1 
   group by kh.sskhid,kh.sskhmc,kh.sskhdm,kh.sfmc   
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 

if '2'='2' or '2'=''
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb 
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq   
       ,zj.dgje,zj.dsje,zc.sjcnzc,zc.xjcnzc,zc.ddcnzc, 
       zc.xxjcnzc,zc.xdddcnzc,
       zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc as cnzc,
       allys.ys_allgsfy,allys.ys_allddfy  
       ,wl.sr as wlsr,wl.zc as wlzc,wl.zc-wl.sr as wlce 
    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.tq_gsfy) as tq_gsfy, sum(c.tq_ddgsfy) as tq_ddgsfy,
       sum(c.tq_ddfy) as tq_ddfy, sum(c.tq_xdddgsfy) as tq_xdddgsfy,
       sum(c.tq_xdddfy) as tq_xdddfy,sum(c.tq_hjfy) as tq_hjfy
   from #tmp_khb kh 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as sj_gsfy, sum(c.sj_ddgsfy) as sj_ddgsfy,
              sum(c.sj_ddfy) as sj_ddfy, sum(c.sj_xdddgsfy) as sj_xdddgsfy,
              sum(c.sj_xdddfy) as sj_xdddfy,sum(c.sj_hjfy) as sj_hjfy  
       from #fyb c where c.ny>=@ksny and c.ny<=@jsny group by c.sskhid,c.khid 
   ) a on kh.sskhid=a.sskhid and kh.khid=a.khid 
   left outer join (select sskhid,khid,sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy from #jhb b where b.ny>=@ksny and b.ny<=@jsny group by sskhid,khid) b 
   on kh.sskhid=b.sskhid and kh.khid=b.khid 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
              sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
              sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy  
       from #fyb c where c.ny>=@tqksny and c.ny<=@tqjsny group by c.sskhid,c.khid 
   ) c on kh.sskhid=c.sskhid and kh.khid=c.khid 
   group by kh.sskhdm,kh.sskhid,kh.sskhmc,kh.sfmc  
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.khid=allys.sskhid 
   left outer join #cnzc zc on a.khid=zc.sskhid 
   left outer join #zjyezb zj on a.khid=zj.tzid 
   left join #wlk wl on a.khid=wl.tzid;

drop table #tmp_khb;
drop table #jhb;
drop table #fyb1 ;
drop table #fyb2 ;
drop table #fyb ;
drop table #sykmdm ;
drop table #cnzc ;
drop table #zjyezb ;
drop table #wlk;
 

2017-8-22 11:16:28  declare @ksny varchar(6); 
declare @jsny varchar(6); 
declare @tqksny varchar(6); 
declare @tqjsny varchar(6); 
declare @jsrq datetime ;
declare @ksrq datetime ;
declare @tqjsrq varchar(10); 
declare @tqksrq varchar(10);

select @ksny=convert(varchar(6),cast('2017-08-01' as datetime),112);
select @jsny=convert(varchar(6),cast('2017-08-22' as datetime),112);
select @tqksny=convert(varchar(6),dateadd(year,-1,cast('2017-08-01' as datetime)),112);/*上一年度*/
select @tqjsny=convert(varchar(6),dateadd(year,-1,cast('2017-08-22' as datetime)),112);
set @ksrq='2017-08-01' ;
set @jsrq='2017-08-22' ;
select @tqksrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-01' as datetime)) ,120); 
select @tqjsrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-22' as datetime)) ,120); 

select a.* into #tmp_khb from ( 
    select distinct b.khid,a.khid sskhid,a.khdm as sskhdm,a.khjc as sskhmc,b.khmc,b.ccid,gx.ksny,gx.jsny,b.ssid,c.mc as sfmc,a.lxr,
           case when Convert(varchar(6),isnull(gx.sjkyrq,'1900-01-01'),112) between @ksny and @jsny then 1 else 0 end as xdbs   
    from yx_t_khb a 
    left join  [192.168.35.10].tlsoft.dbo.yx_t_khsfdm c on a.sfdm=c.dm   
    inner join yx_t_khb b on a.ssid=1 and a.khlbdm<>'g' and (b.ccid+'-' like a.ccid+'-%')  and a.khid>1 
    left outer join yx_t_khgxb gx on gx.khid=case when b.khlbdm in ('D','d') then b.ssid else a.khid end and b.khid=gx.gxid and (gx.ksny<=@jsny and gx.jsny>=@ksny) 
    where 1=1 and a.khid not in(85,1384,14204) and len(a.dzbbpx)>0 and b.khmc not like '%直销户%' and b.ty=0 
          and a.khfl like 'x%' and isnull(gx.qtlx,0)=0   /*and b.khfl='xz'*/
) as a ; 

select * into #jhb from (
    select 'ys' as cs,b.ny,1 as xh,a.sskhid,a.khid,
           sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-1 then b.je else 0 end) as ys_gsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=0 then b.je else 0 end) as ys_ddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=0 then b.je else 0 end) as ys_ddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=1 then b.je else 0 end) as ys_xdddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=1 then b.je else 0 end) as ys_xdddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny then b.je else 0 end) as ys_hjfy, 
	sum(b.je) as ys_allfy 
    from #tmp_khb a inner join zw_t_fyjh_kz b on a.khid=b.tzid where b.nd=left(@ksny,4) and b.djlx=12457 /*(b.ny>=@ksny and b.ny<=@jsny) */
    and b.ny>=a.ksny and b.ny<=a.jsny
    group by b.ny,a.sskhid,a.khid    
) a ;
 /*同期实际开支*/
   select 'sjfy' as cs,b.nd,b.ny,1 as xh,a.sskhid,a.khid,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' then b.je else 0 end) as sj_gsfy,  
   sum(case when a.khid=b.khid and b.sjlx='ddmy' and a.xdbs=0 then b.je else 0 end) as sj_ddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=0 then b.je else 0 end) as sj_ddfy,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddfy
   /*,sum(b.je) as sj_hjfy*/
   into #fyb2 
   from #tmp_khb a inner join  [192.168.35.10].tlsoft.dbo.rs_t_yxsjfyb b on a.khid=b.khid 
   where b.nd=2016 and b.khid>0 and b.sjlx in ('sjfy','ddmy') and b.ny>='201603' and b.ny<='201702' 
         and ((b.ny>=@ksny and b.ny<=@jsny) or (b.ny>=@tqksny and b.ny<=@tqjsny) )
    group by b.nd,b.ny,a.sskhid,a.khid;
 /*本期实际开支*/
 select a.* into #fyb1 from (
   /*日常开支，店租费用，税务费用，个人借款，个人花费，差旅费，工资,固定资产*/
   select a.cs,dbo.f_Zw_kjnd(a.khid,a.rq) as nd,convert(varchar(6),a.rq,112) as ny,1 as xh,kh.sskhid,kh.khid,
   sum(case when ((a.jb='xf' and a.bxlx=0) or (a.bxlx=1 and a.jb!='xz')) then a.hdje else 0 end) as sj_gsfy,  
   sum(case when a.jb='mydd' and a.bxlx=0 and kh.xdbs=0  then a.hdje else 0 end) as sj_ddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=0 then a.hdje else 0 end) as sj_ddfy, 
   sum(case when a.jb='mydd'  and a.bxlx=0 and kh.xdbs=1  then a.hdje else 0 end) as sj_xdddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=1 then a.hdje else 0 end) as sj_xdddfy  
  from zw_v_sjkzfy a
  inner join #tmp_khb kh on a.khid=kh.khid 
  where a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.pzbs=1
  group by dbo.f_Zw_kjnd(a.khid,a.rq),convert(varchar(6),a.rq,112) ,kh.sskhid,kh.khid,a.cs
) a 


select *,sj_gsfy+sj_ddgsfy+sj_ddfy+sj_xdddgsfy+sj_xdddfy as sj_hjfy into #fyb 
from (
   select * from #fyb1   
   union all 
   select * from #fyb2 
) a ;

 /*往来款*/
 select a.tzid,sum(jfje) as sr,sum(dfje) as zc
 into #wlk 
 from Zw_T_Cnrjz as a 
 inner join ( select kmdm from zw_t_kmsdb where djlx='12460' and xjdfkm=6982 and tzid=1 and scxe=1  ) b on a.dfkm=b.kmdm
 where a.lylx in (311,312,316,321,322,323,0,826) 
  and  a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.nd=dbo.f_zw_kjnd(a.tzid,@jsrq) 
 group by a.tzid


  select a.sskhid,km.kmdm into #sykmdm from (select sskhid from #tmp_khb group by sskhid) a 
  inner join zw_t_zwkmb km on a.sskhid=km.tzid 
  where km.nd=2017 and km.kzlb=1 
  group by a.sskhid,km.kmdm ;

 select a.sskhid,sum(xjcnzc) as xjcnzc,sum(xxjcnzc) as xxjcnzc,sum(sjcnzc) as sjcnzc,sum(ddcnzc) as ddcnzc,sum(xdddcnzc) as xdddcnzc 
        into #cnzc 
 from (
    select a.sskhid,sum(case when b.khid>0  and b.khid!=b.tzid and isnull(kh.xdbs,0)=0 then b.dfje else 0 end) as xjcnzc,
           sum(case when b.khid>0  and b.khid!=b.tzid and kh.xdbs=1 then b.dfje else 0 end) as xxjcnzc,
           sum(case when (b.khid=0 or b.khid=b.tzid) then b.dfje else 0 end) as sjcnzc,0 as ddcnzc,0 as xdddcnzc
    from #sykmdm a inner join zw_t_cnrjz b on a.sskhid=b.tzid and a.kmdm=b.dfkm and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq)   
    left outer join #tmp_khb kh on b.khid=kh.khid 
    group by a.sskhid 
    union all 
    select a.sskhid,0 as xjcnzc,0 as xxjcnzc,0 as sjcnzc,sum(case when a.xdbs=0 then dfje else 0 end) as ddcnzc,
           sum(case when a.xdbs=1 then dfje else 0 end) as xdddcnzc 
	from (select sskhid,khid,xdbs from #tmp_khb group by sskhid,khid,xdbs) a 
    inner join zw_t_cnrjz b on a.sskhid=b.tzid and b.khid=a.khid and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq) and b.dfkm='122111' 
    and b.khid>0 group by a.sskhid 
 ) a group by a.sskhid;


/*资金余额[对公，对私]*/
 select a.tzid,sum(case when a.kmdm in ('100201','100202') then a.qmje else 0 end) as dgje 
              ,sum(case when a.kmdm in ('100101','100102','1012') then a.qmje else 0 end) as dsje 
 into #zjyezb 
 from ds_t_cnrjzzzb a where 1=1 and ny=@jsny and a.kmdm in ('100201','100202','100101','100102','1012') group by a.tzid ;


if '2'='1' 
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,max(zj.dgje) as dgje,
       max(zj.dsje) as dsje,max(zc.sjcnzc) as sjcnzc,max(zc.xjcnzc) as xjcnzc,max(zc.ddcnzc) as ddcnzc,
       max(zc.xxjcnzc) as xxjcnzc,max(zc.xdddcnzc) as xdddcnzc,
       max(zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc) as cnzc,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
       sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
       sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy,
       max(allys.ys_allgsfy) as ys_allgsfy, max(allys.ys_allddfy) as ys_allddfy 
       ,max(wl.sr) as wlsr,max(wl.zc) as wlzc,max(wl.zc)-max(wl.sr) as wlce    
   from #tmp_khb kh left outer join #fyb a on kh.sskhid=a.sskhid and kh.khid=a.khid  and a.ny>=@ksny and a.ny<=@jsny
   left outer join #jhb b on kh.sskhid=b.sskhid and kh.khid=b.khid and b.ny>=@ksny and b.ny>=@jsny  
   left outer join #fyb c on kh.sskhid=c.sskhid and kh.khid=c.khid and c.ny>=@tqksny and c.ny<=@tqjsny and right(a.ny,2)=right(c.ny,2) 
        and a.sj_hjfy>0 and c.sj_hjfy>0 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.sskhid=allys.sskhid 
   left outer join #cnzc zc on kh.sskhid=zc.sskhid 
   left outer join #zjyezb zj on kh.sskhid=zj.tzid  
   left join #wlk wl on kh.sskhid=wl.tzid
   where 1=1 
   group by kh.sskhid,kh.sskhmc,kh.sskhdm,kh.sfmc   
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 

if '2'='2' or '2'=''
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb 
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq   
       ,zj.dgje,zj.dsje,zc.sjcnzc,zc.xjcnzc,zc.ddcnzc, 
       zc.xxjcnzc,zc.xdddcnzc,
       zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc as cnzc,
       allys.ys_allgsfy,allys.ys_allddfy  
       ,wl.sr as wlsr,wl.zc as wlzc,wl.zc-wl.sr as wlce 
    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.tq_gsfy) as tq_gsfy, sum(c.tq_ddgsfy) as tq_ddgsfy,
       sum(c.tq_ddfy) as tq_ddfy, sum(c.tq_xdddgsfy) as tq_xdddgsfy,
       sum(c.tq_xdddfy) as tq_xdddfy,sum(c.tq_hjfy) as tq_hjfy
   from #tmp_khb kh 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as sj_gsfy, sum(c.sj_ddgsfy) as sj_ddgsfy,
              sum(c.sj_ddfy) as sj_ddfy, sum(c.sj_xdddgsfy) as sj_xdddgsfy,
              sum(c.sj_xdddfy) as sj_xdddfy,sum(c.sj_hjfy) as sj_hjfy  
       from #fyb c where c.ny>=@ksny and c.ny<=@jsny group by c.sskhid,c.khid 
   ) a on kh.sskhid=a.sskhid and kh.khid=a.khid 
   left outer join (select sskhid,khid,sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy from #jhb b where b.ny>=@ksny and b.ny<=@jsny group by sskhid,khid) b 
   on kh.sskhid=b.sskhid and kh.khid=b.khid 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
              sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
              sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy  
       from #fyb c where c.ny>=@tqksny and c.ny<=@tqjsny group by c.sskhid,c.khid 
   ) c on kh.sskhid=c.sskhid and kh.khid=c.khid 
   group by kh.sskhdm,kh.sskhid,kh.sskhmc,kh.sfmc  
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.khid=allys.sskhid 
   left outer join #cnzc zc on a.khid=zc.sskhid 
   left outer join #zjyezb zj on a.khid=zj.tzid 
   left join #wlk wl on a.khid=wl.tzid;

drop table #tmp_khb;
drop table #jhb;
drop table #fyb1 ;
drop table #fyb2 ;
drop table #fyb ;
drop table #sykmdm ;
drop table #cnzc ;
drop table #zjyezb ;
drop table #wlk;
 

2017-8-22 11:16:59  declare @ksny varchar(6); 
declare @jsny varchar(6); 
declare @tqksny varchar(6); 
declare @tqjsny varchar(6); 
declare @jsrq datetime ;
declare @ksrq datetime ;
declare @tqjsrq varchar(10); 
declare @tqksrq varchar(10);

select @ksny=convert(varchar(6),cast('2017-08-01' as datetime),112);
select @jsny=convert(varchar(6),cast('2017-08-22' as datetime),112);
select @tqksny=convert(varchar(6),dateadd(year,-1,cast('2017-08-01' as datetime)),112);/*上一年度*/
select @tqjsny=convert(varchar(6),dateadd(year,-1,cast('2017-08-22' as datetime)),112);
set @ksrq='2017-08-01' ;
set @jsrq='2017-08-22' ;
select @tqksrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-01' as datetime)) ,120); 
select @tqjsrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-22' as datetime)) ,120); 

select a.* into #tmp_khb from ( 
    select distinct b.khid,a.khid sskhid,a.khdm as sskhdm,a.khjc as sskhmc,b.khmc,b.ccid,gx.ksny,gx.jsny,b.ssid,c.mc as sfmc,a.lxr,
           case when Convert(varchar(6),isnull(gx.sjkyrq,'1900-01-01'),112) between @ksny and @jsny then 1 else 0 end as xdbs   
    from yx_t_khb a 
    left join  [192.168.35.10].tlsoft.dbo.yx_t_khsfdm c on a.sfdm=c.dm   
    inner join yx_t_khb b on a.ssid=1 and a.khlbdm<>'g' and (b.ccid+'-' like a.ccid+'-%')  and a.khid>1 
    left outer join yx_t_khgxb gx on gx.khid=case when b.khlbdm in ('D','d') then b.ssid else a.khid end and b.khid=gx.gxid and (gx.ksny<=@jsny and gx.jsny>=@ksny) 
    where 1=1 and a.khid not in(85,1384,14204) and len(a.dzbbpx)>0 and b.khmc not like '%直销户%' and b.ty=0 
          and a.khfl like 'x%' and isnull(gx.qtlx,0)=0   /*and b.khfl='xz'*/
) as a ; 

select * into #jhb from (
    select 'ys' as cs,b.ny,1 as xh,a.sskhid,a.khid,
           sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-1 then b.je else 0 end) as ys_gsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=0 then b.je else 0 end) as ys_ddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=0 then b.je else 0 end) as ys_ddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=1 then b.je else 0 end) as ys_xdddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=1 then b.je else 0 end) as ys_xdddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny then b.je else 0 end) as ys_hjfy, 
	sum(b.je) as ys_allfy 
    from #tmp_khb a inner join zw_t_fyjh_kz b on a.khid=b.tzid where b.nd=left(@ksny,4) and b.djlx=12457 /*(b.ny>=@ksny and b.ny<=@jsny) */
    and b.ny>=a.ksny and b.ny<=a.jsny
    group by b.ny,a.sskhid,a.khid    
) a ;
 /*同期实际开支*/
   select 'sjfy' as cs,b.nd,b.ny,1 as xh,a.sskhid,a.khid,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' then b.je else 0 end) as sj_gsfy,  
   sum(case when a.khid=b.khid and b.sjlx='ddmy' and a.xdbs=0 then b.je else 0 end) as sj_ddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=0 then b.je else 0 end) as sj_ddfy,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddfy
   /*,sum(b.je) as sj_hjfy*/
   into #fyb2 
   from #tmp_khb a inner join  [192.168.35.10].tlsoft.dbo.rs_t_yxsjfyb b on a.khid=b.khid 
   where b.nd=2016 and b.khid>0 and b.sjlx in ('sjfy','ddmy') and b.ny>='201603' and b.ny<='201702' 
         and ((b.ny>=@ksny and b.ny<=@jsny) or (b.ny>=@tqksny and b.ny<=@tqjsny) )
    group by b.nd,b.ny,a.sskhid,a.khid;
 /*本期实际开支*/
 select a.* into #fyb1 from (
   /*日常开支，店租费用，税务费用，个人借款，个人花费，差旅费，工资,固定资产*/
   select a.cs,dbo.f_Zw_kjnd(a.khid,a.rq) as nd,convert(varchar(6),a.rq,112) as ny,1 as xh,kh.sskhid,kh.khid,
   sum(case when ((a.jb='xf' and a.bxlx=0) or (a.bxlx=1 and a.jb!='xz')) then a.hdje else 0 end) as sj_gsfy,  
   sum(case when a.jb='mydd' and a.bxlx=0 and kh.xdbs=0  then a.hdje else 0 end) as sj_ddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=0 then a.hdje else 0 end) as sj_ddfy, 
   sum(case when a.jb='mydd'  and a.bxlx=0 and kh.xdbs=1  then a.hdje else 0 end) as sj_xdddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=1 then a.hdje else 0 end) as sj_xdddfy  
  from zw_v_sjkzfy a
  inner join #tmp_khb kh on a.khid=kh.khid 
  where a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.pzbs=1
  group by dbo.f_Zw_kjnd(a.khid,a.rq),convert(varchar(6),a.rq,112) ,kh.sskhid,kh.khid,a.cs
) a 


select *,sj_gsfy+sj_ddgsfy+sj_ddfy+sj_xdddgsfy+sj_xdddfy as sj_hjfy into #fyb 
from (
   select * from #fyb1   
   union all 
   select * from #fyb2 
) a ;

 /*往来款*/
 select a.tzid,sum(jfje) as sr,sum(dfje) as zc
 into #wlk 
 from Zw_T_Cnrjz as a 
 inner join ( select kmdm from zw_t_kmsdb where djlx='12460' and xjdfkm=6982 and tzid=1 and scxe=1  ) b on a.dfkm=b.kmdm
 where a.lylx in (311,312,316,321,322,323,0,826) 
  and  a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.nd=dbo.f_zw_kjnd(a.tzid,@jsrq) 
 group by a.tzid


  select a.sskhid,km.kmdm into #sykmdm from (select sskhid from #tmp_khb group by sskhid) a 
  inner join zw_t_zwkmb km on a.sskhid=km.tzid 
  where km.nd=2017 and km.kzlb=1 
  group by a.sskhid,km.kmdm ;

 select a.sskhid,sum(xjcnzc) as xjcnzc,sum(xxjcnzc) as xxjcnzc,sum(sjcnzc) as sjcnzc,sum(ddcnzc) as ddcnzc,sum(xdddcnzc) as xdddcnzc 
        into #cnzc 
 from (
    select a.sskhid,sum(case when b.khid>0  and b.khid!=b.tzid and isnull(kh.xdbs,0)=0 then b.dfje else 0 end) as xjcnzc,
           sum(case when b.khid>0  and b.khid!=b.tzid and kh.xdbs=1 then b.dfje else 0 end) as xxjcnzc,
           sum(case when (b.khid=0 or b.khid=b.tzid) then b.dfje else 0 end) as sjcnzc,0 as ddcnzc,0 as xdddcnzc
    from #sykmdm a inner join zw_t_cnrjz b on a.sskhid=b.tzid and a.kmdm=b.dfkm and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq)   
    left outer join #tmp_khb kh on b.khid=kh.khid 
    group by a.sskhid 
    union all 
    select a.sskhid,0 as xjcnzc,0 as xxjcnzc,0 as sjcnzc,sum(case when a.xdbs=0 then dfje else 0 end) as ddcnzc,
           sum(case when a.xdbs=1 then dfje else 0 end) as xdddcnzc 
	from (select sskhid,khid,xdbs from #tmp_khb group by sskhid,khid,xdbs) a 
    inner join zw_t_cnrjz b on a.sskhid=b.tzid and b.khid=a.khid and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq) and b.dfkm='122111' 
    and b.khid>0 group by a.sskhid 
 ) a group by a.sskhid;


/*资金余额[对公，对私]*/
 select a.tzid,sum(case when a.kmdm in ('100201','100202') then a.qmje else 0 end) as dgje 
              ,sum(case when a.kmdm in ('100101','100102','1012') then a.qmje else 0 end) as dsje 
 into #zjyezb 
 from ds_t_cnrjzzzb a where 1=1 and ny=@jsny and a.kmdm in ('100201','100202','100101','100102','1012') group by a.tzid ;


if '2'='1' 
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,max(zj.dgje) as dgje,
       max(zj.dsje) as dsje,max(zc.sjcnzc) as sjcnzc,max(zc.xjcnzc) as xjcnzc,max(zc.ddcnzc) as ddcnzc,
       max(zc.xxjcnzc) as xxjcnzc,max(zc.xdddcnzc) as xdddcnzc,
       max(zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc) as cnzc,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
       sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
       sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy,
       max(allys.ys_allgsfy) as ys_allgsfy, max(allys.ys_allddfy) as ys_allddfy 
       ,max(wl.sr) as wlsr,max(wl.zc) as wlzc,max(wl.zc)-max(wl.sr) as wlce    
   from #tmp_khb kh left outer join #fyb a on kh.sskhid=a.sskhid and kh.khid=a.khid  and a.ny>=@ksny and a.ny<=@jsny
   left outer join #jhb b on kh.sskhid=b.sskhid and kh.khid=b.khid and b.ny>=@ksny and b.ny>=@jsny  
   left outer join #fyb c on kh.sskhid=c.sskhid and kh.khid=c.khid and c.ny>=@tqksny and c.ny<=@tqjsny and right(a.ny,2)=right(c.ny,2) 
        and a.sj_hjfy>0 and c.sj_hjfy>0 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.sskhid=allys.sskhid 
   left outer join #cnzc zc on kh.sskhid=zc.sskhid 
   left outer join #zjyezb zj on kh.sskhid=zj.tzid  
   left join #wlk wl on kh.sskhid=wl.tzid
   where 1=1 
   group by kh.sskhid,kh.sskhmc,kh.sskhdm,kh.sfmc   
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 

if '2'='2' or '2'=''
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb 
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq   
       ,zj.dgje,zj.dsje,zc.sjcnzc,zc.xjcnzc,zc.ddcnzc, 
       zc.xxjcnzc,zc.xdddcnzc,
       zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc as cnzc,
       allys.ys_allgsfy,allys.ys_allddfy  
       ,wl.sr as wlsr,wl.zc as wlzc,wl.zc-wl.sr as wlce 
    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.tq_gsfy) as tq_gsfy, sum(c.tq_ddgsfy) as tq_ddgsfy,
       sum(c.tq_ddfy) as tq_ddfy, sum(c.tq_xdddgsfy) as tq_xdddgsfy,
       sum(c.tq_xdddfy) as tq_xdddfy,sum(c.tq_hjfy) as tq_hjfy
   from #tmp_khb kh 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as sj_gsfy, sum(c.sj_ddgsfy) as sj_ddgsfy,
              sum(c.sj_ddfy) as sj_ddfy, sum(c.sj_xdddgsfy) as sj_xdddgsfy,
              sum(c.sj_xdddfy) as sj_xdddfy,sum(c.sj_hjfy) as sj_hjfy  
       from #fyb c where c.ny>=@ksny and c.ny<=@jsny group by c.sskhid,c.khid 
   ) a on kh.sskhid=a.sskhid and kh.khid=a.khid 
   left outer join (select sskhid,khid,sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy from #jhb b where b.ny>=@ksny and b.ny<=@jsny group by sskhid,khid) b 
   on kh.sskhid=b.sskhid and kh.khid=b.khid 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
              sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
              sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy  
       from #fyb c where c.ny>=@tqksny and c.ny<=@tqjsny group by c.sskhid,c.khid 
   ) c on kh.sskhid=c.sskhid and kh.khid=c.khid 
   group by kh.sskhdm,kh.sskhid,kh.sskhmc,kh.sfmc  
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.khid=allys.sskhid 
   left outer join #cnzc zc on a.khid=zc.sskhid 
   left outer join #zjyezb zj on a.khid=zj.tzid 
   left join #wlk wl on a.khid=wl.tzid;

drop table #tmp_khb;
drop table #jhb;
drop table #fyb1 ;
drop table #fyb2 ;
drop table #fyb ;
drop table #sykmdm ;
drop table #cnzc ;
drop table #zjyezb ;
drop table #wlk;
 

2017-8-22 11:18:37  declare @ksny varchar(6); 
declare @jsny varchar(6); 
declare @tqksny varchar(6); 
declare @tqjsny varchar(6); 
declare @jsrq datetime ;
declare @ksrq datetime ;
declare @tqjsrq varchar(10); 
declare @tqksrq varchar(10);

select @ksny=convert(varchar(6),cast('2017-08-01' as datetime),112);
select @jsny=convert(varchar(6),cast('2017-08-22' as datetime),112);
select @tqksny=convert(varchar(6),dateadd(year,-1,cast('2017-08-01' as datetime)),112);/*上一年度*/
select @tqjsny=convert(varchar(6),dateadd(year,-1,cast('2017-08-22' as datetime)),112);
set @ksrq='2017-08-01' ;
set @jsrq='2017-08-22' ;
select @tqksrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-01' as datetime)) ,120); 
select @tqjsrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-22' as datetime)) ,120); 

select a.* into #tmp_khb from ( 
    select distinct b.khid,a.khid sskhid,a.khdm as sskhdm,a.khjc as sskhmc,b.khmc,b.ccid,gx.ksny,gx.jsny,b.ssid,c.mc as sfmc,a.lxr,
           case when Convert(varchar(6),isnull(gx.sjkyrq,'1900-01-01'),112) between @ksny and @jsny then 1 else 0 end as xdbs   
    from yx_t_khb a 
    left join  [192.168.35.10].tlsoft.dbo.yx_t_khsfdm c on a.sfdm=c.dm   
    inner join yx_t_khb b on a.ssid=1 and a.khlbdm<>'g' and (b.ccid+'-' like a.ccid+'-%')  and a.khid>1 
    left outer join yx_t_khgxb gx on gx.khid=case when b.khlbdm in ('D','d') then b.ssid else a.khid end and b.khid=gx.gxid and (gx.ksny<=@jsny and gx.jsny>=@ksny) 
    where 1=1 and a.khid not in(85,1384,14204) and len(a.dzbbpx)>0 and b.khmc not like '%直销户%' and b.ty=0 
          and a.khfl like 'x%' and isnull(gx.qtlx,0)=0   /*and b.khfl='xz'*/
) as a ; 

select * into #jhb from (
    select 'ys' as cs,b.ny,1 as xh,a.sskhid,a.khid,
           sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-1 then b.je else 0 end) as ys_gsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=0 then b.je else 0 end) as ys_ddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=0 then b.je else 0 end) as ys_ddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=1 then b.je else 0 end) as ys_xdddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=1 then b.je else 0 end) as ys_xdddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny then b.je else 0 end) as ys_hjfy, 
	sum(b.je) as ys_allfy 
    from #tmp_khb a inner join zw_t_fyjh_kz b on a.khid=b.tzid where b.nd=left(@ksny,4) and b.djlx=12457 /*(b.ny>=@ksny and b.ny<=@jsny) */
    and b.ny>=a.ksny and b.ny<=a.jsny
    group by b.ny,a.sskhid,a.khid    
) a ;
 /*同期实际开支*/
   select 'sjfy' as cs,b.nd,b.ny,1 as xh,a.sskhid,a.khid,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' then b.je else 0 end) as sj_gsfy,  
   sum(case when a.khid=b.khid and b.sjlx='ddmy' and a.xdbs=0 then b.je else 0 end) as sj_ddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=0 then b.je else 0 end) as sj_ddfy,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddfy
   /*,sum(b.je) as sj_hjfy*/
   into #fyb2 
   from #tmp_khb a inner join  [192.168.35.10].tlsoft.dbo.rs_t_yxsjfyb b on a.khid=b.khid 
   where b.nd=2016 and b.khid>0 and b.sjlx in ('sjfy','ddmy') and b.ny>='201603' and b.ny<='201702' 
         and ((b.ny>=@ksny and b.ny<=@jsny) or (b.ny>=@tqksny and b.ny<=@tqjsny) )
    group by b.nd,b.ny,a.sskhid,a.khid;
 /*本期实际开支*/
 select a.* into #fyb1 from (
   /*日常开支，店租费用，税务费用，个人借款，个人花费，差旅费，工资,固定资产*/
   select a.cs,dbo.f_Zw_kjnd(a.khid,a.rq) as nd,convert(varchar(6),a.rq,112) as ny,1 as xh,kh.sskhid,kh.khid,
   sum(case when ((a.jb='xf' and a.bxlx=0) or (a.bxlx=1 and a.jb!='xz')) then a.hdje else 0 end) as sj_gsfy,  
   sum(case when a.jb='mydd' and a.bxlx=0 and kh.xdbs=0  then a.hdje else 0 end) as sj_ddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=0 then a.hdje else 0 end) as sj_ddfy, 
   sum(case when a.jb='mydd'  and a.bxlx=0 and kh.xdbs=1  then a.hdje else 0 end) as sj_xdddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=1 then a.hdje else 0 end) as sj_xdddfy  
  from zw_v_sjkzfy a
  inner join #tmp_khb kh on a.khid=kh.khid 
  where a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.pzbs=1
  group by dbo.f_Zw_kjnd(a.khid,a.rq),convert(varchar(6),a.rq,112) ,kh.sskhid,kh.khid,a.cs
) a 


select *,sj_gsfy+sj_ddgsfy+sj_ddfy+sj_xdddgsfy+sj_xdddfy as sj_hjfy into #fyb 
from (
   select * from #fyb1   
   union all 
   select * from #fyb2 
) a ;

 /*往来款*/
 select a.tzid,sum(jfje) as sr,sum(dfje) as zc
 into #wlk 
 from Zw_T_Cnrjz as a 
 inner join ( select kmdm from zw_t_kmsdb where djlx='12460' and xjdfkm=6982 and tzid=1 and scxe=1  ) b on a.dfkm=b.kmdm
 where a.lylx in (311,312,316,321,322,323,0,826) 
  and  a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.nd=dbo.f_zw_kjnd(a.tzid,@jsrq) 
 group by a.tzid


  select a.sskhid,km.kmdm into #sykmdm from (select sskhid from #tmp_khb group by sskhid) a 
  inner join zw_t_zwkmb km on a.sskhid=km.tzid 
  where km.nd=2017 and km.kzlb=1 
  group by a.sskhid,km.kmdm ;

 select a.sskhid,sum(xjcnzc) as xjcnzc,sum(xxjcnzc) as xxjcnzc,sum(sjcnzc) as sjcnzc,sum(ddcnzc) as ddcnzc,sum(xdddcnzc) as xdddcnzc 
        into #cnzc 
 from (
    select a.sskhid,sum(case when b.khid>0  and b.khid!=b.tzid and isnull(kh.xdbs,0)=0 then b.dfje else 0 end) as xjcnzc,
           sum(case when b.khid>0  and b.khid!=b.tzid and kh.xdbs=1 then b.dfje else 0 end) as xxjcnzc,
           sum(case when (b.khid=0 or b.khid=b.tzid) then b.dfje else 0 end) as sjcnzc,0 as ddcnzc,0 as xdddcnzc
    from #sykmdm a inner join zw_t_cnrjz b on a.sskhid=b.tzid and a.kmdm=b.dfkm and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq)   
    left outer join #tmp_khb kh on b.khid=kh.khid 
    group by a.sskhid 
    union all 
    select a.sskhid,0 as xjcnzc,0 as xxjcnzc,0 as sjcnzc,sum(case when a.xdbs=0 then dfje else 0 end) as ddcnzc,
           sum(case when a.xdbs=1 then dfje else 0 end) as xdddcnzc 
	from (select sskhid,khid,xdbs from #tmp_khb group by sskhid,khid,xdbs) a 
    inner join zw_t_cnrjz b on a.sskhid=b.tzid and b.khid=a.khid and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq) and b.dfkm='122111' 
    and b.khid>0 group by a.sskhid 
 ) a group by a.sskhid;


/*资金余额[对公，对私]*/
 select a.tzid,sum(case when a.kmdm in ('100201','100202') then a.qmje else 0 end) as dgje 
              ,sum(case when a.kmdm in ('100101','100102','1012') then a.qmje else 0 end) as dsje 
 into #zjyezb 
 from ds_t_cnrjzzzb a where 1=1 and ny=@jsny and a.kmdm in ('100201','100202','100101','100102','1012') group by a.tzid ;


if '2'='1' 
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,max(zj.dgje) as dgje,
       max(zj.dsje) as dsje,max(zc.sjcnzc) as sjcnzc,max(zc.xjcnzc) as xjcnzc,max(zc.ddcnzc) as ddcnzc,
       max(zc.xxjcnzc) as xxjcnzc,max(zc.xdddcnzc) as xdddcnzc,
       max(zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc) as cnzc,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
       sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
       sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy,
       max(allys.ys_allgsfy) as ys_allgsfy, max(allys.ys_allddfy) as ys_allddfy 
       ,max(wl.sr) as wlsr,max(wl.zc) as wlzc,max(wl.zc)-max(wl.sr) as wlce    
   from #tmp_khb kh left outer join #fyb a on kh.sskhid=a.sskhid and kh.khid=a.khid  and a.ny>=@ksny and a.ny<=@jsny
   left outer join #jhb b on kh.sskhid=b.sskhid and kh.khid=b.khid and b.ny>=@ksny and b.ny>=@jsny  
   left outer join #fyb c on kh.sskhid=c.sskhid and kh.khid=c.khid and c.ny>=@tqksny and c.ny<=@tqjsny and right(a.ny,2)=right(c.ny,2) 
        and a.sj_hjfy>0 and c.sj_hjfy>0 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.sskhid=allys.sskhid 
   left outer join #cnzc zc on kh.sskhid=zc.sskhid 
   left outer join #zjyezb zj on kh.sskhid=zj.tzid  
   left join #wlk wl on kh.sskhid=wl.tzid
   where 1=1 
   group by kh.sskhid,kh.sskhmc,kh.sskhdm,kh.sfmc   
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 

if '2'='2' or '2'=''
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb 
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq   
       ,zj.dgje,zj.dsje,zc.sjcnzc,zc.xjcnzc,zc.ddcnzc, 
       zc.xxjcnzc,zc.xdddcnzc,
       zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc as cnzc,
       allys.ys_allgsfy,allys.ys_allddfy  
       ,wl.sr as wlsr,wl.zc as wlzc,wl.zc-wl.sr as wlce 
    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.tq_gsfy) as tq_gsfy, sum(c.tq_ddgsfy) as tq_ddgsfy,
       sum(c.tq_ddfy) as tq_ddfy, sum(c.tq_xdddgsfy) as tq_xdddgsfy,
       sum(c.tq_xdddfy) as tq_xdddfy,sum(c.tq_hjfy) as tq_hjfy
   from #tmp_khb kh 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as sj_gsfy, sum(c.sj_ddgsfy) as sj_ddgsfy,
              sum(c.sj_ddfy) as sj_ddfy, sum(c.sj_xdddgsfy) as sj_xdddgsfy,
              sum(c.sj_xdddfy) as sj_xdddfy,sum(c.sj_hjfy) as sj_hjfy  
       from #fyb c where c.ny>=@ksny and c.ny<=@jsny group by c.sskhid,c.khid 
   ) a on kh.sskhid=a.sskhid and kh.khid=a.khid 
   left outer join (select sskhid,khid,sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy from #jhb b where b.ny>=@ksny and b.ny<=@jsny group by sskhid,khid) b 
   on kh.sskhid=b.sskhid and kh.khid=b.khid 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
              sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
              sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy  
       from #fyb c where c.ny>=@tqksny and c.ny<=@tqjsny group by c.sskhid,c.khid 
   ) c on kh.sskhid=c.sskhid and kh.khid=c.khid 
   group by kh.sskhdm,kh.sskhid,kh.sskhmc,kh.sfmc  
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.khid=allys.sskhid 
   left outer join #cnzc zc on a.khid=zc.sskhid 
   left outer join #zjyezb zj on a.khid=zj.tzid 
   left join #wlk wl on a.khid=wl.tzid;

drop table #tmp_khb;
drop table #jhb;
drop table #fyb1 ;
drop table #fyb2 ;
drop table #fyb ;
drop table #sykmdm ;
drop table #cnzc ;
drop table #zjyezb ;
drop table #wlk;
 

2017-8-22 11:27:46  declare @ksny varchar(6); 
declare @jsny varchar(6); 
declare @tqksny varchar(6); 
declare @tqjsny varchar(6); 
declare @jsrq datetime ;
declare @ksrq datetime ;
declare @tqjsrq varchar(10); 
declare @tqksrq varchar(10);

select @ksny=convert(varchar(6),cast('2017-08-01' as datetime),112);
select @jsny=convert(varchar(6),cast('2017-08-22' as datetime),112);
select @tqksny=convert(varchar(6),dateadd(year,-1,cast('2017-08-01' as datetime)),112);/*上一年度*/
select @tqjsny=convert(varchar(6),dateadd(year,-1,cast('2017-08-22' as datetime)),112);
set @ksrq='2017-08-01' ;
set @jsrq='2017-08-22' ;
select @tqksrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-01' as datetime)) ,120); 
select @tqjsrq=convert(varchar(10),dateadd(year,-1,cast('2017-08-22' as datetime)) ,120); 

select a.* into #tmp_khb from ( 
    select distinct b.khid,a.khid sskhid,a.khdm as sskhdm,a.khjc as sskhmc,b.khmc,b.ccid,gx.ksny,gx.jsny,b.ssid,c.mc as sfmc,a.lxr,
           case when Convert(varchar(6),isnull(gx.sjkyrq,'1900-01-01'),112) between @ksny and @jsny then 1 else 0 end as xdbs   
    from yx_t_khb a 
    left join  [192.168.35.10].tlsoft.dbo.yx_t_khsfdm c on a.sfdm=c.dm   
    inner join yx_t_khb b on a.ssid=1 and a.khlbdm<>'g' and (b.ccid+'-' like a.ccid+'-%')  and a.khid>1 
    left outer join yx_t_khgxb gx on gx.khid=case when b.khlbdm in ('D','d') then b.ssid else a.khid end and b.khid=gx.gxid and (gx.ksny<=@jsny and gx.jsny>=@ksny) 
    where 1=1 and a.khid not in(85,1384,14204) and len(a.dzbbpx)>0 and b.khmc not like '%直销户%' and b.ty=0 
          and a.khfl like 'x%' and isnull(gx.qtlx,0)=0   /*and b.khfl='xz'*/
) as a ; 

select * into #jhb from (
    select 'ys' as cs,b.ny,1 as xh,a.sskhid,a.khid,
           sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-1 then b.je else 0 end) as ys_gsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=0 then b.je else 0 end) as ys_ddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=0 then b.je else 0 end) as ys_ddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-3 and a.xdbs=1 then b.je else 0 end) as ys_xdddgsfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny and b.bmid=-2 and a.xdbs=1 then b.je else 0 end) as ys_xdddfy,
	sum(case when b.ny>=@ksny and b.ny<=@jsny then b.je else 0 end) as ys_hjfy, 
	sum(b.je) as ys_allfy 
    from #tmp_khb a inner join zw_t_fyjh_kz b on a.khid=b.tzid where b.nd=left(@ksny,4) and b.djlx=12457 /*(b.ny>=@ksny and b.ny<=@jsny) */
    and b.ny>=a.ksny and b.ny<=a.jsny
    group by b.ny,a.sskhid,a.khid    
) a ;
 /*同期实际开支*/
   select 'sjfy' as cs,b.nd,b.ny,1 as xh,a.sskhid,a.khid,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' then b.je else 0 end) as sj_gsfy,  
   sum(case when a.khid=b.khid and b.sjlx='ddmy' and a.xdbs=0 then b.je else 0 end) as sj_ddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=0 then b.je else 0 end) as sj_ddfy,
   sum(case when a.khid=b.khid and a.sskhid=b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddgsfy,
   sum(case when a.khid=b.khid and a.sskhid<>b.khid and b.sjlx='sjfy' and a.xdbs=1  then b.je else 0 end) as sj_xdddfy
   /*,sum(b.je) as sj_hjfy*/
   into #fyb2 
   from #tmp_khb a inner join  [192.168.35.10].tlsoft.dbo.rs_t_yxsjfyb b on a.khid=b.khid 
   where b.nd=2016 and b.khid>0 and b.sjlx in ('sjfy','ddmy') and b.ny>='201603' and b.ny<='201702' 
         and ((b.ny>=@ksny and b.ny<=@jsny) or (b.ny>=@tqksny and b.ny<=@tqjsny) )
    group by b.nd,b.ny,a.sskhid,a.khid;
 /*本期实际开支*/
 select a.* into #fyb1 from (
   /*日常开支，店租费用，税务费用，个人借款，个人花费，差旅费，工资,固定资产*/
   select a.cs,dbo.f_Zw_kjnd(a.khid,a.rq) as nd,convert(varchar(6),a.rq,112) as ny,1 as xh,kh.sskhid,kh.khid,
   sum(case when ((a.jb='xf' and a.bxlx=0) or (a.bxlx=1 and a.jb!='xz')) then a.hdje else 0 end) as sj_gsfy,  
   sum(case when a.jb='mydd' and a.bxlx=0 and kh.xdbs=0  then a.hdje else 0 end) as sj_ddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=0 then a.hdje else 0 end) as sj_ddfy, 
   sum(case when a.jb='mydd'  and a.bxlx=0 and kh.xdbs=1  then a.hdje else 0 end) as sj_xdddgsfy,  
   sum(case when a.jb='xz'  and kh.xdbs=1 then a.hdje else 0 end) as sj_xdddfy  
  from zw_v_sjkzfy a
  inner join #tmp_khb kh on a.khid=kh.khid 
  where a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.pzbs=1
  group by dbo.f_Zw_kjnd(a.khid,a.rq),convert(varchar(6),a.rq,112) ,kh.sskhid,kh.khid,a.cs
) a 


select *,sj_gsfy+sj_ddgsfy+sj_ddfy+sj_xdddgsfy+sj_xdddfy as sj_hjfy into #fyb 
from (
   select * from #fyb1   
   union all 
   select * from #fyb2 
) a ;

 /*往来款*/
 select a.tzid,sum(jfje) as sr,sum(dfje) as zc
 into #wlk 
 from Zw_T_Cnrjz as a 
 inner join ( select kmdm from zw_t_kmsdb where djlx='12460' and xjdfkm=6982 and tzid=1 and scxe=1  ) b on a.dfkm=b.kmdm
 where a.lylx in (311,312,316,321,322,323,0,826) 
  and  a.rq>=@ksrq and a.rq<dateadd(d,1,@jsrq)  and a.nd=dbo.f_zw_kjnd(a.tzid,@jsrq) 
 group by a.tzid


  select a.sskhid,km.kmdm into #sykmdm from (select sskhid from #tmp_khb group by sskhid) a 
  inner join zw_t_zwkmb km on a.sskhid=km.tzid 
  where km.nd=2017 and km.kzlb=1 
  group by a.sskhid,km.kmdm ;

 select a.sskhid,sum(xjcnzc) as xjcnzc,sum(xxjcnzc) as xxjcnzc,sum(sjcnzc) as sjcnzc,sum(ddcnzc) as ddcnzc,sum(xdddcnzc) as xdddcnzc 
        into #cnzc 
 from (
    select a.sskhid,sum(case when b.khid>0  and b.khid!=b.tzid and isnull(kh.xdbs,0)=0 then b.dfje else 0 end) as xjcnzc,
           sum(case when b.khid>0  and b.khid!=b.tzid and kh.xdbs=1 then b.dfje else 0 end) as xxjcnzc,
           sum(case when (b.khid=0 or b.khid=b.tzid) then b.dfje else 0 end) as sjcnzc,0 as ddcnzc,0 as xdddcnzc
    from #sykmdm a inner join zw_t_cnrjz b on a.sskhid=b.tzid and a.kmdm=b.dfkm and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq)   
    left outer join #tmp_khb kh on b.khid=kh.khid 
    group by a.sskhid 
    union all 
    select a.sskhid,0 as xjcnzc,0 as xxjcnzc,0 as sjcnzc,sum(case when a.xdbs=0 then dfje else 0 end) as ddcnzc,
           sum(case when a.xdbs=1 then dfje else 0 end) as xdddcnzc 
	from (select sskhid,khid,xdbs from #tmp_khb group by sskhid,khid,xdbs) a 
    inner join zw_t_cnrjz b on a.sskhid=b.tzid and b.khid=a.khid and b.rq>=@ksrq and b.rq<dateadd(d,1,@jsrq) and b.dfkm='122111' 
    and b.khid>0 group by a.sskhid 
 ) a group by a.sskhid;


/*资金余额[对公，对私]*/
 select a.tzid,sum(case when a.kmdm in ('100201','100202') then a.qmje else 0 end) as dgje 
              ,sum(case when a.kmdm in ('100101','100102','1012') then a.qmje else 0 end) as dsje 
 into #zjyezb 
 from ds_t_cnrjzzzb a where 1=1 and ny=@jsny and a.kmdm in ('100201','100202','100101','100102','1012') group by a.tzid ;


if '2'='1' 
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,max(zj.dgje) as dgje,
       max(zj.dsje) as dsje,max(zc.sjcnzc) as sjcnzc,max(zc.xjcnzc) as xjcnzc,max(zc.ddcnzc) as ddcnzc,
       max(zc.xxjcnzc) as xxjcnzc,max(zc.xdddcnzc) as xdddcnzc,
       max(zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc) as cnzc,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
       sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
       sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy,
       max(allys.ys_allgsfy) as ys_allgsfy, max(allys.ys_allddfy) as ys_allddfy 
       ,max(wl.sr) as wlsr,max(wl.zc) as wlzc,max(wl.zc)-max(wl.sr) as wlce    
   from #tmp_khb kh left outer join #fyb a on kh.sskhid=a.sskhid and kh.khid=a.khid  and a.ny>=@ksny and a.ny<=@jsny
   left outer join #jhb b on kh.sskhid=b.sskhid and kh.khid=b.khid and b.ny>=@ksny and b.ny>=@jsny  
   left outer join #fyb c on kh.sskhid=c.sskhid and kh.khid=c.khid and c.ny>=@tqksny and c.ny<=@tqjsny and right(a.ny,2)=right(c.ny,2) 
        and a.sj_hjfy>0 and c.sj_hjfy>0 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.sskhid=allys.sskhid 
   left outer join #cnzc zc on kh.sskhid=zc.sskhid 
   left outer join #zjyezb zj on kh.sskhid=zj.tzid  
   left join #wlk wl on kh.sskhid=wl.tzid
   where 1=1 
   group by kh.sskhid,kh.sskhmc,kh.sskhdm,kh.sfmc   
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 

if '2'='2' or '2'=''
select a.*,ys_gsfy-sj_gsfy as jc_gsfy,ys_ddgsfy-sj_ddgsfy as jc_ddgsfy,ys_ddfy-sj_ddfy as jc_ddfy
       ,ys_xdddgsfy-sj_xdddgsfy as jc_xdddgsfy,ys_xdddfy-sj_xdddfy as jc_xdddfy,ys_hjfy-sj_hjfy as jc_hjfy
       ,case when ys_allgsfy=0 then 0 else (a.sj_gsfy+a.sj_ddgsfy+a.sj_xdddgsfy)/ys_allgsfy*100 end as gsfyzb 
       ,case when ys_allddfy=0 then 0 else (a.sj_ddfy+a.sj_xdddfy)/ys_allddfy*100 end as ddfyzb 
       ,b.sz2 as zcfzr,b.sz3 as ldy,@ksrq as ksrq,@jsrq as jsrq ,@ksny as ksny,@jsny as jsny,@tqksny as tqksny,@tqjsny as tqjsny 
       ,b.cnry as ry_cn,b.kjry as ry_kj,b.rzry as ry_rz,b.spry as ry_sp,@tqksrq as tqksrq,@tqjsrq as tqjsrq   
       ,zj.dgje,zj.dsje,zc.sjcnzc,zc.xjcnzc,zc.ddcnzc, 
       zc.xxjcnzc,zc.xdddcnzc,
       zc.sjcnzc+zc.xjcnzc+zc.ddcnzc+zc.xxjcnzc+zc.xdddcnzc as cnzc,
       allys.ys_allgsfy,allys.ys_allddfy  
       ,wl.sr as wlsr,wl.zc as wlzc,wl.zc-wl.sr as wlce 
    
from (
   select kh.sfmc,kh.sskhid as khid,kh.sskhmc as khmc,kh.sskhdm as khdm,max(kh.lxr) lxr,
       sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy,
       sum(a.sj_gsfy) as sj_gsfy, sum(a.sj_ddgsfy) as sj_ddgsfy,
       sum(a.sj_ddfy) as sj_ddfy, sum(a.sj_xdddgsfy) as sj_xdddgsfy,
       sum(a.sj_xdddfy) as sj_xdddfy, sum(a.sj_hjfy) as sj_hjfy,
       sum(c.tq_gsfy) as tq_gsfy, sum(c.tq_ddgsfy) as tq_ddgsfy,
       sum(c.tq_ddfy) as tq_ddfy, sum(c.tq_xdddgsfy) as tq_xdddgsfy,
       sum(c.tq_xdddfy) as tq_xdddfy,sum(c.tq_hjfy) as tq_hjfy
   from #tmp_khb kh 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as sj_gsfy, sum(c.sj_ddgsfy) as sj_ddgsfy,
              sum(c.sj_ddfy) as sj_ddfy, sum(c.sj_xdddgsfy) as sj_xdddgsfy,
              sum(c.sj_xdddfy) as sj_xdddfy,sum(c.sj_hjfy) as sj_hjfy  
       from #fyb c where c.ny>=@ksny and c.ny<=@jsny group by c.sskhid,c.khid 
   ) a on kh.sskhid=a.sskhid and kh.khid=a.khid 
   left outer join (select sskhid,khid,sum(isnull(b.ys_gsfy,0)) as ys_gsfy,sum(isnull(b.ys_ddgsfy,0)) as ys_ddgsfy,
       sum(isnull(b.ys_ddfy,0)) as ys_ddfy,sum(isnull(b.ys_xdddgsfy,0)) as ys_xdddgsfy,
       sum(isnull(b.ys_xdddfy,0)) as ys_xdddfy,sum(isnull(b.ys_hjfy,0)) as ys_hjfy from #jhb b where b.ny>=@ksny and b.ny<=@jsny group by sskhid,khid) b 
   on kh.sskhid=b.sskhid and kh.khid=b.khid 
   left outer join (
       select c.sskhid,c.khid,sum(c.sj_gsfy) as tq_gsfy, sum(c.sj_ddgsfy) as tq_ddgsfy,
              sum(c.sj_ddfy) as tq_ddfy, sum(c.sj_xdddgsfy) as tq_xdddgsfy,
              sum(c.sj_xdddfy) as tq_xdddfy,sum(c.sj_hjfy) as tq_hjfy  
       from #fyb c where c.ny>=@tqksny and c.ny<=@tqjsny group by c.sskhid,c.khid 
   ) c on kh.sskhid=c.sskhid and kh.khid=c.khid 
   group by kh.sskhdm,kh.sskhid,kh.sskhmc,kh.sfmc  
) a left outer join [192.168.35.10].tlsoft.dbo.xt_T_tycsxz b on a.khid=b.khid and b.bid=1 
   left outer join (
       select sum(case when a.sskhid=a.khid then ys_allfy else 0 end) as ys_allgsfy , 
              sum(case when a.sskhid<>a.khid then ys_allfy else 0 end) as ys_allddfy ,a.sskhid 
       from #tmp_khb a inner join #jhb b on a.sskhid=b.sskhid and a.khid=b.khid 
       group by a.sskhid 
   ) allys on a.khid=allys.sskhid 
   left outer join #cnzc zc on a.khid=zc.sskhid 
   left outer join #zjyezb zj on a.khid=zj.tzid 
   left join #wlk wl on a.khid=wl.tzid;

drop table #tmp_khb;
drop table #jhb;
drop table #fyb1 ;
drop table #fyb2 ;
drop table #fyb ;
drop table #sykmdm ;
drop table #cnzc ;
drop table #zjyezb ;
drop table #wlk;
 
