<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name=viewport content="width=device-width,initial-scale=1,user-scalable=0,maximum-scale=1">
    <meta name=format-detection content="telephone=no">
    <meta name=apple-mobile-web-app-capable content=yes>
    <meta name=apple-mobile-web-app-status-bar-style content=black>
    <link rel="stylesheet" type="text/css" href="../../res/css/LeePageSlider.css">
    <title>经营指标得分</title>
    <style type="text/css">
        @font-face {
            font-family: "iconfont";
            src: url('./bbtable-iconfont.ttf?t=1502455069640') format('truetype');
        }

        .iconfont {
            font-family: "iconfont" !important;
            font-style: normal;
            -webkit-font-smoothing: antialiased;
            font-size: 16px;
        }

        input {
            border: none;
            border-radius: 0;
        }

        .page {
            padding: 0;
            background-color: #f2f2f2;
            font-size: 12px;
        }

        .header {
            height: 44px;
            background-color: #212121;
            color: #fff;
        }

        .page-not-header {
            top: 44px;
        }

        .table-page {
            background-color: #eef1f6;
        }

        /*iconfonts style*/
        .icon-search:before {
            content: "\e638";
        }

        .icon-leftarrow:before {
            content: "\e600";
        }

        .icon-filter:before {
            content: "\e663";
        }

        .icon-checkbox:before {
            content: "\e642";
        }

        .icon-checkbox.checked {
            color: #1cc1c7;
        }

        .header {
            display: flex;
            align-items: center;
            line-height: 1;
        }

            .header .btn {
                width: 44px;
                min-width: 44px;
                text-align: center;
            }

        .btn.btn_filter {
            min-width: 48px;
        }

        .btn_back .icon-leftarrow {
            font-size: 24px;
        }

        .btn_filter .icon-filter {
            font-size: 20px;
        }

        .header input {
            flex: 1;
            -webkit-appearance: none;
            border-radius: 0;
            border: none;
            width: 100%;
            height: 34px;
            padding: 0 10px;
            font-size: 14px;
        }

        .inp_search .icon-search {
            display: block;
            background-color: #666;
            position: absolute;
            top: 0;
            right: 0;
            text-align: center;
            height: 34px;
            width: 34px;
            font-size: 24px;
            line-height: 34px;
        }

        /*table style*/
        .ll-table {
            position: relative;
            overflow: hidden;
            background-color: #fff;
            color: #1f2d3d;
            height: 100%;
            display: flex;
            flex-direction: column;
            min-width: 100%;
        }

        .ll-table_header-wrapper, .ll-table_static-wrapper {
            position: relative;
            z-index: 100;
            background-color: #eef1f6;
            box-sizing: border-box;
        }

            .ll-table_header-wrapper table, .ll-table_static-wrapper table {
                transition: transform 150ms cubic-bezier(.42,0,.58,1);
            }

            .ll-table_header-wrapper th {
                border-bottom: 1px solid #dfe6ec;
            }

        .ll-table_body-wrapper {
            flex: 1;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
        }

        .ll-table th {
            background-color: #eef1f6;
        }

        .ll-table td, .ll-table th {
            min-width: 0;
            box-sizing: border-box;
            text-overflow: ellipsis;
            vertical-align: middle;
            padding: 5px;
        }

        .ll-table--border td:not(:last-child), .ll-table--border th:not(:last-child) {
            border-right: 1px solid #dfe6ec;
        }

        .ll-table_header-wrapper tr:not(:first-child) th {
            border-right: 1px solid #dfe6ec;
        }

        .ll-table td, .ll-table th.is-leaf {
            border-bottom: 1px solid #dfe6ec;
        }

        .ll-table .cell {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: normal;
            word-break: break-all;
        }

        .ll-table_body-wrapper table .cell {
            padding: 3px 0;
        }

        .ll-table_body-wrapper tr:nth-child(even) {
            background: #f4f4f4;
        }

        .ll-table_static-wrapper {
            background-color: #eef1f6;
            height: 41px;
            border-top:1px solid #dfe6ec;
            display:none;
        }

            .ll-table_static-wrapper thead {
                visibility: hidden;
            }

            .ll-table_static-wrapper table {
                position: absolute;
                left: 0;
                width: 100%;
                bottom: 0;
                height: 40px;
            }

            .ll-table_static-wrapper td {
                vertical-align: middle;
                font-size: 14px;
                overflow: hidden;
            }

            .ll-table_static-wrapper .cell {
                white-space: nowrap;
                text-overflow: ellipsis;
                height: 30px;
                line-height: 30px;
            }

        table {
            width: 100%;
            overflow: auto;
            table-layout: fixed;
        }

        .ll-table__body thead {
            visibility: hidden;
        }

        .cell.number {
            text-align: right;
        }

        /*filter-page style*/
        .filter-page {
            background-color: transparent;
            font-size: 14px;
        }

            .filter-page .mask {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.4);
                display: none;
            }

        .filter_wrapper {
            background-color: #f0f0f0;
            position: absolute;
            top: 0;
            right: 0;
            width: 260px;
            height: 100%;
        }

        .filter_wrapper {
            display: flex;
            flex-direction: column;
        }

            .filter_wrapper .filter_main {
                flex: 1;
                overflow-x: hidden;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            .filter_wrapper .filter_btns {
                min-height: 40px;
            }

        .filter_btns button {
            display: block;
            width: 50%;
            float: left;
            border: none;
            height: 40px;
            line-height: 40px;
            font-size: 14px;
            font-weight: bold;
        }

        .filter_main {
            padding: 0 10px;
        }

        .filter_item {
            padding: 10px 0;
        }

            .filter_item .title {
                color: #888;
                font-weight: bold;
                margin-bottom: 10px;
            }

            .filter_item .date-range {
                background-color: #dedede;
                text-align: center;
                white-space: nowrap;
                width: 100%;
            }

            .filter_item input[type=date], .filter_item input[type=month] {
                margin: 8px 0;
                height: 32px;
                padding-left: 5px;
                font-size: 12px;
                color: #000;
                max-width: 40%;
                background-color:#fff;
            }

            .filter_item select {
                border-radius: 0;
                background-color: #fff;
                border: none;
                width: 100%;
                height: 36px;
                font-size: 14px;
                -webkit-appearance: none;
                padding: 0 10px;
                color: #a4a4a6;
                box-shadow: 0 1px 2px #ccc;
            }

                .filter_item select:before {
                    content: "\e600";
                    font-family: "iconfont" !important;
                    font-style: normal;
                    -webkit-font-smoothing: antialiased;
                    font-size: 16px;
                }

        .select_wrapper {
            position: relative;
            background-color: #dedede;
            text-align: center;
            white-space: nowrap;
            width: 100%;
            padding: 10px;
        }

            .select_wrapper .icon-leftarrow {
                position: absolute;
                right: 10px;
                top: 50%;
                transform: translate(0,-50%) rotate(-90deg);
                color: #aaa;
            }

        /*loading style*/
        .loading_mask {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,.6);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.4;
            display: none;
        }

        .loading_wrap {
            background-color: rgba(0,0,0,.6);
            padding: 10px 15px;
            color: #fff;
            text-align: center;
            max-width: 240px;
            max-height: 400px;
            overflow: hidden;
        }

        .loading_gif {
            width: 30px;
        }
    </style>
</head>
<body>
    <div class="loading_mask">
        <div class="loading_wrap">
            <img class="loading_gif" src="../../res/img/my_loading.gif" />
            <p class="loading_text">正在查询..</p>
        </div>
    </div>
    <div class="header">
        <div class="btn btn_back"><i class="iconfont icon-leftarrow"></i></div>
        <div class="inp_search" style="flex:1;position:relative;">
            <input type="text" placeholder="搜索条件" id="search-text" />
            <i class="iconfont icon-search"></i>
        </div>
        <div class="btn btn_filter">
            <i class="iconfont icon-filter"></i>
            <p>筛选</p>
        </div>
    </div>
    <div class="wrap-page">
        <!--表格页-->
        <div class="page page-not-header table-page">
            <div class="ll-table ll-table--border">
                <div class="ll-table_header-wrapper">
                    <table cellspacing="0" cellpadding="0" border="0" class="ll-table__header">
                        <thead>
                            <tr>
                                <th style="width:160px;">贸易公司</th>
                                <th style="width:50px;">总得分</th>
                                <th style="width:50px;">排名</th>
                                <th style="width:80px;">销售规模增长20%（加盟收入+直营销售）</th>
                                <th style="width:80px;">287折盈利增长或减亏20%</th>
                                <th style="width:80px;">平均折扣5%</th>
                                <th style="width:80px;">新货售罄率（一）15% 75%以上；70%-74.9%；65%-69%；60-65%</th>
                                <th style="width:80px;">新货售罄率（二）10%同比增长或下降（达75%满分）</th>
                                <th style="width:80px;">旧货销售目标达成10%（41折）</th>
                                <th style="width:80px;">平均店效（同店增长）10%</th>
                                <th style="width:80px;">平均店效（平均年效）10%</th>
                            </tr>
                        </thead>
                    </table>
                </div>
                <div class="ll-table_body-wrapper">
                    <table cellspacing="0" cellpadding="0" border="0" class="ll-table__body">
                        <tbody></tbody>
                    </table>
                </div>
                <div class="ll-table_static-wrapper">
                    <table cellspacing="0" cellpadding="0" border="0" class="ll-table__static">
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="page filter-page page-right">
            <div class="mask"></div>
            <div class="filter_wrapper">
                <div class="filter_main">
                    <div class="filter_item">
                        <p class="title">年月范围</p>
                        <div class="date-range">
                            <input id="startDate" type="month" value="2017-01">
                            <span>至</span>
                            <input id="endDate" type="month" value="2017-01">
                        </div>
                    </div>
                    <div class="filter_item">
                        <p class="title">贸易公司</p>
                        <div class="select_wrapper">
                            <select id="filter_khid"></select>
                            <i class="iconfont icon-leftarrow"></i>
                        </div>
                    </div>
                    <!--<div class="filter_item">
                        <p class="title">本期可调配状态</p>
                        <div class="select_wrapper">
                            <select>
                                <option value="1">全部</option>
                            </select>
                            <i class="iconfont icon-leftarrow"></i>
                        </div>
                    </div>
                    <div class="filter_item">
                        <p class="title">只含费用科目 <i class="iconfont icon-checkbox"></i></p>
                    </div>-->
                </div>
                <div class="filter_btns floatfix">
                    <button class="btn_reset" style="background-color:#daf9fb;color:#5bbec4">重 置</button>
                    <button class="btn_confirm" style="background-color:#5bbec4;color:#daf9fb">提 交</button>
                </div>
            </div>
        </div>
    </div>

    <!--模板区-->
    <script type="text/html" id="tpl_filterKhid">
        <option value="{{dm}}">{{mc}}</option>
    </script>
    <script type="text/html" id="tpl_tableRow">
        <tr class="ll-table__row">
            <td><div class="cell" data-khid="{{khid}}">{{khmc}}</div></td>
            <td><div class="cell number">{{zf}}</div></td>
            <td><div class="cell number">{{xh}}</div></td>
            <td><div class="cell number">{{xssr}}</div></td>
            <td><div class="cell number">{{yl}}</div></td>
            <td><div class="cell number">{{pjzk}}</div></td>
            <td><div class="cell number">{{sql1}}</div></td>
            <td><div class="cell number">{{sql2}}</div></td>
            <td><div class="cell number">{{jhxsmb}}</div></td>
            <td><div class="cell number">{{pjdx1}}</div></td>
            <td><div class="cell number">{{pjdx2}}</div></td>
        </tr>
    </script>
    <script type="text/javascript" src="../../res/js/jquery.js"></script>
    <script type="text/javascript" src="../../res/js/template.js"></script>
    <script type="text/javascript" src="../../res/js/fastclick.min.js"></script>
    <script type="text/javascript">
        $(function () {
            //initFilters --> getDatas --> initTable
            var $loading = $(".loading_mask");
            FastClick.attach(document.body);

            function leeRequest(url, data) {
                return new Promise(function (resolve, reject) {
                    $.ajax({
                        url: url,
                        type: "POST",
                        dataType: "text",
                        contentType: "application/x-www-form-urlencoded; charset=UTF-8",
                        timeout: 15 * 1000,
                        data: data,
                        error: function (XMLHttpRequest, textStatus, errorThrown) {
                            reject("网络出错！" + textStatus);
                        },
                        success: function (res) {
                            resolve(res);
                        }
                    }); //end ajax
                });
            }

            function bindEvents() {
                $(".ll-table_body-wrapper").off().on("scroll", debounce(scrollFunc, 50, false));

                $(".header .btn_filter").click(switchFilter);

                $(".filter-page").on("webkitTransitionEnd", function () {
                    if ($(this).hasClass("page-right"))
                        $(this).find(".mask").hide();
                    else
                        $(this).find(".mask").show();
                });

                $(".filter-page .mask").click(switchFilter);

                $(".btn_confirm").click(function () {
                    switchFilter();
                    getDatas();
                });

                //返回
                $(".btn_back").click(function () {
                    window.history.go(-1);
                })
            }

            function switchFilter() {
                var $filter = $(".filter-page");
                if ($filter.hasClass("page-right"))
                    $filter.removeClass("page-right");
                else {
                    $filter.find(".mask").hide();
                    $filter.addClass("page-right");
                }
            }

            function scrollFunc() {
                var leftsite = $(this).scrollLeft();
                //var winWidth = $(window).width();
                //var contentWidth = $(".ll-table_body-wrapper table").width();
                //var distance = contentWidth - winWidth;
                //leftsite = leftsite >= distance ? distance : leftsite;
                $(".ll-table_header-wrapper table").css("transform", "translate(-" + leftsite + "px,0)");
                $(".ll-table_static-wrapper table").css("transform", "translate(-" + leftsite + "px,0)");
            }

            function showLoading(text) {
                text = text || "正在查询..";
                $loading.find(".loading_text").text(text);
                $loading.css("display", "flex");
            }

            function hideLoading() {
                $loading.hide();
            }

            function initFilters() {                
                return new Promise(function (resolve, reject) {
                    showLoading("正在初始化页面..");
                    setTimeout(function () {
                        leeRequest("http://tm.lilanz.com/QYWX/project/Report/ReportInterface.aspx", {
                            method: "getFinFil"
                        }).then(function (res) {
                            var data = JSON.parse(res);
                            if (data.code == "200") {
                                var html = "";
                                for (var i = 0; i < data.data.khid.length; i++) {
                                    html += template("tpl_filterKhid", data.data.khid[i]);
                                }
                                $("#filter_khid").empty().html(html);
                                //初始化年月
                                var date = new Date;
                                var year = date.getFullYear();
                                var month = date.getMonth() + 1;
                                month = (month < 10 ? "0" + month : month);
                                var mydate = (year.toString() + "-" + month.toString());
                                $("#startDate").val(mydate);
                                $("#endDate").val(mydate);
                                hideLoading();
                                resolve();
                            } else {
                                showLoading(data.msg);
                                reject();
                            }
                        }).catch(function (error) {
                            reject();
                            showLoading(error);
                        });
                    }, 50);
                });
            }

            //节流函数
            function debounce(func, wait, immediate) {
                var timeout;
                return function () {
                    var context = this,
                        args = arguments;
                    var later = function () {
                        timeout = null;
                        if (!immediate) func.apply(context, args);
                    };
                    var callNow = immediate && !timeout;
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                    if (callNow) func.apply(context, args);
                };
            };

            function initTable() {
                var $thead = $(".ll-table_header-wrapper");
                var $tbody = $(".ll-table_body-wrapper");
                var $tstatic = $(".ll-table_static-wrapper");
                $tbody.find("table tbody").before($thead.find("table thead").clone());
                $tbody.css("margin-top", $(".ll-table_header-wrapper").height() * -1 + "px");

                $tstatic.find("table tbody").before($thead.find("table thead").clone());
            }

            function getDatas() {
                return new Promise(function (resolve, reject) {
                    showLoading("正在查询..");
                    var ksny = $("#startDate").val().replace('-', '');
                    var jsny = $("#endDate").val().replace('-', '');
                    var khid = $("#filter_khid").val();
                    leeRequest("http://tm.lilanz.com/QYWX/project/Report/mbb_jyfxb_core.aspx", {
                        method: "GETRPT_23864",
                        filters: JSON.stringify({ ksny: ksny, jsny: jsny, khid: khid })
                    }).then(function (res) {                        
                        var data = JSON.parse(res);
                        if (data.code == "200") {
                            var html = "";
                            for (var i = 0; i < data.data.length; i++) {
                                html += template("tpl_tableRow", data.data[i]);
                            }
                            $(".ll-table_body-wrapper table tbody").empty().html(html);
                            hideLoading();
                            resolve();
                        } else {                            
                            showLoading(data.msg);
                            reject();
                        }
                    }).catch(function (error) {
                        showLoading(error);
                        reject();
                    });
                });
            }

            function init() {
                bindEvents();
                //initFilters().then(getDatas).then(initTable);
                initFilters().then(function () {
                    initTable();
                    switchFilter();
                })
            }

            init();
        });
    </script>
</body>
</html>
